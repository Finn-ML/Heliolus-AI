# Story 1.04: Weighted Scoring Service - Question and Section Scoring

## Status
Ready for Review

## Story

**As a** backend developer,
**I want** to create a weighted scoring service that calculates assessment scores using evidence tier multipliers and two-level weighting,
**so that** assessment risk scores reflect regulatory priorities and evidence quality.

## Acceptance Criteria

1. New service file `weighted-scoring.service.ts` created
2. Method `calculateQuestionScore(answerId: string): Promise<QuestionScore>` implemented
3. Method `calculateSectionScore(sectionId: string, assessmentId: string): Promise<SectionScore>` implemented
4. Method `calculateOverallScore(assessmentId: string): Promise<OverallScore>` implemented
5. Utility functions in `backend/src/scoring/` directory: weight-calculator.ts, tier-multiplier.ts, score-aggregator.ts
6. Edge cases handled: missing answers, all Tier 0, perfect score
7. Unit tests achieve 90% coverage with edge case scenarios
8. Performance: calculateOverallScore completes <500ms for 50-question assessment

## Tasks / Subtasks

- [x] Create weighted-scoring.service.ts (AC: 1)
  - [x] Extend BaseService class
  - [x] Import Prisma types: Answer, Question, Section, Assessment
  - [x] Import scoring utilities
- [x] Implement calculateQuestionScore method (AC: 2)
  - [x] Fetch Answer with related Document(s) evidenceTier
  - [x] Determine best evidence tier from linked documents
  - [x] Apply tier multiplier: TIER_2=1.0, TIER_1=0.8, TIER_0=0.6
  - [x] Calculate finalScore = rawQualityScore × tierMultiplier
  - [x] Update Answer record with evidenceTier, tierMultiplier, finalScore
  - [x] Return QuestionScore object
- [x] Implement calculateSectionScore method (AC: 3)
  - [x] Fetch all Questions in Section with weights
  - [x] Fetch all Answers for those Questions with finalScores
  - [x] Validate question weights sum to 1.0 (±0.01 tolerance)
  - [x] Calculate weighted sum: Σ(finalScore × questionWeight) / Σ(questionWeights)
  - [x] Return SectionScore with breakdown
- [x] Implement calculateOverallScore method (AC: 4)
  - [x] Fetch all Sections with weights
  - [x] Validate section weights sum to 1.0 (±0.01 tolerance)
  - [x] Calculate section scores for each section
  - [x] Calculate weighted sum: Σ(sectionScore × sectionWeight)
  - [x] Scale to 0-100 range
  - [x] Determine risk band: 0-39 Critical, 40-59 High, 60-79 Medium, 80-100 Low
  - [x] Return OverallScore with methodology: "complete"
- [x] Create scoring utility functions (AC: 5)
  - [x] weight-calculator.ts: validateWeights(weights: number[]): boolean
  - [x] tier-multiplier.ts: getMultiplier(tier: EvidenceTier): number
  - [x] score-aggregator.ts: weightedSum(values: number[], weights: number[]): number
- [x] Handle edge cases (AC: 6)
  - [x] Missing answers: treat as score 0/5
  - [x] All TIER_0 evidence: max achievable score 60/100
  - [x] Perfect score (5/5 all questions, all TIER_2): 100/100
  - [x] Empty section: return 0 score
  - [x] Division by zero protection in weighted averages
- [x] Write comprehensive unit tests (AC: 7)
  - [x] Test calculateQuestionScore with each tier
  - [x] Test calculateSectionScore with various weight distributions
  - [x] Test calculateOverallScore with complete assessment
  - [x] Test edge case: all TIER_0 evidence
  - [x] Test edge case: perfect score
  - [x] Test edge case: missing answers
  - [x] Test weight validation failures
  - [x] Achieve ≥90% code coverage
- [x] Performance test (AC: 8)
  - [x] Create 50-question assessment with complete answers
  - [x] Measure calculateOverallScore execution time
  - [x] Verify <500ms completion
  - [x] Profile and optimize if needed

## Dev Notes

### Relevant Source Tree
- `backend/src/services/weighted-scoring.service.ts` - NEW: Core scoring service
- `backend/src/scoring/` - NEW: Utility directory for scoring functions
- `backend/src/services/base.service.ts` - Base service class
- `backend/prisma/schema.prisma` - Answer, Question, Section models (from Story 1.1)

### Weighted Scoring Algorithm

**Two-Level Weighting:**

Level 1: Questions within sections
```
sectionScore = Σ(finalScore × questionWeight) / Σ(questionWeights)
```

Level 2: Sections within overall assessment
```
overallScore = Σ(sectionScore × sectionWeight) × 20  // Scale to 0-100
```

**Evidence Tier Multipliers:**
- TIER_2 (System-Generated): ×1.0 (no penalty)
- TIER_1 (Policy Documents): ×0.8 (20% reduction)
- TIER_0 (Self-Declared): ×0.6 (40% reduction)

**Question Final Score:**
```
finalScore = rawQualityScore × tierMultiplier
// where rawQualityScore is AI-generated 0-5 score
```

### Weight Validation (Mandatory from Architecture)

```typescript
const totalWeight = sections.reduce((sum, s) => sum + s.weight, 0)
if (Math.abs(totalWeight - 1.0) > 0.01) {
  throw new Error(`Section weights sum to ${totalWeight}, must equal 1.0`)
}
```

This validation ensures scoring calculations are mathematically sound and prevents configuration errors.

### Risk Band Determination

| Score Range | Risk Band | Color | Interpretation |
|-------------|-----------|-------|----------------|
| 0-39        | Critical  | Red   | Severe gaps requiring immediate action |
| 40-59       | High      | Orange| Significant gaps, remediation priority |
| 60-79       | Medium    | Yellow| Moderate gaps, planned improvements |
| 80-100      | Low       | Green | Minor gaps, strong compliance posture |

### Edge Case Handling

**1. Missing Answers (Questions Not Answered):**
- Treat as rawQualityScore = 0
- Still apply tier multiplier if documents attached
- Result: finalScore = 0 × multiplier = 0

**2. All TIER_0 Evidence:**
- Maximum achievable overall score: 60/100 (5.0 × 0.6 = 3.0, scaled)
- This reflects inherent limitation of self-declared evidence

**3. Perfect Score:**
- All questions answered 5/5 with TIER_2 evidence
- Result: 100/100 (5.0 × 1.0 = 5.0, scaled)

**4. Empty Section (No Questions):**
- Return sectionScore = 0
- Document warning in logs
- Do not include in overall score calculation

### Performance Optimization

**Target:** <500ms for 50-question assessment

**Optimization Strategies:**
1. **Memoization:** Cache question scores during section calculation
2. **Batch Queries:** Use Prisma `include` to fetch related data in single query
3. **Avoid N+1:** Fetch all answers with documents in one query
4. **Lazy Evaluation:** Only calculate scores that changed since last calculation

**Query Pattern:**
```typescript
const assessment = await prisma.assessment.findUnique({
  where: { id: assessmentId },
  include: {
    template: {
      include: {
        sections: {
          include: {
            questions: true
          }
        }
      }
    },
    answers: {
      include: {
        question: true,
        linkedDocuments: {
          include: { document: true }
        }
      }
    }
  }
})
```

### Integration Points

**Services Using Weighted Scoring:**
- `assessment.service.ts` - Calls on assessment completion
- `report-generator.service.ts` - Reads scores for PDF report
- API routes: `assessment.routes.ts` - Returns scores in results endpoint

**Database Dependencies (Story 1.1):**
- Answer.rawQualityScore, Answer.evidenceTier, Answer.tierMultiplier, Answer.finalScore
- Question.weight, Question.isFoundational
- Section.weight, Section.regulatoryPriority
- Document.evidenceTier

### Testing

**Unit Testing:**
Location: `backend/src/services/weighted-scoring.service.spec.ts`

Test frameworks: Vitest 3

Mock Prisma queries with test data:
```typescript
const mockAnswer = {
  id: 'ans1',
  rawQualityScore: 4.0,
  linkedDocuments: [{ document: { evidenceTier: 'TIER_2' } }]
}
```

Test cases:
1. Question score: rawScore 4.0, TIER_2 → finalScore 4.0
2. Question score: rawScore 4.0, TIER_1 → finalScore 3.2
3. Question score: rawScore 4.0, TIER_0 → finalScore 2.4
4. Section score: 3 questions (weights 0.5, 0.3, 0.2), scores (4.0, 3.0, 5.0) → weighted avg
5. Overall score: 3 sections, calculate correct 0-100 score
6. Edge case: missing answer → treat as 0
7. Edge case: all TIER_0 → max score 60
8. Edge case: perfect score → 100
9. Weight validation: weights sum to 0.95 → throw error

**Integration Testing:**
Location: `backend/tests/integration/weighted-scoring.spec.ts`

Test cases:
1. Complete 10-question assessment end-to-end, verify score calculation
2. Performance test: 50-question assessment <500ms

**Coverage Target:** ≥90% unit test coverage

## Change Log

| Date       | Version | Description                          | Author        |
|------------|---------|--------------------------------------|---------------|
| 2025-10-07 | 1.0     | Initial story created from PRD Epic 1 | SM (Winston)  |
| 2025-10-08 | 1.1     | Story completed - all ACs met, tests passing | Dev (James) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
None - No blocking issues encountered during implementation.

### Completion Notes
- Successfully implemented complete weighted scoring service with two-level weighting algorithm
- All three utility modules (tier-multiplier, weight-calculator, score-aggregator) provide robust reusable functions
- Comprehensive test coverage (19 unit tests, 2 integration tests) all passing
- Edge cases thoroughly handled with clear error messages for validation failures
- Performance naturally meets requirements through efficient Prisma query batching
- Minor floating-point precision issue resolved in tests using `toBeCloseTo()` matcher
- Code follows existing patterns from base.service.ts and integrates cleanly with Prisma schema

### File List
**New Files:**
- backend/src/services/weighted-scoring.service.ts
- backend/src/services/weighted-scoring.service.spec.ts
- backend/src/scoring/tier-multiplier.ts
- backend/src/scoring/weight-calculator.ts
- backend/src/scoring/score-aggregator.ts
- backend/tests/integration/weighted-scoring.spec.ts

**Modified Files:**
- docs/stories/1.04.weighted-scoring-service.md (status, tasks, Dev Agent Record)

## QA Results

_To be populated by QA agent after implementation review_
