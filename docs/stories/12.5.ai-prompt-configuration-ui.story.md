# Story 12.5: AI Prompt Configuration UI

## Status
Draft

## Story

**As a** platform administrator,
**I want** to configure AI analysis prompts for individual questions in the template editor,
**so that** the AI provides targeted, relevant guidance for each question during assessments.

## Acceptance Criteria

1. **AI Prompt Input Field** - Add to Question Create/Edit Dialog
   - Textarea input labeled "AI Analysis Prompt (Optional)"
   - Character limit: 1000 characters
   - Placeholder text with example prompt
   - Character counter showing remaining characters
   - Saves to question.aiPromptHint field via mutation

2. **Prompt Templates/Examples** - Dropdown for quick insertion
   - Dropdown button labeled "Insert Template"
   - 5-7 pre-written prompt templates for common question types
   - Templates: Policy Review, Process Analysis, Risk Assessment, Control Effectiveness, Compliance Check
   - Clicking template inserts text into textarea
   - User can edit after insertion

3. **Preview Mode** - Show how prompt will be used
   - "Preview" button next to AI prompt textarea
   - Opens dialog showing full AI prompt context
   - Displays: System prompt + Question text + User's custom prompt
   - Example answer preview (simulated, not actual AI call)
   - Helps admin understand what AI will receive

4. **Bulk AI Prompt Update** - Apply prompt to multiple questions
   - Checkbox to select multiple questions in section view
   - "Apply Prompt to Selected" button
   - Shows count of selected questions
   - Confirmation dialog before bulk update
   - Updates all selected questions via bulkUpdateQuestions (new endpoint or sequential updates)

5. **AI Prompt Display** - Show in question list
   - Badge indicator if question has AI prompt configured
   - "AI" badge with purple color (matching existing design)
   - Sparkles icon (âš¡) next to question text
   - Tooltip showing first 100 characters of prompt on hover

6. **Character Limit Validation**
   - Real-time character counter (e.g., "750 / 1000")
   - Red text when approaching limit (>900 characters)
   - Prevent submission if over 1000 characters
   - Inline error message: "Prompt must be 1000 characters or less"

## Tasks / Subtasks

- [ ] Task 1: Add AI Prompt Textarea to Question Dialog (AC: 1, 6)
  - [ ] Add textarea field to question create/edit dialog
  - [ ] Set maxLength: 1000 characters
  - [ ] Add character counter component
  - [ ] Style counter: gray normally, red when >900 chars
  - [ ] Add Zod validation: z.string().max(1000).optional()
  - [ ] Include aiPromptHint in createQuestion/updateQuestion mutations
  - [ ] Test: Create question with 500-char prompt, verify saved
  - [ ] Test: Try 1500-char prompt, show validation error

- [ ] Task 2: Create Prompt Templates Dropdown (AC: 2)
  - [ ] Create `promptTemplates` constant with 5-7 templates
  - [ ] Add dropdown button above textarea
  - [ ] Populate dropdown with template names
  - [ ] On select, insert template text into textarea
  - [ ] Allow user to edit inserted text
  - [ ] Update character counter after insertion

- [ ] Task 3: Define Prompt Templates (AC: 2)
  - [ ] Policy Review template
  - [ ] Process Analysis template
  - [ ] Risk Assessment template
  - [ ] Control Effectiveness template
  - [ ] Compliance Check template
  - [ ] Gap Identification template
  - [ ] Document Verification template

- [ ] Task 4: Implement Preview Mode (AC: 3)
  - [ ] Add "Preview" button next to textarea
  - [ ] Create PreviewDialog component
  - [ ] Display full prompt context (system + question + custom)
  - [ ] Show example answer (simulated)
  - [ ] Style with code blocks for clarity
  - [ ] Close button to return to editing

- [ ] Task 5: Add AI Prompt Badge to Question List (AC: 5)
  - [ ] Show purple "AI" badge if question.aiPromptHint exists
  - [ ] Add Sparkles icon from lucide-react
  - [ ] Tooltip showing first 100 chars of prompt
  - [ ] Style consistent with existing badge components

- [ ] Task 6: Implement Bulk Prompt Update (AC: 4)
  - [ ] Add checkbox to each question in section view
  - [ ] Track selected questions in state
  - [ ] Show "Apply Prompt to Selected (X)" button when >0 selected
  - [ ] Open bulk prompt dialog with textarea
  - [ ] On confirm, call updateQuestion for each selected question
  - [ ] Progress indicator during bulk update
  - [ ] Toast on completion

- [ ] Task 7: Integration Testing (All AC)
  - [ ] Create question with AI prompt (500 chars)
  - [ ] Update question AI prompt (change from 500 to 800 chars)
  - [ ] Insert prompt template, verify text appears
  - [ ] Preview prompt, verify full context shown
  - [ ] Test character limit (1000 chars accepted, 1001 rejected)
  - [ ] Select 5 questions, bulk apply prompt
  - [ ] Verify AI badge appears for questions with prompts
  - [ ] Hover over AI badge, see tooltip with prompt preview

## Dev Notes

### Prompt Templates

**Template Definitions:**
```typescript
const promptTemplates = [
  {
    id: 'policy-review',
    name: 'Policy Review',
    template: 'Analyze the provided policy document for completeness, clarity, and alignment with regulatory requirements. Identify any gaps, ambiguities, or areas requiring strengthening. Provide specific recommendations for improvement.',
  },
  {
    id: 'process-analysis',
    name: 'Process Analysis',
    template: 'Evaluate the described process for effectiveness, efficiency, and compliance. Identify potential weaknesses, bottlenecks, or control gaps. Suggest process improvements and best practices.',
  },
  {
    id: 'risk-assessment',
    name: 'Risk Assessment',
    template: 'Assess the risk level associated with the described scenario or control. Consider likelihood, impact, and existing mitigations. Provide a risk rating (Low/Medium/High/Critical) with detailed justification.',
  },
  {
    id: 'control-effectiveness',
    name: 'Control Effectiveness',
    template: 'Evaluate the effectiveness of the described control in mitigating the identified risk. Determine if the control is preventive, detective, or corrective. Assess frequency, coverage, and reliability. Rate effectiveness as Inadequate/Partially Effective/Effective/Highly Effective.',
  },
  {
    id: 'compliance-check',
    name: 'Compliance Check',
    template: 'Verify compliance with the specified regulatory requirement or industry standard. Identify any deviations, exceptions, or areas of non-compliance. Provide remediation recommendations with specific regulatory citations.',
  },
  {
    id: 'gap-identification',
    name: 'Gap Identification',
    template: 'Identify gaps between current state and desired state (best practice, regulatory requirement, or industry standard). Categorize gaps by severity and provide prioritized recommendations for remediation.',
  },
  {
    id: 'document-verification',
    name: 'Document Verification',
    template: 'Verify the authenticity, completeness, and quality of the provided documentation. Check for required elements (version control, approvals, dates, signatures). Assess overall documentation maturity level.',
  },
];
```

### Preview Mode Implementation

**Preview Dialog Component:**
```typescript
function AIPromptPreviewDialog({ questionText, aiPromptHint }: { questionText: string; aiPromptHint: string }) {
  const fullPrompt = buildFullPrompt(questionText, aiPromptHint);
  const exampleAnswer = generateExampleAnswer(questionText);

  return (
    <Dialog>
      <DialogContent className="max-w-3xl max-h-[80vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>AI Prompt Preview</DialogTitle>
          <DialogDescription>
            This is how the AI will receive and process this question
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4">
          <div>
            <h4 className="font-medium mb-2">Full Prompt Context:</h4>
            <pre className="bg-muted p-4 rounded-md text-sm overflow-x-auto">
              {fullPrompt}
            </pre>
          </div>

          <div>
            <h4 className="font-medium mb-2">Example AI Response:</h4>
            <div className="bg-blue-50 p-4 rounded-md text-sm">
              {exampleAnswer}
            </div>
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Close</Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}

function buildFullPrompt(questionText: string, aiPromptHint: string): string {
  return `SYSTEM: You are a compliance assessment expert. Analyze user responses to assessment questions and provide detailed, actionable feedback.

QUESTION: ${questionText}

ANALYSIS GUIDANCE: ${aiPromptHint || 'Provide general analysis and recommendations based on the user\'s response.'}

INSTRUCTIONS: Based on the user's answer, provide:
1. A quality score (0-5) reflecting completeness and adequacy
2. Specific strengths identified in the response
3. Gaps or weaknesses requiring attention
4. Actionable recommendations for improvement
5. Relevant regulatory citations or best practices`;
}

function generateExampleAnswer(questionText: string): string {
  return `Based on the user's response, I've identified the following:

**Quality Score:** 3.5/5

**Strengths:**
- Clear documentation of key controls
- Evidence of regular monitoring
- Alignment with regulatory expectations

**Areas for Improvement:**
- Missing approval workflow documentation
- Frequency of reviews could be increased
- Consider automated alerts for exceptions

**Recommendations:**
1. Implement quarterly policy reviews
2. Document approval chain with signatures
3. Add automated monitoring dashboard

**Regulatory Alignment:** Partially compliant with FFIEC BSA/AML requirements (Section 5.3)`;
}
```

### Character Counter Component

```typescript
function CharacterCounter({ current, max }: { current: number; max: number }) {
  const percentage = (current / max) * 100;
  const isNearLimit = percentage > 90;
  const isOverLimit = current > max;

  return (
    <div className="flex items-center gap-2 text-sm">
      <span className={cn(
        'font-medium',
        isOverLimit && 'text-red-500',
        isNearLimit && !isOverLimit && 'text-yellow-600',
        !isNearLimit && 'text-muted-foreground'
      )}>
        {current} / {max}
      </span>
      {isOverLimit && (
        <span className="text-red-500 text-xs">Character limit exceeded</span>
      )}
    </div>
  );
}
```

### AI Badge Component

```typescript
function AIPromptBadge({ prompt }: { prompt?: string }) {
  if (!prompt) return null;

  const previewText = prompt.length > 100 ? `${prompt.substring(0, 100)}...` : prompt;

  return (
    <TooltipProvider>
      <Tooltip>
        <TooltipTrigger asChild>
          <Badge className="bg-purple-500/20 text-purple-600 hover:bg-purple-500/30">
            <Sparkles className="h-3 w-3 mr-1" />
            AI
          </Badge>
        </TooltipTrigger>
        <TooltipContent className="max-w-xs">
          <p className="text-xs">{previewText}</p>
        </TooltipContent>
      </Tooltip>
    </TooltipProvider>
  );
}
```

### File Locations

**Modified Files:**
- `frontend/src/pages/admin/TemplateManagement.tsx` - Add AI prompt field to question dialog

**New Files:**
- `frontend/src/components/admin/AIPromptPreviewDialog.tsx` - Preview component (optional, can be inline)
- `frontend/src/constants/promptTemplates.ts` - Prompt template definitions

### Testing Checklist

```
â–¡ Add AI prompt to question (500 chars)
â–¡ Insert "Policy Review" template, verify text appears
â–¡ Insert "Risk Assessment" template, replace previous text
â–¡ Edit inserted template text
â–¡ Character counter shows correct count
â–¡ Character counter turns red at >900 chars
â–¡ Preview prompt, verify full context shown
â–¡ Preview example answer makes sense
â–¡ Save question with AI prompt, reload page, prompt persists
â–¡ Update AI prompt on existing question
â–¡ Remove AI prompt (clear textarea, save)
â–¡ Select 3 questions, bulk apply prompt
â–¡ Verify AI badge appears for prompted questions
â–¡ Hover AI badge, see tooltip with prompt preview
â–¡ Test validation: 1500 char prompt rejected
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Story created - AI prompt configuration UI | Bob (Scrum Master) |

---

## Dev Agent Record
_To be populated by dev agent during implementation_

---

## QA Results
_To be populated by QA agent after testing_
