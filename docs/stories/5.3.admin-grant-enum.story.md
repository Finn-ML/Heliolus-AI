# Story 5.3: Add ADMIN_GRANT to TransactionType Enum

## Status
Draft

## Story
**As a** system administrator,
**I want** to record when credits are manually granted to users,
**so that** we have an audit trail of Enterprise credit allocations.

## Acceptance Criteria
1. `TransactionType` enum includes new value `ADMIN_GRANT`
2. Existing transaction types remain unchanged
3. Migration created successfully
4. Enum can be used in CreditTransaction records

## Tasks / Subtasks

- [ ] **Task 1: Add ADMIN_GRANT to TransactionType Enum** (AC: 1, 2)
  - [ ] Open `backend/prisma/schema.prisma`
  - [ ] Locate `TransactionType` enum (line 232)
  - [ ] Add new value `ADMIN_GRANT` to enum
  - [ ] Verify existing values remain: PURCHASE, BONUS, ASSESSMENT, REFUND, ADJUSTMENT, SUBSCRIPTION_RENEWAL
  - [ ] Add comment explaining purpose: `// Manual credit grant by admin`

- [ ] **Task 2: Generate Prisma Migration** (AC: 3)
  - [ ] Run: `npx prisma migrate dev --name add_admin_grant_transaction_type`
  - [ ] Review generated SQL (ALTER TYPE statement)
  - [ ] Verify migration adds ADMIN_GRANT to enum
  - [ ] Verify no existing data affected

- [ ] **Task 3: Update TypeScript Types** (AC: 4)
  - [ ] Run: `npx prisma generate`
  - [ ] Verify `TransactionType.ADMIN_GRANT` available in generated types
  - [ ] Verify TypeScript compilation succeeds

- [ ] **Task 4: Test Enum Usage** (AC: 4)
  - [ ] Create test: `backend/tests/unit/transaction-type-enum.test.ts`
  - [ ] Test creating CreditTransaction with type ADMIN_GRANT
  - [ ] Test querying transactions by type ADMIN_GRANT
  - [ ] Run tests: `npm test`

## Dev Notes

### Enum Location
**File:** `backend/prisma/schema.prisma`
**Line:** 232

**Current TransactionType Enum:**
```prisma
enum TransactionType {
  PURCHASE
  BONUS
  ASSESSMENT
  REFUND
  ADJUSTMENT
  SUBSCRIPTION_RENEWAL
}
```

**Updated Enum:**
```prisma
enum TransactionType {
  PURCHASE
  BONUS
  ASSESSMENT
  REFUND
  ADJUSTMENT
  SUBSCRIPTION_RENEWAL
  ADMIN_GRANT  // NEW - Manual credit grant by admin
}
```

[Source: backend/prisma/schema.prisma#TransactionType]

---

### Usage Context

**ADMIN_GRANT Purpose:**
- Used when admin manually grants credits to Enterprise users
- Distinguishes manual grants from automatic credits (PURCHASE, SUBSCRIPTION_RENEWAL)
- Enables audit trail filtering: "Show all admin credit grants"

**CreditTransaction Usage:**
```typescript
// In AdminCreditService.addCreditsToUser()
await prisma.creditTransaction.create({
  data: {
    subscriptionId: subscription.id,
    type: TransactionType.ADMIN_GRANT,  // NEW enum value
    amount: creditsToAdd,
    balance: newBalance,
    description: reason,
    metadata: {
      grantedBy: adminUserId,
      grantReason: reason,
    },
  },
});
```

[Source: docs/V4_REVISED_PAY_GATING_PLAN.md#AdminCreditService]

---

### Migration Pattern

**Migration Type:** ALTER TYPE (PostgreSQL enum modification)

**Expected SQL:**
```sql
ALTER TYPE "TransactionType" ADD VALUE 'ADMIN_GRANT';
```

**Migration Safety:**
- ✅ Adding enum value is non-breaking
- ✅ Existing CreditTransaction records unaffected
- ✅ No data migration needed
- ✅ Backward compatible

[Source: architecture.md#Database Migration Safety]

---

### Generated TypeScript Type

**Location:** `backend/src/generated/prisma/index.d.ts`

**Before:**
```typescript
export enum TransactionType {
  PURCHASE = 'PURCHASE',
  BONUS = 'BONUS',
  ASSESSMENT = 'ASSESSMENT',
  REFUND = 'REFUND',
  ADJUSTMENT = 'ADJUSTMENT',
  SUBSCRIPTION_RENEWAL = 'SUBSCRIPTION_RENEWAL'
}
```

**After:**
```typescript
export enum TransactionType {
  PURCHASE = 'PURCHASE',
  BONUS = 'BONUS',
  ASSESSMENT = 'ASSESSMENT',
  REFUND = 'REFUND',
  ADJUSTMENT = 'ADJUSTMENT',
  SUBSCRIPTION_RENEWAL = 'SUBSCRIPTION_RENEWAL',
  ADMIN_GRANT = 'ADMIN_GRANT'  // NEW
}
```

[Source: backend/src/generated/prisma/]

---

### Testing Standards

**Test Framework:** Vitest 3
**Test Location:** `backend/tests/unit/transaction-type-enum.test.ts`

**Test Pattern:**
```typescript
import { describe, it, expect, beforeAll, afterAll } from 'vitest';
import { PrismaClient, TransactionType } from '../src/generated/prisma';

describe('TransactionType Enum - ADMIN_GRANT', () => {
  let prisma: PrismaClient;

  beforeAll(() => {
    prisma = new PrismaClient();
  });

  afterAll(async () => {
    await prisma.$disconnect();
  });

  it('should include ADMIN_GRANT in TransactionType enum', () => {
    expect(TransactionType.ADMIN_GRANT).toBe('ADMIN_GRANT');
  });

  it('should create CreditTransaction with ADMIN_GRANT type', async () => {
    // Assuming test subscription exists
    const transaction = await prisma.creditTransaction.create({
      data: {
        subscriptionId: 'test-sub-id',
        type: TransactionType.ADMIN_GRANT,
        amount: 100,
        balance: 100,
        description: 'Test admin grant',
        metadata: { grantedBy: 'admin-123' }
      }
    });

    expect(transaction.type).toBe(TransactionType.ADMIN_GRANT);
  });

  it('should query transactions by ADMIN_GRANT type', async () => {
    const grants = await prisma.creditTransaction.findMany({
      where: { type: TransactionType.ADMIN_GRANT }
    });

    expect(Array.isArray(grants)).toBe(true);
  });
});
```

[Source: architecture.md#Testing Strategy]

---

### File Locations
- **Schema:** `backend/prisma/schema.prisma` (line 232)
- **Migration:** `backend/prisma/migrations/[timestamp]_add_admin_grant_transaction_type/`
- **Generated Types:** `backend/src/generated/prisma/index.d.ts`
- **Test:** `backend/tests/unit/transaction-type-enum.test.ts`

---

### Dependencies
**Depends On:** None (independent enum change)
**Depended On By:** Story 5.5 (AdminCreditService will use this enum)

---

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from Epic 5 | Bob (Scrum Master) |

---

## Dev Agent Record
_This section will be populated by the development agent during implementation_

### Agent Model Used
_TBD_

### Debug Log References
_TBD_

### Completion Notes
_TBD_

### File List
_TBD_

---

## QA Results
_This section will be populated by the QA agent after story completion_
