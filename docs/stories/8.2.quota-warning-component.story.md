# Story 8.2: Add Quota Warning Component to Assessment Templates Page

## Status
Draft

## Story
**As a** Freemium user,
**I want** to see remaining assessment quota,
**so that** I'm aware of my limits before starting a new assessment.

## Acceptance Criteria
1. New component created: `frontend/src/components/QuotaWarning.tsx`
2. Component accepts props:
   ```typescript
   { used: number, total: number, message: string }
   ```
3. Component displays:
   - Progress bar showing X of Y assessments used
   - Color coding: green (0-1 used), yellow (2 used), red (2+ used)
   - Message text (e.g., "1 assessment remaining")
4. Component integrated into `AssessmentTemplates.tsx`:
   - Shown only for FREE tier users
   - Positioned above template selection
   - Fetches quota data via: `useQuery(['user', 'assessment-quota'], () => api.get('/v1/user/assessment-quota'))`
5. If quota exceeded (2 of 2 used):
   - Show red alert with "Assessment Limit Reached"
   - Display upgrade CTA button
   - Disable template selection

## Tasks / Subtasks

- [ ] **Task 1: Create QuotaWarning Component** (AC: 1, 2, 3)
  - [ ] Create file: `frontend/src/components/QuotaWarning.tsx`
  - [ ] Import required dependencies:
    ```typescript
    import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
    import { Progress } from '@/components/ui/progress';
    import { Button } from '@/components/ui/button';
    import { Badge } from '@/components/ui/badge';
    import { AlertTriangle, Crown } from 'lucide-react';
    import { cn } from '@/lib/utils';
    ```
  - [ ] Define component interface:
    ```typescript
    interface QuotaWarningProps {
      used: number;
      total: number;
      message?: string;
      onUpgrade?: () => void;
      className?: string;
    }
    ```

- [ ] **Task 2: Implement QuotaWarning Component Logic** (AC: 3, 5)
  - [ ] Add component implementation:
    ```typescript
    export const QuotaWarning = ({
      used,
      total,
      message,
      onUpgrade,
      className,
    }: QuotaWarningProps) => {
      const percentage = (used / total) * 100;
      const isAtLimit = used >= total;
      const isNearLimit = used === total - 1;

      // Color coding based on usage
      const getVariant = () => {
        if (isAtLimit) return 'destructive';
        if (isNearLimit) return 'warning';  // Custom variant or default
        return 'default';
      };

      const getProgressColor = () => {
        if (isAtLimit) return 'bg-destructive';
        if (isNearLimit) return 'bg-yellow-500';
        return 'bg-primary';
      };

      return (
        <Alert
          variant={isAtLimit ? 'destructive' : 'default'}
          className={cn('mb-6', className)}
        >
          <div className="flex items-start gap-4">
            <div className="flex-1">
              <div className="flex items-center justify-between mb-2">
                <AlertTitle className="text-base font-semibold flex items-center gap-2">
                  {isAtLimit ? (
                    <>
                      <AlertTriangle className="h-4 w-4" />
                      Assessment Limit Reached
                    </>
                  ) : (
                    'Assessment Quota'
                  )}
                </AlertTitle>
                <Badge variant={isAtLimit ? 'destructive' : 'secondary'}>
                  {used} of {total} used
                </Badge>
              </div>

              <Progress
                value={percentage}
                className={cn('h-2 mb-3', isAtLimit && '[&>div]:bg-destructive')}
              />

              <AlertDescription className="text-sm">
                {message || `You have ${total - used} assessment${total - used !== 1 ? 's' : ''} remaining.`}
              </AlertDescription>

              {isAtLimit && onUpgrade && (
                <Button
                  onClick={onUpgrade}
                  className="mt-4"
                  size="sm"
                >
                  <Crown className="h-4 w-4 mr-2" />
                  Upgrade to Premium
                </Button>
              )}
            </div>
          </div>
        </Alert>
      );
    };
    ```

- [ ] **Task 3: Add API Client Method for Quota** (AC: 4)
  - [ ] Open `frontend/src/lib/api.ts`
  - [ ] Add quota fetch method:
    ```typescript
    export const quotaApi = {
      getAssessmentQuota: async () => {
        const response = await apiRequest<{
          success: boolean;
          data: {
            userId: string;
            totalAssessmentsCreated: number;
            assessmentsThisMonth: number;
            assessmentsUsedThisMonth: number;
            plan: string;
            quotaLimit: number;
            quotaRemaining: number;
          };
        }>('/user/assessment-quota');
        return response.data;
      },
    };
    ```

- [ ] **Task 4: Integrate QuotaWarning into AssessmentTemplates Page** (AC: 4, 5)
  - [ ] Open `frontend/src/pages/AssessmentTemplates.tsx`
  - [ ] Add imports:
    ```typescript
    import { useQuery } from '@tanstack/react-query';
    import { useNavigate } from 'react-router-dom';
    import { QuotaWarning } from '@/components/QuotaWarning';
    import { quotaApi } from '@/lib/api';
    ```
  - [ ] Add quota query:
    ```typescript
    const { data: quota, isLoading: quotaLoading } = useQuery({
      queryKey: ['user', 'assessment-quota'],
      queryFn: quotaApi.getAssessmentQuota,
      enabled: !!localStorage.getItem('token'),  // Only if authenticated
    });

    const navigate = useNavigate();
    const isFreeUser = quota?.plan === 'FREE';
    const quotaExceeded = quota?.quotaRemaining === 0;
    ```

- [ ] **Task 5: Render QuotaWarning Conditionally** (AC: 4)
  - [ ] Add QuotaWarning before template selection:
    ```typescript
    return (
      <div className="container mx-auto px-4 py-8">
        <h1 className="text-3xl font-bold mb-6">Choose Assessment Template</h1>

        {/* Show quota warning only for FREE users */}
        {isFreeUser && quota && (
          <QuotaWarning
            used={quota.totalAssessmentsCreated}
            total={quota.quotaLimit}
            message={
              quotaExceeded
                ? 'You have reached your free assessment limit. Upgrade to Premium for unlimited assessments.'
                : `You have ${quota.quotaRemaining} assessment${quota.quotaRemaining !== 1 ? 's' : ''} remaining on your free plan.`
            }
            onUpgrade={() => navigate('/pricing?upgrade=premium')}
          />
        )}

        {/* Template selection grid */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {/* Templates */}
        </div>
      </div>
    );
    ```

- [ ] **Task 6: Disable Template Selection When Quota Exceeded** (AC: 5)
  - [ ] Modify template card click handlers:
    ```typescript
    const handleTemplateSelect = (templateId: string) => {
      // Check quota before allowing selection
      if (quotaExceeded) {
        // Show upgrade modal or prevent action
        return;
      }

      // Proceed with template selection
      navigate(`/assessment/new?templateId=${templateId}`);
    };
    ```
  - [ ] Add disabled state to template cards:
    ```typescript
    <TemplateCard
      template={template}
      onClick={() => handleTemplateSelect(template.id)}
      disabled={quotaExceeded}
      className={quotaExceeded ? 'opacity-50 cursor-not-allowed' : ''}
    />
    ```

- [ ] **Task 7: Add Loading State** (AC: 4)
  - [ ] Show skeleton while loading quota:
    ```typescript
    {isFreeUser && quotaLoading && (
      <div className="mb-6 h-24 bg-muted rounded-lg animate-pulse" />
    )}
    ```

- [ ] **Task 8: Handle Error State** (AC: 4)
  - [ ] Add error handling for quota fetch:
    ```typescript
    const { data: quota, isLoading, isError } = useQuery({ ... });

    if (isError) {
      // Fail gracefully - don't block template selection
      console.warn('Failed to fetch quota, allowing template selection');
    }
    ```

- [ ] **Task 9: Add Unit Tests**
  - [ ] Create test file: `frontend/src/components/QuotaWarning.test.tsx`
  - [ ] Test quota display (0/2, 1/2, 2/2)
  - [ ] Test color coding (green, yellow, red)
  - [ ] Test upgrade button appears when quota exceeded
  - [ ] Test message display
  - [ ] Test progress bar percentage calculation

- [ ] **Task 10: Update AssessmentTemplates Styling** (AC: 4)
  - [ ] Ensure QuotaWarning has proper spacing
  - [ ] Verify responsive design on mobile
  - [ ] Test with different quota values (0, 1, 2)

## Dev Notes

### Quota Warning Display Logic

**FREE User Quota States:**

**State 1: 0 of 2 used (Green)**
```
Assessment Quota                    [0 of 2 used]
â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 0%
You have 2 assessments remaining.
```

**State 2: 1 of 2 used (Yellow)**
```
Assessment Quota                    [1 of 2 used]
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 50%
You have 1 assessment remaining.
```

**State 3: 2 of 2 used (Red)**
```
âš  Assessment Limit Reached          [2 of 2 used]
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
You have reached your free assessment limit. Upgrade to Premium for unlimited assessments.

[ðŸ‘‘ Upgrade to Premium]
```

[Source: docs/prd/epic-8-frontend-integration.md#Story 4.2]

---

### Component Reuse

**Existing Component:**
The codebase already has `FreemiumProgress` in `frontend/src/components/ui/freemium.tsx` which provides similar functionality.

**Options:**
1. **Use FreemiumProgress** (simpler):
   ```typescript
   import { FreemiumProgress } from '@/components/ui/freemium';

   <FreemiumProgress
     used={quota.totalAssessmentsCreated}
     limit={quota.quotaLimit}
     itemName="Assessment"
   />
   ```

2. **Create Custom QuotaWarning** (more control):
   - Allows custom messaging
   - Custom upgrade button integration
   - Template-specific styling

**Recommendation:** Use existing `FreemiumProgress` if it meets all requirements, otherwise create custom `QuotaWarning`.

[Source: frontend/src/components/ui/freemium.tsx:125-153]

---

### API Integration

**Endpoint:** GET /v1/user/assessment-quota

**Response Structure:**
```json
{
  "success": true,
  "data": {
    "userId": "cm123abc",
    "totalAssessmentsCreated": 1,
    "assessmentsThisMonth": 1,
    "assessmentsUsedThisMonth": 1,
    "plan": "FREE",
    "quotaLimit": 2,
    "quotaRemaining": 1
  }
}
```

**TanStack Query Pattern:**
```typescript
const { data: quota } = useQuery({
  queryKey: ['user', 'assessment-quota'],
  queryFn: quotaApi.getAssessmentQuota,
  staleTime: 5 * 60 * 1000,  // 5 minutes
  refetchOnWindowFocus: true,  // Refresh when user returns to page
});
```

[Source: docs/stories/7.7.get-user-assessment-quota.story.md]

---

### Color Coding

**Progress Bar Colors:**
- **Green (0-1 used):** `bg-primary` (default)
- **Yellow (1 used, near limit):** `bg-yellow-500`
- **Red (2+ used, at limit):** `bg-destructive`

**Alert Variant:**
- **Default:** Normal gray background
- **Destructive:** Red background when quota exceeded

**Badge Color:**
- **Secondary:** Gray badge for normal usage
- **Destructive:** Red badge when quota exceeded

[Source: TailwindCSS color palette, Radix UI Alert variants]

---

### Placement in AssessmentTemplates Page

**Page Structure:**
```
<AssessmentTemplates>
  <Header>
    <h1>Choose Assessment Template</h1>
  </Header>

  {/* NEW: Quota Warning (FREE users only) */}
  {isFreeUser && (
    <QuotaWarning ... />
  )}

  <TemplateGrid>
    <TemplateCard disabled={quotaExceeded} />
    <TemplateCard disabled={quotaExceeded} />
    <TemplateCard disabled={quotaExceeded} />
  </TemplateGrid>
</AssessmentTemplates>
```

**Why Above Template Selection:**
- Immediate visibility
- User sees quota before attempting to select template
- Prevents wasted clicks on templates they can't use

[Source: UX best practices for quota warnings]

---

### Template Selection Disabling

**When Quota Exceeded:**
1. Template cards show disabled state (opacity-50, cursor-not-allowed)
2. Click handlers check quota before navigation
3. Hover shows tooltip: "Upgrade to create more assessments"
4. Upgrade CTA prominently displayed in QuotaWarning

**Implementation:**
```typescript
const handleTemplateSelect = (templateId: string) => {
  if (quotaExceeded) {
    // Option 1: Silent prevention
    return;

    // Option 2: Show toast
    toast.error('Assessment limit reached. Please upgrade to continue.');
    return;

    // Option 3: Show upgrade modal (implemented in Story 8.3)
    setShowUpgradeModal(true);
    return;
  }

  navigate(`/assessment/new?templateId=${templateId}`);
};
```

[Source: docs/prd/epic-8-frontend-integration.md#Story 4.2]

---

### Premium Users

**No Quota Warning Shown:**
- PREMIUM users have 2 assessments per billing cycle (resets monthly)
- ENTERPRISE users have unlimited assessments
- QuotaWarning only shown when `quota.plan === 'FREE'`

**Why:**
- PREMIUM/ENTERPRISE users don't have hard lifetime limits
- Monthly quotas less critical (resets regularly)
- Can purchase additional assessments if needed

**Future Enhancement:**
Could add optional quota display for PREMIUM users showing monthly usage:
```
Assessments This Month: 1 of 2 used
Resets in 15 days
```

[Source: docs/V4_REVISED_PAY_GATING_PLAN.md]

---

### Error Handling

**Quota Fetch Fails:**
- Fail gracefully (don't block template selection)
- Log warning to console
- Allow user to proceed (backend will catch quota on API call)

**Why:**
- Better UX than blocking user completely
- Backend has authoritative quota check in assessment creation endpoint
- Frontend quota is informational/preventive, not authoritative

**Implementation:**
```typescript
const { data: quota, isError } = useQuery({ ... });

if (isError) {
  console.warn('Failed to fetch quota, allowing template selection');
  // Don't render QuotaWarning
  // Let backend handle quota check on assessment creation
}
```

[Source: Frontend error handling best practices]

---

### Accessibility

**Requirements:**
- Screen reader announces quota status
- Alert role for quota exceeded state
- Keyboard navigation to upgrade button
- High contrast colors for color-blind users

**Implementation:**
```typescript
<Alert role="alert" aria-live="polite">
  <AlertTitle id="quota-title">Assessment Limit Reached</AlertTitle>
  <AlertDescription aria-describedby="quota-title">
    You have reached your free assessment limit.
  </AlertDescription>
</Alert>

<Progress
  value={percentage}
  aria-label={`${used} of ${total} assessments used`}
  aria-valuenow={used}
  aria-valuemin={0}
  aria-valuemax={total}
/>
```

[Source: WCAG 2.1 guidelines, ARIA best practices]

---

### Testing Checklist

- [ ] Component renders with 0/2 quota (green)
- [ ] Component renders with 1/2 quota (yellow)
- [ ] Component renders with 2/2 quota (red)
- [ ] Upgrade button appears only when quota exceeded
- [ ] Upgrade button navigates to /pricing
- [ ] Component only shown for FREE users
- [ ] Component not shown for PREMIUM/ENTERPRISE users
- [ ] Template selection disabled when quota exceeded
- [ ] Loading skeleton shown while fetching quota
- [ ] Error state handled gracefully
- [ ] Responsive design works on mobile
- [ ] Progress bar percentage correct
- [ ] Message text updates based on quota

[Source: Frontend testing best practices]

---

### File Locations
- **Component:** `frontend/src/components/QuotaWarning.tsx` (new)
- **Page:** `frontend/src/pages/AssessmentTemplates.tsx` (modify)
- **API Client:** `frontend/src/lib/api.ts` (add quotaApi)
- **Tests:** `frontend/src/components/QuotaWarning.test.tsx` (new)

---

### Dependencies
**Depends On:**
- Story 7.7: GET /v1/user/assessment-quota endpoint
- Existing: Alert, Progress, Button UI components
- Existing: TanStack Query

**Depended On By:**
- Story 8.3: Quota exceeded modal (triggered from template selection)

---

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from Epic 8 | Bob (Scrum Master) |

---

## Dev Agent Record
_This section will be populated by the development agent during implementation_

### Agent Model Used
_TBD_

### Debug Log References
_TBD_

### Completion Notes
_TBD_

### File List
_TBD_

---

## QA Results
_This section will be populated by the QA agent after story completion_
