# Story 13.3: Chart Data Transformation & UI Polish

## Status
Draft

## Epic
Epic 13: Admin Revenue Reports - Backend Integration

## Story

**As an** admin user
**I want** revenue charts to display accurate real-time data with proper formatting
**So that** I can make informed business decisions based on actual platform financials

## Description

This is the final story in the Revenue Reports epic. It transforms the raw API data from Story 13.2 into the specific formats required by Recharts components, implements dynamic calculations (growth percentages, averages), handles edge cases, and ensures proper currency formatting throughout the UI.

**Key Challenge**: The API returns data in database-friendly formats (ISO dates, decimal numbers), but Recharts expects specific structures (short month names, arrays of objects). We must transform the data without losing precision while handling edge cases like zero-revenue months and missing organizations.

## Acceptance Criteria

### Chart Data Transformation
1. ✅ Revenue trend LineChart renders correctly with API data
   - X-axis shows month names (Jan, Feb, Mar...)
   - Y-axis shows revenue in EUR
   - Line colors match existing theme (#3BE2E9, #F345B8)
2. ✅ Revenue by product PieChart renders correctly
   - Shows subscription vs credit revenue split
   - Colors match existing theme
   - Percentages display correctly
3. ✅ Top customers Table renders correctly
   - Sorts by revenue descending
   - Shows organization names (not IDs)
   - Displays growth percentage with up/down indicators
4. ✅ Metric cards display correct values:
   - Total Revenue (€23,960)
   - Monthly Average (€1,997)
   - Active Customers (8)
   - Growth percentage with arrow icons

### Currency Formatting
5. ✅ All currency values formatted as EUR (€) with 2 decimals
6. ✅ Large numbers use comma separators (€12,345.67)
7. ✅ Consistent formatting across all components (cards, charts, tables)

### Dynamic Calculations
8. ✅ Growth percentages calculate correctly:
   - Positive growth → green text + up arrow
   - Negative growth → red text + down arrow
   - Zero growth → gray text + minus icon
9. ✅ MRR/ARR displayed prominently in overview
10. ✅ Average monthly revenue calculates accurately (total ÷ months)
11. ✅ Trend indicators show correct direction based on data

### Empty State Handling
12. ✅ "No revenue data available" message when all revenue = 0
13. ✅ Charts display empty state (not errors) for zero-revenue months
14. ✅ Growth calculations handle division by zero (show "N/A" or 0%)
15. ✅ Missing organization names show "Unknown Organization"

### Edge Cases
16. ✅ Zero-revenue months in trend chart show €0 (not gaps in line)
17. ✅ Customers with negative growth display correctly (red, down arrow)
18. ✅ ANNUAL subscriptions normalized in monthly chart (amount ÷ 12)
19. ✅ Single data point doesn't break chart rendering
20. ✅ Very large numbers (>€100k) format correctly with K/M suffixes (optional)

### Time Range Integration
21. ✅ Time range selector updates groupBy parameter:
   - Week/Month → day grouping
   - Quarter → week grouping
   - Year/All → month grouping
22. ✅ X-axis labels adjust based on groupBy (days, weeks, months)

### PDF Export Compatibility
23. ✅ PDF export button continues to work with real data
24. ✅ Export includes current time range filter

## Tasks / Subtasks

- [ ] Task 1: Create Data Transformation Utilities (AC: 5, 6)
  - [ ] Add helper function: `formatCurrency(amount: number): string`
  - [ ] Use Intl.NumberFormat with EUR currency
  - [ ] Format: €12,345.67 (comma separators, 2 decimals)
  - [ ] Add helper function: `formatGrowth(growth: number): string`
  - [ ] Format: +15.3% (with sign) or -8.2%
  - [ ] Round to 1 decimal place

- [ ] Task 2: Transform Revenue Trend Data for LineChart (AC: 1, 16, 18)
  - [ ] Add React.useMemo hook to transform trendsData
  - [ ] Map API response to Recharts format:
    ```typescript
    const revenueData = React.useMemo(() => {
      if (!trendsData?.trends) return [];

      return trendsData.trends.map((t: any) => ({
        month: formatDateForChart(t.date, groupBy),  // "Jan", "Feb", etc.
        revenue: t.revenue,
        subscriptions: t.subscriptions || t.revenue,  // V1: all revenue is subscriptions
        credits: t.credits || 0,                      // V1: credits simplified
        assessments: t.invoiceCount,
      }));
    }, [trendsData, groupBy]);
    ```
  - [ ] Add formatDateForChart helper:
    - 'day' groupBy → "Jan 15", "Jan 16"
    - 'week' groupBy → "Week 1", "Week 2"
    - 'month' groupBy → "Jan", "Feb", "Mar"
  - [ ] Handle zero-revenue months (include in array with revenue: 0)

- [ ] Task 3: Transform Revenue by Product Data for PieChart (AC: 2)
  - [ ] Add React.useMemo hook to transform breakdownData
  - [ ] Map API response to Recharts format:
    ```typescript
    const revenueByProduct = React.useMemo(() => {
      if (!breakdownData?.breakdown?.byProduct) return [];

      return breakdownData.breakdown.byProduct.map((p: any, index: number) => ({
        name: p.type === 'subscription' ? 'Subscriptions' : 'Credit Purchases',
        value: p.revenue,
        color: index === 0 ? '#F345B8' : '#3BE2E9',
      }));
    }, [breakdownData]);
    ```
  - [ ] Handle empty array (no breakdown data)

- [ ] Task 4: Transform Top Customers Data for Table (AC: 3, 15)
  - [ ] Add React.useMemo hook to transform customersData
  - [ ] Map API response to table format:
    ```typescript
    const topCustomers = React.useMemo(() => {
      if (!customersData?.customers) return [];

      return customersData.customers.map((c: any) => ({
        name: c.organizationName || 'Unknown Organization',
        revenue: c.totalRevenue,
        growth: c.growth || 0,
        assessments: c.invoiceCount,
      }));
    }, [customersData]);
    ```
  - [ ] Sort by revenue descending (backend should already sort)

- [ ] Task 5: Update Metric Cards (AC: 4, 9, 10)
  - [ ] Update "Total Revenue" card (line ~151):
    - Value: `formatCurrency(overviewData?.overview?.totalRevenue || 0)`
    - Subtext: `formatGrowth(overviewData?.overview?.growth?.lastMonth || 0)` + " from last month"
  - [ ] Update "Monthly Avg" card (line ~161):
    - Value: `formatCurrency(overviewData?.overview?.avgMonthlyRevenue || 0)`
    - Subtext: "6-month average" or based on date range
  - [ ] Update "Active Customers" card (line ~175):
    - Value: `overviewData?.overview?.totalCustomers || 0`
    - Subtext: Calculate new customers this month (optional, or keep generic)
  - [ ] Update "Assessments" card (line ~185):
    - Value: `overviewData?.overview?.totalInvoices || 0`
    - Subtext: "Completed this period"
  - [ ] Note: May rename "Assessments" card to "Invoices" for accuracy

- [ ] Task 6: Add Growth Indicators (AC: 8, 11, 17)
  - [ ] Create getTrendIcon helper:
    ```typescript
    const getTrendIcon = (growth: number) => {
      if (growth > 0) return <ArrowUpRight className="h-3 w-3 mr-1" />;
      if (growth < 0) return <ArrowDownRight className="h-3 w-3 mr-1" />;
      return <Minus className="h-3 w-3 mr-1" />;
    };
    ```
  - [ ] Create getTrendColor helper:
    ```typescript
    const getTrendColor = (growth: number) => {
      if (growth > 0) return 'text-green-500';
      if (growth < 0) return 'text-red-500';
      return 'text-gray-500';
    };
    ```
  - [ ] Apply to growth displays in cards and tables

- [ ] Task 7: Update Revenue Trend Chart Component (AC: 1, 21, 22)
  - [ ] Update LineChart data prop: `data={revenueData}`
  - [ ] Update X-axis dataKey based on groupBy:
    - 'day' → dataKey="day"
    - 'week' → dataKey="week"
    - 'month' → dataKey="month"
  - [ ] Update Y-axis formatter to show EUR:
    ```typescript
    <YAxis
      stroke="#999"
      tickFormatter={(value) => `€${(value / 1000).toFixed(0)}k`}
    />
    ```
  - [ ] Update Tooltip formatter to show full EUR amounts
  - [ ] Verify line colors match theme (#3BE2E9, #F345B8)

- [ ] Task 8: Update Revenue by Product PieChart (AC: 2)
  - [ ] Update PieChart data prop: `data={revenueByProduct}`
  - [ ] Verify colors apply from data.color property
  - [ ] Update legend to show formatted amounts
  - [ ] Add hover tooltip with percentage

- [ ] Task 9: Update Top Customers Table (AC: 3, 17)
  - [ ] Update table data: `topCustomers.map(...)`
  - [ ] Format revenue column: `formatCurrency(customer.revenue)`
  - [ ] Format growth column:
    ```typescript
    <span className={getTrendColor(customer.growth)}>
      {getTrendIcon(customer.growth)}
      {Math.abs(customer.growth).toFixed(1)}%
    </span>
    ```
  - [ ] Verify sorting (backend handles, but double-check)

- [ ] Task 10: Handle Empty Data States (AC: 12, 13, 14)
  - [ ] Update empty state check: `const isEmpty = revenueData.length === 0`
  - [ ] Update empty state message (line ~485):
    ```typescript
    <p className="text-muted-foreground">
      {timeRange === 'all'
        ? 'No paid invoices found in the system. Revenue data will appear after customers complete payments.'
        : 'No paid invoices found for the selected time range. Try adjusting your filters.'}
    </p>
    ```
  - [ ] Verify charts don't crash with empty data
  - [ ] Add fallback values: `revenueData.length > 0 ? <LineChart ... /> : <EmptyChart />`

- [ ] Task 11: Implement GroupBy Logic (AC: 21)
  - [ ] Add helper function: `getGroupByForTimeRange(range: string)`
  - [ ] Map timeRange to groupBy:
    ```typescript
    const getGroupByForTimeRange = (range: string): 'day' | 'week' | 'month' => {
      switch (range) {
        case 'week':
        case 'month':
          return 'day';
        case 'quarter':
          return 'week';
        case 'year':
        case 'all':
          return 'month';
        default:
          return 'day';
      }
    };
    ```
  - [ ] Use in TanStack Query: `groupBy: getGroupByForTimeRange(timeRange)`

- [ ] Task 12: Format Large Numbers (AC: 20) [Optional]
  - [ ] Add helper: `formatLargeNumber(value: number)`
  - [ ] If value > 1,000,000 → show "€1.2M"
  - [ ] If value > 1,000 → show "€12.3k"
  - [ ] Otherwise → show full amount
  - [ ] Apply to Y-axis labels only (not tooltips/cards)

- [ ] Task 13: Test Chart Rendering (AC: 1, 2, 3, 4)
  - [ ] Navigate to /admin/reports with seed data
  - [ ] Verify LineChart renders with proper labels
  - [ ] Verify PieChart renders with colors
  - [ ] Verify Table sorts correctly
  - [ ] Verify all metric cards show formatted values
  - [ ] Change time range → verify charts update
  - [ ] Check for console errors

- [ ] Task 14: Test Edge Cases (AC: 16, 17, 18, 19)
  - [ ] Test with single data point:
    - Clear all but 1 invoice
    - Verify chart renders (doesn't crash)
  - [ ] Test with zero-revenue month:
    - Verify shows €0 on chart (not gap)
  - [ ] Test with negative growth:
    - Verify red color + down arrow
  - [ ] Test with very large numbers:
    - Create invoice with amount: 999999
    - Verify formatting (€999,999.00 or €1.0M)

- [ ] Task 15: Test PDF Export (AC: 23, 24)
  - [ ] Click "Export PDF" button
  - [ ] Verify PDF generates (shows "Generating..." then downloads)
  - [ ] Open PDF → verify contains real data (not mock)
  - [ ] Verify includes current time range in PDF
  - [ ] Note: Actual PDF generation may use existing mock data (acceptable for V1)

- [ ] Task 16: Currency Formatting Audit (AC: 5, 6, 7)
  - [ ] Search codebase for all revenue displays
  - [ ] Ensure all use formatCurrency() helper
  - [ ] Verify consistent formatting across:
    - Metric cards (4 cards)
    - Tooltip in LineChart
    - Tooltip in PieChart
    - Table cells (revenue column)
    - Legend values
  - [ ] Check for hardcoded "$" symbols (replace with "€")

## Testing Validation

```bash
# Prerequisites
cd backend
npm run db:seed:revenue  # Story 13.0
npm run dev              # Story 13.1

cd frontend
npm run dev              # Story 13.2

# Manual Testing Checklist:

# 1. Chart Rendering
- [ ] Navigate to http://localhost:5173/admin/reports
- [ ] Verify LineChart displays with proper line
- [ ] Verify X-axis shows month names (Jan, Feb, Mar...)
- [ ] Verify Y-axis shows EUR amounts (€0, €5k, €10k...)
- [ ] Hover over line → verify tooltip shows EUR amounts
- [ ] Verify PieChart displays with 2 slices (subscriptions/credits)
- [ ] Verify colors match theme (cyan/pink)
- [ ] Hover over slice → verify tooltip shows percentage
- [ ] Verify Table shows 5 rows (top customers)
- [ ] Verify revenue column formatted as EUR
- [ ] Verify growth column shows % with arrow icon

# 2. Metric Cards
- [ ] Verify "Total Revenue" card shows EUR amount with comma
- [ ] Verify growth percentage shows with green up arrow (if positive)
- [ ] Verify "Monthly Avg" card shows EUR amount
- [ ] Verify "Active Customers" card shows number
- [ ] Verify all cards have proper formatting

# 3. Time Range Changes
- [ ] Change from "This Month" to "This Quarter"
- [ ] Verify all charts update (loading spinner shows briefly)
- [ ] Verify X-axis labels change (daily → weekly)
- [ ] Verify metric cards update with new values
- [ ] Change to "All Time"
- [ ] Verify X-axis shows monthly grouping

# 4. Empty Data State
- [ ] Run SQL: UPDATE "Invoice" SET status='DRAFT' WHERE status='PAID';
- [ ] Refresh page
- [ ] Verify "No revenue data available" message shows
- [ ] Verify charts don't crash (empty state renders)
- [ ] Re-run seed script to restore data

# 5. Edge Cases
- [ ] Create invoice with amount 999999.99
- [ ] Verify formats as €999,999.99 (or €1.0M with optional formatting)
- [ ] Create invoice with negative growth organization
- [ ] Verify shows red down arrow
- [ ] Delete all but 1 invoice
- [ ] Verify single-point chart renders correctly

# 6. PDF Export (Basic Test)
- [ ] Click "Export PDF" button
- [ ] Verify button shows "Generating..." state
- [ ] Verify file downloads after 2 seconds
- [ ] Note: PDF may still use mock data (acceptable for V1)

# 7. Console Check
- [ ] Open browser DevTools → Console tab
- [ ] Verify no errors during page load
- [ ] Verify no errors when changing time range
- [ ] Verify no errors when hovering charts
```

## Dev Notes

**Primary File**: `frontend/src/pages/admin/RevenueReports.tsx`
- Main work: Lines 85-180 (metric cards), 197-343 (charts)
- Pattern: Use React.useMemo for transformations (avoid recalculation on every render)
- Pattern: Use helper functions (formatCurrency, getTrendIcon, etc.)

**Currency Formatting**:
```typescript
const formatCurrency = (amount: number): string => {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'EUR',
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  }).format(amount);
};

// Result: €12,345.67
```

**Date Formatting for Charts**:
```typescript
const formatDateForChart = (dateString: string, groupBy: string): string => {
  const date = new Date(dateString);

  if (groupBy === 'day') {
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    // "Jan 15"
  } else if (groupBy === 'week') {
    const weekNum = getWeekNumber(date);
    return `Week ${weekNum}`;
    // "Week 3"
  } else {
    return date.toLocaleDateString('en-US', { month: 'short' });
    // "Jan"
  }
};
```

**Growth Calculation**:
```typescript
// Already calculated by backend, just display
// If implementing frontend calculation:
const calculateGrowth = (current: number, previous: number): number => {
  if (previous === 0) return current > 0 ? 100 : 0;
  return ((current - previous) / previous) * 100;
};
```

**Recharts Data Structure**:
```typescript
// LineChart expects:
[
  { month: 'Jan', revenue: 12500, subscriptions: 8500, credits: 4000 },
  { month: 'Feb', revenue: 15200, subscriptions: 9200, credits: 6000 },
  ...
]

// PieChart expects:
[
  { name: 'Subscriptions', value: 45000, color: '#F345B8' },
  { name: 'Credit Purchases', value: 25000, color: '#3BE2E9' },
]
```

**Performance Tips**:
- Use React.useMemo for transformations (prevents recalculation)
- Keep transformations simple (map/filter only, no complex logic)
- Recharts handles large datasets well (1000+ points)
- TanStack Query caching prevents redundant API calls

## Related Files
- `frontend/src/pages/admin/RevenueReports.tsx` - Main transformation work
- `frontend/src/components/ui/badge.tsx` - Growth indicators (already exists)
- Chart components from `recharts` library (already imported)

## Dependencies
- Story 13.0 complete (seed data)
- Story 13.1 complete (backend API)
- Story 13.2 complete (frontend API integration)
- Recharts library (already installed)

## Estimated Effort
**Story Points**: 5
**Time Estimate**: 4-6 hours

## Definition of Done
- [ ] All tasks completed and checked off
- [ ] All acceptance criteria verified
- [ ] All charts render correctly with real data
- [ ] All currency values formatted as EUR (€)
- [ ] Growth indicators show correct colors/arrows
- [ ] Empty data state displays correctly
- [ ] Time range changes update charts
- [ ] Edge cases handled (zero revenue, negative growth, single point)
- [ ] No console errors during normal usage
- [ ] PDF export works (basic functionality)
- [ ] Currency formatting consistent across all components
- [ ] Code follows React best practices (useMemo, helper functions)
- [ ] Ready for production deployment

## Post-Story Cleanup
- [ ] Remove any commented-out mock data
- [ ] Remove unused imports
- [ ] Run ESLint and fix any warnings
- [ ] Verify TypeScript compilation (no errors)
- [ ] Update CLAUDE.md if needed (document new patterns)
