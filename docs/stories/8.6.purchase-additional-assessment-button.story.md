# Story 8.6: Add Purchase Additional Assessment Button to Dashboard

## Status
Draft

## Story
**As a** Premium user,
**I want** to purchase additional assessments,
**so that** I can exceed my monthly allocation when needed.

## Acceptance Criteria
1. New component created: `frontend/src/components/PurchaseAssessmentButton.tsx`
2. Component displayed on Dashboard for PREMIUM users
3. Button shows: "Purchase Additional Assessment - €299"
4. On click:
   - Open confirmation modal with:
     - Message: "Purchase 1 additional assessment for €299?"
     - Shows current credit balance
     - Shows new balance after purchase (+50 credits)
     - "Confirm Purchase" button
     - "Cancel" button
5. On confirm:
   - Call API: `POST /v1/subscriptions/:userId/purchase-assessment`
   - Show loading state during API call
   - On success: Show success toast, refresh credit balance
   - On error: Show error message
6. Component hidden for FREE (show upgrade prompt) and ENTERPRISE users (unlimited)
7. Disable button if user has insufficient Stripe payment method on file

## Tasks / Subtasks

- [ ] **Task 1: Create PurchaseAssessmentButton Component** (AC: 1, 3)
  - [ ] Create file: `frontend/src/components/PurchaseAssessmentButton.tsx`
  - [ ] Import dependencies:
    ```typescript
    import { useState } from 'react';
    import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';
    import { Button } from '@/components/ui/button';
    import { ShoppingCart, Plus } from 'lucide-react';
    import { toast } from '@/hooks/use-toast';
    ```

- [ ] **Task 2: Create Confirmation Modal Component** (AC: 4)
  - [ ] Add modal component:
    ```typescript
    import {
      Dialog,
      DialogContent,
      DialogDescription,
      DialogFooter,
      DialogHeader,
      DialogTitle,
    } from '@/components/ui/dialog';

    interface PurchaseConfirmationModalProps {
      isOpen: boolean;
      onClose: () => void;
      currentBalance: number;
      onConfirm: () => void;
      isLoading: boolean;
    }

    const PurchaseConfirmationModal = ({
      isOpen,
      onClose,
      currentBalance,
      onConfirm,
      isLoading,
    }: PurchaseConfirmationModalProps) => {
      const CREDITS_PER_PURCHASE = 50;
      const newBalance = currentBalance + CREDITS_PER_PURCHASE;

      return (
        <Dialog open={isOpen} onOpenChange={onClose}>
          <DialogContent className="sm:max-w-md">
            <DialogHeader>
              <DialogTitle>Purchase Additional Assessment</DialogTitle>
              <DialogDescription>
                Confirm your purchase to add credits to your account
              </DialogDescription>
            </DialogHeader>

            <div className="space-y-4 my-4">
              <div className="bg-muted rounded-lg p-4">
                <div className="flex justify-between items-center mb-2">
                  <span className="text-sm text-muted-foreground">Price</span>
                  <span className="font-semibold">€299</span>
                </div>
                <div className="flex justify-between items-center mb-2">
                  <span className="text-sm text-muted-foreground">Credits</span>
                  <span className="font-semibold">+50 credits</span>
                </div>
                <div className="flex justify-between items-center pt-2 border-t">
                  <span className="text-sm text-muted-foreground">Current Balance</span>
                  <span>{currentBalance} credits</span>
                </div>
                <div className="flex justify-between items-center font-semibold">
                  <span>New Balance</span>
                  <span className="text-primary">{newBalance} credits</span>
                </div>
              </div>

              <p className="text-sm text-muted-foreground">
                This will charge your payment method on file €299 and add 50 credits to your account.
              </p>
            </div>

            <DialogFooter className="flex-col sm:flex-row gap-2">
              <Button variant="outline" onClick={onClose} disabled={isLoading}>
                Cancel
              </Button>
              <Button onClick={onConfirm} disabled={isLoading}>
                {isLoading ? 'Processing...' : 'Confirm Purchase - €299'}
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      );
    };
    ```

- [ ] **Task 3: Implement Purchase Logic** (AC: 5)
  - [ ] Add API mutation:
    ```typescript
    const queryClient = useQueryClient();

    const purchaseMutation = useMutation({
      mutationFn: async () => {
        const userId = getCurrentUserId();
        const response = await fetch(`/v1/subscriptions/${userId}/purchase-assessment`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${localStorage.getItem('token')}`,
          },
          body: JSON.stringify({
            stripePriceId: 'price_additional_assessment',  // Mock for now
          }),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Purchase failed');
        }

        return response.json();
      },
      onSuccess: (data) => {
        toast({
          title: 'Purchase Successful',
          description: `${data.data.creditsAdded} credits added to your account.`,
        });

        // Refresh credit balance
        queryClient.invalidateQueries({ queryKey: ['subscription', 'billing-info'] });

        setShowModal(false);
      },
      onError: (error: Error) => {
        toast({
          title: 'Purchase Failed',
          description: error.message,
          variant: 'destructive',
        });
      },
    });
    ```

- [ ] **Task 4: Create Main Button Component** (AC: 2, 3)
  - [ ] Add main component:
    ```typescript
    export const PurchaseAssessmentButton = () => {
      const [showModal, setShowModal] = useState(false);

      const { data: billingInfo } = useQuery({
        queryKey: ['subscription', 'billing-info'],
        queryFn: getBillingInfo,
      });

      const currentBalance = billingInfo?.data?.creditsBalance || 0;

      return (
        <>
          <Button
            onClick={() => setShowModal(true)}
            variant="outline"
            className="w-full sm:w-auto"
          >
            <Plus className="h-4 w-4 mr-2" />
            Purchase Additional Assessment - €299
          </Button>

          <PurchaseConfirmationModal
            isOpen={showModal}
            onClose={() => setShowModal(false)}
            currentBalance={currentBalance}
            onConfirm={() => purchaseMutation.mutate()}
            isLoading={purchaseMutation.isPending}
          />
        </>
      );
    };
    ```

- [ ] **Task 5: Integrate into Dashboard** (AC: 2, 6)
  - [ ] Open dashboard page (e.g., `frontend/src/pages/Index.tsx` or `Dashboard.tsx`)
  - [ ] Add conditional rendering:
    ```typescript
    import { PurchaseAssessmentButton } from '@/components/PurchaseAssessmentButton';

    const { data: billingInfo } = useQuery({
      queryKey: ['subscription', 'billing-info'],
      queryFn: getBillingInfo,
    });

    const plan = billingInfo?.data?.plan;

    // Show button only for PREMIUM users
    {plan === 'PREMIUM' && (
      <div className="mb-6">
        <h3 className="text-lg font-semibold mb-2">Need More Assessments?</h3>
        <p className="text-sm text-muted-foreground mb-4">
          Purchase additional assessments at any time.
        </p>
        <PurchaseAssessmentButton />
      </div>
    )}

    // Show upgrade prompt for FREE users
    {plan === 'FREE' && (
      <UpgradePrompt
        title="Unlock Additional Assessments"
        description="Upgrade to Premium to purchase additional assessments"
        features={['2 assessments per month', 'Purchase more at €299 each']}
        onUpgrade={() => navigate('/pricing')}
      />
    )}

    // Hide for ENTERPRISE users (unlimited)
    ```

- [ ] **Task 6: Add Payment Method Check** (AC: 7)
  - [ ] Check for payment method:
    ```typescript
    const hasPaymentMethod = billingInfo?.data?.stripePaymentMethodId != null;

    <Button
      onClick={() => setShowModal(true)}
      disabled={!hasPaymentMethod}
    >
      {hasPaymentMethod
        ? 'Purchase Additional Assessment - €299'
        : 'Add Payment Method to Purchase'}
    </Button>

    {!hasPaymentMethod && (
      <p className="text-sm text-muted-foreground mt-2">
        Please add a payment method to your account before purchasing.
      </p>
    )}
    ```

- [ ] **Task 7: Add Success State** (AC: 5)
  - [ ] Show success animation/message after purchase
  - [ ] Update credit balance display immediately
  - [ ] Confetti animation (optional enhancement)

- [ ] **Task 8: Add Error Handling** (AC: 5)
  - [ ] Handle insufficient funds
  - [ ] Handle payment method errors
  - [ ] Handle network errors
  - [ ] Display user-friendly error messages

- [ ] **Task 9: Test Purchase Flow** (AC: 4, 5)
  - [ ] Test modal opens correctly
  - [ ] Test balance calculation displayed
  - [ ] Test confirm button triggers API call
  - [ ] Test loading state during purchase
  - [ ] Test success toast appears
  - [ ] Test credit balance updates
  - [ ] Test error handling

## Dev Notes

### Purchase Flow

**Step 1: Click Button**
```
[Purchase Additional Assessment - €299]
```

**Step 2: Confirmation Modal**
```
┌──────────────────────────────────┐
│ Purchase Additional Assessment   │
│                                  │
│ ┌──────────────────────────────┐ │
│ │ Price:          €299         │ │
│ │ Credits:        +50 credits  │ │
│ │ ──────────────────────────── │ │
│ │ Current Balance: 25 credits  │ │
│ │ New Balance:     75 credits  │ │
│ └──────────────────────────────┘ │
│                                  │
│ This will charge €299...         │
│                                  │
│ [Cancel]  [Confirm Purchase]     │
└──────────────────────────────────┘
```

**Step 3: Success**
```
✓ Purchase Successful
  50 credits added to your account.

Credit Balance: 75 credits
```

[Source: docs/prd/epic-8-frontend-integration.md#Story 4.6]

---

### Pricing

**Additional Assessment Price:** €299
**Credits Granted:** 50 credits
**Sufficient for:** 1 complete assessment (assessments cost 50 credits each)

[Source: docs/stories/6.3.purchase-additional-assessment.story.md, docs/stories/7.5.purchase-additional-assessment.story.md]

---

### API Integration

**Endpoint:** POST /v1/subscriptions/:userId/purchase-assessment

**Request:**
```json
{
  "stripePriceId": "price_additional_assessment"
}
```

**Response (Success):**
```json
{
  "success": true,
  "data": {
    "success": true,
    "creditsAdded": 50
  }
}
```

**Response (Error):**
```json
{
  "success": false,
  "message": "Payment method required",
  "code": "PAYMENT_METHOD_MISSING"
}
```

[Source: docs/stories/7.5.purchase-additional-assessment.story.md]

---

### User Visibility

**Show Button:**
- PREMIUM users with payment method

**Show Disabled Button:**
- PREMIUM users without payment method

**Show Upgrade Prompt:**
- FREE users

**Hide Completely:**
- ENTERPRISE users (unlimited assessments)

[Source: docs/V4_REVISED_PAY_GATING_PLAN.md]

---

### Testing Checklist

- [ ] PREMIUM user sees purchase button
- [ ] FREE user sees upgrade prompt
- [ ] ENTERPRISE user doesn't see button
- [ ] Modal shows correct balance calculation
- [ ] Confirm button triggers API call
- [ ] Loading state shown during purchase
- [ ] Success toast appears on successful purchase
- [ ] Credit balance updates immediately
- [ ] Error message shown on failure
- [ ] Button disabled without payment method
- [ ] Cancel button closes modal

[Source: Frontend testing best practices]

---

### File Locations
- **Component:** `frontend/src/components/PurchaseAssessmentButton.tsx` (new)
- **Dashboard:** `frontend/src/pages/Index.tsx` or `Dashboard.tsx` (modify)

---

### Dependencies
**Depends On:**
- Story 7.5: POST purchase-assessment endpoint
- Story 7.6: GET billing info endpoint
- Existing: Dialog, Button UI components

**Depended On By:**
- Future: Real Stripe payment integration (Story 9.x)

---

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from Epic 8 | Bob (Scrum Master) |

---

## Dev Agent Record
_This section will be populated by the development agent during implementation_

### Agent Model Used
_TBD_

### Debug Log References
_TBD_

### Completion Notes
_TBD_

### File List
_TBD_

---

## QA Results
_This section will be populated by the QA agent after story completion_
