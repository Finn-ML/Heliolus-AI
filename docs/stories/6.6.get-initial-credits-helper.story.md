# Story 6.6: Add Get Initial Credits Helper

## Status
Ready for Review

## Story
**As a** subscription service,
**I want** standardized credit allocation on subscription creation,
**so that** new subscriptions get correct starting balance.

## Acceptance Criteria
1. Private method `getInitialCredits(plan: SubscriptionPlan)` created in `SubscriptionService`
2. Method returns credits based on plan:
   - FREE: 0 credits
   - PREMIUM: 100 credits
   - ENTERPRISE: 0 credits
3. Method used by `createSubscription` to set initial `creditsBalance`
4. Credits sufficient for Premium users to complete ~2 assessments
5. Enterprise gets 0 because admin grants credits manually

## Tasks / Subtasks

- [ ] **Task 1: Create getInitialCredits Helper Method** (AC: 1, 2)
  - [ ] Open `backend/src/services/subscription.service.ts`
  - [ ] Add private helper method after createSubscription (around line 300):
    ```typescript
    /**
     * Get initial credit allocation for a subscription plan
     * Private helper method for createSubscription
     *
     * @param plan - Subscription plan
     * @returns Initial credits for the plan
     */
    private getInitialCredits(plan: SubscriptionPlan): number {
      return CREDIT_ALLOCATION[plan];
    }
    ```

- [ ] **Task 2: Update createSubscription to Use Helper** (AC: 3)
  - [ ] Find line 251 (creditsBalance assignment)
  - [ ] Replace direct CREDIT_ALLOCATION access with helper call:
    ```typescript
    // OLD (Story 6.2 implementation):
    creditsBalance: CREDIT_ALLOCATION[validatedData.plan],

    // NEW:
    creditsBalance: this.getInitialCredits(validatedData.plan),
    ```

- [ ] **Task 3: Update Initial Credit Transaction** (AC: 3)
  - [ ] Find line 261 (initial credit transaction)
  - [ ] Use helper method:
    ```typescript
    // Create initial credit transaction for paid plans
    const initialCredits = this.getInitialCredits(validatedData.plan);
    if (initialCredits > 0) {
      await this.prisma.creditTransaction.create({
        data: {
          subscriptionId: subscription.id,
          type: TransactionType.SUBSCRIPTION_RENEWAL,
          amount: initialCredits,
          balance: initialCredits,
          description: `Initial credits for ${validatedData.plan} plan`,
        },
      });
    }
    ```

- [ ] **Task 4: Add JSDoc Documentation** (AC: 4, 5)
  - [ ] Add detailed documentation:
    ```typescript
    /**
     * Get initial credit allocation for a subscription plan
     *
     * Credit allocation strategy:
     * - FREE: 0 credits (limited to 2 assessments total via quota)
     * - PREMIUM: 100 credits (sufficient for ~2 assessments at 50 credits each)
     * - ENTERPRISE: 0 credits (admin grants manually via AdminCreditService)
     *
     * @param plan - Subscription plan (FREE, PREMIUM, or ENTERPRISE)
     * @returns Number of credits to allocate on subscription creation
     *
     * @see CREDIT_ALLOCATION for credit allocation constants
     * @see Story 6.1 for pricing and credit definitions
     * @see Story 5.5 for AdminCreditService (Enterprise credit grants)
     */
    private getInitialCredits(plan: SubscriptionPlan): number {
      return CREDIT_ALLOCATION[plan];
    }
    ```

- [ ] **Task 5: Write Unit Tests** (AC: 1-5)
  - [ ] Test file: `backend/tests/unit/get-initial-credits.test.ts`
  - [ ] Test FREE returns 0 credits
  - [ ] Test PREMIUM returns 100 credits
  - [ ] Test ENTERPRISE returns 0 credits
  - [ ] Test invalid plan throws error (if applicable)
  - [ ] Run tests: `npm test`

- [ ] **Task 6: Verify createSubscription Integration** (AC: 3)
  - [ ] Run existing createSubscription tests (from Story 6.2)
  - [ ] Verify credits still allocated correctly
  - [ ] Verify no breaking changes

## Dev Notes

### Helper Method Purpose

**Why Create Helper:**
1. **Encapsulation**: Centralize credit allocation logic
2. **Testability**: Easy to unit test in isolation
3. **Readability**: Self-documenting method name
4. **Maintainability**: Single place to update credit allocation rules

**Current Implementation (Story 6.2):**
```typescript
// Direct access to CREDIT_ALLOCATION
creditsBalance: CREDIT_ALLOCATION[validatedData.plan],
```

**New Implementation (Story 6.6):**
```typescript
// Helper method call
creditsBalance: this.getInitialCredits(validatedData.plan),
```

**Benefits:**
- Clearer intent
- Easier to add validation logic later
- Consistent with other helper methods in service

[Source: Epic 6 - Billing Services]

---

### Credit Allocation Strategy

**FREE Tier:**
- Initial credits: 0
- Rationale:
  - Limited to 2 assessments LIFETIME (not per month)
  - Tracked via `UserAssessmentQuota.totalAssessmentsCreated`
  - No credit system needed for FREE users
- Upgrade path: Must upgrade to Premium for more assessments

**PREMIUM Tier:**
- Initial credits: 100
- Rationale:
  - Sufficient for ~2 assessments (50 credits each)
  - Allows immediate value after signup
  - Monthly renewal adds 100 more credits (if on monthly plan)
  - Can purchase additional credits at €299 = 50 credits
- Usage: Credits deducted on assessment completion

**ENTERPRISE Tier:**
- Initial credits: 0
- Rationale:
  - Custom contract with specific credit allocation
  - Admin manually grants credits via AdminCreditService
  - Prevents automatic allocation before contract finalized
  - Flexible based on agreement
- Management: Admins use `/admin/credits/grant` endpoint

[Source: docs/V4_REVISED_PAY_GATING_PLAN.md#Credit System]

---

### Integration with createSubscription

**Call Chain:**
1. User calls `/v1/subscription/create` with plan: PREMIUM
2. SubscriptionService.createSubscription() invoked
3. getInitialCredits(PREMIUM) called → returns 100
4. Subscription created with creditsBalance: 100
5. CreditTransaction created with amount: 100

**Example Flow:**
```typescript
// User requests Premium subscription
const response = await subscriptionService.createSubscription(userId, {
  plan: SubscriptionPlan.PREMIUM,
  billingCycle: 'MONTHLY',
});

// Inside createSubscription:
const initialCredits = this.getInitialCredits(SubscriptionPlan.PREMIUM);
// Returns: 100

// Subscription created:
{
  plan: 'PREMIUM',
  creditsBalance: 100,  // From getInitialCredits
  creditsPurchased: 100,
  creditsUsed: 0,
}
```

[Source: Story 6.2 - Update createSubscription]

---

### Future Enhancements (Not This Story)

**Potential Improvements:**
1. **Tiered Credits**: Different credit amounts for different Premium plans
   ```typescript
   private getInitialCredits(plan: SubscriptionPlan, tier?: 'basic' | 'pro'): number {
     if (plan === SubscriptionPlan.PREMIUM) {
       return tier === 'pro' ? 200 : 100;
     }
     return CREDIT_ALLOCATION[plan];
   }
   ```

2. **Promotional Credits**: Bonus credits for first-time users
   ```typescript
   private getInitialCredits(plan: SubscriptionPlan, isNewUser?: boolean): number {
     const baseCredits = CREDIT_ALLOCATION[plan];
     const bonusCredits = isNewUser ? 50 : 0;
     return baseCredits + bonusCredits;
   }
   ```

3. **Regional Pricing**: Different credit amounts per region
   ```typescript
   private getInitialCredits(plan: SubscriptionPlan, region?: string): number {
     const baseCredits = CREDIT_ALLOCATION[plan];
     const regionalMultiplier = REGIONAL_MULTIPLIERS[region] || 1;
     return baseCredits * regionalMultiplier;
   }
   ```

**Not Implementing Now:**
- Keep simple for MVP
- Can extend later if business requirements change
- Current helper method structure supports easy enhancement

[Source: Future roadmap considerations]

---

### Testing Standards

**Test Framework:** Vitest 3
**Test Location:** `backend/tests/unit/get-initial-credits.test.ts`

**Test Pattern:**
```typescript
import { describe, it, expect } from 'vitest';
import { SubscriptionService } from '../src/services/subscription.service';
import { SubscriptionPlan } from '../src/generated/prisma';

describe('getInitialCredits Helper', () => {
  let service: SubscriptionService;

  beforeAll(() => {
    service = new SubscriptionService();
  });

  describe('Credit allocation per plan', () => {
    it('should return 0 credits for FREE plan', () => {
      // Access private method via reflection for testing
      const initialCredits = (service as any).getInitialCredits(
        SubscriptionPlan.FREE
      );

      expect(initialCredits).toBe(0);
    });

    it('should return 100 credits for PREMIUM plan', () => {
      const initialCredits = (service as any).getInitialCredits(
        SubscriptionPlan.PREMIUM
      );

      expect(initialCredits).toBe(100);
    });

    it('should return 0 credits for ENTERPRISE plan', () => {
      const initialCredits = (service as any).getInitialCredits(
        SubscriptionPlan.ENTERPRISE
      );

      expect(initialCredits).toBe(0);
    });
  });

  describe('Integration with CREDIT_ALLOCATION', () => {
    it('should match CREDIT_ALLOCATION constants', () => {
      // Verify helper returns same values as direct constant access
      const plans = [
        SubscriptionPlan.FREE,
        SubscriptionPlan.PREMIUM,
        SubscriptionPlan.ENTERPRISE,
      ];

      plans.forEach((plan) => {
        const helperResult = (service as any).getInitialCredits(plan);
        const constantResult = CREDIT_ALLOCATION[plan];

        expect(helperResult).toBe(constantResult);
      });
    });
  });

  describe('createSubscription integration', () => {
    it('should allocate correct credits when creating PREMIUM subscription', async () => {
      const testUser = await prisma.user.create({
        data: {
          email: 'credit-test@example.com',
          firstName: 'Credit',
          lastName: 'Test',
          password: 'hashed',
        },
      });

      const response = await service.createSubscription(testUser.id, {
        plan: SubscriptionPlan.PREMIUM,
        billingCycle: 'MONTHLY',
      });

      expect(response.success).toBe(true);
      expect(response.data.creditsBalance).toBe(100);

      // Cleanup
      await prisma.user.delete({ where: { id: testUser.id } });
    });

    it('should allocate 0 credits when creating FREE subscription', async () => {
      const testUser = await prisma.user.create({
        data: {
          email: 'free-credit-test@example.com',
          firstName: 'Free',
          lastName: 'Test',
          password: 'hashed',
        },
      });

      const response = await service.createSubscription(testUser.id, {
        plan: SubscriptionPlan.FREE,
      });

      expect(response.success).toBe(true);
      expect(response.data.creditsBalance).toBe(0);

      // Cleanup
      await prisma.user.delete({ where: { id: testUser.id } });
    });
  });
});
```

**Note on Testing Private Methods:**
- TypeScript private methods can be accessed via `(service as any).methodName()`
- This is acceptable for unit testing
- Alternatively, test through public methods (createSubscription)

[Source: architecture.md#Testing Strategy]

---

### Comparison with Direct Constant Access

**Without Helper (Story 6.2):**
```typescript
// Line 251 in createSubscription
const subscription = await this.prisma.subscription.create({
  data: {
    creditsBalance: CREDIT_ALLOCATION[validatedData.plan],
    // ...
  },
});
```

**With Helper (Story 6.6):**
```typescript
// Line 251 in createSubscription
const initialCredits = this.getInitialCredits(validatedData.plan);
const subscription = await this.prisma.subscription.create({
  data: {
    creditsBalance: initialCredits,
    // ...
  },
});
```

**Advantages:**
1. **Clarity**: Method name explains intent
2. **Flexibility**: Can add logic later without changing callers
3. **Testing**: Easier to mock/stub in tests
4. **Consistency**: Matches pattern of other helper methods

**Disadvantage:**
- One extra function call (negligible performance impact)

**Decision:** Use helper for maintainability benefits

[Source: Clean Code principles]

---

### File Locations
- **Service:** `backend/src/services/subscription.service.ts`
- **Method:** `getInitialCredits()` (private helper, insert after line 300)
- **Usage:** Line 251 (creditsBalance in createSubscription)
- **Test:** `backend/tests/unit/get-initial-credits.test.ts`

---

### Dependencies
**Depends On:**
- Story 6.1: CREDIT_ALLOCATION constants
- Story 6.2: createSubscription method
- Existing: SubscriptionPlan enum

**Depended On By:**
- Future: Any new subscription creation flows
- Future: Credit allocation policy changes

---

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from Epic 6 | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used
Claude Code (Sonnet 4.5) - Development Agent

### Completion Notes
**Implementation Date**: 2025-10-24

**Changes Made:**
1. ✅ Created private getInitialCredits() helper method
   - Encapsulates credit allocation logic
   - Returns credits based on CREDIT_ALLOCATION constant
   - Comprehensive JSDoc documentation with rationale

2. ✅ Updated createSubscription to use helper:
   - Replaced direct CREDIT_ALLOCATION access with this.getInitialCredits()
   - Updated creditsBalance initialization
   - Updated creditsPurchased initialization
   - Updated initial credit transaction logic

3. ✅ Benefits of refactor:
   - **Clarity**: Method name explains intent
   - **Encapsulation**: Centralized credit allocation logic
   - **Testability**: Easy to unit test in isolation
   - **Maintainability**: Single place to update credit rules
   - **Flexibility**: Can add promotional bonuses, regional adjustments later

**Credit Allocation Strategy:**
- FREE: 0 credits (limited to 2 assessments via quota)
- PREMIUM: 100 credits (sufficient for ~2 assessments)
- ENTERPRISE: 0 credits (admin grants manually via AdminCreditService)

**All Acceptance Criteria Met:**
- [x] AC1: Private getInitialCredits() method created
- [x] AC2: Returns correct credits (FREE: 0, PREMIUM: 100, ENTERPRISE: 0)
- [x] AC3: Used by createSubscription for creditsBalance
- [x] AC4: Credits sufficient for Premium users (~2 assessments)
- [x] AC5: Enterprise gets 0 for manual admin grants

**Testing:**
- 11 test suites covering all functionality
- Tests for each plan type
- Consistency tests with CREDIT_ALLOCATION
- Type safety tests
- Integration tests
- Encapsulation benefit tests

### File List
**Modified:**
- `backend/src/services/subscription.service.ts`
  - Lines 534-551: Added getInitialCredits() private helper
  - Line 343: Updated creditsBalance to use helper
  - Line 346: Updated creditsPurchased to use helper
  - Line 356: Updated initial credit transaction to use helper

**Created:**
- `backend/tests/unit/get-initial-credits.test.ts`
  - 11 test suites
  - Full coverage of helper method
  - Integration tests with credit system

---

## QA Results
_This section will be populated by the QA agent after story completion_
