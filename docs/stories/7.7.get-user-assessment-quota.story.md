# Story 7.7: Create Get User Assessment Quota Endpoint

## Status
Draft

## Story
**As a** frontend application,
**I want** to retrieve user's assessment quota information,
**so that** I can display "X of Y assessments used" warnings.

## Acceptance Criteria
1. New endpoint: `GET /v1/user/assessment-quota`
2. Route protected by: `authMiddleware`
3. No request parameters (uses authenticated user ID)
4. Endpoint queries `UserAssessmentQuota` for authenticated user
5. Success response (200):
   ```json
   {
     "success": true,
     "data": {
       "userId": "...",
       "totalAssessmentsCreated": 2,
       "assessmentsThisMonth": 1,
       "assessmentsUsedThisMonth": 1,
       "plan": "FREE",
       "quotaLimit": 2,
       "quotaRemaining": 0
     }
   }
   ```
6. Response includes calculated fields:
   - `quotaLimit`: 2 for FREE, 2 for PREMIUM per cycle, -1 for ENTERPRISE (unlimited)
   - `quotaRemaining`: limit - used (or -1 if unlimited)
7. Error responses:
   - 401 if unauthenticated
   - 404 if quota record not found

## Tasks / Subtasks

- [ ] **Task 1: Create User Routes File (if doesn't exist)** (AC: 1)
  - [ ] Check if `backend/src/routes/user.routes.ts` exists
  - [ ] If not, create file with basic structure:
    ```typescript
    /**
     * User Routes
     * User-specific endpoints (profile, quota, preferences)
     */

    import { FastifyInstance, FastifyRequest, FastifyReply } from 'fastify';
    import { z } from 'zod';
    import { asyncHandler, authenticationMiddleware } from '../middleware';

    export default async function userRoutes(server: FastifyInstance) {
      // User routes go here
    }
    ```
  - [ ] Register route in `backend/src/server.ts` (if new file):
    ```typescript
    import userRoutes from './routes/user.routes';
    // ...
    server.register(userRoutes, { prefix: '/v1/user' });
    ```

- [ ] **Task 2: Define Response Schema** (AC: 5, 6)
  - [ ] Add Fastify response schema in user.routes.ts:
    ```typescript
    const AssessmentQuotaResponseSchema = {
      200: {
        type: 'object',
        properties: {
          success: { type: 'boolean' },
          data: {
            type: 'object',
            properties: {
              userId: { type: 'string' },
              totalAssessmentsCreated: { type: 'number' },
              assessmentsThisMonth: { type: 'number' },
              assessmentsUsedThisMonth: { type: 'number' },
              plan: { type: 'string', enum: ['FREE', 'PREMIUM', 'ENTERPRISE'] },
              quotaLimit: { type: 'number' },  // -1 for unlimited
              quotaRemaining: { type: 'number' },  // -1 for unlimited
            },
            required: [
              'userId',
              'totalAssessmentsCreated',
              'assessmentsThisMonth',
              'assessmentsUsedThisMonth',
              'plan',
              'quotaLimit',
              'quotaRemaining',
            ],
          },
        },
      },
      401: {
        type: 'object',
        properties: {
          success: { type: 'boolean' },
          message: { type: 'string' },
          code: { type: 'string' },
        },
      },
      404: {
        type: 'object',
        properties: {
          success: { type: 'boolean' },
          message: { type: 'string' },
          code: { type: 'string' },
        },
      },
    };
    ```

- [ ] **Task 3: Create GET /user/assessment-quota Endpoint** (AC: 1, 2, 3)
  - [ ] Add endpoint definition:
    ```typescript
    server.get('/assessment-quota', {
      schema: {
        description: 'Get assessment quota information for authenticated user',
        tags: ['User'],
        response: AssessmentQuotaResponseSchema,
      },
      preHandler: authenticationMiddleware,
    }, asyncHandler(async (request, reply) => {
      // Implementation in next tasks
    }));
    ```

- [ ] **Task 4: Query UserAssessmentQuota and Subscription** (AC: 4)
  - [ ] Get authenticated user ID:
    ```typescript
    const user = (request as any).user ?? (request as any).currentUser;
    const userId = user.id;
    ```
  - [ ] Query quota and subscription (join):
    ```typescript
    const quota = await this.prisma.userAssessmentQuota.findUnique({
      where: { userId },
      include: {
        user: {
          select: {
            subscription: {
              select: {
                plan: true,
              },
            },
          },
        },
      },
    });

    if (!quota) {
      return reply.status(404).send({
        success: false,
        message: 'Assessment quota not found. This should not happen - contact support.',
        code: 'QUOTA_NOT_FOUND',
      });
    }
    ```

- [ ] **Task 5: Calculate Quota Limits and Remaining** (AC: 6)
  - [ ] Calculate based on plan:
    ```typescript
    const plan = quota.user.subscription?.plan || 'FREE';

    // Quota limits by plan
    const QUOTA_LIMITS = {
      FREE: 2,          // 2 total assessments (lifetime limit)
      PREMIUM: 2,       // 2 assessments per billing cycle
      ENTERPRISE: -1,   // Unlimited (-1 indicates unlimited)
    };

    const quotaLimit = QUOTA_LIMITS[plan];

    let quotaRemaining: number;

    if (quotaLimit === -1) {
      // Unlimited
      quotaRemaining = -1;
    } else {
      // Calculate remaining
      if (plan === 'FREE') {
        // FREE: lifetime limit
        quotaRemaining = Math.max(0, quotaLimit - quota.totalAssessmentsCreated);
      } else {
        // PREMIUM: monthly limit
        quotaRemaining = Math.max(0, quotaLimit - quota.assessmentsUsedThisMonth);
      }
    }
    ```

- [ ] **Task 6: Return Quota Response** (AC: 5, 6)
  - [ ] Return quota data with calculated fields:
    ```typescript
    reply.status(200).send({
      success: true,
      data: {
        userId: quota.userId,
        totalAssessmentsCreated: quota.totalAssessmentsCreated,
        assessmentsThisMonth: quota.assessmentsThisMonth,
        assessmentsUsedThisMonth: quota.assessmentsUsedThisMonth,
        plan,
        quotaLimit,
        quotaRemaining,
      },
    });
    ```

- [ ] **Task 7: Add Error Handling** (AC: 7)
  - [ ] Wrap handler in try-catch:
    ```typescript
    try {
      // Main logic
    } catch (error: any) {
      request.log.error({ error, userId: user?.id }, 'Failed to get assessment quota');

      if (error.code === 'QUOTA_NOT_FOUND') {
        return reply.status(404).send({
          success: false,
          message: error.message || 'Assessment quota not found',
          code: 'QUOTA_NOT_FOUND',
        });
      }

      throw error;
    }
    ```

- [ ] **Task 8: Add JSDoc Documentation** (AC: 1, 6)
  - [ ] Add comment above endpoint:
    ```typescript
    /**
     * Get Assessment Quota Information
     *
     * GET /v1/user/assessment-quota
     *
     * Returns assessment quota information for the authenticated user.
     * Includes usage counts and calculated quota limits/remaining.
     *
     * Quota Rules:
     * - FREE: 2 total assessments (lifetime limit)
     * - PREMIUM: 2 assessments per billing cycle (resets monthly/annually)
     * - ENTERPRISE: Unlimited assessments (quotaLimit and quotaRemaining = -1)
     *
     * Frontend uses this to display:
     * - "You've used X of Y assessments"
     * - Progress bars showing quota usage
     * - Warnings when quota nearly exhausted
     * - Upgrade prompts when quota exceeded
     *
     * @returns Quota information with calculated limits
     *
     * @see Story 5.2 - UserAssessmentQuota model
     * @see Story 5.6 - AssessmentService quota checks
     * @see Story 8.x - Frontend quota warning UI
     */
    ```

- [ ] **Task 9: Write Integration Test** (AC: 1-7)
  - [ ] Create test file: `backend/tests/integration/assessment-quota-endpoint.test.ts`
  - [ ] Test FREE user quota (limit 2, lifetime)
  - [ ] Test PREMIUM user quota (limit 2, per cycle)
  - [ ] Test ENTERPRISE user quota (unlimited, -1)
  - [ ] Test quotaRemaining calculation (FREE: 2 created, 0 remaining)
  - [ ] Test quotaRemaining calculation (PREMIUM: 1 used this month, 1 remaining)
  - [ ] Test missing quota record gets 404
  - [ ] Test unauthenticated request gets 401
  - [ ] Run tests: `npm test`

- [ ] **Task 10: Update OpenAPI/Swagger Documentation** (AC: 1)
  - [ ] Verify Swagger UI includes new endpoint
  - [ ] Verify "User" tag grouping
  - [ ] Verify example response shown

## Dev Notes

### Endpoint Purpose
This endpoint provides real-time quota information for frontend display:
- Shows "You've used 2 of 2 assessments" message
- Displays progress bar: 100% full (2/2)
- Shows upgrade prompt when quota exhausted
- Enables/disables "Create Assessment" button based on quota

**No Parameters:** Uses authenticated user ID from JWT token.

[Source: docs/prd/epic-7-api-endpoints.md#Story 3.7]

---

### UserAssessmentQuota Model

**Location:** `backend/prisma/schema.prisma`

**Model Definition (from Story 5.2):**
```prisma
model UserAssessmentQuota {
  id     String @id @default(cuid())
  userId String @unique

  totalAssessmentsCreated   Int @default(0)  // Lifetime total
  assessmentsThisMonth      Int @default(0)  // This billing period
  assessmentsUsedThisMonth  Int @default(0)  // Completed this period

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(...)
}
```

**Fields:**
- `totalAssessmentsCreated`: Total assessments ever created (for FREE limit)
- `assessmentsThisMonth`: Assessments created this billing period
- `assessmentsUsedThisMonth`: Assessments completed/used this period (for PREMIUM limit)

**Why Two Monthly Fields:**
- `assessmentsThisMonth`: Counts all created (including drafts)
- `assessmentsUsedThisMonth`: Counts only completed (used credits)
- PREMIUM limit based on completed assessments

[Source: docs/stories/5.2.user-assessment-quota.story.md]

---

### Quota Limits by Plan

**Quota Rules:**

| Plan | Quota Limit | Resets | Based On Field |
|------|-------------|--------|----------------|
| FREE | 2 | Never (lifetime) | totalAssessmentsCreated |
| PREMIUM | 2 | Monthly/Annual cycle | assessmentsUsedThisMonth |
| ENTERPRISE | Unlimited (-1) | N/A | N/A |

**FREE Plan:**
- User can create 2 assessments total (ever)
- Limit never resets
- After 2 assessments, must upgrade to PREMIUM

**PREMIUM Plan:**
- User can complete 2 assessments per billing cycle
- Limit resets at period start (monthly or annual)
- Can purchase additional assessments if needed

**ENTERPRISE Plan:**
- No quota limit (unlimited)
- quotaLimit = -1 (indicates unlimited)
- quotaRemaining = -1 (indicates unlimited)

[Source: docs/stories/5.2.user-assessment-quota.story.md, docs/V4_REVISED_PAY_GATING_PLAN.md]

---

### Calculated Fields

**quotaLimit:**
```typescript
const QUOTA_LIMITS = {
  FREE: 2,
  PREMIUM: 2,
  ENTERPRISE: -1,  // Unlimited
};

const quotaLimit = QUOTA_LIMITS[plan];
```

**quotaRemaining:**
```typescript
let quotaRemaining: number;

if (quotaLimit === -1) {
  // Unlimited
  quotaRemaining = -1;
} else {
  if (plan === 'FREE') {
    // Lifetime limit
    quotaRemaining = Math.max(0, quotaLimit - quota.totalAssessmentsCreated);
  } else {
    // PREMIUM: Monthly limit
    quotaRemaining = Math.max(0, quotaLimit - quota.assessmentsUsedThisMonth);
  }
}
```

**Why Math.max(0, ...):**
Prevent negative remaining values if user somehow exceeded quota.

[Source: This story Task 5]

---

### Response Examples by Plan

**FREE User (0 assessments created):**
```json
{
  "success": true,
  "data": {
    "userId": "user_cm123abc",
    "totalAssessmentsCreated": 0,
    "assessmentsThisMonth": 0,
    "assessmentsUsedThisMonth": 0,
    "plan": "FREE",
    "quotaLimit": 2,
    "quotaRemaining": 2
  }
}
```

**FREE User (2 assessments created - quota exhausted):**
```json
{
  "success": true,
  "data": {
    "userId": "user_cm123abc",
    "totalAssessmentsCreated": 2,
    "assessmentsThisMonth": 2,
    "assessmentsUsedThisMonth": 2,
    "plan": "FREE",
    "quotaLimit": 2,
    "quotaRemaining": 0
  }
}
```

**PREMIUM User (1 assessment used this month):**
```json
{
  "success": true,
  "data": {
    "userId": "user_cm456def",
    "totalAssessmentsCreated": 5,
    "assessmentsThisMonth": 1,
    "assessmentsUsedThisMonth": 1,
    "plan": "PREMIUM",
    "quotaLimit": 2,
    "quotaRemaining": 1
  }
}
```

**ENTERPRISE User (unlimited):**
```json
{
  "success": true,
  "data": {
    "userId": "user_cm789ghi",
    "totalAssessmentsCreated": 50,
    "assessmentsThisMonth": 10,
    "assessmentsUsedThisMonth": 10,
    "plan": "ENTERPRISE",
    "quotaLimit": -1,
    "quotaRemaining": -1
  }
}
```

[Source: docs/prd/epic-7-api-endpoints.md#Story 3.7]

---

### Frontend Usage Examples

**Quota Display Component:**
```typescript
const { data: quota } = useQuery(['assessmentQuota'], () =>
  api.getAssessmentQuota()
);

if (quota.quotaLimit === -1) {
  return <div>Unlimited assessments</div>;
}

if (quota.quotaRemaining === 0) {
  return (
    <div>
      <p>You've used all {quota.quotaLimit} assessments</p>
      <UpgradeButton />
    </div>
  );
}

return (
  <div>
    <p>You've used {quota.quotaLimit - quota.quotaRemaining} of {quota.quotaLimit} assessments</p>
    <ProgressBar value={(quota.quotaLimit - quota.quotaRemaining) / quota.quotaLimit * 100} />
  </div>
);
```

**Create Assessment Button:**
```typescript
const { data: quota } = useQuery(['assessmentQuota'], () =>
  api.getAssessmentQuota()
);

const canCreateAssessment = quota.quotaRemaining > 0 || quota.quotaRemaining === -1;

return (
  <Button
    disabled={!canCreateAssessment}
    onClick={handleCreateAssessment}
  >
    {canCreateAssessment
      ? 'Create Assessment'
      : 'Upgrade to Create More Assessments'}
  </Button>
);
```

[Source: Frontend integration patterns]

---

### User Routes File

**Location:** `backend/src/routes/user.routes.ts`

**Purpose:** User-specific endpoints (not admin, not subscriptions)

**Endpoints:**
- GET /assessment-quota - Get quota information (this story)
- (Future) GET /profile - Get user profile
- (Future) PUT /profile - Update user profile
- (Future) GET /preferences - Get user preferences
- (Future) PUT /preferences - Update user preferences

**Registration in server.ts:**
```typescript
import userRoutes from './routes/user.routes';

server.register(userRoutes, { prefix: '/v1/user' });
```

**Full URL:** `http://localhost:4000/v1/user/assessment-quota`

[Source: This story Task 1, common API structure]

---

### Quota Record Creation

**When is UserAssessmentQuota created?**
Created automatically when user subscription is created (Story 6.2):

```typescript
// In SubscriptionService.createSubscription()
await this.prisma.userAssessmentQuota.create({
  data: {
    userId,
    totalAssessmentsCreated: 0,
    assessmentsThisMonth: 0,
    assessmentsUsedThisMonth: 0,
  },
});
```

**Edge Case:**
If quota record doesn't exist (shouldn't happen), endpoint returns 404 with helpful error message.

[Source: docs/stories/6.2.update-create-subscription.story.md#Task 7]

---

### Error Handling

**Error Types:**

| Error Code | HTTP Status | Cause | Handled By |
|------------|-------------|-------|-----------|
| AUTH_REQUIRED | 401 | Missing/invalid JWT | authenticationMiddleware |
| QUOTA_NOT_FOUND | 404 | UserAssessmentQuota record missing | Route handler |

**Route Error Handler:**
```typescript
try {
  const quota = await prisma.userAssessmentQuota.findUnique({ where: { userId }, include: { ... } });

  if (!quota) {
    return reply.status(404).send({
      success: false,
      message: 'Assessment quota not found. This should not happen - contact support.',
      code: 'QUOTA_NOT_FOUND',
    });
  }

  // Calculate and return quota
} catch (error: any) {
  request.log.error({ error, userId }, 'Failed to get assessment quota');
  throw error;
}
```

[Source: backend/src/services/base.service.ts#createError]

---

### Testing Standards

**Test Framework:** Vitest 3
**Test Location:** `backend/tests/integration/assessment-quota-endpoint.test.ts`

**Key Test Cases:**
1. **FREE user (0 assessments):** quotaLimit=2, quotaRemaining=2
2. **FREE user (1 assessment):** quotaLimit=2, quotaRemaining=1
3. **FREE user (2 assessments):** quotaLimit=2, quotaRemaining=0 (exhausted)
4. **PREMIUM user (0 used this month):** quotaLimit=2, quotaRemaining=2
5. **PREMIUM user (1 used this month):** quotaLimit=2, quotaRemaining=1
6. **PREMIUM user (2 used this month):** quotaLimit=2, quotaRemaining=0
7. **ENTERPRISE user:** quotaLimit=-1, quotaRemaining=-1 (unlimited)
8. **Missing quota record:** 404 QUOTA_NOT_FOUND
9. **Unauthenticated request:** 401 AUTH_REQUIRED

[Source: CLAUDE.md#Testing Infrastructure]

---

### Performance Considerations

**Why Include Subscription in Query:**
Need subscription.plan to calculate quotaLimit.

**Query Pattern:**
```typescript
const quota = await prisma.userAssessmentQuota.findUnique({
  where: { userId },
  include: {
    user: {
      select: {
        subscription: {
          select: { plan: true },  // Only need plan field
        },
      },
    },
  },
});
```

**Generated SQL:**
```sql
SELECT * FROM UserAssessmentQuota WHERE userId = ?
JOIN User ON User.id = UserAssessmentQuota.userId
JOIN Subscription ON Subscription.userId = User.id
```

**Alternative (Less Efficient):**
```typescript
// Two separate queries
const quota = await prisma.userAssessmentQuota.findUnique({ where: { userId } });
const subscription = await prisma.subscription.findUnique({ where: { userId } });
```

[Source: Prisma query optimization]

---

### File Locations
- **Route File:** `backend/src/routes/user.routes.ts` (create if doesn't exist)
- **Server Registration:** `backend/src/server.ts` (add registration if new file)
- **Test:** `backend/tests/integration/assessment-quota-endpoint.test.ts`

---

### Dependencies
**Depends On:**
- Story 5.2: UserAssessmentQuota model must exist
- Story 6.2: Subscription has plan field
- Existing: authenticationMiddleware

**Depended On By:**
- Story 8.x: Frontend quota display components will call this endpoint

---

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from Epic 7 | Bob (Scrum Master) |

---

## Dev Agent Record
_This section will be populated by the development agent during implementation_

### Agent Model Used
_TBD_

### Debug Log References
_TBD_

### Completion Notes
_TBD_

### File List
_TBD_

---

## QA Results
_This section will be populated by the QA agent after story completion_
