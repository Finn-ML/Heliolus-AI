# Story 13.4: Company User RFP Management Dashboard

## Status
Draft

## Story

**As a** user
**I want** to view all my RFPs, track their status, and see vendor responses
**So that** I can manage my vendor engagement activities efficiently

## Acceptance Criteria

1. User dashboard shows:
   - RFP list (table or card view)
   - Columns: RFP Title, Created Date, Vendors Contacted, Status, Response Count
   - Filter: Status (All, Active, Closed, Archived)
   - Sort: Date (newest first), Status
2. RFP detail view:
   - Full RFP content (objectives, requirements, timeline, budget)
   - Vendor list with response status per vendor
   - Attached documents (downloadable)
   - Activity timeline (sent, viewed by vendors, responses received)
3. Status toggle:
   - User can mark RFP as Active, Closed, or Archived
   - Closed RFPs notify vendors (optional)
4. API endpoints:
   - `GET /v1/rfp/my-rfps` - User's RFP list
   - `GET /v1/rfp/:id` - RFP details (authorization: owner only)
   - `PATCH /v1/rfp/:id/status` - Update status
5. Empty state: "No RFPs yet" with CTA to create first RFP

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Get User's RFPs** (AC: 1, 4)
  - [ ] Add method to rfp.service.ts: `getMyRFPs(userId, filters)`
  - [ ] Query RFPs where userId = current user
  - [ ] Filters:
    - `status`: RFPStatus[] (filter by DRAFT, SENT, ACTIVE, CLOSED, ARCHIVED)
    - `sortBy`: 'createdAt' | 'status' (default: createdAt DESC)
  - [ ] Include counts:
    - `vendorsContacted`: Count of VendorContact records with this rfpId
    - `responsesReceived`: Count where VendorContact.status = RESPONDED
  - [ ] Return RFP list with aggregated counts

- [ ] **Task 2: Get RFP Details** (AC: 2, 4)
  - [ ] Extend existing `GET /v1/rfp/:id` route (from Story 13.1)
  - [ ] Add authorization: User must own RFP (userId check)
  - [ ] Include relations:
    - user, organization
    - contacts (VendorContact) with vendor details
  - [ ] For each VendorContact, return:
    - Vendor name, contact status, contacted date, response date (if any)
  - [ ] Activity timeline: Parse VendorContact records to build timeline
    - "Sent to Acme Corp on Oct 27"
    - "Viewed by Beta Inc on Oct 28"
    - "Response from Gamma Co on Oct 29"

- [ ] **Task 3: Update RFP Status** (AC: 3, 4)
  - [ ] Add route: `PATCH /v1/rfp/:id/status`
  - [ ] Authorization: User must own RFP
  - [ ] Validation: New status must be valid RFPStatus (SENT, ACTIVE, CLOSED, ARCHIVED)
  - [ ] Cannot change DRAFT to CLOSED/ARCHIVED (must send first)
  - [ ] Update RFP.status in database
  - [ ] If newStatus = CLOSED: Optionally send email to vendors (future enhancement)
  - [ ] Return updated RFP

- [ ] **Task 4: RFP List API Route** (AC: 4)
  - [ ] Add route: `GET /v1/rfp/my-rfps` to rfp.routes.ts
  - [ ] Require authentication (JWT)
  - [ ] Query params: `status`, `sortBy`
  - [ ] Call rfp.service.getMyRFPs(userId, filters)
  - [ ] Response:
    ```typescript
    {
      success: true,
      data: {
        rfps: Array<{
          id: string,
          title: string,
          createdAt: DateTime,
          sentAt: DateTime,
          status: RFPStatus,
          vendorsContacted: number,
          responsesReceived: number
        }>,
        total: number
      }
    }
    ```

### Frontend Tasks

- [ ] **Task 5: RFP Dashboard Page** (AC: 1, 5)
  - [ ] Create `frontend/src/pages/RFPDashboardPage.tsx`
  - [ ] Fetch user's RFPs: `useMyRFPs(filters)` hook
  - [ ] Display RFP list as table (desktop) or cards (mobile)
  - [ ] Table columns:
    - RFP Title (clickable → detail view)
    - Created Date (formatted)
    - Status badge (color-coded: DRAFT=gray, SENT=blue, ACTIVE=green, CLOSED=yellow, ARCHIVED=gray)
    - Vendors Contacted (count)
    - Responses Received (count with percentage)
  - [ ] Empty state:
    - Icon, "No RFPs yet" message
    - "Create Your First RFP" button → Opens RFP form modal

- [ ] **Task 6: Status Filter** (AC: 1)
  - [ ] Add status filter dropdown above table
  - [ ] Options: All, Draft, Sent, Active, Closed, Archived
  - [ ] On change: Update query filters, refetch RFPs
  - [ ] Show count per status (e.g., "Active (5)")

- [ ] **Task 7: RFP Detail View** (AC: 2)
  - [ ] Create `frontend/src/pages/RFPDetailPage.tsx` or modal
  - [ ] Route: `/rfp/:id` or open as modal
  - [ ] Fetch RFP details: `useRFPDetails(rfpId)` hook
  - [ ] Display sections:
    - **Header**: RFP title, status badge, created/sent dates
    - **Content**: Company overview, objectives, requirements, timeline, budget
    - **Documents**: List of attached documents with download links
    - **Vendors**: Table of vendors contacted with response status
    - **Activity Timeline**: Chronological list of events
  - [ ] Back button to return to dashboard

- [ ] **Task 8: Vendor Response Status Table** (AC: 2)
  - [ ] In RFP detail view, show vendor table:
    - Columns: Vendor Name, Contacted Date, Status (Pending/Responded/Closed), Response Date
    - Status indicators: Pending=yellow, Responded=green, Closed=gray
  - [ ] Calculate response rate: (responded / total) * 100%
  - [ ] Display above table: "3 of 5 vendors responded (60%)"

- [ ] **Task 9: Activity Timeline Component** (AC: 2)
  - [ ] Create timeline component showing:
    - "RFP created" (with date)
    - "Sent to 5 vendors" (with date)
    - Per-vendor events: "Viewed by Acme Corp", "Response from Beta Inc"
  - [ ] Chronological order (newest first or oldest first)
  - [ ] Use timeline UI component (vertical line with dots)

- [ ] **Task 10: Status Update Action** (AC: 3)
  - [ ] Add status dropdown in RFP detail header
  - [ ] Current status displayed as badge
  - [ ] Dropdown options: Active, Closed, Archived (exclude DRAFT, SENT - system-controlled)
  - [ ] On selection: Show confirmation modal
    - "Mark this RFP as Closed?"
    - "Vendors will be notified that you've closed this RFP."
  - [ ] On confirm: Call PATCH /v1/rfp/:id/status
  - [ ] Success: Update status badge, show toast, update cache
  - [ ] Error: Show error toast

- [ ] **Task 11: API Hooks** (AC: 4)
  - [ ] Create `frontend/src/hooks/useMyRFPs.ts`:
    - `useMyRFPs(filters)` - Fetch user's RFP list
    - `useRFPDetails(rfpId)` - Fetch RFP details with vendors
    - `useUpdateRFPStatus(rfpId)` - Mutation for status update
  - [ ] Use TanStack Query for caching and refetching
  - [ ] Handle loading, error states

- [ ] **Task 12: Navigation Integration** (AC: 1)
  - [ ] Add "My RFPs" link to main navigation
  - [ ] Visible only to authenticated users
  - [ ] Badge showing count of active RFPs (optional)

### Testing

- [ ] **Task 13: Backend Unit Tests** (AC: 1, 3)
  - [ ] Test rfp.service.getMyRFPs: Filters, sorting, vendor counts
  - [ ] Test authorization: User can only see their own RFPs
  - [ ] Test status update: Valid transitions, invalid transitions

- [ ] **Task 14: API Contract Tests** (AC: 4)
  - [ ] Test GET /v1/rfp/my-rfps: Returns user's RFPs (200), empty list for new user
  - [ ] Test GET /v1/rfp/:id: Owner access (200), non-owner (403), invalid ID (404)
  - [ ] Test PATCH /v1/rfp/:id/status: Valid status (200), invalid status (400), non-owner (403)

- [ ] **Task 15: Frontend Component Tests**
  - [ ] Test RFP dashboard: Renders table, empty state
  - [ ] Test status filter: Filters RFPs correctly
  - [ ] Test RFP detail view: Displays all sections
  - [ ] Test status update: Shows confirmation, updates status

## Dev Notes

### Project Context
Story 13.4 provides users with a dashboard to manage their RFPs, track vendor responses, and update RFP status. This complements the admin view (Story 13.3) by giving users self-service visibility into their engagement activities.

**Dependencies:**
- Story 13.1 (RFP model, creation)
- Story 13.2 (RFP sending, VendorContact tracking)

[Source: docs/prd/epic-13-rfp-vendor-engagement.md#Story 13.4]

### Tech Stack
- **Backend**: Fastify 4 + TypeScript | Prisma 6
- **Frontend**: React 18 + TypeScript | TanStack Query 5 | Radix UI | TailwindCSS

[Source: CLAUDE.md#Tech Stack]

### RFP Status Flow

**RFPStatus Enum:**
```prisma
enum RFPStatus {
  DRAFT      // Created but not sent
  SENT       // Sent to vendors (system-controlled)
  ACTIVE     // User-marked as actively pursuing
  CLOSED     // User-marked as closed (vendor selected or abandoned)
  ARCHIVED   // User-marked as archived (historical record)
}
```

**Status Transitions:**
- DRAFT → SENT (via Story 13.2 send API, system-controlled)
- SENT → ACTIVE (user action, default after sending)
- ACTIVE → CLOSED (user action, engagement complete)
- ACTIVE → ARCHIVED (user action, no longer relevant)
- CLOSED → ARCHIVED (user action, cleanup)

**User-Controllable Statuses:**
Users can only change between: SENT, ACTIVE, CLOSED, ARCHIVED
Users cannot set DRAFT or manually set SENT (system-controlled)

[Source: docs/prd/epic-13-rfp-vendor-engagement.md#Database Schema - RFP model]

### Backend Service Methods

**Get User's RFPs:**
```typescript
async getMyRFPs(
  userId: string,
  filters: { status?: RFPStatus[], sortBy?: 'createdAt' | 'status' }
): Promise<Array<RFPListItem>> {
  const rfps = await this.prisma.rFP.findMany({
    where: {
      userId,
      ...(filters.status && { status: { in: filters.status } })
    },
    include: {
      contacts: {
        select: {
          id: true,
          status: true,
          createdAt: true,
          respondedAt: true
        }
      }
    },
    orderBy: filters.sortBy === 'status'
      ? { status: 'asc' }
      : { createdAt: 'desc' }
  });

  return rfps.map(rfp => ({
    id: rfp.id,
    title: rfp.title,
    createdAt: rfp.createdAt,
    sentAt: rfp.sentAt,
    status: rfp.status,
    vendorsContacted: rfp.contacts.length,
    responsesReceived: rfp.contacts.filter(c => c.status === 'RESPONDED').length
  }));
}
```

**Get RFP Details with Activity Timeline:**
```typescript
async getRFPDetails(rfpId: string, userId: string): Promise<RFPDetails> {
  const rfp = await this.prisma.rFP.findUnique({
    where: { id: rfpId },
    include: {
      user: true,
      organization: true,
      contacts: {
        include: { vendor: true },
        orderBy: { createdAt: 'asc' }
      }
    }
  });

  if (!rfp) throw this.createError('RFP not found', 404, 'RFP_NOT_FOUND');
  if (rfp.userId !== userId) throw this.createError('Not authorized', 403, 'FORBIDDEN');

  // Build activity timeline
  const timeline = [
    { event: 'RFP created', date: rfp.createdAt },
    ...(rfp.sentAt ? [{ event: `Sent to ${rfp.contacts.length} vendors`, date: rfp.sentAt }] : []),
    ...rfp.contacts.map(contact => ({
      event: contact.status === 'RESPONDED'
        ? `Response from ${contact.vendor.companyName}`
        : `Contacted ${contact.vendor.companyName}`,
      date: contact.respondedAt || contact.createdAt
    }))
  ].sort((a, b) => b.date.getTime() - a.date.getTime());

  return {
    ...rfp,
    timeline,
    vendorResponses: rfp.contacts.map(c => ({
      vendorName: c.vendor.companyName,
      contactedDate: c.createdAt,
      status: c.status,
      responseDate: c.respondedAt
    }))
  };
}
```

[Source: Service patterns from CLAUDE.md#Core Architecture]

### Authorization Pattern

**User-Scoped Queries:**
All RFP queries must filter by `userId` to ensure users only see their own RFPs:
```typescript
const rfp = await prisma.rFP.findUnique({
  where: { id: rfpId }
});

// Authorization check
if (rfp.userId !== request.user.id) {
  throw new Error('Forbidden');
}
```

**Middleware:**
Use existing `authenticationMiddleware` (JWT verification) on all routes.
No need for Premium tier check on read-only endpoints (GET my-rfps, GET rfp/:id).

[Source: CLAUDE.md#API Architecture - Authentication]

### Frontend Dashboard Layout

**Page Structure:**
```tsx
<RFPDashboardPage>
  <PageHeader>
    <Title>My RFPs</Title>
    <CreateRFPButton />
  </PageHeader>

  <Filters>
    <StatusFilter />
    <SearchBar />  {/* Future enhancement */}
  </Filters>

  {rfps.length === 0 ? (
    <EmptyState>
      <Icon />
      <Message>No RFPs yet</Message>
      <CreateRFPButton variant="primary" />
    </EmptyState>
  ) : (
    <RFPTable rfps={rfps} />
  )}
</RFPDashboardPage>
```

**RFP Detail Layout:**
```tsx
<RFPDetailPage>
  <Header>
    <BackButton />
    <Title>{rfp.title}</Title>
    <StatusBadge status={rfp.status} />
    <StatusDropdown />
  </Header>

  <Grid>
    <ContentSection>
      <h3>Overview</h3>
      <p>{rfp.objectives}</p>
      <h3>Requirements</h3>
      <p>{rfp.requirements}</p>
      <h3>Timeline & Budget</h3>
      <p>{rfp.timeline} | {rfp.budget}</p>
    </ContentSection>

    <DocumentsSection>
      <h3>Attached Documents</h3>
      <DocumentList documents={rfp.documents} />
    </DocumentsSection>
  </Grid>

  <VendorResponsesSection>
    <h3>Vendor Responses ({responseRate}%)</h3>
    <VendorTable vendors={rfp.vendorResponses} />
  </VendorResponsesSection>

  <ActivityTimelineSection>
    <h3>Activity Timeline</h3>
    <Timeline events={rfp.timeline} />
  </ActivityTimelineSection>
</RFPDetailPage>
```

[Source: Frontend patterns from CLAUDE.md#Frontend Component Patterns]

### Activity Timeline Component

**Timeline Events:**
Build chronological timeline from:
1. RFP creation (rfp.createdAt)
2. RFP sent (rfp.sentAt)
3. Vendor contacts (VendorContact.createdAt)
4. Vendor responses (VendorContact.respondedAt)

**UI Pattern:**
Use vertical timeline with dots and connecting lines:
```tsx
<Timeline>
  {events.map(event => (
    <TimelineItem key={event.id}>
      <TimelineDot color={getEventColor(event.type)} />
      <TimelineContent>
        <TimelineDate>{formatDate(event.date)}</TimelineDate>
        <TimelineEvent>{event.description}</TimelineEvent>
      </TimelineContent>
    </TimelineItem>
  ))}
</Timeline>
```

**Example Events:**
- "Oct 27, 2025 - RFP created"
- "Oct 27, 2025 - Sent to 5 vendors"
- "Oct 28, 2025 - Viewed by Acme Corp"
- "Oct 29, 2025 - Response from Beta Inc"

[Source: Common timeline UI patterns]

### Vendor Response Rate Calculation

**Formula:**
```typescript
const responseRate = (responsesReceived / vendorsContacted) * 100;
```

**Display:**
- Above vendor table: "3 of 5 vendors responded (60%)"
- Color-coded: <40% = red, 40-70% = yellow, >70% = green

**Per-Vendor Status:**
- PENDING: Contacted but no response yet
- RESPONDED: Vendor has responded
- CLOSED: Engagement closed (no longer expecting response)

[Source: docs/prd/epic-13-rfp-vendor-engagement.md#Story 13.4 AC 2]

### Status Update with Vendor Notification

**Optional Feature:**
When user marks RFP as CLOSED, optionally send email to all contacted vendors:
- Subject: "RFP Closed: {{rfpTitle}}"
- Body: "Thank you for your response. We have completed our vendor selection process."

**Implementation:**
- In rfp.service.updateRFPStatus, check if newStatus = CLOSED
- If yes, call email.service.sendRFPClosureNotification for each vendor
- Non-blocking: Don't fail status update if email fails

**Note:** This is optional and can be deferred to future enhancement.

[Source: docs/prd/epic-13-rfp-vendor-engagement.md#Story 13.4 AC 3]

### API Route Specifications

**1. GET /v1/rfp/my-rfps**
- Auth: Required (JWT)
- Query params: `status[]`, `sortBy`
- Response: `{ success: true, data: { rfps: RFPListItem[], total: number } }`

**2. GET /v1/rfp/:id**
- Auth: Required (JWT)
- Authorization: Owner only
- Response: `{ success: true, data: RFPDetails }`

**3. PATCH /v1/rfp/:id/status**
- Auth: Required (JWT)
- Authorization: Owner only
- Body: `{ status: RFPStatus }`
- Validation: Status must be SENT, ACTIVE, CLOSED, or ARCHIVED
- Response: `{ success: true, data: RFP }`

[Source: docs/prd/epic-13-rfp-vendor-engagement.md#Story 13.4 AC 4]

### Empty State Design

**When No RFPs Exist:**
Display centered empty state with:
- Icon: Document with magnifying glass or similar
- Headline: "No RFPs yet"
- Subtext: "Create your first RFP to engage with compliance vendors"
- CTA Button: "Create Your First RFP" → Opens RFP form modal from Story 13.1

**Design Pattern:**
```tsx
<EmptyState>
  <Icon name="document-search" size="large" color="gray" />
  <Heading>No RFPs yet</Heading>
  <Subtext>Create your first RFP to engage with compliance vendors</Subtext>
  <Button onClick={openRFPModal}>Create Your First RFP</Button>
</EmptyState>
```

[Source: docs/prd/epic-13-rfp-vendor-engagement.md#Story 13.4 AC 5]

### Responsive Design

**Desktop (>768px):**
- RFP list: Table layout with all columns
- Detail view: Two-column grid (content left, sidebar right)

**Mobile (<768px):**
- RFP list: Card layout (stacked)
  - Each card shows: Title, date, status badge, vendor count
  - Tap card to open detail view
- Detail view: Single column (stacked sections)

**TailwindCSS Classes:**
```tsx
<div className="hidden md:block">
  {/* Desktop table */}
</div>
<div className="block md:hidden">
  {/* Mobile cards */}
</div>
```

[Source: docs/prd/epic-13-rfp-vendor-engagement.md#Story 13.4 Technical Notes, TailwindCSS responsive utilities]

### File Locations

**Backend:**
- Extend service: `backend/src/services/rfp.service.ts` (add getMyRFPs, getRFPDetails methods)
- Add routes: `backend/src/routes/rfp.routes.ts` (GET /my-rfps, PATCH /:id/status)

**Frontend:**
- New page: `frontend/src/pages/RFPDashboardPage.tsx`
- New page: `frontend/src/pages/RFPDetailPage.tsx`
- New components:
  - `frontend/src/components/rfp/RFPTable.tsx`
  - `frontend/src/components/rfp/RFPStatusBadge.tsx`
  - `frontend/src/components/rfp/VendorResponseTable.tsx`
  - `frontend/src/components/rfp/ActivityTimeline.tsx`
  - `frontend/src/components/rfp/EmptyState.tsx`
- New hooks: `frontend/src/hooks/useMyRFPs.ts`
- Update navigation: `frontend/src/components/layout/MainNav.tsx`

[Source: CLAUDE.md#Project Structure]

### Testing

#### Backend Testing

**Service Tests:**
- File: `backend/tests/services/rfp.service.test.ts`
- Test getMyRFPs: Filters, sorting, vendor counts
- Test getRFPDetails: Authorization, timeline building
- Test updateRFPStatus: Valid transitions, invalid statuses

**Contract Tests:**
- File: `backend/tests/contract/rfp.routes.test.ts`
- Test GET /v1/rfp/my-rfps: Returns user's RFPs, filters work
- Test GET /v1/rfp/:id: Owner access (200), non-owner (403)
- Test PATCH /v1/rfp/:id/status: Valid status (200), invalid (400)

**Run Commands:**
- `npm run test` (from backend/)
- `npm run test:contract` (from backend/)

[Source: CLAUDE.md#Testing]

#### Frontend Testing

**Component Tests:**
- Test RFPDashboardPage: Renders table, empty state
- Test RFPDetailPage: Displays all sections correctly
- Test status filter: Filters RFPs by status
- Test status update: Shows confirmation, updates cache
- Test activity timeline: Chronological order, correct events

[Source: CLAUDE.md#Testing patterns]

## Codebase Review Findings

**Review Date**: 2025-10-27
**Review Document**: `.ai/epic-13-codebase-review.md`

### Confirmed Missing Components (Must Create/Enhance)

✅ **RFP Service** (Enhancements):
- rfp.service.ts does NOT exist yet (dependency from Story 13.1)
- **MUST ADD** after Story 13.1:
  - getMyRFPs(userId, filters) method (Task 1)
  - getRFPDetails(rfpId, userId) method (Task 2)
  - updateRFPStatus(rfpId, userId, newStatus) method (Task 3)

✅ **Routes**:
- rfp.routes.ts does NOT exist yet (dependency from Story 13.1)
- **MUST ADD**:
  - GET /v1/rfp/my-rfps (Task 4)
  - PATCH /v1/rfp/:id/status (Task 3)
  - GET /v1/rfp/:id (already in Story 13.1, will be enhanced)

✅ **Database**:
- RFP model does NOT exist (dependency from Story 13.1)
- RFPStatus enum does NOT exist (will be added in Story 13.1)
- VendorContact model EXISTS ✅

### Dependencies

**BLOCKING**: Stories 13.1 and 13.2 must be completed first:
- RFP model must exist
- RFP service must exist
- rfp.routes.ts must exist with base CRUD routes
- RFPs must be sendable (Story 13.2 complete)
- VendorContact records must have rfpId linkage

### RFP Status Flow Confirmed

**RFPStatus Enum** (from Story 13.1):
```
DRAFT → SENT (system controlled) → ACTIVE/CLOSED/ARCHIVED (user controlled)
```

**User-Controllable Statuses**:
- Users can change between: SENT, ACTIVE, CLOSED, ARCHIVED
- Users CANNOT set DRAFT (create operation)
- Users CANNOT manually set SENT (send operation from Story 13.2)

**Status Transitions**:
- DRAFT → SENT: Via POST /v1/rfp/:id/send (Story 13.2)
- SENT → ACTIVE: User marks as actively pursuing
- ACTIVE → CLOSED: User marks as complete
- ACTIVE → ARCHIVED: User marks as no longer relevant
- CLOSED → ARCHIVED: User archives old RFPs

### Implementation Priority

**Story 13.4 Order**:
1. Extend rfp.service.ts with getMyRFPs (Task 1)
2. Extend rfp.service.ts with getRFPDetails (Task 2)
3. Add updateRFPStatus to rfp.service.ts (Task 3)
4. Add GET /v1/rfp/my-rfps route (Task 4)
5. Add PATCH /v1/rfp/:id/status route (Task 3)

**Estimated Effort**: 4-5 hours (backend only)

### Notes for Dev Agent

- **Authorization**: All routes require userId check (users can only see their own RFPs)
- **Activity Timeline**: Build from VendorContact.createdAt, respondedAt timestamps
- **Vendor Response Counts**: Use VendorContact aggregate where rfpId matches
- **Status Update Validation**: Prevent invalid transitions (e.g., DRAFT → CLOSED)
- **Optional Enhancement**: Send email to vendors when status = CLOSED (not required for MVP)

### Activity Timeline Data Sources

**Timeline Events**:
1. RFP created (rfp.createdAt)
2. RFP sent (rfp.sentAt)
3. Contacted vendors (VendorContact.createdAt for each vendor)
4. Vendor responses (VendorContact.respondedAt when status = RESPONDED)

**Sort Order**: Chronological (newest first OR oldest first, specify in UI)

### Vendor Response Rate Calculation

```typescript
const vendorContacts = rfp.contacts; // All VendorContact where rfpId = rfp.id
const totalVendors = vendorContacts.length;
const responsesReceived = vendorContacts.filter(c => c.status === 'RESPONDED').length;
const responseRate = (responsesReceived / totalVendors) * 100;
```

## Architectural Decisions & Issue Resolutions

**Decision Document**: `.ai/epic-13-architectural-decisions.md`
**Review Date**: 2025-10-27

### Authorization Pattern Usage (CRITICAL)

**Requirement**: All RFP list and detail endpoints MUST use authorization checks from Story 13.1.

**Implementation**:
```typescript
// backend/src/services/rfp.service.ts
async getUserRFPs(userId: string, filters: RFPFilters) {
  // No separate authorization needed - query filters by userId automatically
  return this.prisma.rFP.findMany({
    where: {
      userId,  // Implicit authorization - only returns user's RFPs
      ...(filters.status && { status: filters.status }),
      ...(filters.dateFrom && { createdAt: { gte: filters.dateFrom } })
    },
    include: { contacts: true, organization: true },
    orderBy: { createdAt: 'desc' }
  });
}

async getRFP(rfpId: string, userId: string) {
  // Use centralizedauthorizeRFPAccess helper from Story 13.1
  return this.authorizeRFPAccess(rfpId, userId, {
    contacts: true,
    organization: true
  });
}
```

**Key Points**:
- List endpoint: Filter by userId in query (implicit authorization)
- Detail endpoint: Use `authorizeRFPAccess()` helper (explicit authorization)
- Never return RFPs from other users

**Update Task 2**: Reference authorizeRFPAccess() from Story 13.1.

### RFP Status Flow (MEDIUM)

**Confirmed Flow**:
```
DRAFT → SENT → ARCHIVED
  ↓
FAILED (if all emails fail in Story 13.2)
```

**Status Transitions**:
- User creates RFP → `DRAFT`
- User sends RFP (Story 13.2) → `SENT` (if any email succeeds) or `FAILED` (if all fail)
- User archives RFP → `ARCHIVED`
- Retry failed RFP → `DRAFT` → `SENT`

**Update Task 5**: Add status transition rules to frontend logic.

### References

- Architectural Decisions: `.ai/epic-13-architectural-decisions.md` (Section 7)
- Story 13.1: Authorization pattern implementation
- Deep Analysis: `.ai/epic-13-deep-analysis-issues.md` (Issue #1)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-27 | 1.0 | Initial story creation for Epic 13: RFP System | Bob (Scrum Master) |
| 2025-10-27 | 1.1 | Added codebase review findings - confirmed RFP status flow and dependencies | Claude (Dev Agent) |
| 2025-10-27 | 1.2 | Added architectural decisions - authorization pattern usage, status flow clarification | Claude (Dev Agent) |

## Dev Agent Record

### Agent Model Used
(To be populated by dev agent)

### Debug Log References
(To be populated by dev agent)

### Completion Notes List
(To be populated by dev agent)

### File List
(To be populated by dev agent)

## QA Results
(To be populated by QA agent)
