# Story 3.4: API Endpoint for AI Content Access

## Status
Draft

## Story

**As a** frontend developer,
**I want** to access AI-generated content via API,
**So that** the UI can display real insights instead of mock data

## Acceptance Criteria

1. GET `/v1/assessments/:id/ai-analysis` endpoint created
2. Generates content if not exists (triggers one-time generation)
3. Returns stored content if exists (no regeneration)
4. Proper HTTP status codes (200, 404, 500)
5. Response schema validated with Fastify schema
6. Error messages are user-friendly
7. Endpoint documented in Swagger
8. Performance: <100ms for cached content, <5s for generation

## Tasks / Subtasks

- [ ] Task 1: Add endpoint to assessment routes (AC: 1)
  - [ ] Open `backend/src/routes/assessment.routes.ts`
  - [ ] Add new GET route handler
  - [ ] Use existing auth middleware pattern
  - [ ] Follow RESTful naming convention

- [ ] Task 2: Implement endpoint logic (AC: 2, 3)
  - [ ] Extract assessment ID from params
  - [ ] Call assessmentService.generateAndStoreAIAnalysis
  - [ ] Handle service response (success/error)
  - [ ] Return appropriate response

- [ ] Task 3: Define Fastify schema (AC: 5)
  - [ ] Define params schema for ID validation
  - [ ] Define response schema for AI content
  - [ ] Add schema to route options
  - [ ] Include error response schemas

- [ ] Task 4: Add proper HTTP status codes (AC: 4)
  - [ ] Return 200 for successful retrieval
  - [ ] Return 404 for assessment not found
  - [ ] Return 500 for generation failures
  - [ ] Return 401/403 for auth failures

- [ ] Task 5: Implement user-friendly error messages (AC: 6)
  - [ ] Map service errors to HTTP responses
  - [ ] Provide clear error descriptions
  - [ ] Hide internal implementation details
  - [ ] Include error codes for frontend

- [ ] Task 6: Add Swagger documentation (AC: 7)
  - [ ] Add description and tags
  - [ ] Document request parameters
  - [ ] Document response structure
  - [ ] Include example responses

- [ ] Task 7: Test performance requirements (AC: 8)
  - [ ] Test retrieval of existing content (<100ms)
  - [ ] Test initial generation (<5s)
  - [ ] Add performance logging
  - [ ] Verify with realistic data

## Dev Notes

### Assessment Routes Location
[Source: backend/src/routes/assessment.routes.ts]

This file contains all assessment-related endpoints. The file is large (~72KB) and uses Fastify route patterns.

### Endpoint Implementation

```typescript
// GET /assessments/:id/ai-analysis - Get or generate AI analysis
server.get('/:id/ai-analysis', {
  schema: {
    description: 'Get AI-generated analysis (generates if not exists)',
    tags: ['Assessments', 'AI'],
    params: {
      type: 'object',
      properties: {
        id: { type: 'string' }
      },
      required: ['id']
    },
    response: {
      200: {
        type: 'object',
        properties: {
          success: { type: 'boolean' },
          data: {
            type: 'object',
            properties: {
              riskAnalysis: {
                type: 'object',
                additionalProperties: {
                  type: 'object',
                  properties: {
                    score: { type: 'number' },
                    totalGaps: { type: 'number' },
                    criticalGaps: { type: 'number' },
                    keyFindings: { type: 'array' },
                    mitigationStrategies: { type: 'array' }
                  }
                }
              },
              strategyMatrix: {
                type: 'array',
                items: {
                  type: 'object',
                  properties: {
                    priority: { type: 'number' },
                    riskArea: { type: 'string' },
                    adjustedRisk: { type: 'string' },
                    urgency: { type: 'string' },
                    impact: { type: 'string' },
                    primaryMitigation: { type: 'string' },
                    timeline: { type: 'string' },
                    budget: { type: 'string' },
                    businessOwner: { type: 'string' },
                    gapCount: { type: 'number' },
                    criticalGaps: { type: 'number' }
                  }
                }
              },
              generatedAt: { type: 'string', format: 'date-time' }
            }
          }
        }
      },
      404: {
        type: 'object',
        properties: {
          success: { type: 'boolean' },
          error: { type: 'string' }
        }
      },
      500: {
        type: 'object',
        properties: {
          success: { type: 'boolean' },
          error: { type: 'string' }
        }
      }
    }
  },
  preHandler: server.authenticate // Use existing auth middleware
}, async (request, reply) => {
  const { id } = request.params as { id: string };

  try {
    // Call service method from Story 3.3
    const result = await assessmentService.generateAndStoreAIAnalysis(
      id,
      request.context
    );

    if (!result.success) {
      if (result.error?.includes('not found')) {
        return reply.code(404).send({
          success: false,
          error: 'Assessment not found'
        });
      }
      return reply.code(500).send({
        success: false,
        error: result.error || 'Failed to generate AI analysis'
      });
    }

    reply.code(200).send(result);
  } catch (error) {
    request.log.error(error);
    reply.code(500).send({
      success: false,
      error: 'An error occurred while processing your request'
    });
  }
});
```

### Authentication Middleware
[Source: Existing pattern in assessment.routes.ts]

Use the existing authentication middleware:
```typescript
preHandler: server.authenticate
```

This ensures only authenticated users can access AI analysis.

### Context Passing
[Source: Existing service pattern]

Pass request context to service for user/org validation:
```typescript
const result = await assessmentService.generateAndStoreAIAnalysis(
  id,
  request.context // Contains user, organization info
);
```

### Error Response Mapping

```typescript
// Service error to HTTP response mapping
const errorResponseMap = {
  'Assessment not found': 404,
  'Unauthorized': 403,
  'AI generation failed': 500,
  'Invalid assessment ID': 400
};
```

### Performance Logging

```typescript
// Add timing logs
const startTime = Date.now();

const result = await assessmentService.generateAndStoreAIAnalysis(id, request.context);

const duration = Date.now() - startTime;
request.log.info({
  assessmentId: id,
  duration,
  generated: !result.data?.generatedAt,
  source: result.data?.generatedAt ? 'cache' : 'generation'
});
```

### Swagger Documentation Example

```typescript
schema: {
  description: `
    Retrieves AI-generated analysis for an assessment.

    If analysis doesn't exist, it will be generated (one-time process).
    Subsequent calls return the stored analysis instantly.

    Generation includes:
    - Key findings per risk category
    - Mitigation strategies (immediate, short, medium, long-term)
    - Strategy matrix for remediation planning

    Performance:
    - First call: 3-5 seconds (generation)
    - Subsequent calls: <100ms (retrieval)
  `,
  tags: ['Assessments', 'AI'],
  security: [{ bearerAuth: [] }],
  // ... rest of schema
}
```

### Response Example

```json
{
  "success": true,
  "data": {
    "riskAnalysis": {
      "KYC_AML": {
        "score": 8.5,
        "totalGaps": 10,
        "criticalGaps": 2,
        "keyFindings": [
          {
            "finding": "Inadequate customer due diligence infrastructure",
            "severity": "CRITICAL",
            "description": "Manual CDD processes create systemic vulnerability..."
          }
        ],
        "mitigationStrategies": [
          {
            "strategy": "Deploy automated KYC platform with AI-powered monitoring",
            "priority": "immediate",
            "impact": "high",
            "rationale": "Addresses critical regulatory gap"
          }
        ]
      }
    },
    "strategyMatrix": [
      {
        "priority": 1,
        "riskArea": "KYC/AML",
        "adjustedRisk": "HIGH",
        "urgency": "IMMEDIATE",
        "impact": "9.2",
        "primaryMitigation": "Deploy automated KYC platform",
        "timeline": "1.5 months",
        "budget": "$75,000",
        "businessOwner": "Chief Compliance Officer",
        "gapCount": 10,
        "criticalGaps": 2
      }
    ],
    "generatedAt": "2025-10-21T10:30:00Z"
  }
}
```

### Rate Limiting
[Source: Existing Fastify pattern]

The endpoint inherits rate limiting from the global Fastify configuration:
```typescript
// Already configured in server setup
server.register(require('@fastify/rate-limit'), {
  max: 100,
  timeWindow: '1 minute'
});
```

## Testing

### Testing Standards

**Test File Location:**
`backend/tests/integration/ai-analysis-endpoint.test.ts`

**Integration Test:**
```typescript
import { describe, it, expect } from 'vitest';
import { app } from '../test-setup';

describe('GET /v1/assessments/:id/ai-analysis', () => {
  let authToken: string;
  let assessmentId: string;

  beforeAll(async () => {
    // Setup auth and create test assessment
    authToken = await getTestAuthToken();
    assessmentId = await createTestAssessment();
  });

  it('should generate AI analysis on first request', async () => {
    const response = await app.inject({
      method: 'GET',
      url: `/v1/assessments/${assessmentId}/ai-analysis`,
      headers: {
        authorization: `Bearer ${authToken}`
      }
    });

    expect(response.statusCode).toBe(200);
    const body = JSON.parse(response.body);
    expect(body.success).toBe(true);
    expect(body.data.riskAnalysis).toBeDefined();
    expect(body.data.strategyMatrix).toBeInstanceOf(Array);
  });

  it('should return cached content on second request', async () => {
    const start = Date.now();

    const response = await app.inject({
      method: 'GET',
      url: `/v1/assessments/${assessmentId}/ai-analysis`,
      headers: {
        authorization: `Bearer ${authToken}`
      }
    });

    const duration = Date.now() - start;
    expect(duration).toBeLessThan(100); // Should be fast (cached)
    expect(response.statusCode).toBe(200);
  });

  it('should return 404 for non-existent assessment', async () => {
    const response = await app.inject({
      method: 'GET',
      url: `/v1/assessments/invalid-id/ai-analysis`,
      headers: {
        authorization: `Bearer ${authToken}`
      }
    });

    expect(response.statusCode).toBe(404);
  });

  it('should return 401 without authentication', async () => {
    const response = await app.inject({
      method: 'GET',
      url: `/v1/assessments/${assessmentId}/ai-analysis`
    });

    expect(response.statusCode).toBe(401);
  });
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-21 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_