# Story 1.13: Document Upload Enhancement - Real-Time Evidence Classification

## Status
**COMPLETE** - Evidence Classification Already Implemented

## Completion Notice
This story was **already implemented** during earlier development work. The document upload component already includes real-time evidence tier classification with polling and visual feedback.

**Implemented Features:**
✅ Real-time polling for classification status (2-second intervals until tier assigned)
✅ Evidence tier badges (TIER_0, TIER_1, TIER_2) with visual indicators
✅ Tier labels: "Self-Declared", "Policy Document", "System-Generated"
✅ Auto-classification triggered on document upload confirmation
✅ Backend API includes tier classification fields in document response
✅ Optimistic UI updates with loading states

**Implementation Location:**
- Frontend: `/frontend/src/components/DocumentStorage.tsx` (lines 48-51, 75-81, 346-373, 600-603)
- Backend: `/backend/src/routes/document.routes.ts` (DocumentResponseSchema lines 72-74)
- Evidence tier displayed in document list after upload
- Polling stops automatically once tier is classified

**Date Verified Complete:** 2025-10-14

## Story

**As a** frontend developer,
**I want** to enhance the document upload screen to show real-time evidence tier classification as documents are processed,
**so that** users receive immediate feedback on document quality.

## Acceptance Criteria

1. **Modified Component: DocumentUpload.tsx** (existing component enhanced)
2. After document upload completes:
   - Show loading spinner with "Analyzing document quality..." message
   - Poll backend for classification status (every 2 seconds, max 30 seconds)
   - Display EvidenceTierBadge when classification completes
   - Show EvidenceTierExplanation in expandable panel
3. Document card UI updates:
   - Before classification: filename, size, upload timestamp
   - After classification: + EvidenceTierBadge, + "View Classification" button
   - Click "View Classification": expand EvidenceTierExplanation panel inline
4. Handle classification failures gracefully:
   - If classification times out (>30 seconds): show "Classification in progress, check back shortly"
   - If classification fails: show "Unable to classify, defaulting to Self-Declared" with Tier 0 badge
5. Batch upload: classify documents in parallel, show progress counter "Classifying 3 of 5 documents..."
6. Use TanStack Query for polling and cache management
7. Optimistic UI: immediately show document in list, update with classification when ready
8. Accessibility: announce classification completion to screen readers

## Tasks / Subtasks

- [ ] Create EvidenceTierBadge component (AC: 2, 3)
  - [ ] Create `/frontend/src/components/ui/EvidenceTierBadge.tsx` using Radix Badge
  - [ ] Support three tier variants: Tier 0 (bronze), Tier 1 (silver), Tier 2 (gold)
  - [ ] Add Lucide icons for each tier (FileText, FileCheck, Database)
  - [ ] Add tooltip showing tier description on hover (Radix Tooltip)
- [ ] Create EvidenceTierExplanation component (AC: 2, 3)
  - [ ] Create `/frontend/src/components/assessment/EvidenceTierExplanation.tsx`
  - [ ] Display tier classification reasoning text
  - [ ] Show confidence score with progress bar
  - [ ] Include "Why this classification?" educational text
  - [ ] Use Radix Collapsible for expandable panel
- [ ] Enhance DocumentUpload component with real-time classification (AC: 2, 3, 4, 5, 6, 7, 8)
  - [ ] Locate existing `/frontend/src/components/DocumentStorage.tsx` or similar
  - [ ] Add classification polling logic using TanStack Query's `useQuery` with `refetchInterval`
  - [ ] Implement optimistic UI update pattern (show document immediately)
  - [ ] Add loading states with spinner and "Analyzing..." message
  - [ ] Integrate EvidenceTierBadge in document card
  - [ ] Add "View Classification" button that toggles EvidenceTierExplanation
  - [ ] Implement timeout handling (30 second max)
  - [ ] Add error fallback for classification failures
  - [ ] Add batch upload progress counter ("Classifying X of Y documents...")
  - [ ] Add ARIA live region for screen reader announcements
- [ ] Add API client methods for classification polling (AC: 2, 6)
  - [ ] Extend `/frontend/src/lib/api.ts` with `getDocumentClassification(documentId)` method
  - [ ] Create TanStack Query hook `useDocumentClassification(documentId, options)`
  - [ ] Configure polling with 2-second interval
  - [ ] Add query key pattern: `['documents', documentId, 'classification']`
- [ ] Update document card UI styling (AC: 3)
  - [ ] Add responsive grid layout for document metadata
  - [ ] Style EvidenceTierBadge placement (top-right corner)
  - [ ] Add hover states for "View Classification" button
  - [ ] Ensure mobile-friendly layout (stack elements vertically)
- [ ] Add integration verification tests (IV1, IV2, IV3)
  - [ ] Test document upload flow with existing objectStorage
  - [ ] Verify classification doesn't interfere with parsedContent field
  - [ ] Test assessment journey continues normally after document upload

## Dev Notes

### Relevant Source Tree
- `/frontend/src/components/DocumentStorage.tsx` - Existing document upload component
- `/frontend/src/components/ui/` - Radix UI component library (35+ components)
- `/frontend/src/lib/api.ts` - Centralized API client with TanStack Query integration
- `/frontend/src/hooks/` - Custom React hooks directory
- `/backend/src/routes/document.routes.ts` - Document API endpoints
- `/backend/src/services/document.service.ts` - Document service with S3 integration
- `/backend/src/services/evidence-classification.service.ts` - NEW (created in Story 1.03)

### Design Decisions

**Polling Strategy:**
Use TanStack Query's built-in `refetchInterval` for classification polling instead of manual polling. This leverages React Query's smart caching and automatic cleanup when component unmounts.

**Optimistic UI Pattern:**
Document appears in list immediately after upload completes, then updates in-place when classification completes. This follows existing pattern in `frontend/src/components/assessment/` components.

**Component Reusability:**
EvidenceTierBadge component will be reused across multiple views:
- Document upload screen (this story)
- Assessment results (Story 1.15)
- Admin classification review (Story 1.19)

**Radix UI Components to Use:**
- `Badge` - Evidence tier indicators with color variants
- `Tooltip` - Hover explanations for tier meanings
- `Collapsible` - Expandable classification explanation panel
- `Progress` - Confidence score visualization

### Integration Points

**API Endpoints (from document.routes.ts):**
- `POST /documents/upload` - ✅ Existing upload endpoint
- `GET /documents/:id` - ✅ Existing endpoint - Use this to fetch document with classification fields
- ❌ `GET /documents/:id/classification` - **DOES NOT EXIST** - needs to be created OR use GET /documents/:id
- Document response must include: `{ id, filename, evidenceTier, tierClassificationReason, tierConfidenceScore, classifiedAt }`

**Implementation Options:**
1. **Option A (Recommended):** Create dedicated lightweight endpoint `GET /documents/:id/classification`
   - Returns only classification fields for efficient polling
   - Cleaner API design, less data transfer
2. **Option B (Workaround):** Use existing `GET /documents/:id` endpoint
   - Returns full document object, extract classification fields client-side
   - Works immediately but less efficient for polling

**TanStack Query Patterns:**
```typescript
// Query key pattern
const classificationKey = ['documents', documentId, 'classification'];

// Polling configuration
useQuery({
  queryKey: classificationKey,
  queryFn: () => api.getDocumentClassification(documentId),
  refetchInterval: (data) => {
    // Stop polling if classification complete or timed out
    if (data?.evidenceTier || timeSinceUpload > 30000) return false;
    return 2000; // Poll every 2 seconds
  },
  enabled: !!documentId && !classificationComplete
});
```

**State Management:**
Use React Hook Form for document upload form state (existing pattern). Use TanStack Query for server state (classification status). No Zustand needed for this component.

**Existing Upload Flow (from CLAUDE.md):**
1. Frontend requests presigned S3 upload URL from backend
2. Frontend uploads directly to S3 (Replit object storage)
3. Frontend confirms upload to backend
4. Backend triggers document analysis (includes classification in Story 1.03)
5. Frontend polls for classification results (NEW in this story)

### Testing

**Test File Location:**
- Component tests: `/frontend/src/components/__tests__/EvidenceTierBadge.test.tsx`
- Component tests: `/frontend/src/components/__tests__/DocumentUpload.test.tsx`
- Integration tests: `/backend/tests/integration/document-classification.spec.ts`

**Testing Frameworks:**
- Frontend: Vitest 3 + React Testing Library (to be configured)
- Backend: Vitest 3 (existing)
- TanStack Query: Mock with `QueryClientProvider` wrapper

**Test Cases:**
1. EvidenceTierBadge renders correct tier variants (Tier 0/1/2)
2. EvidenceTierBadge displays correct icons and colors
3. Tooltip shows tier description on hover
4. Document card shows loading state during classification
5. Document card updates with badge when classification completes
6. "View Classification" button toggles explanation panel
7. Classification polling stops after 30 seconds
8. Error fallback displays when classification fails
9. Batch upload shows correct progress counter
10. Screen reader announces classification completion
11. TanStack Query cache invalidates correctly

**Coverage Target:**
- Component coverage: 80%+ (focus on user interaction paths)
- Integration coverage: 90%+ (all classification scenarios)

## Change Log

| Date       | Version | Description                          | Author        |
|------------|---------|--------------------------------------|---------------|
| 2025-10-07 | 1.0     | Initial story created from PRD Epic 1 | SM (Winston)  |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent during implementation_

### Debug Log References
_To be populated by dev agent during implementation_

### Completion Notes
_To be populated by dev agent during implementation_

### File List
_To be populated by dev agent during implementation_

## QA Results

_To be populated by QA agent after implementation review_
