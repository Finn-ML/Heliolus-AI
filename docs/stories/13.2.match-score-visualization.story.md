# Story 13.2: Match Score Visualization

## Status
Draft

## Story

**As a** Premium/Enterprise user,
**I want** to see visual match scores and component breakdowns for each vendor in the comparison,
**so that** I can understand the quantitative assessment of how well each vendor matches my specific needs.

## Acceptance Criteria

1. Total match scores (0-140) displayed prominently for each vendor
2. Match quality badges shown (Excellent/Strong/Good/Partial based on score thresholds)
3. Visual chart shows baseScore breakdown (risk coverage, size fit, geo, price)
4. Visual chart shows priorityBoost breakdown (top priority, features, deployment, speed)
5. Vendor with higher score is visually highlighted
6. Graceful fallback if matchDetails missing (show static view)

## Tasks / Subtasks

- [ ] Task 1: Implement PremiumComparisonView Header with Match Scores (AC: 1, 2, 5)
  - [ ] Create PremiumComparisonView component in VendorComparison.tsx or separate file
  - [ ] Accept vendors prop with matchDetails: VendorMatchScore
  - [ ] Display total scores prominently for both vendors (vendor1.matchDetails.totalScore, vendor2.matchDetails.totalScore)
  - [ ] Calculate and display match quality badge using helper functions from vendor-matching.types.ts:
    - [ ] getMatchQuality(score): 'Excellent' (≥120), 'Strong' (≥100), 'Good' (≥80), 'Partial' (<80)
    - [ ] getMatchQualityColor(quality): color classes for badges
  - [ ] Highlight vendor with higher score: add visual indicator (border glow, background highlight)
  - [ ] Use large font sizes (text-4xl or text-5xl) for scores to emphasize importance

- [ ] Task 2: Create BaseScore Breakdown Chart Component (AC: 3)
  - [ ] Create <BaseScoreChart> component accepting baseScore: BaseScore prop
  - [ ] Use Recharts BarChart or RadialBarChart for visualization
  - [ ] Display 4 components: riskAreaCoverage (0-40), sizeFit (0-20), geoCoverage (0-20), priceScore (0-20)
  - [ ] Color code bars: use existing TailwindCSS colors (blue for risk coverage, green for size fit, purple for geo, yellow for price)
  - [ ] Add labels with actual scores and max possible (e.g., "Risk Coverage: 32/40")
  - [ ] Show totalBase score at bottom of chart
  - [ ] Make chart responsive using Recharts ResponsiveContainer

- [ ] Task 3: Create PriorityBoost Breakdown Chart Component (AC: 4)
  - [ ] Create <PriorityBoostChart> component accepting priorityBoost: PriorityBoost prop
  - [ ] Use Recharts BarChart or Progress bars for visualization
  - [ ] Display 4 components: topPriorityBoost (0-20), featureBoost (0-10), deploymentBoost (0-5), speedBoost (0-5)
  - [ ] Show matchedPriority text if present (e.g., "Covers your #1 priority: Transaction Monitoring")
  - [ ] Color code bars: use gradient colors (cyan for top priority, pink for features, etc.)
  - [ ] If missingFeatures array not empty, display warning icon with tooltip showing missing features
  - [ ] Show totalBoost score at bottom of chart
  - [ ] Make chart responsive

- [ ] Task 4: Integrate Charts into Side-by-Side Comparison Layout (AC: 3, 4, 5)
  - [ ] Create two-column grid layout for vendor comparisons
  - [ ] Left column: Vendor 1 scores + charts, Right column: Vendor 2 scores + charts
  - [ ] Add vertical divider between columns with gradient effect
  - [ ] Each column shows:
    - [ ] Vendor header (logo, name, total score, quality badge)
    - [ ] BaseScore breakdown chart
    - [ ] PriorityBoost breakdown chart
  - [ ] Highlight column of higher-scoring vendor with subtle border or background color
  - [ ] Ensure responsive design: stack vertically on mobile (<768px), side-by-side on desktop

- [ ] Task 5: Add Match Quality Badge Component (AC: 2)
  - [ ] Create <MatchQualityBadge> component accepting score: number prop
  - [ ] Use Radix Badge with color variants:
    - [ ] Excellent (≥120): bg-gradient-to-r from-green-400 to-emerald-400
    - [ ] Strong (≥100): bg-gradient-to-r from-blue-400 to-cyan-400
    - [ ] Good (≥80): bg-gradient-to-r from-yellow-400 to-orange-400
    - [ ] Partial (<80): bg-gradient-to-r from-gray-400 to-gray-500
  - [ ] Add icon from Lucide React based on quality (CheckCircle2, Check, AlertCircle, XCircle)
  - [ ] Add tooltip explaining score threshold and what it means
  - [ ] Make badge prominent (text-lg, px-4, py-2)

- [ ] Task 6: Add Graceful Fallback Logic (AC: 6)
  - [ ] Check if both vendors have matchDetails before rendering PremiumComparisonView
  - [ ] If missing, fall back to StaticComparisonView (from Story 13.1)
  - [ ] Add console warning for debugging: "Match data missing for premium comparison"
  - [ ] Show user-friendly message: "Complete priorities questionnaire to see AI-powered insights"

- [ ] Task 7: Testing (All AC)
  - [ ] Test score display: verify correct totalScore (0-140) rendered from matchDetails
  - [ ] Test badge rendering: verify correct badge for each score range
  - [ ] Test baseScore chart: verify 4 components displayed with correct values
  - [ ] Test priorityBoost chart: verify 4 components displayed, matchedPriority text shown
  - [ ] Test vendor highlighting: verify higher-scoring vendor has visual indicator
  - [ ] Test responsive design: verify layout adapts to mobile/desktop
  - [ ] Test fallback: verify static view shown when matchDetails missing

## Dev Notes

### Previous Story Insights
[Source: Story 13.1]

Story 13.1 established the premium/free feature flag pattern:
- `isPremium` boolean checks `currentPlan === 'PREMIUM' || 'ENTERPRISE'`
- `hasMatchData` checks `vendors[0]?.matchDetails && vendors[1]?.matchDetails`
- Conditional rendering: `isPremium && hasMatchData ? <PremiumComparisonView /> : <StaticComparisonView />`

This story implements the actual PremiumComparisonView component that was stubbed in 13.1.

### Data Models
[Source: frontend/src/types/vendor-matching.types.ts]

**VendorMatchScore Interface:**
```typescript
interface VendorMatchScore {
  vendorId: string;
  vendor: Vendor;
  baseScore: BaseScore;
  priorityBoost: PriorityBoost;
  totalScore: number;         // 0-140
  matchReasons: string[];
}

interface BaseScore {
  vendorId: string;
  riskAreaCoverage: number;   // 0-40 points
  sizeFit: number;            // 0-20 points
  geoCoverage: number;        // 0-20 points
  priceScore: number;         // 0-20 points
  totalBase: number;          // Sum of above (0-100)
}

interface PriorityBoost {
  vendorId: string;
  topPriorityBoost: number;   // 0-20 points
  matchedPriority?: string;   // e.g., "Transaction Monitoring"
  featureBoost: number;       // 0-10 points
  missingFeatures: string[];  // Array of missing must-have features
  deploymentBoost: number;    // 0-5 points
  speedBoost: number;         // 0-5 points
  totalBoost: number;         // Sum of above (0-40)
}
```

**Helper Functions** (already exist in vendor-matching.types.ts):
```typescript
getMatchQuality(score: number): 'Excellent' | 'Strong' | 'Good' | 'Partial'
getMatchQualityColor(quality: string): string  // Returns TailwindCSS classes
```

### Component Architecture
[Source: docs/architecture.md#ui-integration]

**Component Hierarchy:**
```
VendorComparison (root)
├─ isPremium && hasMatchData → PremiumComparisonView
│   ├─ Vendor 1 Column
│   │   ├─ Header (logo, name, score, badge)
│   │   ├─ <BaseScoreChart baseScore={vendor1.matchDetails.baseScore} />
│   │   └─ <PriorityBoostChart priorityBoost={vendor1.matchDetails.priorityBoost} />
│   └─ Vendor 2 Column
│       ├─ Header (logo, name, score, badge)
│       ├─ <BaseScoreChart baseScore={vendor2.matchDetails.baseScore} />
│       └─ <PriorityBoostChart priorityBoost={vendor2.matchDetails.priorityBoost} />
├─ else → StaticComparisonView (from Story 13.1)
```

**Chart Component Library:**
[Source: docs/architecture.md#tech-stack]

Use **Recharts 2.x** (already in dependencies):
- `BarChart`, `Bar`, `XAxis`, `YAxis`, `CartesianGrid`, `Tooltip`, `Legend` for breakdown charts
- `ResponsiveContainer` for responsive sizing
- Colors match existing TailwindCSS theme
- Example usage patterns available in existing codebase (search for "Recharts" in frontend/src/)

### Visualization Design Patterns

**BaseScore Breakdown Chart:**
- Type: Horizontal BarChart with 4 bars
- Data: `[{ name: 'Risk Coverage', value: 32, max: 40 }, ...]`
- Colors: Use `fill` prop with TailwindCSS colors (blue-500, green-500, purple-500, yellow-500)
- Tooltip: Show value/max and percentage

**PriorityBoost Breakdown Chart:**
- Type: Horizontal BarChart with 4 bars OR stacked Progress bars
- Data: `[{ name: 'Top Priority', value: 20, max: 20, matched: 'Transaction Monitoring' }, ...]`
- Colors: Gradient fills (cyan-400, pink-400, etc.)
- Special handling: Show matchedPriority text prominently above top priority bar
- Warning: If missingFeatures.length > 0, show AlertCircle icon next to feature boost bar

**Vendor Highlighting:**
- Compare `vendor1.matchDetails.totalScore` vs `vendor2.matchDetails.totalScore`
- Higher score gets: `border-2 border-green-400 bg-green-500/5` class
- Add "Best Match" badge to higher-scoring vendor

### File Locations

**Files to Modify:**
- `frontend/src/components/VendorComparison.tsx` (implement PremiumComparisonView)

**New Component Files (optional):**
- `frontend/src/components/vendor/PremiumComparisonView.tsx` (main premium view)
- `frontend/src/components/vendor/BaseScoreChart.tsx` (base score visualization)
- `frontend/src/components/vendor/PriorityBoostChart.tsx` (priority boost visualization)
- `frontend/src/components/vendor/MatchQualityBadge.tsx` (reusable badge)

**Files to Reference:**
- `frontend/src/types/vendor-matching.types.ts` (interfaces and helper functions)
- `frontend/src/components/VendorMarketplace.tsx` (existing Recharts usage patterns)

### Technical Constraints
[Source: docs/architecture.md#compatibility-requirements]

**Performance Considerations:**
- Recharts components should be memoized with React.memo to prevent unnecessary re-renders
- Keep chart data transformations outside render (useMemo for derived data)
- Responsive charts should use ResponsiveContainer with minHeight to prevent layout shifts

**Styling Consistency:**
- Match colors to existing VendorMarketplace design (cyan, pink, purple gradients)
- Use existing TailwindCSS classes for consistency
- Maintain dark theme (bg-gray-900, text-white)
- Cards should use existing Card, CardHeader, CardContent pattern from Radix UI

**Responsive Design:**
- Desktop (≥1024px): Two-column side-by-side layout
- Tablet (768-1023px): Two-column but narrower charts
- Mobile (<768px): Single-column stacked layout
- Use Tailwind responsive prefixes: `grid-cols-1 md:grid-cols-2`

### Calculation Notes
[Source: backend/src/matching/base-scorer.ts, priority-boost.ts]

**Score Calculation (Read-Only - for understanding only):**

Total Score = Base Score (0-100) + Priority Boost (0-40) = 0-140

Base Score Components:
- Risk Area Coverage: 0-40 pts (gap_count_covered / total_gaps * 40)
- Company Size Fit: 0-20 pts (exact match = 20, adjacent = 15, none = 0)
- Geographic Coverage: 0-20 pts (jurisdiction_overlap / required_jurisdictions * 20)
- Price Appropriateness: 0-20 pts (within budget = 20, 25% over = 10, over = 0)

Priority Boost Components:
- Top Priority Match: 20 pts (rank #1), 15 pts (rank #2), 10 pts (rank #3), 0 pts (no match)
- Must-Have Features: 10 pts (all features), 5 pts (most features), 0 pts (missing critical)
- Deployment Model: 5 pts (matches preference), 0 pts (doesn't match)
- Implementation Speed: 5 pts (≤90 days), 0 pts (>90 days)

These calculations are done on backend. Frontend only displays the results.

### Project Structure Notes

**Recommended Structure:**
```
frontend/src/components/
├── VendorComparison.tsx           # Main component with routing logic
├── vendor/                        # Subdirectory for vendor-related components
│   ├── StaticComparisonView.tsx  # Free tier view (from Story 13.1)
│   ├── PremiumComparisonView.tsx # Premium view (this story)
│   ├── BaseScoreChart.tsx        # Reusable chart component
│   ├── PriorityBoostChart.tsx    # Reusable chart component
│   └── MatchQualityBadge.tsx     # Reusable badge component
```

## Testing

[Source: docs/architecture.md#tech-stack - Testing Framework]

### Testing Standards

**Testing Framework:** React Testing Library + Vitest
**Test File Location:** `frontend/src/components/__tests__/VendorComparison.premium.test.tsx` (extend from Story 13.1)
**Test Pattern:** Component integration tests with mocked data

### Test Cases

1. **Match Scores Display**
   - Mock vendors with matchDetails containing totalScores (120, 85)
   - Render PremiumComparisonView
   - Assert both scores displayed prominently
   - Assert higher score (120) has visual highlight

2. **Match Quality Badges**
   - Test Excellent badge: mock score 125, assert badge shows "Excellent" with green gradient
   - Test Strong badge: mock score 105, assert badge shows "Strong" with blue gradient
   - Test Good badge: mock score 85, assert badge shows "Good" with yellow gradient
   - Test Partial badge: mock score 65, assert badge shows "Partial" with gray gradient

3. **BaseScore Chart Rendering**
   - Mock baseScore: { riskAreaCoverage: 32, sizeFit: 20, geoCoverage: 15, priceScore: 18, totalBase: 85 }
   - Render BaseScoreChart
   - Assert 4 bars rendered
   - Assert values match mock data (32/40, 20/20, 15/20, 18/20)
   - Assert totalBase displayed: 85

4. **PriorityBoost Chart Rendering**
   - Mock priorityBoost: { topPriorityBoost: 20, matchedPriority: "Transaction Monitoring", featureBoost: 10, missingFeatures: [], deploymentBoost: 5, speedBoost: 5, totalBoost: 40 }
   - Render PriorityBoostChart
   - Assert 4 components rendered
   - Assert matchedPriority text displayed: "Covers your #1 priority: Transaction Monitoring"
   - Assert totalBoost displayed: 40

5. **Missing Features Warning**
   - Mock priorityBoost with missingFeatures: ["Real-time monitoring", "API integration"]
   - Render PriorityBoostChart
   - Assert warning icon displayed
   - Assert tooltip shows missing features on hover

6. **Vendor Highlighting**
   - Mock vendor1 totalScore: 120, vendor2 totalScore: 90
   - Render PremiumComparisonView
   - Assert vendor1 column has highlight styling (border-green-400 class present)
   - Assert vendor2 column does NOT have highlight styling

7. **Responsive Layout**
   - Test desktop: assert grid-cols-2 class applied
   - Test mobile: assert grid-cols-1 class applied (or use CSS media query testing)

8. **Graceful Fallback**
   - Mock vendor1 with matchDetails, vendor2 without matchDetails
   - Render VendorComparison
   - Assert StaticComparisonView rendered instead of PremiumComparisonView
   - Assert message shown: "Complete priorities questionnaire to see AI-powered insights"

### Testing Requirements

- Use @testing-library/react render, screen, within utilities
- Mock Recharts components if they cause rendering issues in tests
- Verify chart ResponsiveContainer renders correctly
- Test accessibility: verify proper ARIA labels on charts
- No console errors or warnings

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-28 | 1.0 | Initial story creation for Epic 13: Premium Vendor Comparison - Match Score Visualization | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
_To be populated during implementation_

### Debug Log References
_To be populated during implementation_

### Completion Notes List
_To be populated during implementation_

### File List
_To be populated during implementation_

## QA Results
_To be populated by QA Agent after implementation_
