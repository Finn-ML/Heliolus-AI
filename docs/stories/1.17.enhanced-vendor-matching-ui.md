# Story 1.17: Enhanced Vendor Matching - Match Scores and Reasoning Display

## Status
**DEPRECATED** - Consolidated into Story 1.27

## Deprecation Notice
This story has been **consolidated into Story 1.27** "Enhanced Results Page - Strategy Matrix & Vendor Matching Integration" which implements vendor matching with a simpler navigation approach: Results page → Button → Marketplace (pre-filtered by matches).

**Why Deprecated:**
- New approach uses existing Marketplace page with match score filtering
- Simpler UX: Navigate to marketplace with assessmentId parameter
- Backend API already exists and is functional (`GET /api/assessments/:id/vendor-matches-v2`)
- Story 1.27 achieves same goals with less complexity

**Replacement Story:** 1.27.results-strategy-vendor-matching.md
**Date Deprecated:** 2025-10-14

## Backend API Status (Confirmed Working)
- ✅ `GET /api/assessments/:id/vendor-matches-v2` - Implemented (vendor.routes.ts:926)
  - Query params supported: `threshold` (default: 80), `limit` (default: 20)
  - Returns enhanced match scores with base + priority boost breakdown
  - **REQUIRES:** Priorities questionnaire completed (returns 400 if missing)
  - Service layer: `VendorMatchingService` fully implemented (vendor-matching.service.ts)

## Story

**As a** frontend developer,
**I want** to display vendor match scores with detailed reasoning and support vendor comparison,
**so that** users understand why vendors are recommended and can make informed selection decisions.

## Acceptance Criteria

1. **Component: EnhancedVendorCard.tsx** - Vendor card with match score
   - Props: `matchData: VendorMatchScore` (contains vendor, baseScore, priorityBoost, totalScore, matchReasons)
   - Vendor logo, name, short description
   - Large match score display: "135/140 points" with progress bar
   - Match score visualization: stacked bar showing base (green, 0-100) + boost (blue, 0-40) components
   - "Highly Relevant" / "Good Match" / "Fair Match" label based on score (≥120 / 100-119 / 80-99)
2. **Component: VendorMatchReasons.tsx** - Match reasoning badges
   - Displays each reason as a badge with icon:
     - "Covers your #1 priority: Sanctions Screening" with ⭐ icon
     - "Addresses 4 out of 4 identified gaps" with ✓ icon
     - "Has all must-have features" with ✓ icon
     - "Cloud deployment (your preference)" with ☁️ icon
   - Expandable "See scoring breakdown" section showing point allocation:
     - Base Score: 100 points (Risk Area: 40, Size Fit: 20, Geography: 20, Price: 20)
     - Priority Boost: 35 points (Top Priority: 20, Features: 10, Deployment: 5)
3. **Component: VendorComparisonView.tsx** - Side-by-side comparison
   - Select up to 3 vendors using checkbox on vendor cards
   - "Compare" button (disabled until 2+ vendors selected)
   - Comparison table with rows:
     - Match score (bar chart)
     - Gap coverage (checklist of gaps, ✓ if covered)
     - Must-have features (checklist, ✓ if present)
     - Deployment options (badges)
     - Pricing range (formatted currency)
     - Implementation timeline (days)
     - Company size fit (match indicator)
     - Geographic coverage (list of jurisdictions)
   - Highlight cells in green for "best in category" (highest score, most gaps covered, etc.)
   - "Contact Vendor" button per column
4. Vendor list sorting:
   - Default: sorted by totalScore descending (highest match first)
   - User can toggle sort: "Best Match" / "Best Price" / "Fastest Implementation"
5. Vendor list filtering:
   - Filter by priority coverage: "Show only vendors covering my #1 priority"
   - Filter by score threshold: slider (min score: 80-140)
6. Empty state: "No vendors match your criteria. Try adjusting your priorities or budget range."
7. Loading states: skeleton vendor cards while fetching matches
8. Responsive: vendor cards in grid (3 columns desktop, 2 tablet, 1 mobile)

## Tasks / Subtasks

- [ ] Create EnhancedVendorCard component (AC: 1)
  - [ ] Create `/frontend/src/components/vendor/EnhancedVendorCard.tsx`
  - [ ] Add props interface: `{ vendor, matchData }`
  - [ ] Display vendor logo with fallback to initials
  - [ ] Display vendor name and short description
  - [ ] Create large match score display: "X/140 points"
  - [ ] Add progress bar visualization (Radix Progress)
  - [ ] Create stacked bar showing base score (green) + priority boost (blue)
  - [ ] Add match quality label with conditional styling:
    - "Highly Relevant" (>120): bg-green-500
    - "Good Match" (100-120): bg-blue-500
    - "Fair Match" (80-100): bg-yellow-500
  - [ ] Integrate VendorMatchReasons component
  - [ ] Add checkbox for comparison selection
  - [ ] Add "View Full Profile" button
- [ ] Create VendorMatchReasons component (AC: 2)
  - [ ] Create `/frontend/src/components/vendor/VendorMatchReasons.tsx`
  - [ ] Display match reasons as badge list with icons (Lucide React):
    - Star icon (⭐) for priority coverage
    - CheckCircle icon (✓) for gap coverage
    - CheckCircle icon (✓) for features
    - Cloud icon (☁️) for deployment preference
  - [ ] Create expandable "See scoring breakdown" section (Radix Collapsible)
  - [ ] Display base score breakdown table:
    - Risk Area alignment: X points
    - Company size fit: X points
    - Geographic coverage: X points
    - Pricing match: X points
  - [ ] Display priority boost breakdown table:
    - Top priority coverage: X points
    - Must-have features: X points
    - Deployment preference: X points
  - [ ] Add tooltip explanations for each scoring category
- [ ] Create VendorComparisonView component (AC: 3)
  - [ ] Create `/frontend/src/components/vendor/VendorComparisonView.tsx`
  - [ ] Implement "Compare" button (disabled until 2+ vendors selected)
  - [ ] Create modal or slide-in panel for comparison view (Radix Dialog)
  - [ ] Build comparison table with dynamic columns (1 per vendor, max 3)
  - [ ] Add comparison rows:
    - Match score with bar chart visualization
    - Gap coverage checklist (✓/✗ for each gap)
    - Must-have features checklist (✓/✗ for each feature)
    - Deployment options (badge list)
    - Pricing range (formatted currency with symbols)
    - Implementation timeline (days with calendar icon)
    - Company size fit (match indicator: Excellent/Good/Fair)
    - Geographic coverage (jurisdiction list)
  - [ ] Implement "best in category" highlighting (green background)
  - [ ] Add "Contact Vendor" button per column
  - [ ] Add "Close Comparison" button
- [ ] Implement vendor list sorting (AC: 4)
  - [ ] Add sort dropdown (Radix Select) with options:
    - "Best Match" (default): sort by totalScore DESC
    - "Best Price": sort by pricing.min ASC
    - "Fastest Implementation": sort by implementationTimeline ASC
  - [ ] Implement client-side sorting logic
  - [ ] Update vendor list when sort changes
  - [ ] Persist sort preference in localStorage
- [ ] Implement vendor list filtering (AC: 5)
  - [ ] Add filter panel with collapsible sections
  - [ ] Create priority coverage filter:
    - Checkbox: "Show only vendors covering my #1 priority"
    - Filter vendors where matchReasons includes top priority
  - [ ] Create score threshold filter:
    - Slider (Radix Slider) with range 80-140
    - Label showing current threshold: "Min score: X"
    - Filter vendors where totalScore >= threshold
  - [ ] Display active filter count badge
  - [ ] Add "Clear Filters" button
  - [ ] Update vendor list dynamically as filters change
- [ ] Add empty state and loading states (AC: 6, 7)
  - [ ] Create EmptyVendorList component
  - [ ] Display message: "No vendors match your criteria"
  - [ ] Add helpful text: "Try adjusting your priorities or budget range"
  - [ ] Create skeleton vendor cards for loading state
  - [ ] Show 6 skeleton cards in grid while fetching
- [ ] Add API client integration
  - [ ] Extend `/frontend/src/lib/api.ts` with `getVendorMatches(assessmentId)` method
  - [ ] Create TanStack Query hook `useVendorMatches(assessmentId)`
  - [ ] Configure query key: `['assessments', assessmentId, 'vendor-matches']`
  - [ ] Add proper TypeScript interfaces for vendor match data
- [ ] Implement responsive design (AC: 8)
  - [ ] Desktop (≥1024px): CSS Grid with 3 columns
  - [ ] Tablet (768-1023px): CSS Grid with 2 columns
  - [ ] Mobile (<768px): Single column
  - [ ] Ensure comparison table is horizontally scrollable on mobile
  - [ ] Test vendor cards are touch-friendly
- [ ] Add comparison selection state management
  - [ ] Create local state for selected vendors (max 3)
  - [ ] Add checkbox to each vendor card
  - [ ] Update "Compare" button enabled state
  - [ ] Display selection counter: "X vendors selected"
  - [ ] Add "Clear Selection" button when vendors selected
  - [ ] Show warning if user tries to select 4th vendor

## Dev Notes

### Relevant Source Tree
- `/frontend/src/components/vendor/` - Vendor-related components directory
- `/frontend/src/components/VendorMarketplace.tsx` - Existing vendor marketplace component
- `/frontend/src/components/VendorComparison.tsx` - Existing comparison component (to be enhanced)
- `/frontend/src/components/ui/` - Radix UI component library
- `/frontend/src/lib/api.ts` - Centralized API client
- `/backend/src/routes/vendor.routes.ts` - Vendor API endpoints (29KB)
- `/backend/src/services/enhanced-vendor-matching.service.ts` - NEW (created in Story 1.09)

### Design Decisions

**Match Score Calculation (from backend):**
- Base Score (0-100 points):
  - Risk area alignment: 40 points max
  - Company size fit: 20 points max
  - Geographic coverage: 20 points max
  - Pricing match: 20 points max
- Priority Boost (0-40 points):
  - Top priority coverage: 20 points max
  - Must-have features: 10 points max
  - Deployment preference: 5 points max
  - Integration availability: 5 points max
- Total Score: Base + Boost (0-140 points)

**Match Quality Thresholds:**
- Highly Relevant: 120+ points (86%+)
- Good Match: 100-119 points (71-85%)
- Fair Match: 80-99 points (57-70%)
- Below 80: Not displayed by default

**Data Structure (from API):**
```typescript
interface VendorMatch {
  vendor: Vendor;
  matchData: {
    baseScore: number; // 0-100
    priorityBoost: number; // 0-40
    totalScore: number; // 0-140
    matchReasons: Array<{
      type: 'priority' | 'gaps' | 'features' | 'deployment' | 'integration';
      label: string;
      icon: string;
    }>;
    scoreBreakdown: {
      base: {
        riskArea: number;
        sizeFit: number;
        geography: number;
        pricing: number;
      };
      boost: {
        topPriority: number;
        features: number;
        deployment: number;
        integration: number;
      };
    };
    gapsCovered: string[]; // gap IDs
  };
}
```

**Stacked Bar Visualization:**
Use two-segment progress bar with distinct colors:
```typescript
<div className="relative h-4 w-full bg-gray-200 rounded-full overflow-hidden">
  <div
    className="absolute top-0 left-0 h-full bg-green-500"
    style={{ width: `${(baseScore / 140) * 100}%` }}
  />
  <div
    className="absolute top-0 h-full bg-blue-500"
    style={{
      left: `${(baseScore / 140) * 100}%`,
      width: `${(priorityBoost / 140) * 100}%`
    }}
  />
</div>
```

### Integration Points

**API Endpoints (from vendor.routes.ts):**
- ✅ `GET /api/assessments/:id/vendor-matches-v2` - Implemented (vendor.routes.ts:926)
  - **IMPORTANT:** Note the `/api` prefix for correct routing
  - Query parameters:
    - `threshold` (optional, default: 80): Minimum match score to include (0-140 scale)
    - `limit` (optional, default: 20): Maximum number of vendors to return
  - Returns enhanced match data with priority boost breakdown
  - **Requires priorities questionnaire** - Returns 400 error if priorities not completed
  - Frontend must handle 400 error and redirect to priorities questionnaire

**Integration Verification (from PRD):**
- **IV1:** Vendor cards display correct vendor profile information from existing vendor database
- **IV2:** Gap coverage checklist matches gaps identified in Gap Analysis tab

**Radix UI Components to Use:**
- `Card` - Vendor cards
- `Progress` - Match score visualization
- `Badge` - Match reasons, deployment options
- `Collapsible` - Expandable scoring breakdown
- `Dialog` - Comparison modal
- `Checkbox` - Vendor selection for comparison
- `Select` - Sort dropdown
- `Slider` - Score threshold filter
- `Tooltip` - Scoring category explanations

**API Response Schema:**
```typescript
interface VendorMatchesV2Response {
  success: boolean;
  data: {
    vendors: VendorMatchScore[];
    count: number;
    threshold: number;
    generatedAt: Date;
  };
}

interface VendorMatchScore {
  vendorId: string;
  vendor: Vendor;  // Full vendor object
  baseScore: {
    riskAreaCoverage: number;  // 0-40 points: Gap category alignment
    sizeFit: number;           // 0-20 points: Company size match
    geoCoverage: number;       // 0-20 points: Geographic coverage
    priceScore: number;        // 0-20 points: Budget alignment
    totalBase: number;         // Sum of above (0-100)
  };
  priorityBoost: {
    topPriorityBoost: number;    // 0-20 points: #1/#2/#3 priority match
    matchedPriority?: string;    // Name of matched priority
    featureBoost: number;        // 0-10 points: Must-have features
    missingFeatures: string[];   // List of missing features
    deploymentBoost: number;     // 0-5 points: Deployment preference
    speedBoost: number;          // 0-5 points: Fast implementation
    totalBoost: number;          // Sum of above (0-40)
  };
  totalScore: number;            // baseScore.totalBase + priorityBoost.totalBoost (0-140)
  matchReasons: string[];        // Human-readable match explanations (5-8 items)
}
```

**TanStack Query Integration:**
```typescript
const { data: vendorMatches, isLoading, error } = useQuery({
  queryKey: ['assessments', assessmentId, 'vendor-matches-v2', threshold],
  queryFn: () => api.getVendorMatchesV2(assessmentId, threshold, limit),
  staleTime: 5 * 60 * 1000, // 5 minutes
  enabled: !!assessmentId && hasPriorities,
  retry: (failureCount, error) => {
    // Don't retry if priorities missing (400 error)
    if (error?.response?.status === 400) return false;
    return failureCount < 3;
  }
});

// Handle priorities missing error
if (error?.response?.status === 400) {
  // Redirect to priorities questionnaire
  navigate(`/assessments/${assessmentId}/priorities`);
}
```

**Comparison Table Structure:**
```typescript
const comparisonRows = [
  { label: 'Match Score', key: 'totalScore', type: 'bar-chart' },
  { label: 'Gap Coverage', key: 'gapsCovered', type: 'checklist' },
  { label: 'Must-Have Features', key: 'features', type: 'checklist' },
  { label: 'Deployment', key: 'deployment', type: 'badges' },
  { label: 'Pricing', key: 'pricing', type: 'currency' },
  { label: 'Implementation', key: 'timeline', type: 'days' },
  { label: 'Size Fit', key: 'sizeFit', type: 'indicator' },
  { label: 'Geography', key: 'geography', type: 'list' }
];
```

### Existing Patterns to Follow

**Vendor Card Pattern:**
Enhance existing `VendorCard` pattern from `VendorMarketplace.tsx`. Add match score display while keeping existing layout structure.

**Comparison Pattern:**
Enhance existing `VendorComparison.tsx` component. Add new comparison rows while maintaining existing comparison logic.

**Filter Pattern:**
Follow existing filter patterns from marketplace. Use collapsible filter sections for better UX.

**Selection State:**
Use React state for vendor selection (not Zustand). Selection is temporary UI state that doesn't need global persistence.

### Testing

**Test File Location:**
- Component tests: `/frontend/src/components/__tests__/EnhancedVendorCard.test.tsx`
- Component tests: `/frontend/src/components/__tests__/VendorComparisonView.test.tsx`
- Integration tests: `/backend/tests/integration/enhanced-vendor-matching.spec.ts`

**Testing Frameworks:**
- Vitest 3 + React Testing Library
- Mock TanStack Query with QueryClientProvider
- Mock vendor data with realistic match scores

**Test Cases:**
1. EnhancedVendorCard displays vendor info correctly
2. Match score displays with correct format (X/140 points)
3. Progress bar shows correct percentage
4. Stacked bar shows base score and boost correctly
5. Match quality label displays correct tier and color
6. VendorMatchReasons displays all reason badges
7. Reason badges show correct icons
8. "See scoring breakdown" expands to show points table
9. Comparison checkbox toggles vendor selection
10. "Compare" button disabled when <2 vendors selected
11. "Compare" button enabled when 2-3 vendors selected
12. Cannot select more than 3 vendors
13. Comparison table displays all rows correctly
14. Gap coverage checklist shows ✓/✗ correctly
15. "Best in category" highlighting works
16. "Contact Vendor" button triggers action
17. Sort dropdown changes vendor order
18. Priority filter removes non-matching vendors
19. Score threshold slider filters correctly
20. "Clear Filters" button resets all filters
21. Empty state displays when no vendors match
22. Loading state shows skeleton cards
23. Responsive grid works on desktop/tablet/mobile
24. Comparison table is horizontally scrollable on mobile
25. Data consistency: gap coverage matches Gap Analysis (IV2)

**Coverage Target:**
- Component coverage: 85%+ (comprehensive vendor matching UI testing)
- Integration coverage: 90%+ (all match score scenarios)

## Change Log

| Date       | Version | Description                          | Author        |
|------------|---------|--------------------------------------|---------------|
| 2025-10-07 | 1.0     | Initial story created from PRD Epic 1 | SM (Winston)  |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent during implementation_

### Debug Log References
_To be populated by dev agent during implementation_

### Completion Notes
_To be populated by dev agent during implementation_

### File List
_To be populated by dev agent during implementation_

## QA Results

_To be populated by QA agent after implementation review_
