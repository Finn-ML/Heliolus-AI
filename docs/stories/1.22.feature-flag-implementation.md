# Story 1.22: Feature Flag Implementation and Rollout Strategy

## Status
Draft - **Consider Simplification**

## Simplification Notice
This story may be **over-engineered for current needs**. The complex percentage-based rollout and organization overrides may not be necessary given the simpler `/execute` endpoint approach.

**Alternative Simpler Approach:**
- Use basic boolean env var: `ENHANCED_FEATURES_ENABLED=true/false`
- Skip percentage rollout complexity
- Skip organization-level overrides
- All users get same experience (simpler testing/support)

**Decision Needed:** Do you need gradual rollout capability, or can we launch with simple on/off toggle?

**If keeping this story:** Implement after core features (1.27, 1.14) are stable.
**Estimated:** 2 days (simplified) or 4-5 days (full complexity)

## Story

**As a** backend developer,
**I want** to implement feature flags controlling enhanced assessment features and configure gradual rollout,
**so that** we can safely deploy to production and enable features progressively for testing.

## Acceptance Criteria

1. **Environment Variable Feature Flag:**
   - Add `ENHANCED_SCORING_ENABLED` env var (values: "true" | "false" | "percentage:X")
   - Default: "false" (enhanced features disabled)
   - "percentage:X" mode: enable for X% of users (hashed by userId for consistency)
2. **Database-Level Override:**
   - Add `featureFlags` JSON field to Organization model (nullable)
   - Example: `{ "enhancedScoring": true }` overrides env var for specific organization
   - Admin can enable/disable per organization via admin panel
3. **Feature Flag Service:**
   - New utility file `backend/src/lib/feature-flags.ts`
   - Method `isEnhancedScoringEnabled(userId: string, organizationId?: string): boolean`
   - Logic:
     1. Check organization.featureFlags if organizationId provided (highest priority)
     2. Check env var ENHANCED_SCORING_ENABLED
     3. If "percentage:X": hash userId, return true if hash % 100 < X
     4. Default: false
4. **Assessment Creation Flag:**
   - When creating assessment, set `scoringMethodology: "complete" | "unavailable"` based on feature flag (if flag enabled: "complete", if disabled: "unavailable")
   - Store methodology on Assessment model (new field: `scoringMethodology: String`)
   - Methodology determines which scoring path to use throughout assessment lifecycle
5. **API Conditional Logic:**
   - Assessment completion: if methodology="complete", run evidence classification and weighted scoring
   - Assessment results endpoint: return scoring fields if methodology="complete"
   - Priorities endpoint: only available if methodology="complete" (return 400 if unavailable)
   - Vendor matches v2 endpoint: only available if methodology="complete"
6. **Frontend Feature Detection:**
   - Check assessment.scoringMethodology field
   - Conditionally render enhanced UI components
   - Show "not available" message if methodology="unavailable"
7. **Rollout Configuration File:**
   - Create `backend/config/rollout-schedule.json`:
     ```json
     {
       "phase1_internal": { "percentage": 0, "organizations": ["org_internal_test"] },
       "phase2_beta": { "percentage": 0, "organizations": ["org_beta_1", "org_beta_2", ...] },
       "phase3_gradual": { "percentage": 10 },
       "phase4_majority": { "percentage": 50 },
       "phase5_full": { "percentage": 100 }
     }
     ```
8. **Monitoring Dashboard:**
   - Admin page showing:
     - Current rollout phase
     - Number of organizations with enhanced scoring enabled
     - Number of assessments created with methodology="complete"
     - Feature flag override list

## Tasks / Subtasks

- [ ] Add ENHANCED_SCORING_ENABLED environment variable (AC: 1)
  - [ ] Update backend/.env.example with ENHANCED_SCORING_ENABLED
  - [ ] Add validation in backend config to parse "true" | "false" | "percentage:X"
  - [ ] Document environment variable in README
- [ ] Extend Organization model with featureFlags field (AC: 2)
  - [ ] Add featureFlags field (Json?, nullable) to Prisma schema
  - [ ] Generate Prisma migration
  - [ ] Test migration on local database
- [ ] Create feature-flags.ts utility service (AC: 3)
  - [ ] Create backend/src/lib/feature-flags.ts
  - [ ] Implement isEnhancedScoringEnabled() with priority logic
  - [ ] Implement hash function for percentage-based rollout (consistent by userId)
  - [ ] Add unit tests for all logic paths
- [ ] Extend Assessment model with scoringMethodology field (AC: 4)
  - [ ] Add scoringMethodology field (String, default "unavailable") to Prisma schema
  - [ ] Generate Prisma migration
  - [ ] Update assessment creation logic to set methodology based on feature flag
- [ ] Add conditional logic to API endpoints (AC: 5)
  - [ ] Update assessment completion logic: check methodology before running enhanced scoring
  - [ ] Update GET /assessments/:id/results: conditionally include enhanced fields
  - [ ] Update POST/GET /assessments/:id/priorities: return 400 if methodology="unavailable"
  - [ ] Update GET /assessments/:id/vendor-matches-v2: return 400 if methodology="unavailable"
  - [ ] Add error message: "Enhanced features not available for this assessment"
- [ ] Update frontend to detect and handle feature flags (AC: 6)
  - [ ] Check assessment.scoringMethodology in frontend components
  - [ ] Conditionally render PrioritiesQuestionnaire component
  - [ ] Conditionally render StrategyMatrixTimeline component
  - [ ] Conditionally render EvidenceTierBadge components
  - [ ] Show "not available" message with upgrade prompt if methodology="unavailable"
- [ ] Create rollout configuration file (AC: 7)
  - [ ] Create backend/config/rollout-schedule.json with 5 phases
  - [ ] Add helper function to read current phase from config
  - [ ] Document rollout process in deployment guide
- [ ] Build admin monitoring dashboard (AC: 8)
  - [ ] Create admin page: /admin/feature-flags
  - [ ] Display current rollout phase from rollout-schedule.json
  - [ ] Query and display count of organizations with featureFlags.enhancedScoring=true
  - [ ] Query and display count of assessments with methodology="complete"
  - [ ] Show list of organizations with feature flag overrides
  - [ ] Add button to enable/disable feature flag for specific organization

## Dev Notes

### Relevant Source Tree
- `backend/src/lib/feature-flags.ts` - New feature flag utility (create new file)
- `backend/src/config/` - Configuration directory
- `backend/config/rollout-schedule.json` - Rollout configuration (create new file)
- `backend/prisma/schema.prisma` - Prisma schema (extend Organization and Assessment models)
- `backend/src/services/assessment.service.ts` - Assessment orchestration (60KB, update creation logic)
- `backend/src/routes/assessment.routes.ts` - Assessment API endpoints (72KB, add conditional logic)
- `backend/src/routes/admin.routes.ts` - Admin API endpoints (48KB, add feature flag management)
- `frontend/src/components/assessment/` - Assessment UI components (conditionally render)
- `frontend/src/lib/api.ts` - API client (handle methodology field)

### Feature Flag Strategy

**Three-Tier Override System:**
1. **Organization-level override (highest priority):** Admin can force-enable or force-disable for specific organizations via database field
2. **Environment variable (medium priority):** Controls global rollout percentage or full enable/disable
3. **Default (lowest priority):** Enhanced features disabled by default

**Percentage-Based Rollout:**
Use consistent hashing to ensure same user always gets same result:
```typescript
const hash = createHash('sha256').update(userId).digest('hex');
const userPercent = parseInt(hash.substring(0, 8), 16) % 100;
return userPercent < targetPercentage;
```

**Assessment-Level Locking:**
Once an assessment is created with a specific methodology, it NEVER changes. This prevents confusion where user starts assessment with enhanced features, then features disappear mid-assessment.

**Frontend Feature Detection:**
Frontend should NEVER check feature flags directly. Always check the assessment.scoringMethodology field returned by API. This ensures frontend state matches backend state.

**Gradual Rollout Phases:**
- Phase 1 (Internal): 0% general population, specific internal test organization only
- Phase 2 (Beta): 0% general population, specific beta customer organizations only
- Phase 3 (Gradual): 10% of all users (random by userId hash)
- Phase 4 (Majority): 50% of all users
- Phase 5 (Full): 100% of all users

**Instant Rollback:**
To disable enhanced features instantly, set ENHANCED_SCORING_ENABLED="false". All NEW assessments will use legacy methodology. Existing enhanced assessments continue to work.

### Integration Points

**Services Using Feature Flags:**
- assessment.service.ts - Check flag during assessment creation
- weighted-scoring.service.ts - Only called if methodology="complete"
- evidence-classification.service.ts - Only called if methodology="complete"
- priorities.service.ts - Only called if methodology="complete"
- vendor-matching.service.ts - Only called if methodology="complete" (v2 endpoint)

**API Endpoints Requiring Conditional Logic:**
- POST /api/assessments - Set methodology based on feature flag
- GET /api/assessments/:id/results - Conditionally include enhanced fields
- POST /api/assessments/:id/priorities - Reject if methodology="unavailable"
- GET /api/assessments/:id/priorities - Reject if methodology="unavailable"
- GET /api/assessments/:id/vendor-matches-v2 - Reject if methodology="unavailable"
- GET /api/assessments/:id/strategy-matrix - Reject if methodology="unavailable"

**Admin Endpoints:**
- GET /api/admin/feature-flags - Return current rollout status
- PUT /api/admin/organizations/:id/feature-flags - Set organization override
- DELETE /api/admin/organizations/:id/feature-flags - Remove organization override

### Database Schema Changes

**Organization Model:**
```prisma
model Organization {
  // ... existing fields
  featureFlags Json?  // { "enhancedScoring": true }
}
```

**Assessment Model:**
```prisma
model Assessment {
  // ... existing fields
  scoringMethodology String @default("unavailable")  // "complete" | "unavailable"
}
```

### Testing

**Location:** `backend/tests/unit/feature-flags.spec.ts` and `backend/tests/integration/feature-flag-rollout.spec.ts`

**Testing Frameworks:**
- Vitest 3 for test execution
- Fastify inject for API testing
- Prisma test client for database operations

**Test Cases:**

**Unit Tests (feature-flags.ts):**
1. isEnhancedScoringEnabled() returns false when env var not set
2. isEnhancedScoringEnabled() returns true when env var="true"
3. isEnhancedScoringEnabled() returns false when env var="false"
4. isEnhancedScoringEnabled() returns true for 15% of users when env var="percentage:15"
5. isEnhancedScoringEnabled() returns same result for same userId (consistent hashing)
6. Organization override=true overrides env var="false"
7. Organization override=false overrides env var="true"
8. Organization override has highest priority in decision tree

**Integration Tests (feature-flag-rollout.spec.ts):**
1. Create assessment with flag enabled, verify methodology="complete"
2. Create assessment with flag disabled, verify methodology="unavailable"
3. POST /priorities with methodology="unavailable" returns 400 error
4. GET /results with methodology="complete" includes enhanced fields
5. GET /results with methodology="unavailable" excludes enhanced fields
6. Admin can set organization override via API
7. Admin can view feature flag dashboard data
8. Percentage rollout distributes users correctly (~10% when set to 10%)

**Coverage Target:** ≥90% code coverage for feature-flags.ts utility (critical business logic)

**Integration Verification:**
- E2E test: Enable flag → Create assessment → Verify enhanced features available
- E2E test: Disable flag → Create assessment → Verify enhanced features unavailable
- E2E test: Enable organization override → Create assessment → Verify enhanced features available regardless of global flag

## Change Log

| Date       | Version | Description                          | Author        |
|------------|---------|--------------------------------------|---------------|
| 2025-10-07 | 1.0     | Initial story created from PRD Epic 1 | SM (Winston)  |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent during implementation_

### Debug Log References
_To be populated by dev agent during implementation_

### Completion Notes
_To be populated by dev agent during implementation_

### File List
_To be populated by dev agent during implementation_

## QA Results

_To be populated by QA agent after implementation review_
