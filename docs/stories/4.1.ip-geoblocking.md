# Story 4.1: Implement IP Geoblocking Middleware

## Status
Ready for Review

## Story
**As a** platform administrator,
**I want** requests from sanctioned countries (Iran and Russia) to be automatically blocked,
**so that** we comply with international sanctions and reduce security risks.

## Acceptance Criteria
1. All HTTP requests are checked for country of origin based on IP address
2. Requests from Iran (country code: IR) return HTTP 403 Forbidden
3. Requests from Russia (country code: RU) return HTTP 403 Forbidden
4. Blocked requests include clear error message indicating geo-restriction
5. Blocked requests are logged with IP, country, timestamp, and attempted endpoint
6. Geoblocking check occurs before authentication middleware (blocks before any processing)
7. Internal/localhost IPs are exempt from geoblocking
8. Error response includes appropriate headers (no sensitive information leaked)
9. Performance impact is minimal (<5ms per request)
10. Configuration allows easy addition/removal of blocked countries

## Tasks / Subtasks

- [x] **Task 1: Install and configure geoip-lite dependency** (AC: 1, 9)
  - [x] Install `geoip-lite` package via npm
  - [x] Verify package installation and database size (~10MB)
  - [x] Test basic IP lookup functionality

- [x] **Task 2: Create geoblocking middleware** (AC: 1, 2, 3, 4, 7, 8, 10)
  - [x] Create new file: `backend/src/middleware/geoblocking.middleware.ts`
  - [x] Implement IP extraction from request (handle X-Forwarded-For, X-Real-IP)
  - [x] Implement GeoIP lookup using geoip-lite
  - [x] Handle localhost/internal IPs (127.0.0.1, ::1, 10.x.x.x, 192.168.x.x)
  - [x] Implement country code checking against blocked list
  - [x] Define blocked countries array: ['IR', 'RU'] as configurable constant
  - [x] Return 403 response with appropriate error message
  - [x] Add TypeScript types for middleware function
  - [x] Handle null/undefined cases from GeoIP lookup gracefully

- [x] **Task 3: Integrate middleware into server** (AC: 6)
  - [x] Import geoblocking middleware in `backend/src/server.ts`
  - [x] Register middleware as global preHandler (before authentication)
  - [x] Ensure middleware runs before all route handlers
  - [x] Verify middleware order: logging → geoblocking → authentication → routes

- [x] **Task 4: Add request logging for blocked IPs** (AC: 5)
  - [x] Log blocked requests with: IP address, country code, timestamp, attempted path
  - [x] Use Fastify's built-in logger for consistency
  - [x] Ensure no sensitive data (tokens, passwords) in logs
  - [x] Use appropriate log level (warn or info)

- [x] **Task 5: Write unit tests** (AC: All)
  - [x] Test file: `backend/tests/unit/geoblocking.middleware.test.ts`
  - [x] Test case: Blocks Iran (IR) IPs with 403
  - [x] Test case: Blocks Russia (RU) IPs with 403
  - [x] Test case: Allows US IPs through
  - [x] Test case: Allows localhost/127.0.0.1
  - [x] Test case: Allows internal IPs (192.168.x.x, 10.x.x.x)
  - [x] Test case: Handles IPv6 addresses correctly
  - [x] Test case: Handles missing GeoIP data gracefully (allows by default)
  - [x] Test case: Error response format includes correct message
  - [x] Test case: Performance < 5ms per request

- [x] **Task 6: Integration testing** (AC: All)
  - [x] Test file: `backend/tests/integration/geoblocking.integration.test.ts`
  - [x] Test full request flow with mocked IPs from blocked countries
  - [x] Verify middleware runs before authentication
  - [x] Test that allowed IPs reach routes normally
  - [x] Verify logging output for blocked requests

- [x] **Task 7: Documentation** (AC: 10)
  - [x] Document middleware configuration in code comments
  - [x] Add JSDoc comments for all exported functions
  - [x] Document how to add/remove countries from block list

## Dev Notes

### Previous Story Insights
No previous stories exist - this is the first story in the project.

### Tech Stack & Framework
[Source: CLAUDE.md#Tech Stack]
- **Backend Framework**: Fastify 4 with TypeScript 5.2
- **Node Version**: >= 18.0.0
- **Testing Framework**: Vitest 3
- **Existing Middleware**: @fastify/helmet, @fastify/cors, @fastify/rate-limit
- **Request Logging**: Fastify built-in logger with Pino

### Project Structure
[Source: CLAUDE.md#Project Structure]
- **Middleware Location**: `backend/src/middleware/`
- **Middleware Files**:
  - `error.middleware.ts` - Error handling
  - `auth.state.ts` - Auth state management
  - `rbac.middleware.ts` - Role-based access control
  - `anonymous-session.middleware.ts` - Anonymous sessions
- **Server Setup**: `backend/src/server.ts` - Fastify server initialization
- **Test Location**: `backend/tests/`
  - Unit tests: `backend/tests/unit/`
  - Integration tests: `backend/tests/integration/`

### Middleware Implementation Pattern
[Source: server.ts]
```typescript
// Middleware are registered in server.ts in setupPlugins() or setupMiddleware()
// Global middleware use server.addHook('preHandler', middlewareFunction)
// Route-specific middleware use preHandler option in route definition

// Example from existing code:
import { loggingMiddleware, authenticationMiddleware } from './middleware';

// Middleware order matters:
// 1. Logging (first)
// 2. Security middleware (helmet, cors)
// 3. Geoblocking (NEW - should go here, before auth)
// 4. Authentication
// 5. Route handlers
```

### IP Extraction
[Source: CLAUDE.md#Infrastructure]
- Server runs with `trustProxy: true` in production
- Request IPs available from:
  - `request.ip` - Fastify's extracted IP
  - `request.headers['x-forwarded-for']` - Proxy forwarded IP
  - `request.headers['x-real-ip']` - Alternative proxy header
- Must handle both IPv4 and IPv6

### GeoIP Library Selection
[Source: Epic 4.1 Technical Notes]
- **Library**: `geoip-lite` (not geoip2 or other alternatives)
- **Pros**:
  - Free, no API key needed
  - No external API calls (0 latency)
  - ~10MB local database
  - IPv4 and IPv6 support
  - Auto-updates database
- **Cons**:
  - Accuracy ~95% (acceptable for this use case)
  - Database size adds to deployment

### Blocked Countries Configuration
[Source: Epic 4.1 AC]
```typescript
// Define as constant array for easy modification
const BLOCKED_COUNTRIES = ['IR', 'RU'];  // Iran, Russia
// ISO 3166-1 alpha-2 country codes
// geoip-lite returns country code in uppercase
```

### Error Response Format
[Source: CLAUDE.md#API Architecture]
Standard error response pattern:
```typescript
{
  message: string;  // Human-readable error
  code: string;     // Error code for client handling
  statusCode: number;
  timestamp: string; // ISO 8601
}

// Example for geoblocking:
{
  message: 'Access denied from your location',
  code: 'GEO_BLOCKED',
  statusCode: 403,
  timestamp: '2025-10-21T14:30:00.000Z'
}
```

### Performance Requirements
[Source: Epic 4.1 AC#9]
- Target: <5ms per request overhead
- GeoIP lookup is in-memory (fast)
- No database or API calls
- Minimal processing overhead
- Test with Vitest performance assertions

### Security Considerations
[Source: CLAUDE.md#Security Implementation]
- **No Information Leakage**: Error message should not reveal internal details
- **Logging**: Log blocked attempts for audit trail
- **Fail Open**: If GeoIP lookup fails, allow request (don't block legitimate users)
- **IP Spoofing**: Trust proxy headers only in production (trustProxy: true)
- **Internal Networks**: Exempt localhost and RFC 1918 private IPs

### Testing Requirements

#### Unit Tests (Vitest)
[Source: CLAUDE.md#Testing Infrastructure]
- Test file location: `backend/tests/unit/geoblocking.middleware.test.ts`
- Framework: Vitest 3
- Mock `geoip-lite` lookup function
- Test all edge cases:
  - Blocked countries return 403
  - Allowed countries pass through
  - Localhost/internal IPs exempt
  - IPv6 support
  - Null/undefined GeoIP results (fail open)
  - Performance assertions (<5ms)

#### Integration Tests
[Source: CLAUDE.md#Testing Infrastructure]
- Test file location: `backend/tests/integration/geoblocking.integration.test.ts`
- Test with actual Fastify server instance
- Mock IP addresses in request headers
- Verify middleware execution order
- Test logging output
- Verify 403 response format matches API standard

### TypeScript Types
```typescript
// Add to types/index.ts or middleware file
interface GeoBlockingOptions {
  blockedCountries: string[];
  exemptIPs?: string[];
}

interface GeoIPResult {
  country: string;
  region?: string;
}
```

### Deployment Considerations
[Source: CLAUDE.md#Infrastructure]
- Docker: geoip-lite database included in container image
- Database updates: Consider periodic updates via package updates
- Environment variable: Could make blocked countries configurable via env var
- No infrastructure changes needed (pure application layer)

## Testing

### Test File Locations
- Unit tests: `backend/tests/unit/geoblocking.middleware.test.ts`
- Integration tests: `backend/tests/integration/geoblocking.integration.test.ts`

### Testing Framework
[Source: CLAUDE.md#Testing Infrastructure]
- **Framework**: Vitest 3
- **Test Commands**:
  - Run all tests: `npm run test` (from backend/)
  - Run specific file: `npx vitest run geoblocking`
  - Watch mode: `npx vitest watch`

### Required Test Cases
1. **Blocked Countries** - Verify 403 for IR and RU
2. **Allowed Countries** - Verify pass-through for US, EU, etc.
3. **Localhost Exemption** - 127.0.0.1, ::1 allowed
4. **Private IPs** - 192.168.x.x, 10.x.x.x, 172.16-31.x.x allowed
5. **IPv6 Support** - Test both IPv4 and IPv6 addresses
6. **GeoIP Failure** - Null/undefined results allow access (fail open)
7. **Error Response Format** - Validate 403 response structure
8. **Logging** - Verify blocked requests are logged correctly
9. **Performance** - Assert <5ms execution time
10. **Middleware Order** - Runs before authentication in integration test

### Test Coverage Target
- Aim for 100% code coverage for middleware file
- All branches (blocked/allowed paths) tested
- All edge cases (localhost, private IPs, IPv6) covered

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-21 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-10-21 | 1.1 | Story implementation completed - all tasks done, 35 tests passing | Dev Agent (James) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
- Unit tests: All 19 tests passing
- Integration tests: All 16 tests passing
- Total geoblocking tests: 35 passing
- GeoIP library verification: Successfully tested with IP 8.8.8.8 → US

### Completion Notes List
1. **Dependency Installation**: Installed geoip-lite package (~10MB database)
2. **Middleware Implementation**: Created geoblocking.middleware.ts with:
   - IP extraction from X-Forwarded-For, X-Real-IP, and request.ip
   - GeoIP lookup using geoip-lite
   - Localhost/private IP exemptions (RFC 1918)
   - Fail-open design (allows traffic if GeoIP lookup fails)
   - Comprehensive logging for blocked requests
   - Performance monitoring (warns if >5ms)
3. **Server Integration**: Added middleware as preHandler hook in server.ts
   - Middleware order: logging → geoblocking → authentication
4. **Testing**: Created comprehensive test suites:
   - Unit tests: 19 tests covering all edge cases
   - Integration tests: 16 tests with full Fastify server
5. **Documentation**: Added JSDoc comments to all functions and configuration examples

### File List
**Created:**
- `backend/src/middleware/geoblocking.middleware.ts` - Main middleware implementation (172 lines)
- `backend/tests/unit/geoblocking.middleware.test.ts` - Unit tests (425 lines, 19 tests)
- `backend/tests/integration/geoblocking.integration.test.ts` - Integration tests (389 lines, 16 tests)

**Modified:**
- `backend/src/server.ts` - Added geoblocking middleware import and registration
- `backend/package.json` - Added geoip-lite dependency

## QA Results
_To be filled by QA Agent_
