# Story 10.2: Bulk User Operations

## Status
Draft

## Story

**As an** admin
**I want** to perform actions on multiple users at once
**So that** I can efficiently manage large user sets

## Acceptance Criteria

1. Add checkbox column to user table (select individual users)
2. "Select All" checkbox in header (selects all visible users on current page)
3. When users selected, show floating action bar with:
   - Count: "X users selected"
   - Actions: "Suspend", "Activate", "Delete"
   - "Clear Selection" button
4. Bulk suspend action:
   - Confirmation dialog: "Suspend X users?"
   - `POST /v1/admin/users/bulk-suspend` with `userIds: string[]`
   - Updates status to SUSPENDED for all selected users
   - Shows toast: "X users suspended"
5. Bulk activate action:
   - Confirmation dialog: "Activate X users?"
   - `POST /v1/admin/users/bulk-activate` with `userIds: string[]`
   - Updates status to ACTIVE for all selected users
   - Shows toast: "X users activated"
6. Bulk delete action:
   - DESTRUCTIVE confirmation dialog: "Permanently delete X users? This cannot be undone."
   - User must type "DELETE" to confirm
   - `POST /v1/admin/users/bulk-delete` with `userIds: string[]`
   - Soft deletes users (status = DELETED)
   - Shows toast: "X users deleted"
7. All bulk operations refresh user list and stats after completion
8. Maximum 100 users per bulk operation (enforce on frontend and backend)

## Tasks / Subtasks

- [ ] Task 1: Add Selection UI to User Table (AC: 1, 2, 3)
  - [ ] Add checkbox column to table in `frontend/src/pages/admin/UserManagement.tsx`
    - [ ] Add state: `const [selectedUserIds, setSelectedUserIds] = useState<string[]>([])`
    - [ ] Add checkbox to header for "Select All"
    - [ ] Add checkbox to each table row
    - [ ] Handle individual checkbox toggle
    - [ ] Handle "Select All" toggle (selects all visible users on page)
  - [ ] Create floating action bar component
    - [ ] Show count: "{selectedUserIds.length} users selected"
    - [ ] Add "Suspend" button (visible when selection has ACTIVE users)
    - [ ] Add "Activate" button (visible when selection has SUSPENDED users)
    - [ ] Add "Delete" button (destructive styling)
    - [ ] Add "Clear Selection" button
    - [ ] Position: Fixed bottom, centered, with slide-up animation
  - [ ] Show/hide action bar based on selection state
  - [ ] Add 100 user limit validation with warning toast

- [ ] Task 2: Implement Bulk Suspend Backend (AC: 4)
  - [ ] Add `bulkSuspendUsers` method to `backend/src/services/user.service.ts`
    - [ ] Accept `userIds: string[]` parameter
    - [ ] Validate max 100 users
    - [ ] Verify all users exist
    - [ ] Use Prisma `updateMany` to set status = SUSPENDED
    - [ ] Create audit log entries for each user
    - [ ] Return count of affected users
  - [ ] Add `POST /admin/users/bulk-suspend` route to `backend/src/routes/admin.routes.ts`
    - [ ] Zod schema: `{ userIds: z.array(z.string()).min(1).max(100) }`
    - [ ] Require ADMIN role
    - [ ] Call service method
    - [ ] Return: `{ success: true, data: { affected: number } }`

- [ ] Task 3: Implement Bulk Suspend Frontend (AC: 4)
  - [ ] Add confirmation dialog component
    - [ ] Title: "Suspend X Users?"
    - [ ] Message: List of user emails to be suspended (max 10 shown)
    - [ ] Confirm button: "Suspend Users"
    - [ ] Cancel button
  - [ ] Add API client function: `bulkSuspendUsers(userIds: string[])`
  - [ ] Add mutation:
    ```typescript
    const suspendMutation = useMutation({
      mutationFn: bulkSuspendUsers,
      onSuccess: () => {
        queryClient.invalidateQueries(['admin-users']);
        queryClient.invalidateQueries(['admin-users-stats']);
        setSelectedUserIds([]);
        toast.success(`${count} users suspended`);
      }
    });
    ```
  - [ ] Wire up "Suspend" button to open dialog then trigger mutation

- [ ] Task 4: Implement Bulk Activate (AC: 5)
  - [ ] Add `bulkActivateUsers` method to `backend/src/services/user.service.ts`
    - [ ] Similar to suspend but sets status = ACTIVE
  - [ ] Add `POST /admin/users/bulk-activate` route
  - [ ] Add frontend confirmation dialog (similar to suspend)
  - [ ] Add API client function and mutation
  - [ ] Wire up "Activate" button

- [ ] Task 5: Implement Bulk Delete with Confirmation (AC: 6)
  - [ ] Add `bulkDeleteUsers` method to `backend/src/services/user.service.ts`
    - [ ] Soft delete: sets status = DELETED (does not remove from database)
    - [ ] Validate users are not current admin
    - [ ] Create audit log entries
  - [ ] Add `POST /admin/users/bulk-delete` route
  - [ ] Create destructive confirmation dialog
    - [ ] Red warning message
    - [ ] Input field: User must type "DELETE" to confirm
    - [ ] Confirm button disabled until correct text entered
    - [ ] Show list of users to be deleted
  - [ ] Add API client function and mutation
  - [ ] Wire up "Delete" button

- [ ] Task 6: Refresh and Clear State (AC: 7)
  - [ ] Ensure all mutations invalidate queries:
    - [ ] `queryClient.invalidateQueries(['admin-users'])`
    - [ ] `queryClient.invalidateQueries(['admin-users-stats'])`
  - [ ] Clear selection after successful operation
  - [ ] Show loading state during bulk operation
  - [ ] Handle errors with toast notifications

- [ ] Task 7: Validation and Limits (AC: 8)
  - [ ] Frontend validation: Max 100 users, show warning if exceeded
  - [ ] Backend validation: Reject requests with > 100 userIds
  - [ ] Show informative error: "Bulk operations limited to 100 users. Please select fewer users."
  - [ ] Consider pagination: If "Select All" on page with 20 users, only those 20 selected

- [ ] Task 8: Testing
  - [ ] Unit test: bulkSuspendUsers service method
  - [ ] Unit test: bulkActivateUsers service method
  - [ ] Unit test: bulkDeleteUsers service method
  - [ ] Integration test: POST /admin/users/bulk-suspend endpoint
  - [ ] Integration test: POST /admin/users/bulk-activate endpoint
  - [ ] Integration test: POST /admin/users/bulk-delete endpoint
  - [ ] Frontend test: Selection state management
  - [ ] Frontend test: Confirmation dialogs
  - [ ] E2E test: Bulk suspend flow
  - [ ] E2E test: Bulk delete with confirmation

## Dev Notes

### Relevant Architecture Context

**Tech Stack** [Source: CLAUDE.md]
- Frontend: React 18 + TypeScript + Radix UI + TanStack Query 5
- Backend: Fastify 4 + Prisma 6 + PostgreSQL
- State Management: React useState for local component state
- Toast Notifications: Existing toast hook in project

**Service Pattern** [Source: docs/architecture.md:72-90]
- Services extend BaseService
- Bulk operations use Prisma `updateMany` for efficiency
- Audit logging using existing AuditLog model
- Error handling via try/catch with `handleDatabaseError`

**Frontend Component Patterns** [Source: CLAUDE.md:136-150]
- Use Radix UI Dialog for confirmations
- Use Radix UI Checkbox for selection
- Use existing Button and Toast components
- Mutations via TanStack Query with optimistic updates

---

### Existing Code Context

**User Table Location**: `frontend/src/pages/admin/UserManagement.tsx`
- Lines 394-548: Table structure with columns and rows
- Lines 398-407: TableHeader - Add checkbox column here
- Lines 458-543: TableBody rows - Add checkbox to each row

**User Service**: `backend/src/services/user.service.ts`
- Existing `updateUser` method (lines 426-506): Single user update pattern
- Existing `deleteUser` method (lines 508-543): Single user delete pattern
- Pattern to follow for bulk methods: validate → Prisma operation → audit log

**Admin Routes**: `backend/src/routes/admin.routes.ts`
- Existing PATCH /admin/users/:id (lines 231-290): Single update endpoint
- Existing DELETE /admin/users/:id (lines 292-332): Single delete endpoint
- Add bulk endpoints after these routes

**Audit Log Model** [Source: backend/prisma/schema.prisma:909-926]:
```prisma
model AuditLog {
  id       String   @id @default(cuid())
  userId   String?
  action   String
  entity   String
  entityId String?
  changes  Json?
  metadata Json?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])
}
```

---

### Implementation Patterns

**Prisma Bulk Update** (Efficient pattern):
```typescript
const result = await this.prisma.user.updateMany({
  where: {
    id: { in: userIds },
    status: { not: UserStatus.DELETED } // Don't update already deleted users
  },
  data: {
    status: UserStatus.SUSPENDED,
    updatedAt: new Date()
  }
});

return result.count; // Number of affected records
```

**Audit Log Creation** (For bulk operations):
```typescript
// Create audit logs for each user in bulk operation
await Promise.all(
  userIds.map(userId =>
    this.prisma.auditLog.create({
      data: {
        userId: userId,
        action: 'BULK_SUSPEND',
        entity: 'User',
        entityId: userId,
        changes: { status: { from: 'ACTIVE', to: 'SUSPENDED' } },
        metadata: { performedBy: context.userId, operation: 'bulk' }
      }
    })
  )
);
```

**Selection State Management**:
```typescript
const [selectedUserIds, setSelectedUserIds] = useState<string[]>([]);

const handleSelectAll = (checked: boolean) => {
  if (checked) {
    setSelectedUserIds(users.map(u => u.id));
  } else {
    setSelectedUserIds([]);
  }
};

const handleSelectUser = (userId: string, checked: boolean) => {
  if (checked) {
    setSelectedUserIds(prev => [...prev, userId]);
  } else {
    setSelectedUserIds(prev => prev.filter(id => id !== userId));
  }
};
```

**Floating Action Bar** (Fixed positioning):
```tsx
{selectedUserIds.length > 0 && (
  <div className="fixed bottom-6 left-1/2 -translate-x-1/2
                  bg-card border rounded-lg shadow-lg p-4
                  flex items-center gap-4 animate-in slide-in-from-bottom">
    <span className="text-sm font-medium">
      {selectedUserIds.length} user{selectedUserIds.length > 1 ? 's' : ''} selected
    </span>
    <div className="flex gap-2">
      <Button size="sm" onClick={handleBulkSuspend}>Suspend</Button>
      <Button size="sm" onClick={handleBulkActivate}>Activate</Button>
      <Button size="sm" variant="destructive" onClick={handleBulkDelete}>
        Delete
      </Button>
      <Button size="sm" variant="ghost" onClick={() => setSelectedUserIds([])}>
        Clear
      </Button>
    </div>
  </div>
)}
```

**Destructive Confirmation Dialog** (Type-to-confirm pattern):
```tsx
const [confirmText, setConfirmText] = useState('');
const isConfirmed = confirmText === 'DELETE';

<Dialog>
  <DialogContent>
    <DialogHeader>
      <DialogTitle className="text-destructive">Delete {count} Users?</DialogTitle>
      <DialogDescription>
        This action cannot be undone. The following users will be permanently deleted:
      </DialogDescription>
    </DialogHeader>

    <Alert variant="destructive">
      <AlertCircle className="h-4 w-4" />
      <AlertDescription>
        Users to be deleted: {userEmails.slice(0, 10).join(', ')}
        {userEmails.length > 10 && ` and ${userEmails.length - 10} more`}
      </AlertDescription>
    </Alert>

    <div className="space-y-2">
      <Label>Type DELETE to confirm</Label>
      <Input
        value={confirmText}
        onChange={(e) => setConfirmText(e.target.value)}
        placeholder="DELETE"
      />
    </div>

    <DialogFooter>
      <Button variant="outline" onClick={onCancel}>Cancel</Button>
      <Button
        variant="destructive"
        disabled={!isConfirmed || deleteMutation.isPending}
        onClick={handleConfirmDelete}
      >
        {deleteMutation.isPending ? 'Deleting...' : 'Delete Users'}
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```

---

### Security Considerations

**Backend Validation**:
- Verify all userIds exist before operation
- Prevent admin from deleting themselves
- Prevent bulk operations on other admins (optional safety)
- Rate limiting: Max 5 bulk operations per minute per admin
- Log all bulk operations with admin identity

**Permission Checks**:
- Require ADMIN role for all bulk endpoints
- Verify current user has permission via RBAC middleware
- Reject operations if current admin not authorized

**Data Integrity**:
- Use database transactions for bulk operations
- If any single operation fails, rollback all (or continue with warnings)
- Soft delete (status = DELETED) preserves data integrity and relations

---

### Error Handling

**Backend Errors**:
```typescript
try {
  // Bulk operation
} catch (error) {
  if (error.code === 'P2025') {
    // Some users not found
    return this.createResponse(false, null, 'Some users no longer exist', 404);
  }
  this.handleDatabaseError(error, 'bulkSuspendUsers');
}
```

**Frontend Errors**:
- Network errors: Show toast with retry button
- Partial success: Show which users succeeded/failed
- Validation errors: Show inline error message
- Timeout: Show warning and suggest smaller batch size

---

### Testing

**Backend Unit Tests**:
```typescript
describe('bulkSuspendUsers', () => {
  it('should suspend multiple users successfully', async () => {
    const userIds = ['user1', 'user2', 'user3'];
    const result = await userService.bulkSuspendUsers(userIds, adminContext);
    expect(result.success).toBe(true);
    expect(result.data.affected).toBe(3);
  });

  it('should reject more than 100 users', async () => {
    const userIds = Array.from({ length: 101 }, (_, i) => `user${i}`);
    await expect(userService.bulkSuspendUsers(userIds, adminContext))
      .rejects.toThrow('Maximum 100 users per bulk operation');
  });

  it('should create audit logs for each user', async () => {
    const userIds = ['user1', 'user2'];
    await userService.bulkSuspendUsers(userIds, adminContext);
    const logs = await prisma.auditLog.findMany({
      where: { action: 'BULK_SUSPEND', entityId: { in: userIds } }
    });
    expect(logs).toHaveLength(2);
  });
});
```

**Frontend Component Tests**:
- Test selection state: Check/uncheck individual users
- Test "Select All": Verify all visible users selected
- Test action bar visibility: Shows only when users selected
- Test confirmation dialogs: Open, type confirm text, submit
- Test mutations: Verify API called with correct userIds

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Story created - Bulk user operations | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

---

## QA Results
_To be populated by QA agent_
