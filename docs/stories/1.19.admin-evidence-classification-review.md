# Story 1.19: Admin Evidence Classification Review Interface

## Status
**DEFERRED** - Admin Tools Epic (Future Release)

## Deferral Reason
This story is **deferred to a future "Admin Tools" epic** as it's an admin-only quality control feature that's not critical for initial launch.

**Why Deferred:**
- Admin-only feature (not user-facing)
- Requires 6 new backend APIs + classification override service
- Classification confidence is already good enough for MVP
- Manual review can be done via database queries if needed
- Priority should be on core user features first

**Estimated Backend Work:** 4-6 days (all 6 endpoints + history tracking)
**Future Epic:** "Admin Configuration Tools" (post-MVP)
**Date Deferred:** 2025-10-14

## Original Blockers (Historical)
- ❌ **CRITICAL:** ALL admin evidence classification endpoints are MISSING from backend
  - `GET /admin/evidence-classification/review` - Get low-confidence documents - **MISSING**
  - `POST /documents/:id/approve-classification` - Approve AI classification - **MISSING**
  - `POST /documents/:id/reclassify` - Override classification - **MISSING**
  - `POST /documents/batch-approve` - Batch approve - **MISSING**
  - `POST /documents/:id/flag-for-review` - Flag document for user - **MISSING**
  - `GET /documents/:id/classification-history` - Get history - **MISSING**
- ⚠️ **DEPENDENCY:** Document model must include classification history tracking
- ⚠️ **DEPENDENCY:** Admin role verification middleware must exist

## Required Backend Work
Before this story can begin, the following must be implemented:
1. Create all 6 admin evidence review endpoints
2. Add endpoints to `backend/src/routes/admin.routes.ts` and/or `document.routes.ts`
3. Implement classification override logic with admin justification storage
4. Add classification history tracking to Document model
5. Implement batch operations for admin efficiency
6. Add email notification for "flag for review" action

## Story

**As a** frontend developer,
**I want** to create an admin interface for reviewing and overriding low-confidence evidence tier classifications,
**so that** admins can ensure classification accuracy and handle edge cases.

## Acceptance Criteria

1. **Component: AdminEvidenceClassificationReview.tsx** - Main review page
   - Route: `/admin/evidence-classification/review`
   - Fetches documents with `tierConfidenceScore < 0.7` from GET /admin/evidence-classification/review
   - Displays filterable list of documents needing review
2. **Component: ClassificationReviewCard.tsx** - Individual document review
   - Document information:
     - Filename
     - Uploaded by (user email, organization)
     - Upload date
     - File type and size
   - Current classification:
     - EvidenceTierBadge with confidence score
     - Classification reasoning (expandable text)
   - Document preview panel (if supported file type: PDF, images, text)
   - Override controls:
     - "Approve Classification" button (accepts AI classification, removes from review queue)
     - "Override Tier" dropdown (Tier 0/1/2)
     - Mandatory justification text area (appears when override selected, min 30 characters)
     - "Submit Override" button
3. Bulk operations:
   - Checkbox selection for multiple documents
   - "Approve All Selected" button (batch approval)
   - "Flag for User Review" button (notifies user to upload better evidence)
4. Filters:
   - Confidence range slider (0-0.7, show documents below threshold)
   - Tier filter: "Show only Tier X classifications"
   - Date range: "Uploaded in last X days"
5. Sorting:
   - Default: lowest confidence first
   - Options: "Newest First", "Oldest First", "Alphabetical"
6. Override submission:
   - POST /documents/:id/reclassify with new tier + justification
   - Success: remove from review list, show toast
   - Error: show inline error message
7. Audit trail per document:
   - "View Classification History" button
   - Modal showing: Original classification, overrides (if any), admin user, timestamps
8. Pagination: 20 documents per page with page controls
9. Empty state: "No documents need review" with checkmark icon

## Tasks / Subtasks

- [ ] Create main AdminEvidenceClassificationReview component (AC: 1)
  - [ ] Create `/frontend/src/pages/admin/AdminEvidenceClassificationReview.tsx`
  - [ ] Add route `/admin/evidence-classification/review` to router
  - [ ] Fetch low-confidence documents from API using TanStack Query
  - [ ] Create page layout with header, filters, and document list
  - [ ] Add AdminLayout wrapper for consistent admin UI
  - [ ] Implement pagination controls (20 per page)
- [ ] Create ClassificationReviewCard component (AC: 2)
  - [ ] Create `/frontend/src/components/admin/classification/ClassificationReviewCard.tsx`
  - [ ] Display document information section:
    - Filename (truncated with full name on hover)
    - Uploaded by user (email, organization name)
    - Upload date (formatted timestamp)
    - File type icon and size (formatted KB/MB)
  - [ ] Display current classification section:
    - Integrate EvidenceTierBadge component (from Story 1.13)
    - Show confidence score with progress bar
    - Add expandable classification reasoning (Radix Collapsible)
  - [ ] Add document preview panel:
    - For PDFs: use iframe or PDF.js preview
    - For images: show thumbnail with lightbox
    - For text files: show first 500 chars
    - For unsupported types: show "Preview unavailable" message
  - [ ] Create override controls section:
    - "Approve Classification" button (green, primary)
    - "Override Tier" dropdown (Radix Select) with Tier 0/1/2 options
    - Justification text area (appears when override selected)
    - Validate justification min 30 characters
    - "Submit Override" button (only enabled when justification valid)
- [ ] Implement bulk operations (AC: 3)
  - [ ] Add checkbox to each ClassificationReviewCard
  - [ ] Track selected documents in component state
  - [ ] Create bulk action toolbar (appears when documents selected)
  - [ ] Add "Approve All Selected" button
  - [ ] Implement batch approval API call
  - [ ] Add "Flag for User Review" button
  - [ ] Create FlagForReviewModal with message to user
  - [ ] Implement batch flag API call
  - [ ] Show progress indicator during bulk operations
  - [ ] Display success count: "5 documents approved"
- [ ] Implement filters (AC: 4)
  - [ ] Create filter panel component (collapsible on mobile)
  - [ ] Add confidence range slider (Radix Slider):
    - Range: 0-0.7 (0-70%)
    - Default: show all below 0.7
    - Label: "Max confidence: X%"
  - [ ] Add tier filter dropdown (Radix Select):
    - Options: All Tiers, Tier 0 only, Tier 1 only, Tier 2 only
  - [ ] Add date range filter:
    - Options: All Time, Last 7 days, Last 30 days, Last 90 days
  - [ ] Apply filters to document list query
  - [ ] Display active filter count badge
  - [ ] Add "Clear Filters" button
- [ ] Implement sorting (AC: 5)
  - [ ] Add sort dropdown (Radix Select) to page header
  - [ ] Sort options:
    - "Lowest Confidence First" (default)
    - "Highest Confidence First"
    - "Newest First" (upload date DESC)
    - "Oldest First" (upload date ASC)
    - "Alphabetical" (filename ASC)
  - [ ] Update API query with sort parameter
  - [ ] Persist sort preference in localStorage
- [ ] Implement override submission (AC: 6)
  - [ ] Create override mutation hook
  - [ ] Call POST /documents/:id/reclassify with new tier and justification
  - [ ] Show loading state during submission (disable buttons)
  - [ ] On success:
    - Remove document from review list
    - Show toast: "Classification overridden successfully"
    - Invalidate queries for review list
  - [ ] On error:
    - Display inline error message
    - Keep document in list for retry
- [ ] Add classification history audit trail (AC: 7)
  - [ ] Add "View Classification History" button to each card
  - [ ] Create ClassificationHistoryModal component
  - [ ] Fetch classification history from API
  - [ ] Display timeline of changes:
    - Original AI classification (timestamp, confidence, reasoning)
    - Admin overrides (timestamp, admin user, before/after tier, justification)
  - [ ] Use Radix Dialog for modal
  - [ ] Style with visual timeline (vertical line with dots)
- [ ] Add API client integration
  - [ ] Extend `/frontend/src/lib/api.ts` with methods:
    - `getDocumentsForReview(filters, sort, page)`
    - `approveClassification(documentId)`
    - `batchApproveClassifications(documentIds)`
    - `overrideClassification(documentId, tier, justification)`
    - `flagForUserReview(documentId, message)`
    - `getClassificationHistory(documentId)`
  - [ ] Create TanStack Query hooks for each operation
  - [ ] Configure proper query keys and cache invalidation
  - [ ] Add TypeScript interfaces for classification data
- [ ] Implement pagination (AC: 8)
  - [ ] Add pagination controls to page footer
  - [ ] Show "Page X of Y" indicator
  - [ ] Add Previous/Next buttons
  - [ ] Add page number buttons (show 5 at a time)
  - [ ] Update API query with page parameter
  - [ ] Scroll to top on page change
- [ ] Add empty state (AC: 9)
  - [ ] Create EmptyReviewList component
  - [ ] Display checkmark icon (Lucide CheckCircle)
  - [ ] Show message: "No documents need review"
  - [ ] Add encouragement: "All classifications look good!"
  - [ ] Center in page with appropriate spacing

## Dev Notes

### Relevant Source Tree
- `/frontend/src/pages/admin/` - Admin page components
- `/frontend/src/components/admin/classification/` - NEW subdirectory for classification components
- `/frontend/src/components/AdminLayout.tsx` - Existing admin layout wrapper
- `/frontend/src/components/ui/EvidenceTierBadge.tsx` - Created in Story 1.13
- `/frontend/src/components/ui/` - Radix UI component library
- `/frontend/src/lib/api.ts` - Centralized API client
- `/backend/src/routes/admin.routes.ts` - Admin API endpoints (48KB)
- `/backend/src/routes/document.routes.ts` - Document API endpoints (23KB)
- `/backend/src/services/evidence-classification.service.ts` - Created in Story 1.03

### Design Decisions

**Review Threshold:**
Documents with `tierConfidenceScore < 0.7` (70%) are flagged for admin review. This threshold balances automation (high confidence classifications auto-approved) with quality control (low confidence classifications human-reviewed).

**Approval vs Override:**
- **Approve:** Accept AI classification, remove from review queue, no justification needed
- **Override:** Change tier classification, requires justification, creates audit trail entry

**Document Preview Strategy:**
- PDFs: Use iframe with `src` pointing to document URL or PDF.js for better control
- Images (PNG, JPG, etc.): Display thumbnail with click-to-expand lightbox
- Text files: Extract and display first 500 characters
- Unsupported types: Show file icon and "Preview unavailable" message

**Bulk Operations UX:**
Show floating action bar when documents selected (similar to Gmail). Prevents accidental bulk actions by requiring explicit selection.

### Data Structure (from API)

```typescript
interface DocumentForReview {
  id: string;
  filename: string;
  fileType: string;
  fileSize: number;
  uploadedAt: string;
  uploadedBy: {
    email: string;
    organizationName: string;
  };
  currentClassification: {
    tier: 'TIER_0' | 'TIER_1' | 'TIER_2';
    confidence: number; // 0-1
    reasoning: string;
    classifiedAt: string;
  };
  documentUrl: string; // For preview
}

interface ClassificationHistory {
  documentId: string;
  events: Array<{
    type: 'ai_classification' | 'admin_override';
    timestamp: string;
    tier: 'TIER_0' | 'TIER_1' | 'TIER_2';
    confidence?: number; // Only for AI classification
    adminUser?: string; // Only for admin override
    justification?: string; // Only for admin override
    reasoning: string;
  }>;
}
```

### Integration Points

**API Endpoints (from admin.routes.ts and document.routes.ts):**
- ❌ `GET /admin/evidence-classification/review` - Get low-confidence docs - **MISSING**
- ❌ `POST /documents/:id/approve-classification` - Approve AI classification - **MISSING**
- ❌ `POST /documents/:id/reclassify` - Override classification - **MISSING**
- ❌ `POST /documents/batch-approve` - Batch approve - **MISSING**
- ❌ `POST /documents/:id/flag-for-review` - Flag document - **MISSING**
- ❌ `GET /documents/:id/classification-history` - Get history - **MISSING**

**⚠️ BLOCKER:** None of the admin evidence review endpoints exist in the current backend.
This story CANNOT be implemented until backend work is completed.

**Expected Endpoint Locations:**
- Review list endpoint: `backend/src/routes/admin.routes.ts`
- Document-specific operations: `backend/src/routes/document.routes.ts`
- All endpoints require ADMIN role verification

**Integration Verification (from PRD):**
- **IV1:** Preview panel loads documents from Replit object storage using existing objectStorage

**Radix UI Components to Use:**
- `Card` - Document review cards
- `Badge` - Evidence tier badges, filter count badge
- `Select` - Tier override dropdown, filters, sort dropdown
- `Checkbox` - Document selection for bulk operations
- `Slider` - Confidence range filter
- `Collapsible` - Classification reasoning expandable
- `Dialog` - Classification history modal, flag for review modal
- `Textarea` - Justification input
- `Button` - Approve, override, bulk actions
- `Toast` - Success/error notifications
- `Progress` - Confidence score visualization
- `ScrollArea` - Document preview panel scrolling

**TanStack Query Integration:**
```typescript
// Fetch documents for review
const { data: documents, isLoading } = useQuery({
  queryKey: ['admin', 'classification-review', filters, sort, page],
  queryFn: () => api.getDocumentsForReview(filters, sort, page),
  keepPreviousData: true, // Smoother pagination UX
});

// Override classification mutation
const overrideClassification = useMutation({
  mutationFn: ({ documentId, tier, justification }: OverridePayload) =>
    api.overrideClassification(documentId, tier, justification),
  onSuccess: () => {
    queryClient.invalidateQueries(['admin', 'classification-review']);
    toast.success('Classification overridden successfully');
  },
});
```

**Document Preview Implementation:**
```typescript
// PDF preview
<iframe
  src={documentUrl}
  className="w-full h-96 border rounded"
  title="Document preview"
/>

// Image preview
<img
  src={documentUrl}
  alt={filename}
  className="max-w-full h-auto cursor-pointer"
  onClick={() => openLightbox(documentUrl)}
/>

// Text preview
<pre className="text-sm bg-gray-50 p-4 rounded max-h-96 overflow-y-auto">
  {textContent.substring(0, 500)}...
</pre>
```

### Existing Patterns to Follow

**Admin Layout Pattern:**
Use existing `AdminLayout` component with sidebar navigation. Add breadcrumbs: Admin > Evidence Classification > Review.

**Card List Pattern:**
Similar to existing assessment and vendor card lists. Use grid layout with responsive columns.

**Modal Patterns:**
Follow existing modal patterns for classification history and flag for review dialogs.

**Toast Notifications:**
Use existing toast system for success/error messages after operations.

### Testing

**Test File Location:**
- Component tests: `/frontend/src/components/__tests__/admin/AdminEvidenceClassificationReview.test.tsx`
- Component tests: `/frontend/src/components/__tests__/admin/classification/*.test.tsx`
- Integration tests: `/backend/tests/integration/admin-classification-review.spec.ts`

**Testing Frameworks:**
- Vitest 3 + React Testing Library
- Mock TanStack Query with QueryClientProvider
- Mock document preview (iframe, images)
- Mock admin user context

**Test Cases:**
1. Review page fetches low-confidence documents on mount
2. ClassificationReviewCard displays document information correctly
3. EvidenceTierBadge shows current classification
4. Confidence score displays with progress bar
5. Classification reasoning expands/collapses
6. Document preview renders for supported file types
7. "Approve Classification" button removes document from list
8. "Override Tier" dropdown shows Tier 0/1/2 options
9. Justification text area appears when override selected
10. Justification validates minimum 30 characters
11. "Submit Override" calls API with correct payload
12. Override success removes document and shows toast
13. Checkbox selection tracks selected documents
14. Bulk action toolbar appears when documents selected
15. "Approve All Selected" performs batch approval
16. Confidence range slider filters correctly
17. Tier filter dropdown filters correctly
18. Date range filter filters correctly
19. Active filter count badge displays correctly
20. "Clear Filters" resets all filters
21. Sort dropdown changes document order
22. "View Classification History" opens modal
23. Classification history timeline displays events
24. Pagination controls work correctly
25. Empty state displays when no documents need review

**Coverage Target:**
- Component coverage: 85%+ (comprehensive admin review workflow testing)
- Integration coverage: 90%+ (all classification review scenarios)

## Change Log

| Date       | Version | Description                          | Author        |
|------------|---------|--------------------------------------|---------------|
| 2025-10-07 | 1.0     | Initial story created from PRD Epic 1 | SM (Winston)  |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent during implementation_

### Debug Log References
_To be populated by dev agent during implementation_

### Completion Notes
_To be populated by dev agent during implementation_

### File List
_To be populated by dev agent during implementation_

## QA Results

_To be populated by QA agent after implementation review_
