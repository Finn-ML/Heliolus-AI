# Story 12.6: Section & Question Library System

## Status
Draft

## Story

**As a** platform administrator,
**I want** a library of reusable sections and questions that can be copied across templates,
**so that** I can efficiently create new templates by reusing well-tested components.

## Acceptance Criteria

1. **Database Schema Migration** - Add library flag fields
   - Add `isLibrary` Boolean field to Section model (default: false)
   - Add `isLibrary` Boolean field to Question model (default: false)
   - Create Prisma migration
   - Update TypeScript types

2. **Mark as Library - Backend API**
   - PUT /admin/sections/:id/library - Toggle section.isLibrary
   - PUT /admin/questions/:id/library - Toggle question.isLibrary
   - Only ADMIN role can mark items as library
   - Audit log: SECTION_MARKED_LIBRARY, QUESTION_MARKED_LIBRARY

3. **Browse Library - Backend API**
   - GET /admin/library/sections - List all sections where isLibrary = true
   - GET /admin/library/questions - List all questions where isLibrary = true
   - Support filtering by category, tags
   - Pagination support (limit 50 per page)
   - Include template name in response for context

4. **Mark as Library - Frontend UI**
   - Add "Add to Library" button in section dropdown menu
   - Add "Add to Library" button in question dropdown menu
   - Toggle state: "Add to Library" â†” "Remove from Library"
   - Library icon (ðŸ“š) appears next to library items
   - Confirmation dialog before adding to library

5. **Library Browser Modal - Frontend UI**
   - "Browse Library" button in template detail view
   - Opens modal with tabs: "Sections" and "Questions"
   - Search/filter by name, category, tags
   - Preview section/question details in modal
   - "Copy to Template" button for each library item

6. **Copy from Library - Functionality**
   - Clicking "Copy to Template" creates new section/question
   - Copies all fields (title, description, weight, aiPromptHint, etc.)
   - Does NOT copy id (generates new CUID)
   - Links to current template/section
   - Shows success toast: "Section copied from library"

7. **Library Management View** - Optional admin page
   - Dedicated page: /admin/library
   - List all library sections and questions
   - Bulk operations: Remove from library, delete
   - Statistics: Total library items, most used items

## Tasks / Subtasks

- [ ] Task 1: Create Database Migration (AC: 1)
  - [ ] Add `isLibrary Boolean @default(false)` to Section model
  - [ ] Add `isLibrary Boolean @default(false)` to Question model
  - [ ] Run `npx prisma migrate dev --name add-library-flags`
  - [ ] Run `npx prisma generate` to update TypeScript types
  - [ ] Test migration on development database

- [ ] Task 2: Add Library Toggle API Routes (AC: 2)
  - [ ] PUT /admin/sections/:id/library in admin.routes.ts
  - [ ] PUT /admin/questions/:id/library in admin.routes.ts
  - [ ] Toggle isLibrary field (true â†” false)
  - [ ] Require ADMIN role
  - [ ] Add audit logging
  - [ ] Return updated section/question

- [ ] Task 3: Add Library Browse API Routes (AC: 3)
  - [ ] GET /admin/library/sections in admin.routes.ts
  - [ ] GET /admin/library/questions in admin.routes.ts
  - [ ] Filter: where: { isLibrary: true }
  - [ ] Include template.name in response
  - [ ] Support query params: search, category, page, limit
  - [ ] Pagination: limit 50, default page 1

- [ ] Task 4: Implement Library Service Methods (AC: 2, 3)
  - [ ] Add `toggleLibraryFlag(type, id)` to TemplateService
  - [ ] Add `getLibrarySections(filters)` to TemplateService
  - [ ] Add `getLibraryQuestions(filters)` to TemplateService
  - [ ] Add `copyFromLibrary(type, itemId, targetId)` to TemplateService
  - [ ] Handle validation, permissions, audit logging

- [ ] Task 5: Add Library Toggle to Frontend (AC: 4)
  - [ ] Add "Add to Library" menu item to section dropdown
  - [ ] Add "Add to Library" menu item to question dropdown
  - [ ] Create `useToggleLibrary()` mutation hook
  - [ ] Toggle button text based on isLibrary state
  - [ ] Show library icon (Book icon from lucide-react) next to library items
  - [ ] Confirmation dialog before marking as library

- [ ] Task 6: Create Library Browser Modal (AC: 5)
  - [ ] Create LibraryBrowserModal component
  - [ ] Add tabs: "Sections" and "Questions"
  - [ ] Implement search input (filters by name)
  - [ ] Implement category filter dropdown
  - [ ] Display library items in list with preview
  - [ ] "Copy to Template" button for each item
  - [ ] Close modal after successful copy

- [ ] Task 7: Implement Copy from Library (AC: 6)
  - [ ] Create `useCopyFromLibrary()` mutation hook
  - [ ] API endpoint: POST /admin/library/copy
  - [ ] Request body: { type: 'section' | 'question', sourceId: string, targetId: string }
  - [ ] Backend: Copy all fields except id, generate new CUID
  - [ ] Link to target template/section
  - [ ] Invalidate template query on success
  - [ ] Toast notification: "Section copied from library"

- [ ] Task 8: Create Library Management Page (AC: 7) - Optional
  - [ ] Create /admin/library page
  - [ ] List all library sections and questions
  - [ ] Search and filter functionality
  - [ ] Bulk select checkboxes
  - [ ] "Remove from Library" bulk action
  - [ ] Display usage count (how many templates use this item)
  - [ ] Statistics cards: Total items, most used

- [ ] Task 9: Integration Testing (All AC)
  - [ ] Mark section as library, verify isLibrary = true in database
  - [ ] Mark question as library, verify isLibrary = true
  - [ ] Browse library sections, see all marked sections
  - [ ] Browse library questions, see all marked questions
  - [ ] Search library for "KYC", filter results
  - [ ] Copy section from library to template
  - [ ] Copy question from library to section
  - [ ] Verify copied item has new ID
  - [ ] Verify copied item has all original fields
  - [ ] Remove section from library, verify isLibrary = false
  - [ ] Test library icon appears next to library items

## Dev Notes

### Database Migration

**Prisma Schema Changes:**
```prisma
model Section {
  // ... existing fields
  isLibrary Boolean @default(false) // NEW
  // ... existing relations
}

model Question {
  // ... existing fields
  isLibrary Boolean @default(false) // NEW
  // ... existing relations
}
```

**Migration Command:**
```bash
cd backend
npx prisma migrate dev --name add-library-flags
npx prisma generate
```

### Library Toggle API Implementation

**Backend Route Handler:**
```typescript
// PUT /admin/sections/:id/library
server.put('/sections/:id/library', {
  schema: {
    description: 'Toggle section library flag',
    tags: ['Admin'],
    params: {
      type: 'object',
      required: ['id'],
      properties: {
        id: { type: 'string' },
      },
    },
  },
}, asyncHandler(async (request: FastifyRequest<{ Params: { id: string } }>, reply: FastifyReply) => {
  const { id } = request.params;
  const { TemplateService } = await import('../services');
  const templateService = new TemplateService();

  const context = {
    userId: (request as any).currentUser?.id,
    userRole: (request as any).currentUser?.role,
    organizationId: (request as any).currentUser?.organizationId,
  };

  const result = await templateService.toggleLibraryFlag('section', id, context);

  if (!result.success) {
    return reply.code((result as any).statusCode || 500).send(result);
  }

  reply.code(200).send({ success: true, data: result.data });
}));
```

**Service Method:**
```typescript
async toggleLibraryFlag(
  type: 'section' | 'question',
  id: string,
  context?: ServiceContext
): Promise<ApiResponse<DatabaseSection | DatabaseQuestion>> {
  try {
    this.requirePermission(context, [UserRole.ADMIN]);

    const model = type === 'section' ? this.prisma.section : this.prisma.question;
    const item = await model.findUnique({ where: { id } });

    if (!item) {
      throw this.createError(`${type} not found`, 404, `${type.toUpperCase()}_NOT_FOUND`);
    }

    const updated = await model.update({
      where: { id },
      data: { isLibrary: !item.isLibrary },
    });

    await this.logAudit(
      {
        action: `${type.toUpperCase()}_${updated.isLibrary ? 'ADDED_TO' : 'REMOVED_FROM'}_LIBRARY`,
        entity: type,
        entityId: id,
      },
      context
    );

    return this.createResponse(true, updated, `${type} ${updated.isLibrary ? 'added to' : 'removed from'} library`);
  } catch (error) {
    if (error.statusCode) throw error;
    this.handleDatabaseError(error, 'toggleLibraryFlag');
  }
}
```

### Copy from Library Implementation

**Backend API Endpoint:**
```typescript
// POST /admin/library/copy
server.post('/library/copy', {
  schema: {
    description: 'Copy section or question from library',
    tags: ['Admin'],
    body: {
      type: 'object',
      required: ['type', 'sourceId', 'targetId'],
      properties: {
        type: { type: 'string', enum: ['section', 'question'] },
        sourceId: { type: 'string' },
        targetId: { type: 'string' }, // templateId for section, sectionId for question
      },
    },
  },
}, asyncHandler(async (request: FastifyRequest<{
  Body: { type: 'section' | 'question'; sourceId: string; targetId: string }
}>, reply: FastifyReply) => {
  const { type, sourceId, targetId } = request.body;
  const { TemplateService } = await import('../services');
  const templateService = new TemplateService();

  const context = {
    userId: (request as any).currentUser?.id,
    userRole: (request as any).currentUser?.role,
    organizationId: (request as any).currentUser?.organizationId,
  };

  const result = await templateService.copyFromLibrary(type, sourceId, targetId, context);

  if (!result.success) {
    return reply.code((result as any).statusCode || 500).send(result);
  }

  reply.code(201).send({ success: true, data: result.data });
}));
```

**Service Method:**
```typescript
async copyFromLibrary(
  type: 'section' | 'question',
  sourceId: string,
  targetId: string, // templateId for section, sectionId for question
  context?: ServiceContext
): Promise<ApiResponse<DatabaseSection | DatabaseQuestion>> {
  try {
    this.requirePermission(context, [UserRole.ADMIN]);

    if (type === 'section') {
      // Copy section to template
      const sourceSection = await this.prisma.section.findUnique({ where: { id: sourceId } });
      if (!sourceSection) {
        throw this.createError('Source section not found', 404, 'SECTION_NOT_FOUND');
      }

      const newSection = await this.prisma.section.create({
        data: {
          templateId: targetId,
          title: sourceSection.title,
          description: sourceSection.description,
          weight: sourceSection.weight,
          order: sourceSection.order,
          regulatoryPriority: sourceSection.regulatoryPriority,
          isRequired: sourceSection.isRequired,
          isLibrary: false, // Copied sections are not library items by default
        },
      });

      await this.logAudit(
        {
          action: 'SECTION_COPIED_FROM_LIBRARY',
          entity: 'Section',
          entityId: newSection.id,
          metadata: { sourceId, targetTemplateId: targetId },
        },
        context
      );

      return this.createResponse(true, newSection, 'Section copied from library');
    } else {
      // Copy question to section
      const sourceQuestion = await this.prisma.question.findUnique({ where: { id: sourceId } });
      if (!sourceQuestion) {
        throw this.createError('Source question not found', 404, 'QUESTION_NOT_FOUND');
      }

      const newQuestion = await this.prisma.question.create({
        data: {
          sectionId: targetId,
          text: sourceQuestion.text,
          type: sourceQuestion.type,
          required: sourceQuestion.required,
          options: sourceQuestion.options,
          validation: sourceQuestion.validation,
          helpText: sourceQuestion.helpText,
          order: sourceQuestion.order,
          categoryTag: sourceQuestion.categoryTag,
          tags: sourceQuestion.tags,
          weight: sourceQuestion.weight,
          isFoundational: sourceQuestion.isFoundational,
          aiPromptHint: sourceQuestion.aiPromptHint,
          scoringRules: sourceQuestion.scoringRules,
          isLibrary: false, // Copied questions are not library items by default
        },
      });

      await this.logAudit(
        {
          action: 'QUESTION_COPIED_FROM_LIBRARY',
          entity: 'Question',
          entityId: newQuestion.id,
          metadata: { sourceId, targetSectionId: targetId },
        },
        context
      );

      return this.createResponse(true, newQuestion, 'Question copied from library');
    }
  } catch (error) {
    if (error.statusCode) throw error;
    this.handleDatabaseError(error, 'copyFromLibrary');
  }
}
```

### Frontend Library Browser Modal

**Component Structure:**
```typescript
function LibraryBrowserModal({ templateId, onClose }: { templateId: string; onClose: () => void }) {
  const [activeTab, setActiveTab] = useState<'sections' | 'questions'>('sections');
  const [search, setSearch] = useState('');

  const { data: librarySections } = useQuery({
    queryKey: ['librarySections', search],
    queryFn: () => adminTemplateApi.getLibrarySections(search),
  });

  const { data: libraryQuestions } = useQuery({
    queryKey: ['libraryQuestions', search],
    queryFn: () => adminTemplateApi.getLibraryQuestions(search),
  });

  const copyFromLibrary = useCopyFromLibrary();

  const handleCopy = async (type: 'section' | 'question', sourceId: string) => {
    const targetId = type === 'section' ? templateId : selectedSectionId;
    await copyFromLibrary.mutateAsync({ type, sourceId, targetId });
    toast.success(`${type} copied from library`);
    onClose();
  };

  return (
    <Dialog open onOpenChange={onClose}>
      <DialogContent className="max-w-4xl">
        <DialogHeader>
          <DialogTitle>Browse Library</DialogTitle>
        </DialogHeader>

        <Tabs value={activeTab} onValueChange={setActiveTab}>
          <TabsList>
            <TabsTrigger value="sections">Sections</TabsTrigger>
            <TabsTrigger value="questions">Questions</TabsTrigger>
          </TabsList>

          <div className="mt-4">
            <Input
              placeholder="Search library..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
            />
          </div>

          <TabsContent value="sections">
            {librarySections?.map((section) => (
              <LibraryItemCard
                key={section.id}
                item={section}
                type="section"
                onCopy={() => handleCopy('section', section.id)}
              />
            ))}
          </TabsContent>

          <TabsContent value="questions">
            {libraryQuestions?.map((question) => (
              <LibraryItemCard
                key={question.id}
                item={question}
                type="question"
                onCopy={() => handleCopy('question', question.id)}
              />
            ))}
          </TabsContent>
        </Tabs>
      </DialogContent>
    </Dialog>
  );
}
```

### File Locations

**Backend:**
- `backend/prisma/schema.prisma` - Add isLibrary fields
- `backend/src/services/template.service.ts` - Add library methods
- `backend/src/routes/admin.routes.ts` - Add library endpoints

**Frontend:**
- `frontend/src/lib/api.ts` - Add library API methods
- `frontend/src/hooks/useAdminTemplates.ts` - Add library hooks
- `frontend/src/pages/admin/TemplateManagement.tsx` - Add library toggle UI
- `frontend/src/components/admin/LibraryBrowserModal.tsx` - New component

### Testing Checklist

```
â–¡ Run migration, verify isLibrary fields added
â–¡ Mark section as library (API)
â–¡ Mark question as library (API)
â–¡ Browse library sections (API), verify filtering
â–¡ Browse library questions (API), verify search
â–¡ Copy section from library (API), verify new ID
â–¡ Copy question from library (API), verify all fields copied
â–¡ Mark section as library (UI), verify library icon appears
â–¡ Mark question as library (UI)
â–¡ Open library browser modal
â–¡ Search for "KYC" in library
â–¡ Copy section from library to template
â–¡ Verify copied section appears in template
â–¡ Copy question from library to section
â–¡ Verify copied question has new ID
â–¡ Remove section from library, verify icon disappears
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Story created - Section & question library system | Bob (Scrum Master) |

---

## Dev Agent Record
_To be populated by dev agent during implementation_

---

## QA Results
_To be populated by QA agent after testing_
