# Story 7.1: Add Quota Check Error Handling to Assessment Routes

## Status
Draft

## Story
**As a** frontend application,
**I want** clear error responses when users exceed quotas,
**so that** I can display appropriate upgrade prompts.

## Acceptance Criteria
1. Modify `POST /v1/assessments` endpoint in `assessment.routes.ts`
2. Wrap `assessmentService.createAssessment()` call in try-catch (already exists)
3. Catch errors with code `FREEMIUM_QUOTA_EXCEEDED`
4. Return HTTP 402 Payment Required with response:
   ```json
   {
     "success": false,
     "error": "Free users can create maximum 2 assessments. Upgrade to Premium for unlimited access.",
     "code": "FREEMIUM_QUOTA_EXCEEDED",
     "upgradeUrl": "/pricing?upgrade=premium"
   }
   ```
5. All other errors handled by existing error middleware
6. Successful assessment creation returns 201 with assessment data

## Tasks / Subtasks

- [ ] **Task 1: Locate POST /assessments Endpoint** (AC: 1)
  - [ ] Open `backend/src/routes/assessment.routes.ts`
  - [ ] Find POST / endpoint (line 356)
  - [ ] Review existing try-catch block (line 419-529)
  - [ ] Identify insertion point for FREEMIUM_QUOTA_EXCEEDED handling

- [ ] **Task 2: Add Specific FREEMIUM_QUOTA_EXCEEDED Handler** (AC: 3, 4)
  - [ ] In catch block (after line 502), add before general 402 handler:
    ```typescript
    } catch (error: any) {
      request.log.error({ error, userId: user.id }, 'Failed to create assessment');

      // Handle Freemium quota exceeded specifically
      if (error.code === 'FREEMIUM_QUOTA_EXCEEDED') {
        reply.status(402).send({
          success: false,
          error: error.message || 'Free users can create maximum 2 assessments. Upgrade to Premium for unlimited access.',
          code: 'FREEMIUM_QUOTA_EXCEEDED',
          upgradeUrl: '/pricing?upgrade=premium',
          statusCode: 402,
          timestamp: new Date().toISOString(),
        });
        return;
      }

      // Existing 402 handler for other credit issues
      if (error.statusCode === 402) {
        reply.status(402).send({
          message: error.message || 'Insufficient credits',
          code: error.code || 'INSUFFICIENT_CREDITS',
          statusCode: 402,
          timestamp: new Date().toISOString(),
        });
        return;
      }

      // ... rest of existing handlers
    ```

- [ ] **Task 3: Update 402 Response Schema** (AC: 4)
  - [ ] Find 402 response schema (line 383-391)
  - [ ] Add optional upgradeUrl field:
    ```typescript
    402: {
      type: 'object',
      properties: {
        success: { type: 'boolean' },
        error: { type: 'string' },
        message: { type: 'string' },
        code: { type: 'string' },
        statusCode: { type: 'number' },
        timestamp: { type: 'string' },
        upgradeUrl: { type: 'string' },  // NEW: Optional upgrade URL
      },
    },
    ```

- [ ] **Task 4: Add JSDoc Documentation** (AC: 3, 4)
  - [ ] Add comment before FREEMIUM_QUOTA_EXCEEDED handler:
    ```typescript
    /**
     * Handle Freemium quota exceeded error
     *
     * When a FREE tier user attempts to create a 3rd assessment,
     * AssessmentService throws FREEMIUM_QUOTA_EXCEEDED error.
     *
     * Response includes upgradeUrl to streamline upgrade flow.
     *
     * @see Story 5.6 - AssessmentService quota checks
     * @see Story 8.2 - Frontend quota warning UI
     */
    if (error.code === 'FREEMIUM_QUOTA_EXCEEDED') {
      // ...
    }
    ```

- [ ] **Task 5: Test Error Response Format** (AC: 4, 6)
  - [ ] Create test file: `backend/tests/integration/assessment-quota-error.test.ts`
  - [ ] Test FREE user with 2 assessments gets 402 on 3rd attempt
  - [ ] Test response includes upgradeUrl
  - [ ] Test response code is FREEMIUM_QUOTA_EXCEEDED
  - [ ] Test PREMIUM user can create multiple assessments (no 402)
  - [ ] Test other 402 errors still handled correctly
  - [ ] Run tests: `npm test`

- [ ] **Task 6: Verify Existing 201 Success Response** (AC: 6)
  - [ ] Verify successful assessment creation still returns 201
  - [ ] Verify response includes all required fields
  - [ ] Test with FREE user (1st assessment should succeed)

## Dev Notes

### Current Implementation

**Location:** `backend/src/routes/assessment.routes.ts` line 356-530

**Existing Structure:**
```typescript
server.post('/', {
  schema: { ... },
  preHandler: authenticationMiddleware
}, asyncHandler(async (request, reply) => {
  try {
    // Organization validation logic (line 419-452)

    // Call service
    const result = await assessmentService.createAssessment({...}, {...});

    // Handle result
    if (!result.success) { ... }

    // Return 201 success
    reply.status(201).send({ ... });

  } catch (error: any) {
    // Line 500: Error handling
    // Currently handles 402 and 403
    // Need to add specific FREEMIUM_QUOTA_EXCEEDED handling
  }
}));
```

**What Needs to Change:**
- Add specific handler for FREEMIUM_QUOTA_EXCEEDED before general 402 handler
- Include upgradeUrl in response for this specific error code
- Update 402 response schema to include upgradeUrl field

[Source: backend/src/routes/assessment.routes.ts:356-530]

---

### Error Flow

**Successful Creation (FREE user, 1st assessment):**
```
1. User: POST /v1/assessments { templateId: 'compliance' }
2. Route: Call assessmentService.createAssessment()
3. Service: Check quota → totalAssessmentsCreated = 0
4. Service: Create assessment, increment quota to 1
5. Route: Return 201 { id, status, ... }
6. Frontend: Show assessment created successfully
```

**Quota Exceeded (FREE user, 3rd assessment):**
```
1. User: POST /v1/assessments { templateId: 'compliance' }
2. Route: Call assessmentService.createAssessment()
3. Service: Check quota → totalAssessmentsCreated = 2
4. Service: Throw error { code: 'FREEMIUM_QUOTA_EXCEEDED', statusCode: 402 }
5. Route: Catch error, detect code
6. Route: Return 402 { code, error, upgradeUrl }
7. Frontend: Show upgrade modal with "Upgrade to Premium" button
```

[Source: Story 5.6 - AssessmentService Quota Checks]

---

### upgradeUrl Format

**Purpose:**
- Provides direct link to pricing page
- Query parameter indicates upgrade intent
- Frontend can use this to pre-select Premium plan

**Format:**
```
/pricing?upgrade=premium
```

**Usage in Frontend:**
```typescript
// Frontend handling of 402
if (error.code === 'FREEMIUM_QUOTA_EXCEEDED') {
  const upgradeUrl = error.upgradeUrl || '/pricing';
  showUpgradeModal({
    message: error.error,
    ctaText: 'Upgrade to Premium',
    ctaLink: upgradeUrl,
  });
}
```

**Why Relative Path:**
- Frontend determines base URL
- Works in dev, staging, production environments
- No hardcoded domain names

[Source: Epic 8 - Frontend Integration]

---

### Response Field Naming

**Current Response (line 504-509):**
```json
{
  "message": "...",
  "code": "...",
  "statusCode": 402,
  "timestamp": "..."
}
```

**New FREEMIUM_QUOTA_EXCEEDED Response:**
```json
{
  "success": false,
  "error": "Free users can create maximum 2 assessments...",
  "code": "FREEMIUM_QUOTA_EXCEEDED",
  "upgradeUrl": "/pricing?upgrade=premium",
  "statusCode": 402,
  "timestamp": "..."
}
```

**Field Differences:**
- Added: `success: false` (explicit failure indicator)
- Changed: `message` → `error` (more explicit for error responses)
- Added: `upgradeUrl` (specific to quota errors)

**Why Different:**
- Quota errors require specific UI treatment (upgrade modal)
- Other 402 errors (insufficient credits) have different resolution (purchase credits)
- Frontend needs to distinguish between error types

[Source: API design patterns]

---

### Existing Error Handlers

**Current catch block has:**
1. **Line 503-511**: General 402 handler (insufficient credits)
2. **Line 513-521**: 403 handler (access denied)
3. **Line 523-528**: Default 400 handler

**New handler order:**
1. **NEW**: FREEMIUM_QUOTA_EXCEEDED (402 with upgradeUrl)
2. General 402 handler (other credit issues)
3. 403 handler
4. Default 400 handler

**Why Order Matters:**
- More specific handlers first
- FREEMIUM_QUOTA_EXCEEDED is a specific case of 402
- Falls through to general 402 if code doesn't match

[Source: backend/src/routes/assessment.routes.ts:500-529]

---

### Integration with AssessmentService

**Service Error (Story 5.6):**
```typescript
// In assessmentService.createAssessment()
if (quota && quota.totalAssessmentsCreated >= 2) {
  throw this.createError(
    'Free users can create maximum 2 assessments. Upgrade to Premium for unlimited access.',
    402,
    'FREEMIUM_QUOTA_EXCEEDED'
  );
}
```

**Route Catches:**
```typescript
// In assessment.routes.ts
} catch (error: any) {
  if (error.code === 'FREEMIUM_QUOTA_EXCEEDED') {
    // Handle with upgradeUrl
  }
}
```

**Error Object Structure:**
```typescript
{
  message: 'Free users can create maximum 2 assessments...',
  statusCode: 402,
  code: 'FREEMIUM_QUOTA_EXCEEDED',
}
```

[Source: Story 5.6 - AssessmentService]

---

### Testing Standards

**Test Framework:** Vitest 3
**Test Location:** `backend/tests/integration/assessment-quota-error.test.ts`

**Test Pattern:**
```typescript
import { describe, it, expect, beforeAll, afterAll } from 'vitest';
import { FastifyInstance } from 'fastify';
import { PrismaClient, SubscriptionPlan } from '../src/generated/prisma';
import { buildServer } from '../src/server';

describe('Assessment Quota Error Handling', () => {
  let server: FastifyInstance;
  let prisma: PrismaClient;
  let freeUserId: string;
  let freeUserToken: string;
  let premiumUserId: string;
  let premiumUserToken: string;
  let templateId: string;

  beforeAll(async () => {
    server = await buildServer();
    prisma = new PrismaClient();

    // Create template
    const template = await prisma.assessmentTemplate.create({
      data: {
        name: 'Test Template',
        category: 'COMPLIANCE',
        sections: { create: [] },
      },
    });
    templateId = template.id;

    // Create FREE user with 2 assessments already
    const freeUser = await prisma.user.create({
      data: {
        email: 'quota-free@example.com',
        firstName: 'Quota',
        lastName: 'Free',
        password: 'hashed',
        subscription: {
          create: {
            plan: SubscriptionPlan.FREE,
          },
        },
        assessmentQuota: {
          create: {
            totalAssessmentsCreated: 2,  // Already at limit
          },
        },
      },
    });
    freeUserId = freeUser.id;

    // Get auth token for free user
    const freeAuthResponse = await server.inject({
      method: 'POST',
      url: '/v1/auth/login',
      payload: { email: 'quota-free@example.com', password: 'hashed' },
    });
    freeUserToken = freeAuthResponse.json().token;

    // Create PREMIUM user
    const premiumUser = await prisma.user.create({
      data: {
        email: 'quota-premium@example.com',
        firstName: 'Quota',
        lastName: 'Premium',
        password: 'hashed',
        subscription: {
          create: {
            plan: SubscriptionPlan.PREMIUM,
            creditsBalance: 100,
          },
        },
      },
    });
    premiumUserId = premiumUser.id;

    const premiumAuthResponse = await server.inject({
      method: 'POST',
      url: '/v1/auth/login',
      payload: { email: 'quota-premium@example.com', password: 'hashed' },
    });
    premiumUserToken = premiumAuthResponse.json().token;
  });

  afterAll(async () => {
    await prisma.user.delete({ where: { id: freeUserId } });
    await prisma.user.delete({ where: { id: premiumUserId } });
    await prisma.assessmentTemplate.delete({ where: { id: templateId } });
    await prisma.$disconnect();
    await server.close();
  });

  describe('FREE user quota exceeded', () => {
    it('should return 402 with FREEMIUM_QUOTA_EXCEEDED code', async () => {
      const response = await server.inject({
        method: 'POST',
        url: '/v1/assessments',
        headers: {
          authorization: `Bearer ${freeUserToken}`,
        },
        payload: {
          templateId,
        },
      });

      expect(response.statusCode).toBe(402);
      expect(response.json().code).toBe('FREEMIUM_QUOTA_EXCEEDED');
    });

    it('should include upgradeUrl in response', async () => {
      const response = await server.inject({
        method: 'POST',
        url: '/v1/assessments',
        headers: {
          authorization: `Bearer ${freeUserToken}`,
        },
        payload: {
          templateId,
        },
      });

      const body = response.json();
      expect(body.upgradeUrl).toBe('/pricing?upgrade=premium');
    });

    it('should include descriptive error message', async () => {
      const response = await server.inject({
        method: 'POST',
        url: '/v1/assessments',
        headers: {
          authorization: `Bearer ${freeUserToken}`,
        },
        payload: {
          templateId,
        },
      });

      const body = response.json();
      expect(body.error).toContain('Free users can create maximum 2 assessments');
      expect(body.error).toContain('Upgrade to Premium');
    });

    it('should have success: false flag', async () => {
      const response = await server.inject({
        method: 'POST',
        url: '/v1/assessments',
        headers: {
          authorization: `Bearer ${freeUserToken}`,
        },
        payload: {
          templateId,
        },
      });

      expect(response.json().success).toBe(false);
    });
  });

  describe('PREMIUM user no quota limit', () => {
    it('should allow multiple assessment creations', async () => {
      // Create 3 assessments (no limit)
      for (let i = 0; i < 3; i++) {
        const response = await server.inject({
          method: 'POST',
          url: '/v1/assessments',
          headers: {
            authorization: `Bearer ${premiumUserToken}`,
          },
          payload: {
            templateId,
          },
        });

        expect(response.statusCode).toBe(201);
      }
    });
  });

  describe('Other 402 errors', () => {
    it('should handle insufficient credits error differently', async () => {
      // Create user with 0 credits
      const noCreditUser = await prisma.user.create({
        data: {
          email: 'nocredit@example.com',
          firstName: 'No',
          lastName: 'Credit',
          password: 'hashed',
          subscription: {
            create: {
              plan: SubscriptionPlan.PREMIUM,
              creditsBalance: 0,  // No credits
            },
          },
        },
      });

      const authResponse = await server.inject({
        method: 'POST',
        url: '/v1/auth/login',
        payload: { email: 'nocredit@example.com', password: 'hashed' },
      });
      const token = authResponse.json().token;

      const response = await server.inject({
        method: 'POST',
        url: '/v1/assessments',
        headers: {
          authorization: `Bearer ${token}`,
        },
        payload: {
          templateId,
        },
      });

      expect(response.statusCode).toBe(402);
      expect(response.json().code).not.toBe('FREEMIUM_QUOTA_EXCEEDED');
      expect(response.json().code).toBe('INSUFFICIENT_CREDITS');

      // Cleanup
      await prisma.user.delete({ where: { id: noCreditUser.id } });
    });
  });
});
```

[Source: architecture.md#Testing Strategy]

---

### File Locations
- **Route:** `backend/src/routes/assessment.routes.ts`
- **Endpoint:** POST / (line 356)
- **Catch Block:** Line 500-529
- **Test:** `backend/tests/integration/assessment-quota-error.test.ts`

---

### Dependencies
**Depends On:**
- Story 5.6: AssessmentService throws FREEMIUM_QUOTA_EXCEEDED error
- Existing: Error handling middleware

**Depended On By:**
- Story 8.2: Frontend quota warning UI will consume this error response
- Story 8.3: Upgrade modal triggered by upgradeUrl

---

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from Epic 7 | Bob (Scrum Master) |

---

## Dev Agent Record
_This section will be populated by the development agent during implementation_

### Agent Model Used
_TBD_

### Debug Log References
_TBD_

### Completion Notes
_TBD_

### File List
_TBD_

---

## QA Results
_This section will be populated by the QA agent after story completion_
