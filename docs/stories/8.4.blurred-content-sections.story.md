# Story 8.4: Add Blurred Content Sections to Assessment Results

## Status
Draft

## Story
**As a** Freemium user,
**I want** to see that gap analysis and strategy matrix exist but are locked,
**so that** I'm motivated to upgrade to see full details.

## Acceptance Criteria
1. New component created: `frontend/src/components/BlurredSection.tsx` (OR use existing `BlurOverlay` from freemium.tsx)
2. Component accepts props:
   ```typescript
   { title: string, children: React.ReactNode, locked: boolean }
   ```
3. Component displays:
   - Section title
   - Content with CSS blur filter (when locked)
   - Overlay with Lock icon
   - "Upgrade to Premium" button
   - Price text: "Starting at €599/month"
4. `AssessmentResults.tsx` modified to:
   - Check `results.isRestricted` flag from API
   - If `true`, wrap Gap Analysis and Strategy Matrix in `<BlurredSection locked={true}>`
   - If `false`, render normal unblurred content
5. Compliance score ALWAYS visible (never blurred)
6. Vendor section shows browse list but hides AI matching for FREE users
7. Download Report button hidden for FREE users
8. Blur effect: `filter: blur(8px)` with pointer-events disabled

## Tasks / Subtasks

- [ ] **Task 1: Use Existing BlurOverlay Component** (AC: 1, 2, 3, 8)
  - [ ] Import from existing freemium components:
    ```typescript
    import { BlurOverlay, RestrictedContent } from '@/components/ui/freemium';
    ```
  - [ ] BlurOverlay already implements:
    - CSS blur filter (blur-sm = 4px, can adjust to blur-lg = 16px)
    - Lock icon overlay
    - Upgrade button
    - Preview toggle functionality

- [ ] **Task 2: Fetch Assessment Results with isRestricted Flag** (AC: 4)
  - [ ] Open `frontend/src/pages/AssessmentResults.tsx`
  - [ ] Update results query to check plan:
    ```typescript
    const { data: results } = useQuery({
      queryKey: ['assessment', 'results', assessmentId],
      queryFn: async () => {
        const response = await fetch(`/v1/assessments/${assessmentId}/results`, {
          headers: { Authorization: `Bearer ${localStorage.getItem('token')}` },
        });
        return response.json();
      },
    });

    const { data: billingInfo } = useQuery({
      queryKey: ['subscription', 'billing-info'],
      queryFn: getBillingInfo,
    });

    const isFreeUser = billingInfo?.data?.plan === 'FREE';
    const isRestricted = results?.isRestricted || isFreeUser;
    ```

- [ ] **Task 3: Wrap Gap Analysis Section** (AC: 4, 5)
  - [ ] Find Gap Analysis section in JSX
  - [ ] Wrap with BlurOverlay:
    ```typescript
    <BlurOverlay
      isBlurred={isRestricted}
      upgradeMessage="Upgrade to Premium to view detailed gap analysis"
      onUpgrade={() => navigate('/pricing?upgrade=premium')}
    >
      <GapAnalysisSection gaps={results.gaps} />
    </BlurOverlay>
    ```

- [ ] **Task 4: Wrap Strategy Matrix Section** (AC: 4)
  - [ ] Find Strategy Matrix section
  - [ ] Wrap with BlurOverlay:
    ```typescript
    <BlurOverlay
      isBlurred={isRestricted}
      upgradeMessage="Upgrade to Premium to view strategy recommendations"
      onUpgrade={() => navigate('/pricing?upgrade=premium')}
    >
      <StrategyMatrixSection matrix={results.strategyMatrix} />
    </BlurOverlay>
    ```

- [ ] **Task 5: Keep Compliance Score Visible** (AC: 5)
  - [ ] Ensure compliance score NOT wrapped in BlurOverlay:
    ```typescript
    {/* Always visible - no blur */}
    <ComplianceScoreCard score={results.riskScore} />

    {/* Conditional blur for gaps */}
    <BlurOverlay isBlurred={isRestricted}>
      <GapAnalysisSection ... />
    </BlurOverlay>
    ```

- [ ] **Task 6: Hide AI Vendor Matching for FREE Users** (AC: 6)
  - [ ] Conditionally render vendor matches:
    ```typescript
    {isFreeUser ? (
      // Show browse-only vendor list
      <VendorBrowseList vendors={allVendors} />
    ) : (
      // Show AI-matched vendors with scores
      <VendorMatchesSection matches={results.vendorMatches} />
    )}
    ```
  - [ ] Add upgrade prompt for FREE users:
    ```typescript
    {isFreeUser && (
      <UpgradePrompt
        title="AI Vendor Matching"
        description="Upgrade to see AI-matched vendors for your assessment"
        features={['AI-powered matching', 'Match scores', 'Personalized recommendations']}
        onUpgrade={() => navigate('/pricing')}
      />
    )}
    ```

- [ ] **Task 7: Hide Download Report Button for FREE Users** (AC: 7)
  - [ ] Conditional button rendering:
    ```typescript
    {!isFreeUser && (
      <Button onClick={handleDownloadReport}>
        <FileDown className="h-4 w-4 mr-2" />
        Download PDF Report
      </Button>
    )}

    {isFreeUser && (
      <Button variant="outline" onClick={() => navigate('/pricing')}>
        <Crown className="h-4 w-4 mr-2" />
        Upgrade to Download Reports
      </Button>
    )}
    ```

- [ ] **Task 8: Adjust Blur Intensity** (AC: 8)
  - [ ] Modify BlurOverlay component if needed:
    ```typescript
    // In freemium.tsx or create custom wrapper
    <div className={cn(
      'transition-all duration-300',
      isBlurred && !showPreview && 'blur-lg pointer-events-none select-none'  // blur-lg = 16px
    )}>
      {children}
    </div>
    ```

- [ ] **Task 9: Add Section-Specific Upgrade Messages** (AC: 3)
  - [ ] Customize upgrade messages:
    ```typescript
    const upgradeMessages = {
      gapAnalysis: 'Upgrade to Premium to view detailed compliance gaps and remediation steps',
      strategyMatrix: 'Upgrade to Premium to access AI-powered strategy recommendations',
      vendorMatching: 'Upgrade to Premium for AI-matched vendor recommendations',
      reports: 'Upgrade to Premium to download comprehensive PDF reports',
    };
    ```

- [ ] **Task 10: Test Blur Effect on Different Devices** (AC: 8)
  - [ ] Test blur visibility on desktop (should be clearly blurred)
  - [ ] Test on mobile (blur may render differently)
  - [ ] Verify pointer-events disabled (can't interact with blurred content)
  - [ ] Test preview toggle (if using existing BlurOverlay)

## Dev Notes

### Existing BlurOverlay Component

**Location:** `frontend/src/components/ui/freemium.tsx` (lines 18-76)

**Features:**
- CSS blur filter (`blur-sm` by default)
- Overlay with Lock icon
- "Upgrade" button
- "Preview" button (toggles blur on/off temporarily)
- Gradient overlay for better readability
- Responsive design

**Props:**
```typescript
interface BlurOverlayProps {
  children: ReactNode;
  isBlurred?: boolean;
  upgradeMessage?: string;
  onUpgrade?: () => void;
  className?: string;
}
```

**Usage:**
```typescript
<BlurOverlay
  isBlurred={isFreeUser}
  upgradeMessage="Upgrade to view gap analysis"
  onUpgrade={() => navigate('/pricing')}
>
  <GapAnalysisContent />
</BlurOverlay>
```

[Source: frontend/src/components/ui/freemium.tsx:18-76]

---

### CSS Blur Filter

**TailwindCSS Blur Classes:**
- `blur-none` - No blur
- `blur-sm` - 4px blur
- `blur` - 8px blur (default)
- `blur-md` - 12px blur
- `blur-lg` - 16px blur
- `blur-xl` - 24px blur

**Recommended:** `blur-lg` (16px) for content protection while still showing structure

**CSS:**
```css
.blur-lg {
  filter: blur(16px);
}
```

[Source: TailwindCSS documentation]

---

### Content Restriction Strategy

**Always Visible (FREE Users):**
- Compliance score (headline number)
- Assessment summary
- Number of gaps found (count)
- Vendor directory (browse mode, no AI matching)

**Blurred/Locked (FREE Users):**
- Gap analysis details (descriptions, remediation steps)
- Strategy matrix (priority quadrants, recommendations)
- Risk analysis details
- AI vendor matches with scores

**Hidden (FREE Users):**
- Download PDF report button
- Export functionality
- Lead tracking

[Source: docs/V4_REVISED_PAY_GATING_PLAN.md, docs/prd/epic-8-frontend-integration.md#Story 4.4]

---

### Assessment Results Structure

**FREE User View:**
```
Assessment Results
==================

✅ Compliance Score: 68%    ← Always visible
Status: Medium Risk

── Gap Analysis ──────────  ← Blurred
[Blurred content with overlay]
"Upgrade to Premium to view detailed gap analysis"
[🔒 Upgrade] [👁 Preview]

── Strategy Matrix ───────  ← Blurred
[Blurred content with overlay]
"Upgrade to Premium to view strategy recommendations"
[🔒 Upgrade] [👁 Preview]

── Vendors ──────────────
Browse All Vendors         ← Visible (browse only)
- Vendor A
- Vendor B
- Vendor C

"Upgrade for AI vendor matching"  ← Upgrade prompt
[👑 Upgrade to Premium]

── Reports ──────────────
[👑 Upgrade to Download Reports]  ← Upgrade button instead of download
```

**PREMIUM User View:**
```
Assessment Results
==================

✅ Compliance Score: 68%    ← Always visible

── Gap Analysis ──────────  ← Fully visible
Gap 1: Lack of AML monitoring
Severity: High
Remediation: Implement transaction monitoring system
...

── Strategy Matrix ───────  ← Fully visible
High Priority / High Impact:
- Implement AML monitoring
- Update KYC procedures
...

── AI-Matched Vendors ────  ← Visible with scores
Vendor A - 92% match
Vendor B - 87% match
Vendor C - 81% match

── Reports ──────────────
[📥 Download PDF Report]    ← Download button
```

[Source: AssessmentResults page design]

---

### isRestricted Flag

**Backend Response:**
```json
{
  "success": true,
  "data": {
    "id": "asmt_123",
    "riskScore": 68,
    "isRestricted": true,  // ← Indicates freemium restrictions
    "gaps": [...],
    "strategyMatrix": {...},
    "vendorMatches": null  // ← Null for FREE users
  }
}
```

**Frontend Logic:**
```typescript
const isRestricted = results?.isRestricted || billingInfo?.plan === 'FREE';

// Use isRestricted to control blur
<BlurOverlay isBlurred={isRestricted}>
  ...
</BlurOverlay>
```

[Source: docs/stories/5.7.serve-mocked-content.story.md]

---

### Preview Toggle Feature

**Existing BlurOverlay has "Preview" button:**
- Temporarily removes blur (toggles `showPreview` state)
- User can peek at content before upgrading
- Encourages upgrade by showing value

**Implementation:**
```typescript
const [showPreview, setShowPreview] = useState(false);

<div className={cn(
  'transition-all duration-300',
  isBlurred && !showPreview && 'blur-sm'
)}>
  {children}
</div>

<Button onClick={() => setShowPreview(!showPreview)}>
  {showPreview ? 'Hide' : 'Preview'}
</Button>
```

[Source: frontend/src/components/ui/freemium.tsx:33-62]

---

### Accessibility

**Blurred Content:**
- Should be marked `aria-hidden="true"` when blurred
- Overlay should have descriptive `aria-label`
- Upgrade button should be keyboard accessible

**Implementation:**
```typescript
<div aria-hidden={isBlurred}>
  {children}
</div>

<div
  role="region"
  aria-label="Premium content - upgrade required"
>
  <Button aria-label="Upgrade to Premium to unlock this content">
    Upgrade
  </Button>
</div>
```

[Source: WCAG 2.1 accessibility guidelines]

---

### File Locations
- **Component:** Use existing `frontend/src/components/ui/freemium.tsx` (BlurOverlay, RestrictedContent)
- **Page:** `frontend/src/pages/AssessmentResults.tsx` (modify)

---

### Dependencies
**Depends On:**
- Story 5.7: Backend returns isRestricted flag
- Story 7.6: GET billing info to check plan
- Existing: BlurOverlay, RestrictedContent components

**Depended On By:**
- Story 8.5: Vendor matching uses similar restriction pattern

---

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from Epic 8 | Bob (Scrum Master) |

---

## Dev Agent Record
_This section will be populated by the development agent during implementation_

### Agent Model Used
_TBD_

### Debug Log References
_TBD_

### Completion Notes
_TBD_

### File List
_TBD_

---

## QA Results
_This section will be populated by the QA agent after story completion_
