# Story 10.4: Enhanced User Search and Advanced Filters

## Status
Draft

## Story

**As an** admin
**I want** advanced search and filtering options
**So that** I can quickly find specific users or user segments

## Acceptance Criteria

1. Search enhancements:
   - Search by email, first name, last name, organization name (existing)
   - Add search by user ID (exact match)
   - Add "Search in" dropdown: "All Fields", "Email Only", "Name Only", "Organization Only"
   - Debounced search (300ms) to reduce API calls
2. Advanced filters panel (collapsible):
   - Email verified: Yes / No / All
   - Last login: "Last 7 days", "Last 30 days", "Last 90 days", "Never", "All"
   - Has organization: Yes / No / All
   - Subscription plan: FREE / PREMIUM / ENTERPRISE / None / All
   - Created date range: Date picker (from/to)
3. Filter chips displayed above table:
   - Show active filters as removable chips
   - "Clear All Filters" button
4. URL state management:
   - Filters persist in URL query params
   - Shareable URLs with filter state
   - Back/forward navigation preserves filters
5. Export filtered results:
   - "Export Visible" button exports current filtered/searched users
   - CSV format with columns: ID, Email, Name, Role, Status, Organization, Created Date, Last Login
   - `GET /v1/admin/users/export?[filters]` returns CSV
   - Downloads as `users-export-YYYY-MM-DD.csv`
6. Performance: Queries with filters return within 500ms

## Tasks / Subtasks

- [ ] Task 1: Enhanced Search UI (AC: 1)
  - [ ] Add "Search in" dropdown next to search input
  - [ ] Implement debounced search with useDebouncedValue hook (300ms)
  - [ ] Add user ID search field (separate input or same with dropdown)
  - [ ] Update search query to respect "Search in" selection

- [ ] Task 2: Advanced Filters Panel (AC: 2)
  - [ ] Create collapsible "Advanced Filters" panel
  - [ ] Add Email Verified filter (Select with Yes/No/All)
  - [ ] Add Last Login filter (Select with presets)
  - [ ] Add Has Organization filter (Yes/No/All)
  - [ ] Add Subscription Plan filter (Select with plans)
  - [ ] Add Created Date Range filter (Date picker from/to)
  - [ ] Apply button to trigger filtered query

- [ ] Task 3: Filter Chips and Clear (AC: 3)
  - [ ] Display active filters as chips above table
  - [ ] Make chips removable (X button)
  - [ ] Add "Clear All Filters" button
  - [ ] Update query when filter removed

- [ ] Task 4: URL State Management (AC: 4)
  - [ ] Use useSearchParams hook for URL state
  - [ ] Serialize filters to URL query params
  - [ ] Parse URL params on page load
  - [ ] Test shareable URLs
  - [ ] Test browser back/forward navigation

- [ ] Task 5: Backend Filter Support (AC: 2, 6)
  - [ ] Update listUsers in user.service.ts to support new filters
  - [ ] Add emailVerified filter to Prisma where clause
  - [ ] Add lastLogin date range filter
  - [ ] Add organization existence filter (organizationId IS NULL)
  - [ ] Join Subscription table for plan filter
  - [ ] Add created date range filter
  - [ ] Optimize with indexes: lastLogin, emailVerified, createdAt
  - [ ] Test performance with 10,000+ users

- [ ] Task 6: CSV Export Backend (AC: 5)
  - [ ] Add exportUsers method to user.service.ts
  - [ ] Query users with same filters as list endpoint
  - [ ] Format as CSV using papaparse library
  - [ ] Include columns: ID, Email, Name, Role, Status, Org, Created, Last Login
  - [ ] Add `GET /admin/users/export` route
  - [ ] Set Content-Type: text/csv header
  - [ ] Set Content-Disposition: attachment header with filename

- [ ] Task 7: CSV Export Frontend (AC: 5)
  - [ ] Add "Export Visible" button next to search
  - [ ] Build export URL with current filters as query params
  - [ ] Trigger download via window.location or fetch + blob
  - [ ] Show loading indicator during export
  - [ ] Handle errors (too many results, timeout)

- [ ] Task 8: Testing (All AC)
  - [ ] Unit test: listUsers with each new filter
  - [ ] Unit test: exportUsers generates valid CSV
  - [ ] Integration test: GET /admin/users with filters
  - [ ] Integration test: GET /admin/users/export
  - [ ] Frontend test: Filter UI state management
  - [ ] Frontend test: URL params sync
  - [ ] E2E test: Search, filter, export flow

## Dev Notes

### Existing Search Implementation
[Source: frontend/src/pages/admin/UserManagement.tsx:167-172, backend/src/routes/admin.routes.ts:170-179]

Current search supports: email, firstName, lastName, organization.name via Prisma `contains` with case-insensitive mode.

### Backend Filter Extensions

**Update Prisma Query Building**:
```typescript
const where: any = {
  status: { not: UserStatus.DELETED }
};

// Email verified filter
if (emailVerified === 'yes') where.emailVerified = true;
if (emailVerified === 'no') where.emailVerified = false;

// Last login filter
if (lastLogin === 'last7days') {
  where.lastLogin = { gte: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000) };
}
if (lastLogin === 'never') where.lastLogin = null;

// Organization filter
if (hasOrganization === 'yes') where.organization = { isNot: null };
if (hasOrganization === 'no') where.organization = { is: null };

// Subscription plan filter (requires join)
if (subscriptionPlan) {
  where.subscription = { plan: subscriptionPlan };
}

// Created date range
if (createdFrom) where.createdAt = { gte: new Date(createdFrom) };
if (createdTo) where.createdAt = { ...where.createdAt, lte: new Date(createdTo) };
```

**Add Database Indexes** (for performance):
```prisma
model User {
  // ... existing fields
  @@index([emailVerified])
  @@index([lastLogin])
  @@index([createdAt])
}
```

### URL State Management Pattern

```typescript
const [searchParams, setSearchParams] = useSearchParams();

// Read filters from URL on mount
const filters = {
  search: searchParams.get('search') || '',
  emailVerified: searchParams.get('emailVerified') || 'all',
  lastLogin: searchParams.get('lastLogin') || 'all',
  // ... other filters
};

// Update URL when filters change
const updateFilters = (newFilters: Filters) => {
  const params = new URLSearchParams();
  Object.entries(newFilters).forEach(([key, value]) => {
    if (value && value !== 'all') params.set(key, value);
  });
  setSearchParams(params);
};
```

### CSV Export Implementation

**Backend CSV Generation**:
```typescript
import Papa from 'papaparse';

const users = await this.prisma.user.findMany({ where, include: { organization: true } });

const csvData = users.map(user => ({
  ID: user.id,
  Email: user.email,
  Name: `${user.firstName} ${user.lastName}`,
  Role: user.role,
  Status: user.status,
  Organization: user.organization?.name || 'N/A',
  'Created Date': user.createdAt.toISOString().split('T')[0],
  'Last Login': user.lastLogin ? user.lastLogin.toISOString().split('T')[0] : 'Never'
}));

const csv = Papa.unparse(csvData);
return csv;
```

**Frontend Download Trigger**:
```typescript
const handleExport = async () => {
  const params = new URLSearchParams(currentFilters);
  const url = `/v1/admin/users/export?${params}`;

  const response = await fetch(url, {
    headers: { Authorization: `Bearer ${token}` }
  });

  const blob = await response.blob();
  const downloadUrl = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = downloadUrl;
  a.download = `users-export-${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
};
```

### File Locations

**Backend**:
- `backend/src/services/user.service.ts` - Update listUsers, add exportUsers
- `backend/src/routes/admin.routes.ts` - Add GET /admin/users/export route
- `backend/prisma/schema.prisma` - Add indexes

**Frontend**:
- `frontend/src/pages/admin/UserManagement.tsx` - Add filters panel, chips, export button
- `frontend/src/hooks/useDebouncedValue.ts` - Create debounce hook (or use existing)

### Testing Standards
[Source: CLAUDE.md:251-263]
- Framework: Vitest 3
- Pattern: Arrange-Act-Assert
- Test each filter independently and combined

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Story created - Enhanced user search and filters | Bob (Scrum Master) |

---

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
