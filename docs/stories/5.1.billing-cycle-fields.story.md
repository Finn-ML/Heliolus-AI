# Story 5.1: Add Subscription Billing Cycle Fields

## Status
Draft

## Story
**As a** system administrator,
**I want** subscription records to track billing cycles (monthly/annual),
**so that** we can properly manage Premium subscription renewals and pricing.

## Acceptance Criteria
1. Subscription model has `billingCycle` enum field (MONTHLY, ANNUAL)
2. Subscription model has `billingEmail` string field
3. Subscription model has `renewalDate` datetime field
4. Subscription model has `stripePriceId` string field for linking to Stripe price objects
5. Migration is created and can be applied without data loss
6. Existing FREE subscriptions default to NULL billing cycle (no auto-renew)

## Tasks / Subtasks

- [ ] **Task 1: Create BillingCycle Enum** (AC: 1)
  - [ ] Add new enum `BillingCycle` to Prisma schema with values: MONTHLY, ANNUAL
  - [ ] Place enum near existing SubscriptionPlan enum (around line 187)
  - [ ] Follow existing enum naming convention (PascalCase for enum name, UPPERCASE for values)

- [ ] **Task 2: Add Fields to Subscription Model** (AC: 1, 2, 3, 4)
  - [ ] Open `backend/prisma/schema.prisma`
  - [ ] Locate Subscription model (line 739)
  - [ ] Add four new fields in "Billing" section (after canceledAt, before trialEnd):
    - `billingCycle BillingCycle?` (optional/nullable)
    - `billingEmail String?` (optional)
    - `renewalDate DateTime?` (optional)
    - `stripePriceId String?` (optional for Stripe price ID reference)
  - [ ] Ensure all fields are nullable to support FREE tier (no billing cycle)

- [ ] **Task 3: Generate and Review Prisma Migration** (AC: 5, 6)
  - [ ] Run: `npx prisma migrate dev --name add_billing_cycle_fields`
  - [ ] Review generated SQL in `prisma/migrations/` directory
  - [ ] Verify migration adds 4 new columns with nullable constraints
  - [ ] Verify migration does NOT modify existing columns
  - [ ] Verify no default values set (all columns nullable)
  - [ ] Test migration can be applied to test database

- [ ] **Task 4: Verify Backward Compatibility** (AC: 6)
  - [ ] Query existing Subscription records after migration
  - [ ] Verify existing records have NULL values for new fields
  - [ ] Verify existing FREE subscriptions still function correctly
  - [ ] Verify no breaking changes to existing API responses

- [ ] **Task 5: Update TypeScript Types** (AC: 1, 2, 3, 4)
  - [ ] Run: `npx prisma generate`
  - [ ] Verify generated `@prisma/client` includes new BillingCycle enum
  - [ ] Verify Subscription type includes new fields
  - [ ] Check TypeScript compilation succeeds: `npm run build`

- [ ] **Task 6: Write Unit Tests** (AC: 1-6)
  - [ ] Create test file: `backend/tests/unit/subscription-model.test.ts`
  - [ ] Test BillingCycle enum values (MONTHLY, ANNUAL)
  - [ ] Test creating Subscription with billingCycle = MONTHLY
  - [ ] Test creating Subscription with billingCycle = ANNUAL
  - [ ] Test creating FREE subscription with NULL billingCycle
  - [ ] Test all new fields accept NULL values
  - [ ] Run tests: `npm test`

## Dev Notes

### Database Schema Context
**Current Subscription Model Location:** `backend/prisma/schema.prisma` lines 739-779

**Existing Structure:**
```prisma
model Subscription {
  id     String @id @default(cuid())
  userId String @unique

  // Plan details
  plan   SubscriptionPlan   @default(FREE)
  status SubscriptionStatus @default(ACTIVE)

  // Stripe
  stripeCustomerId      String?
  stripeSubscriptionId  String?
  stripePaymentMethodId String?

  // Credits
  creditsBalance   Int @default(0)
  creditsUsed      Int @default(0)
  creditsPurchased Int @default(0)

  // Billing
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAt           DateTime?
  canceledAt         DateTime?

  // Trial
  trialEnd DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

**New Fields to Add (in "Billing" section):**
```prisma
// Billing Cycle (NEW)
billingCycle  BillingCycle? // MONTHLY or ANNUAL
billingEmail  String?       // Billing contact email
renewalDate   DateTime?     // Next renewal date
stripePriceId String?       // Links to Stripe price object (price_xxx)
```

[Source: backend/prisma/schema.prisma#Subscription]

---

### Enum Pattern
**Existing Enum Example:** `SubscriptionPlan` (line 187)
```prisma
enum SubscriptionPlan {
  FREE
  PREMIUM // â‚¬599/month
  ENTERPRISE // Custom
}
```

**New Enum to Create:**
```prisma
enum BillingCycle {
  MONTHLY
  ANNUAL
}
```

Place this enum near SubscriptionPlan enum (around line 193) to keep billing-related enums grouped together.

[Source: backend/prisma/schema.prisma#SubscriptionPlan]

---

### Migration Safety Requirements
**Critical Constraints:**
1. **All new fields MUST be nullable** - Cannot add required fields to existing table
2. **No default values** - FREE tier should have NULL billingCycle (not MONTHLY/ANNUAL)
3. **Additive only** - Do NOT modify existing columns
4. **Indexed appropriately** - No index needed on new fields (optional lookups)

**Migration Command:**
```bash
npx prisma migrate dev --name add_billing_cycle_fields
```

**Expected Migration Location:** `backend/prisma/migrations/YYYYMMDDHHMMSS_add_billing_cycle_fields/`

[Source: architecture.md#Database Integration]

---

### TypeScript Integration
After migration, Prisma will auto-generate TypeScript types:

**Location:** `backend/src/generated/prisma/index.d.ts`

**Generated Type (excerpt):**
```typescript
export type Subscription = {
  id: string
  userId: string
  plan: SubscriptionPlan
  status: SubscriptionStatus
  // ... existing fields
  billingCycle: BillingCycle | null  // NEW
  billingEmail: string | null        // NEW
  renewalDate: Date | null           // NEW
  stripePriceId: string | null       // NEW
  createdAt: Date
  updatedAt: Date
}

export enum BillingCycle {
  MONTHLY = 'MONTHLY',
  ANNUAL = 'ANNUAL'
}
```

**Regenerate Command:** `npx prisma generate`

[Source: architecture.md#Code Integration Strategy]

---

### File Locations
- **Schema File:** `backend/prisma/schema.prisma`
- **Migration Directory:** `backend/prisma/migrations/`
- **Generated Types:** `backend/src/generated/prisma/`
- **Test File:** `backend/tests/unit/subscription-model.test.ts`

[Source: architecture.md#Unified Project Structure]

---

### Backward Compatibility Notes
**Existing Subscriptions:**
- All existing records will have NULL values for new fields after migration
- FREE tier subscriptions will continue to work (NULL billingCycle)
- PREMIUM/ENTERPRISE subscriptions created before migration will have NULL billingCycle until upgraded

**API Compatibility:**
- No changes to existing API endpoints in this story
- Existing queries selecting Subscription will continue working
- New fields only returned if explicitly selected in Prisma query

[Source: architecture.md#Compatibility Requirements]

---

### Testing Standards

**Test Framework:** Vitest 3
**Test Location:** `backend/tests/unit/subscription-model.test.ts`

**Required Test Cases:**
1. **Enum Validation**
   - Test BillingCycle.MONTHLY exists
   - Test BillingCycle.ANNUAL exists
   - Test invalid values rejected

2. **Field Nullability**
   - Test creating Subscription with all new fields NULL
   - Test creating Subscription with all new fields populated
   - Test mixing NULL and non-NULL values

3. **FREE Tier Defaults**
   - Test FREE plan can be created without billingCycle
   - Test FREE plan saves with NULL billingCycle

4. **Migration Verification**
   - Test existing records have NULL values after migration
   - Test no data loss during migration

**Test Pattern:**
```typescript
import { describe, it, expect, beforeAll, afterAll } from 'vitest';
import { PrismaClient, BillingCycle, SubscriptionPlan } from '../src/generated/prisma';

describe('Subscription Billing Cycle Fields', () => {
  let prisma: PrismaClient;

  beforeAll(() => {
    prisma = new PrismaClient();
  });

  afterAll(async () => {
    await prisma.$disconnect();
  });

  it('should create subscription with MONTHLY billing cycle', async () => {
    const subscription = await prisma.subscription.create({
      data: {
        userId: 'test-user-1',
        plan: SubscriptionPlan.PREMIUM,
        billingCycle: BillingCycle.MONTHLY,
        billingEmail: 'billing@example.com',
        currentPeriodStart: new Date(),
        currentPeriodEnd: new Date(),
      },
    });

    expect(subscription.billingCycle).toBe(BillingCycle.MONTHLY);
    expect(subscription.billingEmail).toBe('billing@example.com');
  });

  // ... more tests
});
```

[Source: architecture.md#Testing Strategy]

---

### Previous Story Insights
No previous pay-gating stories exist. This is Story 5.1 (first story in Epic 5).

---

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from Epic 5 | Bob (Scrum Master) |

---

## Dev Agent Record
_This section will be populated by the development agent during implementation_

### Agent Model Used
_TBD_

### Debug Log References
_TBD_

### Completion Notes
_TBD_

### File List
_TBD_

---

## QA Results
_This section will be populated by the QA agent after story completion_
