# Story 1.27.1: Vendor Metadata Enhancement for Priorities-Based Matching

## Status
üìù **DRAFT** - Ready for Implementation

## Story

**As a** platform administrator managing vendor data,
**I want** enhanced vendor schema fields that align with the priorities questionnaire,
**so that** vendor matching accuracy improves from ~70% to ~95% precision when users complete their priorities.

## Background

Story 1.14 (Priorities Questionnaire) captures 6 steps of user preferences including deployment options, vendor maturity, support models, and decision factors. Story 1.27 (Vendor Matching) uses these priorities to boost match scores by up to 40 points.

**Current Issue:** The Vendor schema lacks structured fields for several priority dimensions, limiting matching precision to ~70%. This story adds missing fields to achieve ~95% precision matching.

## Acceptance Criteria

1. **Database Schema Enhancement**
   - Add `deploymentOptionsStructured` field (String array) to Vendor model
   - Add `maturityLevel` field (enum: ENTERPRISE, GROWTH, STARTUP) to Vendor model
   - Add `supportModels` field (String array) to Vendor model
   - Add `integrationsStructured` field (String array) to Vendor model
   - Add `minImplementationDays` field (Int) to Vendor model
   - Add `maxImplementationDays` field (Int) to Vendor model
   - Add `decisionFactorStrengths` field (Json) to Vendor model
   - Create Prisma migration for schema changes

2. **Enum Definitions**
   - Create `VendorMaturityLevel` enum: ENTERPRISE, GROWTH, STARTUP
   - Create `DeploymentOption` enum: CLOUD, ON_PREMISE, HYBRID, MANAGED_SERVICE
   - Create `SupportModel` enum: SELF_SERVICE, STANDARD, PREMIUM

3. **Data Migration Script**
   - Parse existing `deploymentOptions` (CSV string) ‚Üí `deploymentOptionsStructured` (array)
   - Parse existing `integrations` (CSV string) ‚Üí `integrationsStructured` (array)
   - Derive `minImplementationDays` / `maxImplementationDays` from `implementationTimeline` field
   - Default values for new nullable fields
   - Validation: Ensure no data loss during migration

4. **Admin UI for New Fields**
   - Update Vendor Admin form (`/frontend/src/pages/admin/VendorManagement.tsx`) to include:
     - Deployment Options multi-select checkboxes
     - Maturity Level radio buttons
     - Support Models multi-select checkboxes
     - Integrations multi-input field (tag-style input)
     - Implementation timeline range inputs (min/max days)
     - Decision Factor Strengths sliders (optional, 0-10 scale for 6 factors)

5. **Backend Service Updates**
   - Update `VendorMatchingService` to use new structured fields in scoring algorithm
   - Add scoring logic for:
     - `deploymentBoost`: Match deployment preference (+0-5 points)
     - `maturityBoost`: Match vendor maturity preference (+0-5 points)
     - `supportBoost`: Match support model preference (+0-5 points)
     - `integrationBoost`: Count of matched critical integrations (+0-10 points)
   - Update `priorityBoost` calculation to include new dimensions (increase max from 40 ‚Üí 50)

6. **API Response Updates**
   - Update Vendor response schema to include new fields
   - Update VendorMatchScore breakdown to show new boost components
   - Maintain backward compatibility (new fields optional)

7. **Vendor CSV Import Enhancement**
   - Update vendor CSV import script to accept new columns:
     - `Deployment Options` (comma-separated)
     - `Maturity Level` (single value)
     - `Support Models` (comma-separated)
     - `Integrations` (comma-separated, replacing old format)
     - `Min Implementation (Days)`
     - `Max Implementation (Days)`
   - Add validation for enum values
   - Add transformation logic for CSV ‚Üí database format

8. **Documentation Updates**
   - Update vendor onboarding guide with new fields
   - Update matching algorithm documentation with new scoring dimensions
   - Create vendor metadata research guide (for gathering data on existing vendors)

## Tasks / Subtasks

- [ ] Update Prisma schema (AC: 1, 2)
  - [ ] Add new enums to `backend/prisma/schema.prisma`:
    - `VendorMaturityLevel` enum
    - `DeploymentOption` enum (or use String[] with validation)
    - `SupportModel` enum (or use String[] with validation)
  - [ ] Add new fields to Vendor model:
    - `deploymentOptionsStructured String[] @default([])`
    - `maturityLevel VendorMaturityLevel?`
    - `supportModels String[] @default([])`
    - `integrationsStructured String[] @default([])`
    - `minImplementationDays Int?`
    - `maxImplementationDays Int?`
    - `decisionFactorStrengths Json?`
  - [ ] Add indexes for frequently queried fields:
    - `@@index([maturityLevel])`
    - `@@index([deploymentOptionsStructured])`
  - [ ] Run `npm run db:migrate` to create migration
  - [ ] Run `npm run db:generate` to regenerate Prisma client

- [ ] Create data migration script (AC: 3)
  - [ ] Create `/backend/scripts/migrate-vendor-metadata.ts`
  - [ ] Implement parsing logic for `deploymentOptions` CSV ‚Üí array
  - [ ] Implement parsing logic for `integrations` CSV ‚Üí array
  - [ ] Implement logic to split `implementationTimeline` into min/max range
  - [ ] Add validation: Log vendors with unparseable data
  - [ ] Add dry-run mode to preview changes
  - [ ] Add rollback capability
  - [ ] Test migration on development database
  - [ ] Document migration steps in script comments

- [ ] Update Admin UI (AC: 4)
  - [ ] Update `/frontend/src/pages/admin/VendorManagement.tsx`
  - [ ] Add Deployment Options multi-select using Radix Checkbox group
    - Options: Cloud, On-Premise, Hybrid, Managed Service
  - [ ] Add Maturity Level radio buttons using Radix RadioGroup
    - Options: Enterprise, Growth, Startup
  - [ ] Add Support Models multi-select using Radix Checkbox group
    - Options: Self-Service, Standard, Premium
  - [ ] Add Integrations tag input field (create reusable TagInput component)
    - Allow adding/removing integration names
    - Display as badges
  - [ ] Add Implementation Timeline range inputs:
    - Minimum days (number input)
    - Maximum days (number input)
    - Validation: Min < Max
  - [ ] Add Decision Factor Strengths section (optional):
    - 6 sliders (Radix Slider) for factors: Price, Features, Support, Implementation Speed, Reputation, Innovation
    - Scale: 0-10
    - Default: 5 (neutral)
  - [ ] Update form validation schema (Zod) to include new fields
  - [ ] Update form submission to API

- [ ] Update Backend Services (AC: 5)
  - [ ] Update `/backend/src/services/vendor-matching.service.ts`:
    - [ ] Add `calculateDeploymentBoost()` method (+0-5 points)
      - Match user's deployment preference with vendor's `deploymentOptionsStructured`
      - Full match = 5 points, partial match = 2 points
    - [ ] Add `calculateMaturityBoost()` method (+0-5 points)
      - Match user's vendor maturity preference with vendor's `maturityLevel`
      - Exact match = 5 points, no match = 0 points
    - [ ] Add `calculateSupportBoost()` method (+0-5 points)
      - Match user's support model preference with vendor's `supportModels`
      - Contains match = 5 points, no match = 0 points
    - [ ] Add `calculateIntegrationBoost()` method (+0-10 points)
      - Count matched integrations between user's `criticalIntegrations` and vendor's `integrationsStructured`
      - 1 point per matched integration (max 10)
    - [ ] Update `calculatePriorityBoost()` to include new dimensions
    - [ ] Update `totalBoost` max from 40 ‚Üí 50 points
    - [ ] Update `totalScore` max from 140 ‚Üí 150 points
  - [ ] Update response schemas to include new boost breakdown

- [ ] Update API Layer (AC: 6)
  - [ ] Update `/backend/src/routes/vendor.routes.ts`:
    - [ ] Update Vendor response schema (Zod) to include new fields
    - [ ] Update VendorMatchScore response to show new boost components:
      - `deploymentBoost: number`
      - `maturityBoost: number`
      - `supportBoost: number`
      - `integrationBoost: number`
    - [ ] Ensure backward compatibility (new fields optional in responses)
  - [ ] Update admin vendor CRUD endpoints to accept new fields

- [ ] Update Frontend Types (AC: 6)
  - [ ] Update `/frontend/src/types/vendor-matching.types.ts`:
    - [ ] Add new fields to `Vendor` interface
    - [ ] Update `PriorityBoost` interface to include new boost components
    - [ ] Update `totalScore` type annotations from 140 ‚Üí 150

- [ ] Enhance CSV Import Script (AC: 7)
  - [ ] Update `/backend/scripts/import-vendors-csv.ts` (or create if missing)
  - [ ] Add new CSV column mappings:
    - `Deployment Options` ‚Üí split by comma ‚Üí `deploymentOptionsStructured`
    - `Maturity Level` ‚Üí enum validation ‚Üí `maturityLevel`
    - `Support Models` ‚Üí split by comma ‚Üí `supportModels`
    - `Integrations` ‚Üí split by comma ‚Üí `integrationsStructured`
    - `Min Implementation (Days)` ‚Üí parseInt ‚Üí `minImplementationDays`
    - `Max Implementation (Days)` ‚Üí parseInt ‚Üí `maxImplementationDays`
  - [ ] Add validation for enum values (log warnings for invalid values)
  - [ ] Add default value handling for optional fields
  - [ ] Update CSV template with new columns

- [ ] Update Documentation (AC: 8)
  - [ ] Update `/docs/vendor-onboarding-guide.md`:
    - [ ] Add new fields to vendor profile requirements
    - [ ] Add examples for each new field
    - [ ] Add validation rules
  - [ ] Update `/docs/architecture/vendor-matching-algorithm.md`:
    - [ ] Document new scoring dimensions
    - [ ] Update scoring formula with new max scores
    - [ ] Add examples of new boost calculations
  - [ ] Create `/docs/vendor-metadata-research-guide.md`:
    - [ ] Include LLM research prompt for gathering vendor data
    - [ ] Add instructions for running research on existing vendors
    - [ ] Add quality assurance checklist

- [ ] Update Vendor Marketplace Display (AC: 6)
  - [ ] Update `/frontend/src/components/VendorMarketplace.tsx`:
    - [ ] Update match score badge from "X/140" ‚Üí "X/150"
    - [ ] Update match quality thresholds if needed
    - [ ] Update tooltip to show new boost components
  - [ ] Test match score display with updated scoring

- [ ] Testing
  - [ ] Unit tests for new boost calculation methods
  - [ ] Integration tests for vendor matching with new fields
  - [ ] Test data migration script on test database
  - [ ] Test admin UI for new fields (CRUD operations)
  - [ ] Test CSV import with new columns
  - [ ] Regression test: Ensure existing matching still works

## Dev Notes

### Current Schema Gaps

| Priority Dimension | Current Field | Issue | New Field |
|-------------------|---------------|-------|-----------|
| Deployment Preference | `deploymentOptions: String?` | Freeform CSV string | `deploymentOptionsStructured: String[]` |
| Vendor Maturity | ‚ùå Missing | No field | `maturityLevel: VendorMaturityLevel?` |
| Support Model | ‚ùå Missing | No field | `supportModels: String[]` |
| Critical Integrations | `integrations: String?` | Freeform CSV string | `integrationsStructured: String[]` |
| Implementation Urgency | `implementationTimeline: Int?` | Single value (days) | `minImplementationDays: Int?`, `maxImplementationDays: Int?` |
| Decision Factors | ‚ùå Missing | No vendor self-assessment | `decisionFactorStrengths: Json?` |

### Proposed Schema Changes

```prisma
// Add to enums section
enum VendorMaturityLevel {
  ENTERPRISE // Established vendors (10+ years, Fortune 500 clients)
  GROWTH     // Mid-stage vendors (3-10 years, growing client base)
  STARTUP    // Early-stage vendors (<3 years, innovative solutions)
}

// Update Vendor model
model Vendor {
  // ... existing fields ...

  // NEW: Structured deployment options (replaces freeform deploymentOptions)
  deploymentOptionsStructured String[] @default([])
  // Values: "CLOUD", "ON_PREMISE", "HYBRID", "MANAGED_SERVICE"

  // NEW: Vendor maturity classification
  maturityLevel VendorMaturityLevel?

  // NEW: Support models offered
  supportModels String[] @default([])
  // Values: "SELF_SERVICE", "STANDARD", "PREMIUM"

  // NEW: Structured integrations list (replaces freeform integrations)
  integrationsStructured String[] @default([])
  // Example: ["Salesforce", "ServiceNow", "Workday", "SAP"]

  // NEW: Implementation timeline range
  minImplementationDays Int? // Fastest possible implementation
  maxImplementationDays Int? // Typical implementation timeline

  // NEW: Vendor self-assessment of decision factor strengths (optional)
  decisionFactorStrengths Json?
  // Example: { "price": 7, "features": 9, "support": 8, "speed": 6, "reputation": 9, "innovation": 7 }

  // ... existing relations ...

  @@index([maturityLevel])
  @@index([deploymentOptionsStructured])
}
```

### Updated Scoring Algorithm

**Current Priority Boost (0-40 points):**
- Top Priority Boost: 0-20 points
- Feature Boost: 0-10 points
- Deployment Boost: 0-5 points (currently basic)
- Speed Boost: 0-5 points

**Enhanced Priority Boost (0-50 points):**
- Top Priority Boost: 0-20 points (unchanged)
- Feature Boost: 0-10 points (unchanged)
- **Deployment Boost: 0-5 points** (enhanced with structured data)
- **Maturity Boost: 0-5 points** (NEW)
- **Support Boost: 0-5 points** (NEW)
- **Integration Boost: 0-10 points** (NEW, replaces Speed Boost)

**Total Score:** 0-150 (was 0-140)

### Data Migration Strategy

1. **Phase 1: Schema Update**
   - Deploy Prisma migration
   - New fields added as nullable/default values
   - Existing data unaffected

2. **Phase 2: Data Transformation**
   - Run migration script on production database
   - Parse existing CSV fields ‚Üí structured arrays
   - Log any parsing errors for manual review
   - Validate data integrity

3. **Phase 3: Service Update**
   - Deploy updated matching service
   - New scoring logic uses structured fields
   - Falls back to old fields if new fields empty

4. **Phase 4: Admin UI Update**
   - Deploy updated admin interface
   - Admins can edit new fields going forward

5. **Phase 5: CSV Import Update**
   - Update import script for new vendor onboarding
   - Provide CSV template with new columns

### Backward Compatibility

- Keep existing `deploymentOptions` and `integrations` fields (deprecated)
- Matching service checks structured fields first, falls back to old fields
- API responses include both old and new fields during transition
- Mark old fields as `@deprecated` in schema after 3 months

### Integration Points

**Backend Services:**
- `vendor-matching.service.ts` - Core scoring updates
- `vendor.service.ts` - CRUD operations for new fields
- `admin.service.ts` - Vendor approval with new fields

**Frontend Components:**
- `VendorManagement.tsx` - Admin UI for editing new fields
- `VendorMarketplace.tsx` - Display updated match scores (X/150)
- `StrategyMatrix.tsx` - Updated vendor recommendations

**Database:**
- Prisma migration: `20250414_add_vendor_metadata_fields`
- Migration script: `migrate-vendor-metadata.ts`

### Testing Strategy

**Unit Tests:**
- `vendor-matching.service.test.ts` - Test new boost calculations
- Test cases: Full matches, partial matches, no matches
- Edge cases: Empty arrays, null values, invalid enums

**Integration Tests:**
- Test vendor CRUD with new fields
- Test matching algorithm with priorities + new fields
- Test CSV import with new columns

**Manual QA:**
- Test admin UI: Add/edit/delete vendors with new fields
- Test matching flow end-to-end:
  1. User completes priorities questionnaire
  2. Navigate to marketplace
  3. Verify match scores reflect new dimensions
  4. Verify tooltip shows new boost breakdown
- Test data migration on staging database

**Regression Tests:**
- Ensure existing vendor matching still works without new fields
- Ensure existing vendors display correctly in marketplace
- Ensure CSV import with old format still works

### Rollout Plan

**Week 1: Schema & Migration**
- Deploy Prisma migration to staging
- Run data migration script on staging database
- Validate data integrity

**Week 2: Backend Services**
- Deploy updated matching service to staging
- Test matching accuracy with new fields
- Compare scores: old algorithm vs new algorithm

**Week 3: Admin UI**
- Deploy admin UI updates to staging
- Train admins on new fields
- Backfill data for existing vendors (10-20 key vendors)

**Week 4: Production Rollout**
- Deploy schema migration to production
- Run data migration script on production
- Deploy services and UI updates
- Monitor error logs and match quality metrics

**Week 5: CSV Import & Onboarding**
- Update vendor onboarding docs
- Send new CSV template to vendors
- Begin collecting new metadata for future vendor additions

### Performance Considerations

- New indexed fields (`maturityLevel`, `deploymentOptionsStructured`) for fast filtering
- JSON field (`decisionFactorStrengths`) not indexed (used only in scoring, not filtering)
- Array fields use GIN indexes (PostgreSQL) for efficient array overlap queries
- Caching: Strategy matrix and vendor matches already cached (5 min TTL), no change needed

### Metrics to Track

**Pre-Implementation (Baseline):**
- Average match score: ~85/140 (60%)
- Users contacting top 3 matches: ~45%
- Users filtering "Show only matched vendors": ~30%

**Post-Implementation (Goals):**
- Average match score: ~105/150 (70%)
- Users contacting top 3 matches: >60% (+15%)
- Users filtering "Show only matched vendors": >50% (+20%)
- Match precision (user feedback): >90% relevant

## Research Prompt for Vendor Metadata

See `VENDOR_METADATA_RESEARCH_PROMPT.md` (created as separate file)

## Change Log

| Date       | Version | Description                          | Author        |
|------------|---------|--------------------------------------|---------------|
| 2025-10-15 | 1.0     | Initial story created based on Story 1.27 vendor metadata gap analysis | Dev (James)  |

## Dev Agent Record

### Agent Model Used
_To be populated during implementation_

### Debug Log References
_To be populated during implementation_

### Completion Notes
_To be populated after implementation_

### File List
_To be populated after implementation_

## QA Results

_To be populated by QA agent after implementation review_
