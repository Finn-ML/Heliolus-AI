# Story 1.16: Strategy Matrix Timeline View - Phased Remediation Roadmap

## Status
**DEPRECATED** - Consolidated into Story 1.27

## Deprecation Notice
This story has been **consolidated into Story 1.27** "Enhanced Results Page - Strategy Matrix & Vendor Matching Integration" which integrates the strategy matrix as a tab within the results page for a more cohesive user experience.

**Why Deprecated:**
- Strategy Matrix is now a tab in Results page (cleaner UX)
- Backend API already exists and is functional (`GET /api/assessments/:id/strategy-matrix`)
- Story 1.27 handles the frontend integration more elegantly

**Replacement Story:** 1.27.results-strategy-vendor-matching.md
**Date Deprecated:** 2025-10-14

## Backend API Status (Confirmed Working)
- ✅ `GET /api/assessments/:id/strategy-matrix` - Implemented (vendor.routes.ts:1002)
  - NOTE: Endpoint is in vendor.routes.ts (not assessment.routes.ts) - architectural decision
  - Service layer: `StrategyMatrixService` exists and functional
- ⚠️ `POST /assessments/:id/export-strategy-matrix` - **NOT IMPLEMENTED** (deferred to future story)
  - Story AC #6 has been marked as DEFERRED
  - Export functionality can be added later or use client-side PDF generation

## Story

**As a** frontend developer,
**I want** to create a visual strategy matrix showing gaps organized into timeline buckets,
**so that** users can see a phased remediation roadmap with effort, cost, and vendor recommendations.

## Acceptance Criteria

1. **Component: StrategyMatrixTimeline.tsx** - Main timeline view
   - Three-column layout (desktop) or vertical stack (mobile/tablet)
   - Fetches data from GET /assessments/:id/strategy-matrix
2. **Component: TimelineBucket.tsx** - Single timeline bucket
   - Props: `bucket: { gaps, gapCount, effortDist, costRange, vendors }`, `title: string`, `timeframe: string`
   - Header: "0-6 Months: Immediate" with timeframe badge
   - Metrics summary card:
     - Gap count: "5 gaps identified"
     - Effort distribution: "2 small, 2 medium, 1 large"
     - Cost range: "Total estimated cost: $100K-$250K"
   - Gap list: scrollable container with GapCard components
   - Vendors section: "Recommended Vendors" with top 3 vendor cards
3. **Component: GapCard.tsx** - Individual gap card
   - Gap title
   - Severity badge (Critical/High/Medium/Low with color coding)
   - Priority score (1-10 with visual indicator)
   - Effort badge (S/M/L)
   - Cost estimate
   - "View Details" button (expands inline or opens modal with full gap description)
4. Visual design:
   - Color-coded severity: Critical (red), High (orange), Medium (yellow), Low (blue)
   - Timeline buckets have distinct background colors (light red, light yellow, light green for immediate/near-term/strategic)
   - Visual connectors: dotted lines between gaps and recommended vendors showing relationship
5. Vendor cards in bucket show:
   - Vendor name and logo
   - "Addresses X gaps in this timeframe" label
   - Gap coverage list (which specific gaps)
   - "View Vendor Details" button
6. ~~"Export Timeline" button generates PDF of strategy matrix~~ **DEFERRED** - Backend endpoint not yet implemented. Can be added in future story with client-side PDF generation or backend endpoint.
7. Responsive design:
   - Desktop (≥1024px): three columns side-by-side
   - Tablet (768-1023px): two columns (immediate + near-term, strategic below)
   - Mobile (<768px): vertical stack, one bucket per section
8. Empty states: "No gaps identified in this timeframe" with checkmark icon

## Tasks / Subtasks

- [ ] Create main StrategyMatrixTimeline component (AC: 1)
  - [ ] Create `/frontend/src/components/assessment/StrategyMatrixTimeline.tsx`
  - [ ] Fetch strategy matrix data using TanStack Query
  - [ ] Implement three-column grid layout (CSS Grid)
  - [ ] Add responsive breakpoints for tablet/mobile
  - [ ] Map timeline buckets (immediate, near-term, strategic)
  - [ ] Render TimelineBucket component for each bucket
- [ ] Create TimelineBucket component (AC: 2)
  - [ ] Create `/frontend/src/components/assessment/timeline/TimelineBucket.tsx`
  - [ ] Add props interface: `{ bucket, title, timeframe }`
  - [ ] Create bucket header with title and timeframe badge
  - [ ] Create metrics summary card:
    - Gap count display
    - Effort distribution breakdown
    - Cost range estimate
  - [ ] Add scrollable gap list container
  - [ ] Render GapCard components for each gap
  - [ ] Add "Recommended Vendors" section
  - [ ] Render top 3 vendor cards per bucket
  - [ ] Style background colors per timeframe:
    - Immediate: bg-red-50
    - Near-term: bg-yellow-50
    - Strategic: bg-green-50
- [ ] Create GapCard component (AC: 3)
  - [ ] Create `/frontend/src/components/assessment/timeline/GapCard.tsx`
  - [ ] Display gap title prominently
  - [ ] Add severity badge with color coding (Radix Badge):
    - Critical: bg-red-500
    - High: bg-orange-500
    - Medium: bg-yellow-500
    - Low: bg-blue-500
  - [ ] Display priority score (1-10) with visual indicator (stars or progress bar)
  - [ ] Add effort badge (S/M/L) with icons
  - [ ] Display cost estimate range
  - [ ] Add "View Details" button
  - [ ] Implement expandable details panel (Radix Collapsible)
  - [ ] Show full gap description, recommendations, affected areas in details
- [ ] Create TimelineVendorCard component (AC: 5)
  - [ ] Create `/frontend/src/components/assessment/timeline/TimelineVendorCard.tsx`
  - [ ] Display vendor name and logo (fallback to initials if no logo)
  - [ ] Add "Addresses X gaps in this timeframe" label
  - [ ] Create gap coverage checklist showing which gaps addressed
  - [ ] Add "View Vendor Details" button linking to vendor profile
  - [ ] Style as compact card (smaller than full vendor card)
- [ ] Add visual connectors between gaps and vendors (AC: 4)
  - [ ] Implement CSS-based dotted lines connecting gaps to vendor cards
  - [ ] Use SVG paths or CSS pseudo-elements for connectors
  - [ ] Only show connectors when gap is addressed by displayed vendor
  - [ ] Add hover effect: highlight connector and related gap/vendor on hover
- [ ] Implement export functionality (AC: 6)
  - [ ] Add "Export Timeline" button to header
  - [ ] Call API POST /assessments/:id/export-strategy-matrix
  - [ ] Show loading state during PDF generation
  - [ ] Trigger download when PDF ready
  - [ ] Handle export errors gracefully
- [ ] Add API client integration
  - [ ] Extend `/frontend/src/lib/api.ts` with `getStrategyMatrix(assessmentId)` method
  - [ ] Extend with `exportStrategyMatrix(assessmentId)` method
  - [ ] Create TanStack Query hook `useStrategyMatrix(assessmentId)`
  - [ ] Configure query key: `['assessments', assessmentId, 'strategy-matrix']`
  - [ ] Add proper TypeScript interfaces for strategy matrix data
- [ ] Implement responsive design (AC: 7)
  - [ ] Desktop (≥1024px): CSS Grid with 3 columns (1fr 1fr 1fr)
  - [ ] Tablet (768-1023px): CSS Grid with 2 columns, strategic bucket spans 2 columns below
  - [ ] Mobile (<768px): Single column, vertical stack
  - [ ] Test gap cards on mobile (ensure readable and touch-friendly)
  - [ ] Adjust vendor cards for mobile (simplified layout)
- [ ] Add empty states (AC: 8)
  - [ ] Create EmptyBucket component with checkmark icon
  - [ ] Display "No gaps identified in this timeframe" message
  - [ ] Add encouraging message: "Great job! No immediate action needed."
  - [ ] Ensure empty state doesn't break grid layout

## Dev Notes

### Relevant Source Tree
- `/frontend/src/components/assessment/` - Assessment-specific components
- `/frontend/src/components/assessment/timeline/` - NEW subdirectory for timeline components
- `/frontend/src/components/ui/` - Radix UI component library
- `/frontend/src/lib/api.ts` - Centralized API client
- `/backend/src/routes/assessment.routes.ts` - Assessment API endpoints (72KB)
- `/backend/src/services/strategy-matrix.service.ts` - NEW (created in Story 1.11)

### Design Decisions

**Timeline Bucket Structure:**
Three predefined buckets based on priority scoring:
- **Immediate (0-6 months):** Critical/High severity gaps with priority score 8-10
- **Near-term (6-12 months):** Medium/High severity gaps with priority score 5-7
- **Strategic (12-24 months):** Low/Medium severity gaps with priority score 1-4

**Data Structure (from API):**
```typescript
interface StrategyMatrix {
  assessmentId: string;
  buckets: {
    immediate: TimelineBucket;
    nearTerm: TimelineBucket;
    strategic: TimelineBucket;
  };
}

interface TimelineBucket {
  gaps: Array<{
    id: string;
    title: string;
    description: string;
    severity: 'Critical' | 'High' | 'Medium' | 'Low';
    priority: number; // 1-10
    effort: 'SMALL' | 'MEDIUM' | 'LARGE';
    costRange: CostRange;
  }>;
  gapCount: number;
  effortDistribution: {
    small: number;
    medium: number;
    large: number;
  };
  costRange: {
    min: number;
    max: number;
  };
  vendors: Array<{
    id: string;
    name: string;
    logo: string | null;
    gapsCovered: string[]; // gap IDs
  }>;
}
```

**Color Scheme:**
- Bucket backgrounds: subtle tints (50 shade in Tailwind)
- Severity badges: vibrant colors (500 shade)
- Effort badges: neutral colors (gray-500/600/700)
- Visual connectors: dashed lines with gray-300

**Scrollable Gap Lists:**
Limit gap list height to prevent excessive scrolling. Use `max-h-96 overflow-y-auto` for scrollable container with custom scrollbar styling.

### Integration Points

**API Endpoints:**
- ✅ `GET /api/assessments/:id/strategy-matrix` - Implemented in vendor.routes.ts:1002 (Story 1.09)
  - **IMPORTANT:** Note the `/api` prefix for correct routing
  - Located in vendor.routes.ts (not assessment.routes.ts) for architectural reasons
  - Returns complete strategy matrix with three timeline buckets
  - Each bucket contains: gaps, metrics, top 3 vendor recommendations
  - Response schema:
    ```typescript
    interface StrategyMatrix {
      assessmentId: string;
      generatedAt: Date;
      immediate: TimelineBucket;   // 0-6 months (priority 8-10)
      nearTerm: TimelineBucket;    // 6-18 months (priority 4-7)
      strategic: TimelineBucket;   // 18+ months (priority 1-3)
    }

    interface TimelineBucket {
      timeline: string;            // "0-6 months", "6-18 months", "18+ months"
      gaps: Gap[];                 // Full gap objects
      gapCount: number;
      effortDistribution: {
        SMALL: number;
        MEDIUM: number;
        LARGE: number;
      };
      estimatedCostRange: string;  // "€50K-€150K estimated"
      topVendors: VendorRecommendation[];  // Top 3 vendors
    }
    ```

**PDF Export Feature:**
- The `POST /assessments/:id/export-strategy-matrix` endpoint is **NOT YET IMPLEMENTED**
- **For this story:** Defer PDF export functionality (AC: 6)
- **Alternative (Optional):** Use client-side PDF generation with `html2pdf.js` or `jsPDF`
- **Recommended:** Implement visualization first, add export in future story

**Integration Verification (from PRD):**
- **IV1:** Gaps in strategy matrix match gaps in Gap Analysis tab (data consistency)
- **IV2:** "View Vendor Details" navigates to vendor profile or comparison view
- **IV3:** "View Details" on gap shows same information as Gap Analysis tab

**Radix UI Components to Use:**
- `Badge` - Severity badges, effort badges, timeframe badges
- `Collapsible` - Expandable gap details panel
- `Card` - Gap cards, vendor cards, metrics summary card
- `Tooltip` - Hover explanations for effort, cost, priority
- `Button` - "View Details", "View Vendor Details", "Export Timeline"
- `ScrollArea` - Custom scrollbar for gap lists

**TanStack Query Integration:**
```typescript
const { data: strategyMatrix, isLoading } = useQuery({
  queryKey: ['assessments', assessmentId, 'strategy-matrix'],
  queryFn: () => api.getStrategyMatrix(assessmentId),
  staleTime: 5 * 60 * 1000, // 5 minutes
  enabled: !!assessmentId
});
```

**CSS Grid Layout:**
```css
/* Desktop */
.timeline-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1.5rem;
}

/* Tablet */
@media (min-width: 768px) and (max-width: 1023px) {
  .timeline-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  .timeline-grid > :last-child {
    grid-column: span 2;
  }
}

/* Mobile */
@media (max-width: 767px) {
  .timeline-grid {
    grid-template-columns: 1fr;
  }
}
```

**Visual Connectors (SVG approach):**
```typescript
// Calculate connector path from gap card to vendor card
const getConnectorPath = (gapId: string, vendorId: string) => {
  const gapEl = document.getElementById(`gap-${gapId}`);
  const vendorEl = document.getElementById(`vendor-${vendorId}`);
  if (!gapEl || !vendorEl) return null;

  const gapRect = gapEl.getBoundingClientRect();
  const vendorRect = vendorEl.getBoundingClientRect();

  // SVG path from gap (right edge) to vendor (left edge)
  return `M ${gapRect.right},${gapRect.top + gapRect.height / 2}
          L ${vendorRect.left},${vendorRect.top + vendorRect.height / 2}`;
};
```

### Existing Patterns to Follow

**Card Component Pattern:**
Follow existing card patterns from `VendorMarketplace.tsx` and `ComparisonView.tsx`. Use consistent padding, border radius, and shadow styles.

**Badge Component Pattern:**
Reuse badge variants from existing codebase. Add new severity variants if not already present.

**Loading States:**
Use skeleton UI matching timeline structure (3 column skeleton grid).

### Testing

**Test File Location:**
- Component tests: `/frontend/src/components/__tests__/StrategyMatrixTimeline.test.tsx`
- Component tests: `/frontend/src/components/__tests__/timeline/*.test.tsx`
- Integration tests: `/backend/tests/integration/strategy-matrix.spec.ts`

**Testing Frameworks:**
- Vitest 3 + React Testing Library
- Mock TanStack Query with QueryClientProvider
- Mock IntersectionObserver for scrollable containers

**Test Cases:**
1. StrategyMatrixTimeline renders three buckets correctly
2. Timeline fetches data from API on mount
3. TimelineBucket displays correct header, title, timeframe
4. Metrics summary shows correct gap count, effort distribution, cost range
5. GapCard renders with all required fields
6. Severity badge displays correct color and label
7. Effort badge displays correct size indicator
8. "View Details" button expands gap details panel
9. TimelineVendorCard displays vendor info correctly
10. Gap coverage list shows correct gaps addressed
11. "View Vendor Details" button navigates to vendor profile
12. Visual connectors render between gaps and vendors
13. "Export Timeline" button triggers API call
14. Export shows loading state and downloads PDF
15. Empty state displays when no gaps in timeframe
16. Responsive layout works on desktop (3 columns)
17. Responsive layout works on tablet (2 columns + full width strategic)
18. Responsive layout works on mobile (vertical stack)
19. Gap list scrolls correctly when many gaps present
20. Data consistency: gaps match Gap Analysis tab (IV1)

**Coverage Target:**
- Component coverage: 85%+ (comprehensive timeline visualization testing)
- Integration coverage: 90%+ (all bucket and gap scenarios)

## Change Log

| Date       | Version | Description                          | Author        |
|------------|---------|--------------------------------------|---------------|
| 2025-10-07 | 1.0     | Initial story created from PRD Epic 1 | SM (Winston)  |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent during implementation_

### Debug Log References
_To be populated by dev agent during implementation_

### Completion Notes
_To be populated by dev agent during implementation_

### File List
_To be populated by dev agent during implementation_

## QA Results

_To be populated by QA agent after implementation review_
