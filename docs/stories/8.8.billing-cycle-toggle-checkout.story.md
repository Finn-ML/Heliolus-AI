# Story 8.8: Add Billing Cycle Toggle to Subscription Upgrade Flow

## Status
Draft

## Story
**As a** user upgrading to Premium,
**I want** to choose between monthly and annual billing,
**so that** I can save 10% with annual commitment.

## Acceptance Criteria
1. Create/update `frontend/src/pages/Checkout.tsx` (if doesn't exist)
2. Page displays:
   - Plan details (Premium features)
   - Billing cycle selector:
     - Radio buttons or toggle: "Monthly" vs "Annual"
     - Monthly: "â‚¬599/month"
     - Annual: "â‚¬6,490/year (Save 10%)" with green savings badge
   - Payment method form (Stripe Elements placeholder)
   - Total amount based on selection
   - "Confirm Upgrade" button
3. On submit:
   - Call API: `POST /v1/subscriptions/:userId/upgrade` with selected billingCycle
   - Mock payment success for now
   - Redirect to dashboard with success message
4. URL params control initial selection: `/checkout?plan=premium&cycle=monthly`
5. Savings calculation displayed: "Save â‚¬718.80/year"
6. Back button returns to pricing page

## Tasks / Subtasks

- [ ] **Task 1: Create Checkout Page** (AC: 1)
  - [ ] Create file: `frontend/src/pages/Checkout.tsx`
  - [ ] Import dependencies:
    ```typescript
    import { useState, useEffect } from 'react';
    import { useNavigate, useSearchParams } from 'react-router-dom';
    import { useMutation } from '@tanstack/react-query';
    import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
    import { Button } from '@/components/ui/button';
    import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';
    import { Label } from '@/components/ui/label';
    import { Badge } from '@/components/ui/badge';
    import { Check, ArrowLeft } from 'lucide-react';
    import { toast } from '@/hooks/use-toast';
    ```

- [ ] **Task 2: Add Page State and URL Params** (AC: 4)
  - [ ] Set up state:
    ```typescript
    export default function Checkout() {
      const navigate = useNavigate();
      const [searchParams] = useSearchParams();

      // Get params from URL
      const planParam = searchParams.get('plan') || 'premium';
      const cycleParam = searchParams.get('cycle') || 'monthly';

      const [billingCycle, setBillingCycle] = useState<'monthly' | 'annual'>(
        cycleParam as 'monthly' | 'annual'
      );

      const [isProcessing, setIsProcessing] = useState(false);
    }
    ```

- [ ] **Task 3: Define Plan Features and Pricing** (AC: 2, 5)
  - [ ] Add configuration:
    ```typescript
    const PREMIUM_FEATURES = [
      'Unlimited compliance assessments',
      'Full gap analysis and remediation steps',
      'AI-powered strategy matrix',
      'AI vendor matching with scores',
      'Downloadable PDF reports',
      'Lead tracking and RFP management',
      'Priority email support',
    ];

    const PRICING = {
      monthly: {
        amount: 599,
        label: 'â‚¬599/month',
        total: 599,
      },
      annual: {
        amount: 6490,
        label: 'â‚¬6,490/year',
        total: 6490,
        savings: 698.80,  // (599 * 12) - 6490
        savingsPercent: 10,
      },
    };
    ```

- [ ] **Task 4: Create Billing Cycle Selector** (AC: 2)
  - [ ] Add radio group:
    ```typescript
    <div className="space-y-4">
      <Label className="text-base font-semibold">Billing Cycle</Label>
      <RadioGroup
        value={billingCycle}
        onValueChange={(value) => setBillingCycle(value as 'monthly' | 'annual')}
      >
        {/* Monthly Option */}
        <div className="flex items-center space-x-2 rounded-lg border p-4 cursor-pointer hover:bg-muted">
          <RadioGroupItem value="monthly" id="monthly" />
          <Label htmlFor="monthly" className="flex-1 cursor-pointer">
            <div className="flex justify-between items-center">
              <div>
                <p className="font-semibold">Monthly</p>
                <p className="text-sm text-muted-foreground">Flexible billing</p>
              </div>
              <div className="text-right">
                <p className="font-semibold">â‚¬599/month</p>
                <p className="text-sm text-muted-foreground">Billed monthly</p>
              </div>
            </div>
          </Label>
        </div>

        {/* Annual Option */}
        <div className="flex items-center space-x-2 rounded-lg border p-4 cursor-pointer hover:bg-muted relative">
          <RadioGroupItem value="annual" id="annual" />
          <Label htmlFor="annual" className="flex-1 cursor-pointer">
            <div className="flex justify-between items-center">
              <div>
                <p className="font-semibold">Annual</p>
                <p className="text-sm text-muted-foreground">Save 10%</p>
              </div>
              <div className="text-right">
                <p className="font-semibold">â‚¬6,490/year</p>
                <p className="text-sm text-green-600">Save â‚¬698.80</p>
              </div>
            </div>
          </Label>
          <Badge className="absolute -top-2 -right-2 bg-green-600">
            Save 10%
          </Badge>
        </div>
      </RadioGroup>
    </div>
    ```

- [ ] **Task 5: Add Plan Features Display** (AC: 2)
  - [ ] Show feature list:
    ```typescript
    <Card>
      <CardHeader>
        <CardTitle>Premium Plan</CardTitle>
        <CardDescription>Full compliance analysis with AI-powered insights</CardDescription>
      </CardHeader>
      <CardContent>
        <ul className="space-y-3">
          {PREMIUM_FEATURES.map((feature, index) => (
            <li key={index} className="flex items-start gap-3">
              <Check className="h-5 w-5 text-primary flex-shrink-0 mt-0.5" />
              <span className="text-sm">{feature}</span>
            </li>
          ))}
        </ul>
      </CardContent>
    </Card>
    ```

- [ ] **Task 6: Add Payment Method Placeholder** (AC: 2)
  - [ ] Add Stripe Elements placeholder:
    ```typescript
    <Card>
      <CardHeader>
        <CardTitle>Payment Method</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="bg-muted rounded-lg p-4 text-center">
          <p className="text-sm text-muted-foreground">
            Stripe payment integration will be added in a future update.
            For now, your upgrade will be processed without payment.
          </p>
        </div>
      </CardContent>
    </Card>
    ```

- [ ] **Task 7: Add Total and Savings Display** (AC: 2, 5)
  - [ ] Show price summary:
    ```typescript
    <Card>
      <CardHeader>
        <CardTitle>Order Summary</CardTitle>
      </CardHeader>
      <CardContent className="space-y-3">
        <div className="flex justify-between">
          <span>Premium Plan</span>
          <span className="font-semibold">{PRICING[billingCycle].label}</span>
        </div>

        {billingCycle === 'annual' && (
          <div className="flex justify-between text-green-600">
            <span>Annual Savings</span>
            <span className="font-semibold">-â‚¬{PRICING.annual.savings}</span>
          </div>
        )}

        <div className="border-t pt-3 flex justify-between text-lg font-bold">
          <span>Total {billingCycle === 'annual' ? 'per year' : 'per month'}</span>
          <span>â‚¬{PRICING[billingCycle].total}</span>
        </div>

        {billingCycle === 'annual' && (
          <p className="text-sm text-muted-foreground text-center">
            That's only â‚¬541/month when billed annually
          </p>
        )}
      </CardContent>
    </Card>
    ```

- [ ] **Task 8: Implement Upgrade Mutation** (AC: 3)
  - [ ] Add API call:
    ```typescript
    const upgradeMutation = useMutation({
      mutationFn: async () => {
        const userId = getCurrentUserId();
        const response = await fetch(`/v1/subscriptions/${userId}/upgrade`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${localStorage.getItem('token')}`,
          },
          body: JSON.stringify({
            plan: 'PREMIUM',
            billingCycle: billingCycle.toUpperCase(),
            stripePaymentMethodId: 'pm_mock_123',  // Mock for now
          }),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Upgrade failed');
        }

        return response.json();
      },
      onSuccess: () => {
        toast({
          title: 'Upgrade Successful!',
          description: 'Your account has been upgraded to Premium.',
        });

        // Redirect to dashboard
        navigate('/?upgraded=true');
      },
      onError: (error: Error) => {
        toast({
          title: 'Upgrade Failed',
          description: error.message,
          variant: 'destructive',
        });
      },
    });
    ```

- [ ] **Task 9: Add Confirm Button** (AC: 2, 3)
  - [ ] Add submit button:
    ```typescript
    <Button
      onClick={() => upgradeMutation.mutate()}
      disabled={upgradeMutation.isPending}
      className="w-full"
      size="lg"
    >
      {upgradeMutation.isPending
        ? 'Processing...'
        : `Confirm Upgrade - ${PRICING[billingCycle].label}`}
    </Button>
    ```

- [ ] **Task 10: Add Back Button** (AC: 6)
  - [ ] Add navigation:
    ```typescript
    <Button
      variant="ghost"
      onClick={() => navigate('/pricing')}
      className="mb-6"
    >
      <ArrowLeft className="h-4 w-4 mr-2" />
      Back to Pricing
    </Button>
    ```

- [ ] **Task 11: Add Route to App** (AC: 1)
  - [ ] Add route in App.tsx:
    ```typescript
    <Route path="/checkout" element={<Checkout />} />
    ```

- [ ] **Task 12: Test Checkout Flow** (AC: 1-6)
  - [ ] Test URL params pre-select cycle
  - [ ] Test toggle between monthly/annual
  - [ ] Test savings calculation displayed
  - [ ] Test confirm button triggers upgrade
  - [ ] Test loading state during upgrade
  - [ ] Test success redirect to dashboard
  - [ ] Test back button returns to pricing
  - [ ] Test responsive design

## Dev Notes

### Checkout Page Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [â† Back to Pricing]                    â”‚
â”‚                                        â”‚
â”‚ Upgrade to Premium                     â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                   â”‚
â”‚                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Premium Plan                       â”‚ â”‚
â”‚ â”‚ âœ“ Unlimited assessments            â”‚ â”‚
â”‚ â”‚ âœ“ Full gap analysis                â”‚ â”‚
â”‚ â”‚ âœ“ AI vendor matching               â”‚ â”‚
â”‚ â”‚ ...                                â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                        â”‚
â”‚ Billing Cycle                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â—‹ Monthly        â‚¬599/month        â”‚ â”‚
â”‚ â”‚   Flexible billing                 â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â— Annual         â‚¬6,490/year  ğŸ’š10%â”‚ â”‚
â”‚ â”‚   Save â‚¬698.80                     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                        â”‚
â”‚ Payment Method                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Stripe integration coming soon     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                        â”‚
â”‚ Order Summary                          â”‚
â”‚ Premium Plan            â‚¬6,490/year    â”‚
â”‚ Annual Savings          -â‚¬698.80       â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ Total per year          â‚¬6,490         â”‚
â”‚ (That's only â‚¬541/month)               â”‚
â”‚                                        â”‚
â”‚ [Confirm Upgrade - â‚¬6,490/year]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

[Source: docs/prd/epic-8-frontend-integration.md#Story 4.8]

---

### Pricing Breakdown

**Monthly:**
- Price: â‚¬599/month
- Billed: Every month
- Annual cost: â‚¬7,188 (â‚¬599 Ã— 12)

**Annual:**
- Price: â‚¬6,490/year
- Billed: Once per year
- Monthly equivalent: â‚¬540.83/month
- Savings: â‚¬698.80/year (10%)

**Calculation:**
```
Monthly annual total: â‚¬599 Ã— 12 = â‚¬7,188
Annual plan cost:     â‚¬6,490
Savings:             â‚¬7,188 - â‚¬6,490 = â‚¬698.80
Percentage:          â‚¬698.80 / â‚¬7,188 = 9.72% â‰ˆ 10%
```

[Source: docs/stories/6.2.update-create-subscription.story.md]

---

### URL Parameters

**Supported Params:**
- `plan` - Plan to upgrade to (e.g., `premium`)
- `cycle` - Billing cycle (e.g., `monthly`, `annual`)

**Examples:**
- `/checkout?plan=premium&cycle=monthly` - Monthly billing pre-selected
- `/checkout?plan=premium&cycle=annual` - Annual billing pre-selected
- `/checkout` - Defaults to premium + monthly

**Usage:**
```typescript
const [searchParams] = useSearchParams();
const cycleParam = searchParams.get('cycle') || 'monthly';
const [billingCycle, setBillingCycle] = useState(cycleParam);
```

[Source: React Router URL params patterns]

---

### Mock Payment

**Current Implementation:**
- No Stripe integration yet
- Upgrade processed immediately without payment
- Payment method field shows placeholder
- TODO comment for future Stripe integration

**Future Enhancement:**
```typescript
// TODO: Story 9.x - Real Stripe Integration
// 1. Collect payment method with Stripe Elements
// 2. Create Stripe payment intent
// 3. Confirm payment
// 4. Wait for webhook confirmation
// 5. Activate subscription
```

[Source: docs/prd/epic-8-frontend-integration.md#Story 4.8]

---

### Savings Badge Design

**Visual Hierarchy:**
- Green color (success/positive)
- Absolute positioning on annual card
- Clear percentage ("Save 10%")
- Euro amount shown in price breakdown

**CSS:**
```typescript
<Badge className="absolute -top-2 -right-2 bg-green-600">
  Save 10%
</Badge>

<p className="text-sm text-green-600">
  Save â‚¬698.80
</p>
```

[Source: UI design patterns for pricing]

---

### Testing Checklist

- [ ] Page loads without errors
- [ ] URL param `?cycle=monthly` pre-selects monthly
- [ ] URL param `?cycle=annual` pre-selects annual
- [ ] Toggle between monthly and annual works
- [ ] Monthly shows â‚¬599/month
- [ ] Annual shows â‚¬6,490/year with savings
- [ ] Savings calculation correct (â‚¬698.80)
- [ ] Feature list displays
- [ ] Payment placeholder shown
- [ ] Order summary calculates correctly
- [ ] Confirm button triggers upgrade
- [ ] Loading state shown during upgrade
- [ ] Success toast on successful upgrade
- [ ] Redirect to dashboard after upgrade
- [ ] Back button returns to /pricing
- [ ] Responsive design on mobile

[Source: Frontend testing best practices]

---

### File Locations
- **Page:** `frontend/src/pages/Checkout.tsx` (new)
- **Router:** `frontend/src/App.tsx` (add route)

---

### Dependencies
**Depends On:**
- Story 7.4: POST /v1/subscriptions/:userId/upgrade endpoint
- Existing: RadioGroup, Card, Button UI components

**Depended On By:**
- Future Story 9.x: Real Stripe checkout integration

---

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from Epic 8 | Bob (Scrum Master) |

---

## Dev Agent Record
_This section will be populated by the development agent during implementation_

### Agent Model Used
_TBD_

### Debug Log References
_TBD_

### Completion Notes
_TBD_

### File List
_TBD_

---

## QA Results
_This section will be populated by the QA agent after story completion_
