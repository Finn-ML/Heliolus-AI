# Story 8.3: Add Quota Exceeded Modal to Assessment Creation Flow

## Status
Draft

## Story
**As a** Freemium user,
**I want** clear messaging when I hit my assessment limit,
**so that** I understand I need to upgrade.

## Acceptance Criteria
1. New component created: `frontend/src/components/UpgradePromptModal.tsx`
2. Component accepts props:
   ```typescript
   {
     title: string,
     message: string,
     plan: string,
     price: string,
     onUpgrade: () => void
   }
   ```
3. Component displays modal with:
   - Icon (Lock or Sparkles)
   - Title: "Assessment Limit Reached"
   - Message: "Free users can create maximum 2 assessments"
   - Upgrade button: "Upgrade to Premium - €599/month"
   - Secondary button: "Learn More" (links to /pricing)
4. Modal shown when user attempts to create 3rd assessment
5. `AssessmentTemplates.tsx` modified to:
   - Check quota before allowing template selection
   - Call `handleSelectTemplate()` which checks `quota.totalAssessmentsCreated >= 2`
   - Show UpgradePromptModal if quota exceeded
   - Prevent assessment creation API call
6. Error code `FREEMIUM_QUOTA_EXCEEDED` from backend triggers same modal

## Tasks / Subtasks

- [ ] **Task 1: Create UpgradePromptModal Component** (AC: 1, 2, 3)
  - [ ] Create file: `frontend/src/components/UpgradePromptModal.tsx`
  - [ ] Import dependencies:
    ```typescript
    import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/dialog';
    import { Button } from '@/components/ui/button';
    import { Crown, Lock, Sparkles, ArrowRight } from 'lucide-react';
    ```
  - [ ] Define component interface:
    ```typescript
    interface UpgradePromptModalProps {
      isOpen: boolean;
      onClose: () => void;
      title?: string;
      message?: string;
      plan?: string;
      price?: string;
      onUpgrade: () => void;
    }
    ```

- [ ] **Task 2: Implement Modal Component** (AC: 3)
  - [ ] Add component implementation:
    ```typescript
    export const UpgradePromptModal = ({
      isOpen,
      onClose,
      title = 'Assessment Limit Reached',
      message = 'Free users can create maximum 2 assessments. Upgrade to Premium for unlimited access.',
      plan = 'Premium',
      price = '€599/month',
      onUpgrade,
    }: UpgradePromptModalProps) => {
      return (
        <Dialog open={isOpen} onOpenChange={onClose}>
          <DialogContent className="sm:max-w-md">
            <DialogHeader>
              <div className="flex items-center justify-center mb-4">
                <div className="p-3 rounded-full bg-primary/10">
                  <Lock className="h-8 w-8 text-primary" />
                </div>
              </div>
              <DialogTitle className="text-center text-xl">
                {title}
              </DialogTitle>
              <DialogDescription className="text-center">
                {message}
              </DialogDescription>
            </DialogHeader>

            <div className="my-6">
              <div className="bg-primary/5 rounded-lg p-4 border border-primary/20">
                <div className="flex items-center gap-3">
                  <Crown className="h-5 w-5 text-primary" />
                  <div className="flex-1">
                    <p className="font-semibold">{plan} Plan</p>
                    <p className="text-sm text-muted-foreground">
                      Unlimited assessments • Full analysis • AI vendor matching
                    </p>
                  </div>
                  <div className="text-right">
                    <p className="font-bold text-lg">{price}</p>
                  </div>
                </div>
              </div>
            </div>

            <DialogFooter className="flex-col sm:flex-row gap-2">
              <Button
                variant="outline"
                onClick={() => {
                  onClose();
                  window.location.href = '/pricing';
                }}
                className="w-full sm:w-auto"
              >
                Learn More
              </Button>
              <Button
                onClick={() => {
                  onClose();
                  onUpgrade();
                }}
                className="w-full sm:w-auto"
              >
                <Crown className="h-4 w-4 mr-2" />
                Upgrade to {plan}
                <ArrowRight className="h-4 w-4 ml-2" />
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      );
    };
    ```

- [ ] **Task 3: Integrate Modal into AssessmentTemplates** (AC: 4, 5)
  - [ ] Open `frontend/src/pages/AssessmentTemplates.tsx`
  - [ ] Add modal state:
    ```typescript
    import { UpgradePromptModal } from '@/components/UpgradePromptModal';

    const [showUpgradeModal, setShowUpgradeModal] = useState(false);
    ```
  - [ ] Modify template selection handler:
    ```typescript
    const handleSelectTemplate = (templateId: string) => {
      // Check quota before proceeding
      if (quota?.quotaRemaining === 0) {
        setShowUpgradeModal(true);
        return;
      }

      // Proceed with assessment creation
      navigate(`/assessment/execute/${templateId}`);
    };
    ```

- [ ] **Task 4: Render Modal** (AC: 3, 4)
  - [ ] Add modal to component JSX:
    ```typescript
    return (
      <div>
        {/* Page content */}

        {/* Upgrade Modal */}
        <UpgradePromptModal
          isOpen={showUpgradeModal}
          onClose={() => setShowUpgradeModal(false)}
          onUpgrade={() => navigate('/pricing?upgrade=premium')}
        />
      </div>
    );
    ```

- [ ] **Task 5: Add Backend Error Handler** (AC: 6)
  - [ ] In assessment creation API call, handle 402 error:
    ```typescript
    const createAssessment = async (templateId: string) => {
      try {
        const response = await fetch(`/v1/assessments`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${localStorage.getItem('token')}`,
          },
          body: JSON.stringify({ templateId }),
        });

        if (!response.ok) {
          const errorData = await response.json();

          // Handle quota exceeded from backend
          if (errorData.code === 'FREEMIUM_QUOTA_EXCEEDED') {
            setShowUpgradeModal(true);
            return;
          }

          throw new Error(errorData.message || 'Failed to create assessment');
        }

        return response.json();
      } catch (error) {
        console.error('Assessment creation failed:', error);
        throw error;
      }
    };
    ```

- [ ] **Task 6: Add Modal Variants** (AC: 3)
  - [ ] Support different modal types:
    ```typescript
    interface UpgradePromptModalProps {
      // ... existing props
      variant?: 'quota-exceeded' | 'feature-locked' | 'generic';
    }

    // Use variant to customize icon, message
    const getIcon = () => {
      switch (variant) {
        case 'quota-exceeded': return Lock;
        case 'feature-locked': return Sparkles;
        default: return Crown;
      }
    };
    ```

- [ ] **Task 7: Add Analytics Tracking** (Optional)
  - [ ] Track when modal is shown:
    ```typescript
    useEffect(() => {
      if (isOpen) {
        // Track modal view
        analytics.track('Upgrade Modal Shown', {
          reason: 'quota_exceeded',
          plan: 'premium',
        });
      }
    }, [isOpen]);
    ```

- [ ] **Task 8: Test Modal Interactions**
  - [ ] Test modal opens when quota exceeded
  - [ ] Test "Learn More" navigates to /pricing
  - [ ] Test "Upgrade" navigates to /pricing?upgrade=premium
  - [ ] Test modal closes when clicking outside (if enabled)
  - [ ] Test ESC key closes modal
  - [ ] Test keyboard navigation (Tab through buttons)

- [ ] **Task 9: Add Animation/Transition** (AC: 3)
  - [ ] Ensure Dialog has smooth open/close animation
  - [ ] Verify backdrop fade-in
  - [ ] Test on mobile devices

- [ ] **Task 10: Update Existing Freemium Component** (Alternative)
  - [ ] Option: Use existing `UpgradeDialog` from freemium.tsx:
    ```typescript
    import { UpgradeDialog } from '@/components/ui/freemium';

    <UpgradeDialog
      isOpen={showUpgradeModal}
      onOpenChange={setShowUpgradeModal}
      title="Assessment Limit Reached"
      description="Free users can create maximum 2 assessments"
      features={[
        'Unlimited assessments',
        'Full gap analysis',
        'AI vendor matching',
        'Downloadable reports',
      ]}
      pricing={{ monthly: '€599', annual: '€6,490' }}
      onUpgrade={(plan) => navigate(`/pricing?cycle=${plan}`)}
    />
    ```

## Dev Notes

### Modal Display Triggers

**Trigger 1: Frontend Quota Check (Preventive)**
```
User clicks template → Check quota.quotaRemaining
→ If 0: Show modal, prevent API call
→ If > 0: Proceed with assessment creation
```

**Trigger 2: Backend Error (Defensive)**
```
User clicks template → API call to create assessment
→ Backend returns 402 FREEMIUM_QUOTA_EXCEEDED
→ Frontend catches error, shows modal
```

**Why Both:**
- Frontend check: Better UX (immediate feedback, no API call)
- Backend check: Security (authoritative, prevents bypassing frontend)

[Source: docs/prd/epic-8-frontend-integration.md#Story 4.3]

---

### Existing UpgradeDialog Component

**Location:** `frontend/src/components/ui/freemium.tsx` (lines 193-264)

**Props:**
```typescript
interface UpgradeDialogProps {
  isOpen: boolean;
  onOpenChange: (open: boolean) => void;
  title?: string;
  description?: string;
  features: string[];
  pricing?: { monthly: string; annual: string; };
  onUpgrade?: (plan: 'monthly' | 'annual') => void;
}
```

**Features:**
- Pre-built with feature list
- Monthly vs Annual plan selection
- Responsive design
- Accessibility built-in

**Recommendation:**
Use existing `UpgradeDialog` instead of creating new component if it meets requirements.

[Source: frontend/src/components/ui/freemium.tsx:193-264]

---

### Modal Content Structure

**Layout:**
```
┌─────────────────────────────┐
│         [Icon]              │
│                             │
│  Assessment Limit Reached   │  ← Title
│                             │
│  Free users can create...   │  ← Message
│                             │
│  ┌───────────────────────┐  │
│  │ 👑 Premium Plan       │  │
│  │ €599/month            │  │  ← Plan Card
│  │ • Unlimited...        │  │
│  └───────────────────────┘  │
│                             │
│  [Learn More] [Upgrade]     │  ← Actions
└─────────────────────────────┘
```

[Source: Modal UX best practices]

---

### Button Actions

**Learn More Button:**
- Variant: `outline` (secondary)
- Action: Navigate to `/pricing`
- Purpose: User wants to compare plans before deciding
- Closes modal

**Upgrade Button:**
- Variant: `default` (primary)
- Action: Navigate to `/pricing?upgrade=premium`
- Purpose: User ready to upgrade immediately
- Closes modal
- Pre-selects Premium plan on pricing page

[Source: UX design patterns for paywalls]

---

### Error Handling from Backend

**402 Response Format (from Story 7.1):**
```json
{
  "success": false,
  "error": "Free users can create maximum 2 assessments. Upgrade to Premium for unlimited access.",
  "code": "FREEMIUM_QUOTA_EXCEEDED",
  "upgradeUrl": "/pricing?upgrade=premium",
  "statusCode": 402,
  "timestamp": "2025-10-23T..."
}
```

**Frontend Handler:**
```typescript
try {
  const response = await createAssessment(templateId);
} catch (error) {
  if (error.response?.status === 402 && error.data?.code === 'FREEMIUM_QUOTA_EXCEEDED') {
    setShowUpgradeModal(true);
    setUpgradeUrl(error.data.upgradeUrl || '/pricing');
  } else {
    toast.error(error.message || 'Failed to create assessment');
  }
}
```

[Source: docs/stories/7.1.quota-error-handling.story.md]

---

### Modal State Management

**Component State:**
```typescript
const [showUpgradeModal, setShowUpgradeModal] = useState(false);
const [modalConfig, setModalConfig] = useState({
  title: 'Assessment Limit Reached',
  message: 'Free users can create maximum 2 assessments.',
  price: '€599/month',
});
```

**Opening Modal:**
```typescript
// From quota check
setShowUpgradeModal(true);

// From backend error
if (error.code === 'FREEMIUM_QUOTA_EXCEEDED') {
  setModalConfig({
    title: error.title || 'Assessment Limit Reached',
    message: error.error,
    price: '€599/month',
  });
  setShowUpgradeModal(true);
}
```

[Source: React state management patterns]

---

### Accessibility

**Requirements:**
- Focus trap (can't tab outside modal)
- ESC key closes modal
- Backdrop click closes modal (optional)
- Screen reader announces modal title
- Buttons keyboard navigable

**Radix UI Dialog Provides:**
```typescript
<Dialog open={isOpen} onOpenChange={onClose}>
  {/* Auto-managed: */}
  {/* - Focus trap */}
  {/* - ESC key handling */}
  {/* - ARIA attributes */}
  {/* - Body scroll lock */}
</Dialog>
```

[Source: Radix UI Dialog documentation]

---

### Responsive Design

**Desktop (> 640px):**
- Modal width: `max-w-md` (28rem / 448px)
- Centered on screen
- Buttons side-by-side

**Mobile (< 640px):**
- Modal full-width with padding
- Buttons stacked vertically
- Larger touch targets

**CSS Classes:**
```typescript
<DialogContent className="sm:max-w-md">  {/* Responsive width */}
  <DialogFooter className="flex-col sm:flex-row gap-2">  {/* Responsive button layout */}
    <Button className="w-full sm:w-auto">...</Button>
  </DialogFooter>
</DialogContent>
```

[Source: TailwindCSS responsive patterns]

---

### Testing Checklist

- [ ] Modal opens when quota exceeded (frontend check)
- [ ] Modal opens on 402 backend error
- [ ] "Learn More" navigates to /pricing
- [ ] "Upgrade" navigates to /pricing?upgrade=premium
- [ ] Modal closes on backdrop click
- [ ] Modal closes on ESC key
- [ ] Focus trapped in modal
- [ ] Buttons keyboard accessible
- [ ] Mobile layout stacks buttons
- [ ] Desktop layout shows buttons side-by-side
- [ ] Icon displays correctly
- [ ] Plan card shows correct pricing
- [ ] Screen reader announces modal content

[Source: Frontend testing best practices]

---

### File Locations
- **Component:** `frontend/src/components/UpgradePromptModal.tsx` (new) OR use existing `frontend/src/components/ui/freemium.tsx`
- **Page:** `frontend/src/pages/AssessmentTemplates.tsx` (modify)
- **API Error Handler:** Assessment creation error handling

---

### Dependencies
**Depends On:**
- Story 7.1: Backend returns FREEMIUM_QUOTA_EXCEEDED error
- Story 8.2: Quota data available for frontend check
- Existing: Dialog, Button UI components

**Depended On By:**
- Story 8.4: Blurred content may trigger similar modals
- Story 8.5: Vendor matching locked feature triggers modal

---

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from Epic 8 | Bob (Scrum Master) |

---

## Dev Agent Record
_This section will be populated by the development agent during implementation_

### Agent Model Used
_TBD_

### Debug Log References
_TBD_

### Completion Notes
_TBD_

### File List
_TBD_

---

## QA Results
_This section will be populated by the QA agent after story completion_
