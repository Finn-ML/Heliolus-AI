# Story 13.5: User Tier Access Control

## Status
Draft

## Story

**As a** system
**I want** to restrict RFP features to Premium users only
**So that** we can monetize the RFP system and drive subscriptions

## Acceptance Criteria

1. Backend middleware: `requirePremiumTier`
   - Applied to: `/v1/rfp` (POST), `/v1/rfp/:id/send` (POST)
   - Returns 403 Forbidden for Free tier users
   - Error message: "RFP creation requires Premium subscription. Upgrade to unlock."
2. Frontend RFP button:
   - Premium users: Enabled, opens RFP form
   - Free users: Disabled with tooltip "Premium feature"
3. Upgrade modal:
   - Triggered when Free user clicks RFP button
   - Shows: "Upgrade to Premium to create RFPs"
   - Lists: Premium features (RFP, auto-population, multi-vendor broadcast)
   - CTA: "Upgrade Now" → /settings/subscription
4. Tier check uses existing Subscription model
5. API response includes user tier in auth context

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Premium Tier Middleware** (AC: 1, 4) - **ALREADY IMPLEMENTED in Story 13.1**
  - [ ] VERIFY: `backend/src/middleware/premium-tier.middleware.ts` exists
  - [ ] VERIFY: Middleware checks user's Subscription.plan field
  - [ ] VERIFY: Returns 403 with error message for Free tier
  - [ ] If not exists: Create middleware following auth.middleware.ts pattern

- [ ] **Task 2: Apply Middleware to RFP Routes** (AC: 1)
  - [ ] Add `requirePremiumTier` to RFP routes in rfp.routes.ts:
    - `POST /v1/rfp` - Create RFP
    - `POST /v1/rfp/:id/send` - Send RFP
    - `POST /v1/rfp/:id/documents` - Upload documents (from Story 13.1)
  - [ ] Middleware order: `[authenticationMiddleware, requirePremiumTier]`
  - [ ] Test: Free user gets 403, Premium user gets 200

- [ ] **Task 3: Include User Tier in Auth Context** (AC: 5)
  - [ ] Extend auth middleware to include subscription tier in request.user
  - [ ] Add field: `tier: 'FREE' | 'PREMIUM'` to user context
  - [ ] Frontend can check tier without separate API call

### Frontend Tasks

- [ ] **Task 4: useAuth Hook with Tier** (AC: 5)
  - [ ] Extend `frontend/src/hooks/useAuth.ts` (or create if not exists)
  - [ ] Include user tier from auth context: `const { user, tier } = useAuth()`
  - [ ] Tier available throughout app for conditional rendering

- [ ] **Task 5: Create RFP Button with Tier Check** (AC: 2)
  - [ ] In RFP dashboard and vendor results pages
  - [ ] Premium users: Button enabled, onClick opens RFP form
  - [ ] Free users:
    - Button disabled with reduced opacity
    - Tooltip on hover: "Premium feature - Upgrade to unlock"
    - onClick: Show upgrade modal

- [ ] **Task 6: Upgrade Modal Component** (AC: 3)
  - [ ] Create `frontend/src/components/subscription/UpgradeModal.tsx`
  - [ ] Modal content:
    - Title: "Upgrade to Premium"
    - Subtitle: "Unlock RFP creation and advanced vendor engagement"
    - Feature list with checkmarks:
      - "Create detailed RFPs with auto-population"
      - "Send RFPs to multiple vendors simultaneously"
      - "Track vendor responses in one dashboard"
      - "Unlimited assessments"
      - "Priority support"
    - Pricing: Display Premium plan price (€599/month)
    - CTA Button: "Upgrade Now" → Navigate to /settings/subscription
    - Secondary link: "Learn more about Premium"
  - [ ] Close button (X) to dismiss

- [ ] **Task 7: Conditional RFP Dashboard Access** (AC: 2)
  - [ ] "My RFPs" navigation link:
    - Premium users: Link visible and functional
    - Free users: Link hidden OR visible with lock icon + tooltip
  - [ ] If Free user navigates to /rfp directly:
    - Show upgrade interstitial page
    - Message: "RFP management is a Premium feature"
    - Upgrade CTA button

- [ ] **Task 8: Tier-Based Feature Flags** (AC: 2)
  - [ ] Create `frontend/src/lib/featureFlags.ts`:
    ```typescript
    export function hasRFPAccess(tier: string): boolean {
      return tier === 'PREMIUM';
    }

    export function hasUnlimitedAssessments(tier: string): boolean {
      return tier === 'PREMIUM';
    }
    ```
  - [ ] Use throughout app for conditional rendering

- [ ] **Task 9: Error Handling for 403 Forbidden** (AC: 1)
  - [ ] In API client (frontend/src/lib/api.ts):
    - Intercept 403 responses from RFP endpoints
    - Check error message for "Premium subscription"
    - Show upgrade modal automatically
  - [ ] Toast notification: "This feature requires Premium. Upgrade to continue."

### Testing

- [ ] **Task 10: Backend Middleware Tests** (AC: 1, 4)
  - [ ] Test requirePremiumTier middleware:
    - Free tier user: Returns 403
    - Premium tier user: Passes through
    - No subscription: Returns 403
  - [ ] Test middleware application:
    - POST /v1/rfp with Free tier: 403
    - POST /v1/rfp with Premium tier: 200/201

- [ ] **Task 11: Frontend Component Tests**
  - [ ] Test Create RFP button:
    - Premium user: Button enabled, opens form
    - Free user: Button disabled, shows tooltip, opens upgrade modal
  - [ ] Test upgrade modal: Displays features, CTA navigates to /settings/subscription
  - [ ] Test tier-based navigation: Premium sees "My RFPs", Free does not

- [ ] **Task 12: Integration Tests** (AC: 1, 2, 3)
  - [ ] E2E test: Free user attempts RFP creation
    - Click "Create RFP" → Upgrade modal appears
    - Click "Upgrade Now" → Navigates to subscription settings
  - [ ] E2E test: Premium user creates RFP
    - Click "Create RFP" → RFP form opens
    - Fill form, submit → RFP created successfully

## Dev Notes

### Project Context
Story 13.5 implements tier-based access control for the RFP system, ensuring only Premium users can create and manage RFPs. This story enhances monetization by creating clear value differentiation between Free and Premium tiers.

**Dependencies:**
- Story 13.1 (Premium tier middleware may already be implemented)
- Existing subscription system (Subscription model, SubscriptionPlan enum)

[Source: docs/prd/epic-13-rfp-vendor-engagement.md#Story 13.5]

### Tech Stack
- **Backend**: Fastify 4 + TypeScript | Prisma 6
- **Frontend**: React 18 + TypeScript | TanStack Query 5 | Radix UI

[Source: CLAUDE.md#Tech Stack]

### Subscription Model

**Subscription Plan Enum:**
```prisma
enum SubscriptionPlan {
  FREE
  PREMIUM
}

model Subscription {
  id                String            @id @default(cuid())
  userId            String            @unique
  plan              SubscriptionPlan  @default(FREE)
  status            SubscriptionStatus
  // ... other fields
}
```

**Tier Check Logic:**
```typescript
// In middleware
const subscription = await prisma.subscription.findUnique({
  where: { userId: request.user.id }
});

if (!subscription || subscription.plan !== 'PREMIUM') {
  return reply.code(403).send({
    success: false,
    message: 'RFP creation requires Premium subscription. Upgrade to unlock.'
  });
}
```

[Source: backend/prisma/schema.prisma, docs/prd/epic-13-rfp-vendor-engagement.md#Story 13.5 Technical Notes]

### Backend Middleware Pattern

**Premium Tier Middleware (from Story 13.1):**
File: `backend/src/middleware/premium-tier.middleware.ts`

```typescript
import { FastifyRequest, FastifyReply } from 'fastify';

export async function requirePremiumTier(
  request: FastifyRequest,
  reply: FastifyReply
) {
  const userId = request.user?.id;

  if (!userId) {
    return reply.code(401).send({
      success: false,
      message: 'Authentication required'
    });
  }

  const subscription = await request.server.prisma.subscription.findUnique({
    where: { userId },
    select: { plan: true, status: true }
  });

  if (!subscription || subscription.plan !== 'PREMIUM') {
    return reply.code(403).send({
      success: false,
      message: 'RFP creation requires Premium subscription. Upgrade to unlock.',
      code: 'PREMIUM_REQUIRED'
    });
  }

  if (subscription.status !== 'ACTIVE') {
    return reply.code(403).send({
      success: false,
      message: 'Your Premium subscription is not active. Please update payment method.',
      code: 'SUBSCRIPTION_INACTIVE'
    });
  }
}
```

**Apply to Routes:**
```typescript
// In rfp.routes.ts
fastify.post(
  '/v1/rfp',
  {
    preHandler: [authenticationMiddleware, requirePremiumTier]
  },
  asyncHandler(async (request, reply) => {
    // Create RFP logic
  })
);
```

[Source: Middleware patterns from backend/src/middleware/auth.middleware.ts, Story 13.1 implementation]

### Frontend Auth Context with Tier

**Auth Hook Enhancement:**
```typescript
// frontend/src/hooks/useAuth.ts
interface User {
  id: string;
  email: string;
  name: string;
  tier: 'FREE' | 'PREMIUM';
  // ... other fields
}

export function useAuth() {
  const [user, setUser] = useState<User | null>(null);

  useEffect(() => {
    // Fetch user data including subscription tier
    // Decode JWT or call /v1/auth/me endpoint
  }, []);

  return {
    user,
    tier: user?.tier || 'FREE',
    isAuthenticated: !!user,
    isPremium: user?.tier === 'PREMIUM',
    isFree: user?.tier === 'FREE'
  };
}
```

**Usage:**
```tsx
function CreateRFPButton() {
  const { isPremium } = useAuth();

  if (!isPremium) {
    return (
      <Tooltip content="Premium feature - Upgrade to unlock">
        <Button disabled onClick={openUpgradeModal}>
          Create RFP
        </Button>
      </Tooltip>
    );
  }

  return <Button onClick={openRFPForm}>Create RFP</Button>;
}
```

[Source: Frontend auth patterns, CLAUDE.md#Frontend Component Patterns]

### Upgrade Modal Component

**Modal Structure:**
```tsx
<Dialog open={showUpgradeModal} onOpenChange={setShowUpgradeModal}>
  <DialogContent>
    <DialogHeader>
      <DialogTitle>Upgrade to Premium</DialogTitle>
      <DialogDescription>
        Unlock RFP creation and advanced vendor engagement
      </DialogDescription>
    </DialogHeader>

    <FeatureList>
      <FeatureItem>
        <CheckIcon />
        Create detailed RFPs with auto-population
      </FeatureItem>
      <FeatureItem>
        <CheckIcon />
        Send RFPs to multiple vendors simultaneously
      </FeatureItem>
      <FeatureItem>
        <CheckIcon />
        Track vendor responses in one dashboard
      </FeatureItem>
      <FeatureItem>
        <CheckIcon />
        Unlimited assessments
      </FeatureItem>
      <FeatureItem>
        <CheckIcon />
        Priority support
      </FeatureItem>
    </FeatureList>

    <PricingSection>
      <Price>€599/month</Price>
      <Subtext>Billed monthly, cancel anytime</Subtext>
    </PricingSection>

    <DialogFooter>
      <Button variant="outline" onClick={closeModal}>
        Maybe Later
      </Button>
      <Button onClick={() => navigate('/settings/subscription')}>
        Upgrade Now
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```

[Source: Radix UI Dialog patterns, frontend/src/components/ui/dialog.tsx]

### Conditional Feature Access Patterns

**Feature Flag Function:**
```typescript
// frontend/src/lib/featureFlags.ts
export const features = {
  rfpCreation: (tier: string) => tier === 'PREMIUM',
  unlimitedAssessments: (tier: string) => tier === 'PREMIUM',
  premiumReports: (tier: string) => tier === 'PREMIUM',
  vendorMatching: (tier: string) => true, // Available to all
  basicContact: (tier: string) => true // Available to all
};

export function hasFeature(feature: keyof typeof features, tier: string): boolean {
  return features[feature](tier);
}
```

**Conditional Rendering:**
```tsx
function VendorResultsPage() {
  const { tier } = useAuth();

  return (
    <div>
      {/* Free users see basic contact form */}
      {!hasFeature('rfpCreation', tier) && (
        <BasicContactForm />
      )}

      {/* Premium users see RFP creation */}
      {hasFeature('rfpCreation', tier) && (
        <CreateRFPButton />
      )}
    </div>
  );
}
```

[Source: Feature flag patterns, CLAUDE.md#Frontend Component Patterns]

### Navigation Conditional Display

**Main Navigation:**
```tsx
function MainNav() {
  const { tier } = useAuth();

  return (
    <nav>
      <NavLink to="/dashboard">Dashboard</NavLink>
      <NavLink to="/assessments">Assessments</NavLink>

      {/* Show "My RFPs" only to Premium users */}
      {tier === 'PREMIUM' && (
        <NavLink to="/rfp">My RFPs</NavLink>
      )}

      {/* Alternative: Show with lock icon for Free users */}
      <NavLink to="/rfp" disabled={tier === 'FREE'}>
        My RFPs
        {tier === 'FREE' && <LockIcon />}
      </NavLink>
    </nav>
  );
}
```

[Source: Frontend navigation patterns]

### Error Handling for 403

**API Client Interceptor:**
```typescript
// frontend/src/lib/api.ts
axios.interceptors.response.use(
  response => response,
  error => {
    if (error.response?.status === 403) {
      const message = error.response.data.message;

      if (message.includes('Premium subscription')) {
        // Show upgrade modal
        showUpgradeModal();
      }
    }

    return Promise.reject(error);
  }
);
```

**React Query Error Handling:**
```typescript
const { mutate: createRFP } = useMutation({
  mutationFn: (data) => api.post('/v1/rfp', data),
  onError: (error) => {
    if (error.response?.status === 403) {
      showUpgradeModal();
      toast.error('This feature requires a Premium subscription');
    }
  }
});
```

[Source: frontend/src/lib/api.ts patterns, TanStack Query error handling]

### Interstitial Page for Free Users

**Route Guard:**
```tsx
function RFPRoute() {
  const { tier } = useAuth();

  if (tier === 'FREE') {
    return <UpgradeInterstitial />;
  }

  return <RFPDashboardPage />;
}

function UpgradeInterstitial() {
  return (
    <div className="flex flex-col items-center justify-center min-h-screen">
      <LockIcon size="large" />
      <h1>RFP Management is a Premium Feature</h1>
      <p>Upgrade to Premium to create and manage RFPs</p>
      <FeatureList />
      <Button onClick={() => navigate('/settings/subscription')}>
        Upgrade to Premium
      </Button>
      <Link to="/dashboard">Back to Dashboard</Link>
    </div>
  );
}
```

[Source: Frontend routing patterns]

### File Locations

**Backend:**
- Middleware: `backend/src/middleware/premium-tier.middleware.ts` (verify exists from Story 13.1)
- Apply to routes: `backend/src/routes/rfp.routes.ts` (update existing file)

**Frontend:**
- Upgrade modal: `frontend/src/components/subscription/UpgradeModal.tsx`
- Interstitial: `frontend/src/pages/UpgradeInterstitial.tsx`
- Feature flags: `frontend/src/lib/featureFlags.ts`
- Auth hook: `frontend/src/hooks/useAuth.ts` (extend existing)

[Source: CLAUDE.md#Project Structure]

### Testing

#### Backend Testing

**Middleware Tests:**
- File: `backend/tests/middleware/premium-tier.test.ts`
- Test cases:
  - Free tier user: 403 Forbidden
  - Premium tier user: Passes through
  - No subscription: 403 Forbidden
  - Inactive subscription: 403 Forbidden

**Route Tests:**
- File: `backend/tests/contract/rfp.routes.test.ts`
- Test POST /v1/rfp as Free tier: 403
- Test POST /v1/rfp as Premium tier: 200/201
- Test POST /v1/rfp/:id/send as Free tier: 403

**Run Commands:**
- `npm run test` (from backend/)
- `npm run test:contract` (from backend/)

[Source: CLAUDE.md#Testing]

#### Frontend Testing

**Component Tests:**
- Test Create RFP button: Premium enabled, Free disabled with tooltip
- Test upgrade modal: Displays correctly, navigates on CTA click
- Test navigation: Premium sees "My RFPs", Free does not (or sees with lock)
- Test route guard: Free user sees interstitial on /rfp route

**Integration Tests:**
- E2E: Free user clicks RFP button → Upgrade modal → Navigate to subscription
- E2E: Premium user clicks RFP button → RFP form opens

[Source: CLAUDE.md#Testing patterns]

## Codebase Review Findings

**Review Date**: 2025-10-27
**Review Document**: `.ai/epic-13-codebase-review.md`

### Confirmed Missing Components (Must Create)

✅ **Middleware**:
- premium-tier.middleware.ts does NOT exist - Task 1 correctly specifies creation ✅
- **IMPORTANT**: rbac.middleware.ts HAS `requirePremium()` function but it's INCOMPLETE
  - Location: `backend/src/middleware/rbac.middleware.ts:151-186`
  - Line 169: `const hasPremium = false; // Placeholder - implement actual check`
  - **Decision**: Create NEW premium-tier.middleware.ts as specified in story (don't modify rbac)

✅ **Database**:
- Subscription model EXISTS ✅
- SubscriptionPlan enum EXISTS with FREE/PREMIUM/ENTERPRISE ✅
- SubscriptionStatus enum EXISTS (ACTIVE, TRIALING, PAST_DUE, CANCELED, etc.) ✅

✅ **Routes**:
- rfp.routes.ts does NOT exist (dependency from Story 13.1)
- Middleware will be applied to RFP routes once they're created

### Implementation Decision: New Middleware vs Fixing Existing

**Existing requirePremium in rbac.middleware.ts**:
```typescript
// Line 151-186
export async function requirePremium(request: AuthenticatedRequest, reply: FastifyReply) {
  // ... auth checks
  const hasPremium = false; // TODO: Implement subscription check from database
  // Returns 402 PAYMENT_REQUIRED
}
```

**Recommendation**: Create **NEW** premium-tier.middleware.ts because:
1. Story explicitly specifies this file name
2. Separates RFP-specific Premium checks from general RBAC
3. Provides RFP-specific error messages
4. Returns 403 Forbidden (not 402 Payment Required) per Story spec
5. Checks subscription.status = ACTIVE (not just plan)

**Alternative**: Fix existing requirePremium in rbac.middleware.ts
- **Pros**: Reuses existing function, single source of truth
- **Cons**: Changes error codes (402→403), different error messages

**Decision**: Create premium-tier.middleware.ts as per story specification.

### Subscription Check Pattern

**Confirmed Implementation**:
```typescript
const subscription = await prisma.subscription.findUnique({
  where: { userId: request.user.id },
  select: { plan: true, status: true }
});

// Check 1: Subscription exists and plan is PREMIUM
if (!subscription || subscription.plan !== 'PREMIUM') {
  return 403 with message: "RFP creation requires Premium subscription. Upgrade to unlock."
}

// Check 2: Subscription is active
if (subscription.status !== 'ACTIVE') {
  return 403 with message: "Your Premium subscription is not active. Please update payment method."
}
```

### Middleware Application Points

**Apply requirePremiumTier to** (Story 13.1):
1. POST /v1/rfp - Create RFP
2. POST /v1/rfp/:id/send - Send RFP
3. POST /v1/rfp/:id/documents - Upload documents

**Middleware Order**: `[authenticationMiddleware, requirePremiumTier]`

**DO NOT APPLY** to read-only routes:
- GET /v1/rfp/:id (users can view their drafts even after downgrading)
- GET /v1/rfp/my-rfps (users can see their RFP history)

### Implementation Priority

**Story 13.5 Backend Order**:
1. Create premium-tier.middleware.ts (Task 1) ✅
2. Register in middleware/index.ts exports
3. Apply to RFP routes in rfp.routes.ts (Task 2)
4. Extend auth middleware to include tier in user context (Task 3)

**Estimated Effort**: 2-3 hours (backend only)

### Notes for Dev Agent

- **Error Code**: Use 403 Forbidden (not 402 Payment Required like rbac.middleware.ts)
- **Error Message**: "RFP creation requires Premium subscription. Upgrade to unlock."
- **Error Code Field**: Include `code: 'PREMIUM_REQUIRED'` for frontend handling
- **Subscription Status**: Check both plan AND status (ACTIVE required)
- **Admin Exemption**: Consider allowing ADMIN role to bypass (optional)

### Frontend Tier Check

**User Context Enhancement** (Task 3):
```typescript
// In auth middleware, add to request.user:
interface User {
  id: string;
  email: string;
  role: UserRole;
  tier: 'FREE' | 'PREMIUM' | 'ENTERPRISE'; // NEW field
}
```

**Frontend can use**: `const { tier } = useAuth()` without separate API call

## Architectural Decisions & Issue Resolutions

**Decision Document**: `.ai/epic-13-architectural-decisions.md`
**Review Date**: 2025-10-27

### Premium Tier Middleware Implementation (CRITICAL)

**Problem**: Existing `requirePremium()` in rbac.middleware.ts:169 is **INCOMPLETE** - uses placeholder logic.

**Current Code** (`backend/src/middleware/rbac.middleware.ts:169`):
```typescript
const hasPremium = false; // TODO: Implement subscription check from database
```

**Solution**: Create dedicated premium-tier.middleware.ts with proper subscription check:

```typescript
// backend/src/middleware/premium-tier.middleware.ts
import { FastifyRequest, FastifyReply } from 'fastify';

export async function requirePremiumTier(
  request: FastifyRequest,
  reply: FastifyReply
) {
  const userId = request.user.id;

  const subscription = await request.server.prisma.subscription.findUnique({
    where: { userId }
  });

  if (!subscription || subscription.plan !== 'PREMIUM' || subscription.status !== 'ACTIVE') {
    return reply.code(403).send({
      success: false,
      message: 'This feature requires a Premium subscription. Upgrade to unlock.',
      code: 'PREMIUM_REQUIRED',
      data: {
        currentPlan: subscription?.plan || 'FREE',
        requiredPlan: 'PREMIUM',
        upgradeUrl: '/settings/subscription'
      }
    });
  }

  // User has active Premium subscription - allow request to continue
}
```

**Apply to RFP Routes**:
```typescript
// backend/src/routes/rfp.routes.ts
import { requirePremiumTier } from '../middleware/premium-tier.middleware.js';

// Apply to RFP creation and sending
server.post('/rfps', {
  preHandler: [server.authenticate, requireUser, requirePremiumTier],
  // ... handler
});

server.post('/rfps/:id/send', {
  preHandler: [server.authenticate, requireUser, requirePremiumTier],
  // ... handler
});
```

**Why Not Use requirePremium from rbac.middleware.ts?**
- Incomplete implementation (placeholder)
- Premium tier check is feature-specific, not role-based
- Cleaner separation of concerns

**Update Task 2**: Create new premium-tier.middleware.ts (don't modify rbac.middleware.ts).

### Subscription Status Check (MEDIUM)

**Decision**: Check BOTH plan AND status for Premium tier:

```typescript
const isPremium =
  subscription?.plan === 'PREMIUM' &&
  subscription?.status === 'ACTIVE';
```

**Status Values** (from SubscriptionStatus enum):
- `ACTIVE` → Paid and active ✅
- `PAST_DUE` → Payment issue ❌
- `CANCELED` → Subscription cancelled ❌
- `TRIALING` → Free trial period ✅ (Allow Premium features)

**Update**: Allow TRIALING status for Premium features:
```typescript
const isPremium =
  subscription?.plan === 'PREMIUM' &&
  (subscription?.status === 'ACTIVE' || subscription?.status === 'TRIALING');
```

**Update Task 2**: Check status is ACTIVE or TRIALING.

### References

- Architectural Decisions: `.ai/epic-13-architectural-decisions.md` (Section 9, Priority 1)
- Incomplete rbac.middleware.ts: Line 169
- Deep Analysis: `.ai/epic-13-deep-analysis-issues.md` (Issue #26)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-27 | 1.0 | Initial story creation for Epic 13: RFP System | Bob (Scrum Master) |
| 2025-10-27 | 1.1 | Added codebase review findings - identified incomplete requirePremium in rbac.middleware.ts | Claude (Dev Agent) |
| 2025-10-27 | 1.2 | Added architectural decisions - complete premium tier middleware implementation, subscription status check | Claude (Dev Agent) |

## Dev Agent Record

### Agent Model Used
(To be populated by dev agent)

### Debug Log References
(To be populated by dev agent)

### Completion Notes List
(To be populated by dev agent)

### File List
(To be populated by dev agent)

## QA Results
(To be populated by QA agent)
