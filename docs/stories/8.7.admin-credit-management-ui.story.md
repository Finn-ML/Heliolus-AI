# Story 8.7: Create Admin Credit Management UI

## Status
Draft

## Story
**As a** system administrator,
**I want** to grant credits to Enterprise users via UI,
**so that** I can manage custom billing arrangements.

## Acceptance Criteria
1. Update `frontend/src/pages/admin/UserManagement.tsx`
2. Add "Manage Credits" action button to user table rows
3. On click, open side panel with:
   - User details (name, email, current credit balance)
   - Form with fields:
     - Amount (number input, min: 1)
     - Reason (textarea, required)
   - "Grant Credits" button
   - Credit transaction history table (recent 10 transactions)
4. On submit:
   - Call API: `POST /v1/admin/users/:userId/credits`
   - Show loading state
   - On success: Close panel, refresh user list, show toast
   - On error: Show error message in form
5. Transaction history displays:
   - Date, Type, Amount, Balance, Description
   - Sorted by date descending
6. Panel only accessible to ADMIN role users
7. Responsive design (full screen on mobile)

## Tasks / Subtasks

- [ ] **Task 1: Add "Manage Credits" Button to User Table** (AC: 2)
  - [ ] Open `frontend/src/pages/admin/UserManagement.tsx`
  - [ ] Add button column to table:
    ```typescript
    import { CreditCard } from 'lucide-react';

    <TableRow>
      <TableCell>{user.name}</TableCell>
      <TableCell>{user.email}</TableCell>
      <TableCell>{user.subscription?.plan}</TableCell>
      <TableCell>
        <Button
          variant="outline"
          size="sm"
          onClick={() => handleManageCredits(user.id)}
        >
          <CreditCard className="h-4 w-4 mr-2" />
          Manage Credits
        </Button>
      </TableCell>
    </TableRow>
    ```

- [ ] **Task 2: Create Credit Management Side Panel Component** (AC: 3)
  - [ ] Add Sheet component import:
    ```typescript
    import {
      Sheet,
      SheetContent,
      SheetDescription,
      SheetHeader,
      SheetTitle,
    } from '@/components/ui/sheet';
    ```
  - [ ] Add panel state:
    ```typescript
    const [selectedUserId, setSelectedUserId] = useState<string | null>(null);
    const [showCreditPanel, setShowCreditPanel] = useState(false);

    const handleManageCredits = (userId: string) => {
      setSelectedUserId(userId);
      setShowCreditPanel(true);
    };
    ```

- [ ] **Task 3: Create Grant Credits Form** (AC: 3)
  - [ ] Use React Hook Form:
    ```typescript
    import { useForm } from 'react-hook-form';
    import { zodResolver } from '@hookform/resolvers/zod';
    import { z } from 'zod';

    const grantCreditsSchema = z.object({
      amount: z.number().min(1, 'Amount must be at least 1'),
      reason: z.string().min(1, 'Reason is required'),
    });

    type GrantCreditsForm = z.infer<typeof grantCreditsSchema>;

    const form = useForm<GrantCreditsForm>({
      resolver: zodResolver(grantCreditsSchema),
      defaultValues: {
        amount: 50,
        reason: '',
      },
    });
    ```

- [ ] **Task 4: Fetch User Details and Credit History** (AC: 3, 5)
  - [ ] Add queries:
    ```typescript
    const { data: user } = useQuery({
      queryKey: ['admin', 'user', selectedUserId],
      queryFn: async () => {
        const response = await fetch(`/v1/admin/users/${selectedUserId}`, {
          headers: { Authorization: `Bearer ${localStorage.getItem('token')}` },
        });
        return response.json();
      },
      enabled: !!selectedUserId,
    });

    const { data: creditHistory } = useQuery({
      queryKey: ['admin', 'credits', selectedUserId],
      queryFn: async () => {
        const response = await fetch(`/v1/admin/users/${selectedUserId}/credits`, {
          headers: { Authorization: `Bearer ${localStorage.getItem('token')}` },
        });
        return response.json();
      },
      enabled: !!selectedUserId,
    });
    ```

- [ ] **Task 5: Implement Grant Credits Mutation** (AC: 4)
  - [ ] Add mutation:
    ```typescript
    const queryClient = useQueryClient();

    const grantCreditsMutation = useMutation({
      mutationFn: async (data: GrantCreditsForm) => {
        const response = await fetch(`/v1/admin/users/${selectedUserId}/credits`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${localStorage.getItem('token')}`,
          },
          body: JSON.stringify(data),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to grant credits');
        }

        return response.json();
      },
      onSuccess: () => {
        toast({
          title: 'Credits Granted',
          description: 'Credits have been successfully added to the user account.',
        });

        // Refresh data
        queryClient.invalidateQueries({ queryKey: ['admin', 'users'] });
        queryClient.invalidateQueries({ queryKey: ['admin', 'credits', selectedUserId] });

        // Close panel and reset form
        setShowCreditPanel(false);
        form.reset();
      },
      onError: (error: Error) => {
        toast({
          title: 'Error',
          description: error.message,
          variant: 'destructive',
        });
      },
    });
    ```

- [ ] **Task 6: Render Side Panel** (AC: 3, 5)
  - [ ] Add Sheet component:
    ```typescript
    <Sheet open={showCreditPanel} onOpenChange={setShowCreditPanel}>
      <SheetContent className="w-full sm:max-w-2xl overflow-y-auto">
        <SheetHeader>
          <SheetTitle>Manage Credits</SheetTitle>
          <SheetDescription>
            Grant credits to {user?.data?.firstName} {user?.data?.lastName}
          </SheetDescription>
        </SheetHeader>

        <div className="mt-6 space-y-6">
          {/* User Details */}
          <div className="bg-muted rounded-lg p-4">
            <h3 className="font-semibold mb-2">User Information</h3>
            <div className="space-y-1 text-sm">
              <div className="flex justify-between">
                <span className="text-muted-foreground">Name:</span>
                <span>{user?.data?.firstName} {user?.data?.lastName}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-muted-foreground">Email:</span>
                <span>{user?.data?.email}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-muted-foreground">Plan:</span>
                <Badge>{user?.data?.subscription?.plan}</Badge>
              </div>
              <div className="flex justify-between font-semibold">
                <span className="text-muted-foreground">Current Balance:</span>
                <span>{user?.data?.subscription?.creditsBalance} credits</span>
              </div>
            </div>
          </div>

          {/* Grant Credits Form */}
          <form onSubmit={form.handleSubmit((data) => grantCreditsMutation.mutate(data))}>
            <div className="space-y-4">
              <div>
                <Label htmlFor="amount">Amount</Label>
                <Input
                  id="amount"
                  type="number"
                  min="1"
                  {...form.register('amount', { valueAsNumber: true })}
                  placeholder="Enter credit amount"
                />
                {form.formState.errors.amount && (
                  <p className="text-sm text-destructive mt-1">
                    {form.formState.errors.amount.message}
                  </p>
                )}
              </div>

              <div>
                <Label htmlFor="reason">Reason</Label>
                <Textarea
                  id="reason"
                  {...form.register('reason')}
                  placeholder="Enter reason for granting credits (e.g., Q1 2025 Enterprise allocation)"
                  rows={3}
                />
                {form.formState.errors.reason && (
                  <p className="text-sm text-destructive mt-1">
                    {form.formState.errors.reason.message}
                  </p>
                )}
              </div>

              <Button
                type="submit"
                disabled={grantCreditsMutation.isPending}
                className="w-full"
              >
                {grantCreditsMutation.isPending ? 'Granting...' : 'Grant Credits'}
              </Button>
            </div>
          </form>

          {/* Transaction History */}
          <div>
            <h3 className="font-semibold mb-4">Credit Transaction History</h3>
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Date</TableHead>
                  <TableHead>Type</TableHead>
                  <TableHead>Amount</TableHead>
                  <TableHead>Balance</TableHead>
                  <TableHead>Description</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {creditHistory?.data?.slice(0, 10).map((tx: any) => (
                  <TableRow key={tx.id}>
                    <TableCell className="text-sm">
                      {new Date(tx.createdAt).toLocaleDateString()}
                    </TableCell>
                    <TableCell>
                      <Badge variant="outline">{tx.type}</Badge>
                    </TableCell>
                    <TableCell className={tx.amount > 0 ? 'text-green-600' : 'text-red-600'}>
                      {tx.amount > 0 ? '+' : ''}{tx.amount}
                    </TableCell>
                    <TableCell>{tx.balance}</TableCell>
                    <TableCell className="text-sm text-muted-foreground max-w-xs truncate">
                      {tx.description}
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </div>
        </div>
      </SheetContent>
    </Sheet>
    ```

- [ ] **Task 7: Add RBAC Check** (AC: 6)
  - [ ] Ensure only admins see "Manage Credits" button:
    ```typescript
    const { data: currentUser } = useQuery({
      queryKey: ['auth', 'user'],
      queryFn: getCurrentUser,
    });

    const isAdmin = currentUser?.role === 'ADMIN';

    // In table
    {isAdmin && (
      <TableCell>
        <Button onClick={() => handleManageCredits(user.id)}>
          Manage Credits
        </Button>
      </TableCell>
    )}
    ```

- [ ] **Task 8: Add Responsive Design** (AC: 7)
  - [ ] Ensure Sheet is full-screen on mobile:
    ```typescript
    <SheetContent className="w-full sm:max-w-2xl">
      {/* Content stacks vertically on mobile */}
    </SheetContent>
    ```

- [ ] **Task 9: Test Admin UI** (AC: 1-7)
  - [ ] Test "Manage Credits" button opens panel
  - [ ] Test user details display correctly
  - [ ] Test form validation (amount > 0, reason required)
  - [ ] Test grant credits API call
  - [ ] Test success toast appears
  - [ ] Test user list refreshes
  - [ ] Test credit history loads
  - [ ] Test transaction history sorted by date
  - [ ] Test only admins see button
  - [ ] Test responsive design on mobile

## Dev Notes

### Admin Panel Flow

**1. User Management Table:**
```
Users
─────────────────────────────────────────────
Name          Email              Plan      Actions
──────────────────────────────────────────────
John Doe      john@acme.com      PREMIUM   [Manage Credits]
Jane Smith    jane@corp.com      ENTERPRISE [Manage Credits]
```

**2. Side Panel (Manage Credits):**
```
┌────────────────────────────────────┐
│ Manage Credits                     │
│ Grant credits to John Doe          │
├────────────────────────────────────┤
│ User Information                   │
│ ┌────────────────────────────────┐ │
│ │ Name:    John Doe             │ │
│ │ Email:   john@acme.com        │ │
│ │ Plan:    PREMIUM              │ │
│ │ Current: 50 credits           │ │
│ └────────────────────────────────┘ │
│                                    │
│ Grant Credits                      │
│ Amount: [100  ]                    │
│ Reason: [___________________]      │
│         [___________________]      │
│                                    │
│ [Grant Credits]                    │
│                                    │
│ Credit Transaction History         │
│ ┌────────────────────────────────┐ │
│ │ Date       Type    Amt  Balance││
│ │ 2025-10-23 GRANT   +100  150  ││
│ │ 2025-10-15 ASSESS  -50   50   ││
│ │ 2025-10-01 SUB     +100  100  ││
│ └────────────────────────────────┘ │
└────────────────────────────────────┘
```

[Source: docs/prd/epic-8-frontend-integration.md#Story 4.7]

---

### API Endpoints

**Grant Credits:** POST /v1/admin/users/:userId/credits
**Get History:** GET /v1/admin/users/:userId/credits

[Source: docs/stories/7.2.admin-credit-grant-endpoint.story.md, docs/stories/7.3.admin-credit-history-endpoint.story.md]

---

### Transaction Types

**Types Displayed:**
- SUBSCRIPTION - Monthly/annual credit allocation
- PURCHASE - Additional assessment purchase
- ASSESSMENT - Credit deduction for assessment
- ADMIN_GRANT - Manual admin grant
- REFUND - Refund/correction

**Color Coding:**
- Green (+): SUBSCRIPTION, PURCHASE, ADMIN_GRANT, REFUND
- Red (-): ASSESSMENT

[Source: backend/prisma/schema.prisma]

---

### Form Validation

**Amount:**
- Minimum: 1
- Type: Integer
- Error: "Amount must be at least 1"

**Reason:**
- Minimum length: 1 character
- Type: String (textarea)
- Error: "Reason is required"
- Examples:
  - "Q1 2025 Enterprise allocation"
  - "Promotional credit for early adoption"
  - "Billing adjustment for service issue"

[Source: React Hook Form + Zod validation patterns]

---

### Testing Checklist

- [ ] Admin sees "Manage Credits" button on user rows
- [ ] Non-admin doesn't see button
- [ ] Panel opens when button clicked
- [ ] User details display correctly
- [ ] Current balance shown
- [ ] Form validates amount > 0
- [ ] Form validates reason required
- [ ] Grant button submits to API
- [ ] Loading state shown during submission
- [ ] Success toast appears on success
- [ ] Error message shown on failure
- [ ] User list refreshes after grant
- [ ] Credit history loads
- [ ] History sorted by date descending
- [ ] History shows recent 10 transactions
- [ ] Panel closes after successful grant
- [ ] Form resets after successful grant
- [ ] Responsive design on mobile (full screen)

[Source: Frontend testing best practices]

---

### File Locations
- **Page:** `frontend/src/pages/admin/UserManagement.tsx` (modify)

---

### Dependencies
**Depends On:**
- Story 7.2: POST admin credit grant endpoint
- Story 7.3: GET admin credit history endpoint
- Existing: Sheet, Form, Table UI components

**Depended On By:**
- Admin credit management workflows

---

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from Epic 8 | Bob (Scrum Master) |

---

## Dev Agent Record
_This section will be populated by the development agent during implementation_

### Agent Model Used
_TBD_

### Debug Log References
_TBD_

### Completion Notes
_TBD_

### File List
_TBD_

---

## QA Results
_This section will be populated by the QA agent after story completion_
