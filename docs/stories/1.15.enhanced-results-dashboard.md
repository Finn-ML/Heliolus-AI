# Story 1.15: Enhanced Assessment Results Dashboard - Overview and Scoring Breakdown

## Status
**DEPRECATED** - Superseded by Story 1.27

## Deprecation Notice
This story has been **superseded by Story 1.27** "Enhanced Results Page - Strategy Matrix & Vendor Matching Integration" which provides a cleaner, more cohesive implementation aligned with the new `/execute` endpoint architecture.

**Why Deprecated:**
- Story 1.27 consolidates functionality from stories 1.15, 1.16, and 1.17
- New approach uses existing Results page structure with enhanced tabs
- Simpler navigation flow: Results → Marketplace (filtered)
- Backend APIs already exist and functional

**Replacement Story:** 1.27.results-strategy-vendor-matching.md
**Date Deprecated:** 2025-10-14

## Original Blockers (Historical)
- ❌ **CRITICAL:** Backend endpoint `GET /assessments/:id/enhanced-results` does NOT exist
  - Required action: Create endpoint in `backend/src/routes/assessment.routes.ts`
  - Must implement enhanced scoring calculation with evidence tier multipliers
  - Expected response structure documented below in Integration Points section
- ⚠️ **DEPENDENCY:** Requires Story 1.04 (Weighted Scoring Service) to be fully implemented
- ⚠️ **DEPENDENCY:** Assessment model must have `scoringMethodology` field added

## Story

**As a** frontend developer,
**I want** to create an enhanced assessment results dashboard with overall score, evidence distribution, and section breakdowns,
**so that** users can understand their risk score and underlying calculations.

## Acceptance Criteria

1. **Component: EnhancedResultsDashboard.tsx** - Main results view
   - Conditional rendering: check `scoringMethodology` field
   - If "unavailable": render message "Risk Score Not Available"
   - If "enhanced": render new enhanced view
2. **Section: Overview**
   - Large risk score display (0-100) with color-coded band:
     - Critical (0-39): red background
     - High (40-59): orange background
     - Medium (60-79): yellow background
     - Low (80-100): green background
   - Risk band label prominently displayed
   - Methodology badge: "Regulatory-Aligned Scoring"
   - EvidenceTierDistribution donut chart
   - Assessment quality indicator: "Strong evidence base" (>50% Tier 1+2) or "Limited documentation" (<30% Tier 1+2)
3. **Component: ScoringBreakdown.tsx** - Expandable section breakdown
   - Accordion component showing all sections
   - Each section card displays:
     - Section title
     - Section score (0-5 scale with progress bar)
     - Section weight (e.g., "18% of overall score")
     - Contribution to overall score (weighted contribution)
   - Click to expand: shows all questions in section
4. **Component: QuestionDetailView.tsx** - Question-level drill-down
   - Appears when section expanded
   - Each question shows:
     - Question text
     - Raw quality score (0-5 stars visualization)
     - Evidence tier badge
     - Tier multiplier (e.g., "×0.8 Policy Document")
     - Question weight within section
     - Final score after multiplier (0-5 with progress bar)
   - Supporting evidence citations (linked to uploaded documents)
   - "Why this score?" button opens explanation modal
5. Tabbed interface:
   - Tab 1: "Overview" (overall score + section breakdown)
   - Tab 2: "Gaps" (gap analysis table - existing, enhanced)
   - Tab 3: "Strategy Matrix" (timeline view - separate story)
   - Tab 4: "Vendor Matches" (vendor recommendations - separate story)
6. "How is this calculated?" button opens methodology explanation page
7. "Download Report" button triggers PDF generation (existing functionality, enhanced template)
8. Responsive: sections stack vertically on mobile, two-column on desktop
9. Loading states: skeleton UI while fetching results
10. Error handling: display friendly message if scoring data incomplete

## Tasks / Subtasks

- [ ] Create main EnhancedResultsDashboard component (AC: 1, 5)
  - [ ] Create `/frontend/src/components/assessment/EnhancedResultsDashboard.tsx`
  - [ ] Add conditional rendering based on `scoringMethodology` field
  - [ ] Render "Risk Score Not Available" message for legacy assessments
  - [ ] Implement tabbed interface using Radix Tabs
  - [ ] Create tabs: Overview, Gaps, Strategy Matrix, Vendor Matches
  - [ ] Add routing integration to preserve active tab in URL
- [ ] Create Overview section with risk score display (AC: 2)
  - [ ] Create `/frontend/src/components/assessment/results/OverviewSection.tsx`
  - [ ] Add large risk score display (0-100) with animated counter
  - [ ] Implement color-coded risk band backgrounds:
    - Critical (0-39): bg-red-500
    - High (40-59): bg-orange-500
    - Medium (60-79): bg-yellow-500
    - Low (80-100): bg-green-500
  - [ ] Display risk band label (Critical/High/Medium/Low)
  - [ ] Add methodology badge: "Regulatory-Aligned Scoring"
  - [ ] Integrate EvidenceTierDistribution component (Recharts donut chart)
  - [ ] Add assessment quality indicator with conditional logic:
    - "Strong evidence base" if >50% Tier 1+2
    - "Limited documentation" if <30% Tier 1+2
- [ ] Create EvidenceTierDistribution chart component (AC: 2)
  - [ ] Create `/frontend/src/components/assessment/results/EvidenceTierDistribution.tsx`
  - [ ] Use Recharts PieChart with donut configuration
  - [ ] Display three segments: Tier 2, Tier 1, Tier 0
  - [ ] Add color coding: gold (Tier 2), silver (Tier 1), bronze (Tier 0)
  - [ ] Show percentage labels on each segment
  - [ ] Add legend with document counts per tier
  - [ ] Add tooltip on hover showing tier description
- [ ] Create ScoringBreakdown component (AC: 3)
  - [ ] Create `/frontend/src/components/assessment/results/ScoringBreakdown.tsx`
  - [ ] Implement accordion using Radix Accordion
  - [ ] Fetch section scoring data from API
  - [ ] Create SectionCard component for each section
  - [ ] Display section title, score (0-5), weight percentage
  - [ ] Calculate and display weighted contribution
  - [ ] Add progress bar visualization for section score (Radix Progress)
  - [ ] Implement expand/collapse to show questions
- [ ] Create QuestionDetailView component (AC: 4)
  - [ ] Create `/frontend/src/components/assessment/results/QuestionDetailView.tsx`
  - [ ] Display question text (truncate long questions, expand on click)
  - [ ] Show raw quality score with 5-star visualization
  - [ ] Integrate EvidenceTierBadge component (from Story 1.13)
  - [ ] Display tier multiplier (e.g., "×0.8 Policy Document")
  - [ ] Show question weight within section
  - [ ] Calculate and display final score after multiplier
  - [ ] Add progress bar for final score visualization
  - [ ] Display supporting evidence citations with links to documents
  - [ ] Add "Why this score?" button opening explanation modal (Radix Dialog)
  - [ ] Create ScoreExplanationModal component for detailed reasoning
- [ ] Add navigation and action buttons (AC: 6, 7)
  - [ ] Add "How is this calculated?" button
  - [ ] Implement navigation to /methodology page
  - [ ] Add "Download Report" button
  - [ ] Integrate with existing PDF generation API endpoint
  - [ ] Show loading state during report generation
  - [ ] Handle download errors gracefully
- [ ] Add API client integration
  - [ ] Extend `/frontend/src/lib/api.ts` with `getEnhancedResults(assessmentId)` method
  - [ ] Create TanStack Query hook `useEnhancedResults(assessmentId)`
  - [ ] Configure query key: `['assessments', assessmentId, 'enhanced-results']`
  - [ ] Add proper TypeScript interfaces for results data structure
- [ ] Implement responsive design (AC: 8)
  - [ ] Mobile (<768px): single column, stacked sections
  - [ ] Tablet (768-1023px): two-column grid where appropriate
  - [ ] Desktop (≥1024px): optimized layout with sidebar for navigation
  - [ ] Test donut chart responsiveness (smaller radius on mobile)
  - [ ] Ensure accordion works well on touch devices
- [ ] Add loading and error states (AC: 9, 10)
  - [ ] Create skeleton UI components for loading state
  - [ ] Use Radix Skeleton for score display, chart, sections
  - [ ] Add error boundary for graceful error handling
  - [ ] Display friendly error message if scoring data incomplete
  - [ ] Add retry button for failed data fetches

## Dev Notes

### Relevant Source Tree
- `/frontend/src/components/assessment/` - Assessment-specific components
- `/frontend/src/components/assessment/results/` - NEW subdirectory for results components
- `/frontend/src/components/ui/` - Radix UI component library
- `/frontend/src/pages/AssessmentResults.tsx` - Existing results page (to be enhanced)
- `/frontend/src/lib/api.ts` - Centralized API client
- `/backend/src/routes/assessment.routes.ts` - Assessment API endpoints (72KB)
- `/backend/src/services/weighted-scoring.service.ts` - NEW (created in Story 1.04)

### Design Decisions

**Conditional Rendering Strategy:**
Check `assessment.scoringMethodology` field to determine which view to render:
- `null` or `"unavailable"`: Show legacy view with message
- `"enhanced"`: Show new enhanced results dashboard
This allows gradual migration without breaking existing assessments.

**Data Structure (from API):**
```typescript
interface EnhancedResults {
  assessmentId: string;
  scoringMethodology: 'enhanced' | 'unavailable';
  overallScore: number; // 0-100
  riskBand: 'Critical' | 'High' | 'Medium' | 'Low';
  evidenceDistribution: {
    tier2: number; // percentage
    tier1: number;
    tier0: number;
  };
  sections: Array<{
    id: string;
    title: string;
    score: number; // 0-5
    weight: number; // 0-1 (e.g., 0.18 for 18%)
    contribution: number; // weighted contribution
    questions: Array<{
      id: string;
      text: string;
      rawQualityScore: number; // 0-5
      evidenceTier: 'TIER_0' | 'TIER_1' | 'TIER_2';
      tierMultiplier: number; // 0.6, 0.8, or 1.0
      weight: number; // within section
      finalScore: number; // after multiplier
      supportingEvidence: Array<{
        documentId: string;
        documentName: string;
      }>;
      explanation: string; // AI reasoning
    }>;
  }>;
}
```

**Risk Band Color Mapping:**
Use Tailwind color utilities for consistency:
- Critical: `bg-red-500 text-white`
- High: `bg-orange-500 text-white`
- Medium: `bg-yellow-500 text-gray-900`
- Low: `bg-green-500 text-white`

**Chart Library:**
Use Recharts (already in dependencies) for donut chart visualization. Configure with:
- innerRadius: 60% (donut hole)
- outerRadius: 80%
- paddingAngle: 2 (gap between segments)
- Custom colors: gold (#FFD700), silver (#C0C0C0), bronze (#CD7F32)

### Integration Points

**API Endpoints (from assessment.routes.ts):**
- ❌ `GET /assessments/:id/enhanced-results` - **DOES NOT EXIST** - Must be created
  - Should call WeightedScoringService to calculate enhanced results
  - Must include section/question breakdown with evidence tier multipliers
  - Response structure documented in Data Structure section below
- ✅ `GET /assessments/:id/report` - Existing PDF generation endpoint

**Backend Implementation Required:**
The backend endpoint must:
1. Fetch assessment with all answers and linked documents
2. For each answer, get associated document's evidence tier
3. Apply tier multiplier to raw quality score (0.6 for TIER_0, 0.8 for TIER_1, 1.0 for TIER_2)
4. Calculate weighted section scores using question weights
5. Calculate overall score using section weights
6. Return complete breakdown structure

**Radix UI Components to Use:**
- `Tabs` - Main tabbed interface
- `Accordion` - Section breakdown with expand/collapse
- `Progress` - Score visualizations (section scores, question scores)
- `Dialog` - Score explanation modal
- `Badge` - Methodology badge, evidence tier indicators
- `Tooltip` - Hover explanations for technical terms
- `Skeleton` - Loading state placeholders

**TanStack Query Integration:**
```typescript
const { data: results, isLoading, error } = useQuery({
  queryKey: ['assessments', assessmentId, 'enhanced-results'],
  queryFn: () => api.getEnhancedResults(assessmentId),
  staleTime: 5 * 60 * 1000, // 5 minutes
  enabled: !!assessmentId
});
```

**Recharts Configuration:**
```typescript
<PieChart width={300} height={300}>
  <Pie
    data={evidenceData}
    cx="50%"
    cy="50%"
    innerRadius={60}
    outerRadius={80}
    paddingAngle={2}
    dataKey="value"
  >
    {evidenceData.map((entry, index) => (
      <Cell key={`cell-${index}`} fill={TIER_COLORS[entry.tier]} />
    ))}
  </Pie>
  <Tooltip />
  <Legend />
</PieChart>
```

**Evidence Quality Indicator Logic:**
```typescript
const tier1and2Percentage =
  evidenceDistribution.tier1 + evidenceDistribution.tier2;

const qualityIndicator =
  tier1and2Percentage > 0.5
    ? { label: 'Strong evidence base', color: 'green' }
    : tier1and2Percentage < 0.3
    ? { label: 'Limited documentation', color: 'yellow' }
    : { label: 'Moderate evidence', color: 'blue' };
```

### Existing Patterns to Follow

**Tabbed Interface Pattern:**
Use Radix Tabs with URL integration (similar to admin dashboard):
```typescript
const [activeTab, setActiveTab] = useState('overview');

// Sync with URL
useEffect(() => {
  const params = new URLSearchParams(location.search);
  const tab = params.get('tab');
  if (tab) setActiveTab(tab);
}, [location.search]);

const handleTabChange = (value: string) => {
  setActiveTab(value);
  navigate(`?tab=${value}`, { replace: true });
};
```

**Skeleton Loading Pattern:**
Create consistent skeleton components matching final content structure (card heights, text widths, etc.)

**Error Boundary Pattern:**
Wrap results dashboard in error boundary to catch rendering errors and display fallback UI.

### Testing

**Test File Location:**
- Component tests: `/frontend/src/components/__tests__/EnhancedResultsDashboard.test.tsx`
- Component tests: `/frontend/src/components/__tests__/results/*.test.tsx`
- Integration tests: `/backend/tests/integration/enhanced-results.spec.ts`

**Testing Frameworks:**
- Vitest 3 + React Testing Library
- Mock TanStack Query with QueryClientProvider
- Mock Recharts (render as div with data-testid)

**Test Cases:**
1. Conditional rendering: shows "Risk Score Not Available" for legacy assessments
2. Conditional rendering: shows enhanced view for enhanced assessments
3. Risk score displays correct value with color-coded band
4. Risk band label displays correctly (Critical/High/Medium/Low)
5. Evidence tier donut chart renders with correct percentages
6. Assessment quality indicator shows correct message based on evidence
7. Tabbed interface switches between tabs
8. Tab state persists in URL
9. Section accordion expands/collapses correctly
10. Section cards display correct scores, weights, contributions
11. Question detail view shows all required fields
12. Evidence tier badge displays in question detail
13. "Why this score?" button opens explanation modal
14. Supporting evidence links navigate to documents
15. "How is this calculated?" button navigates to methodology page
16. "Download Report" button triggers API call
17. Loading state shows skeleton UI
18. Error state displays friendly message
19. Responsive layout works on mobile, tablet, desktop
20. Recharts donut chart resizes on viewport change

**Coverage Target:**
- Component coverage: 85%+ (comprehensive UI state testing)
- Integration coverage: 90%+ (all data scenarios)

## Change Log

| Date       | Version | Description                          | Author        |
|------------|---------|--------------------------------------|---------------|
| 2025-10-07 | 1.0     | Initial story created from PRD Epic 1 | SM (Winston)  |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent during implementation_

### Debug Log References
_To be populated by dev agent during implementation_

### Completion Notes
_To be populated by dev agent during implementation_

### File List
_To be populated by dev agent during implementation_

## QA Results

_To be populated by QA agent after implementation review_
