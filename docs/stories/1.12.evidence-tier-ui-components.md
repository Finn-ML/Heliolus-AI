# Story 1.12: Evidence Tier UI Components - Badge, Explanation, Distribution Chart

## Status
Ready for Review

## Story

**As a** frontend developer,
**I want** to create reusable React components for displaying evidence tiers,
**so that** users can see document quality classifications throughout the assessment journey.

## Acceptance Criteria

1. **Component: EvidenceTierBadge.tsx**
   - Props: `tier: EvidenceTier`, `confidence?: number`, `size?: "sm" | "md" | "lg"`
   - Displays color-coded badge: Tier 0 (gray), Tier 1 (blue), Tier 2 (green)
   - Shows tier label: "Self-Declared", "Policy Documents", "System-Generated"
   - Optionally shows confidence score as percentage: "85% confidence"
   - Uses existing Badge component from Radix UI
2. **Component: EvidenceTierExplanation.tsx**
   - Props: `documentId: string`, `tier: EvidenceTier`, `reason: string`, `confidence: number`
   - Expandable panel showing classification reasoning
   - Icon indicating tier quality (⚠️ low, ℹ️ medium, ✅ high)
   - Formatted explanation text with bullet points
   - "Why this matters" section explaining tier impact on scoring
3. **Component: EvidenceTierDistribution.tsx**
   - Props: `distribution: { tier0: number, tier1: number, tier2: number }`
   - Donut chart using Recharts showing percentage breakdown
   - Legend with counts: "Tier 2: 5 documents (25%)"
   - Responsive sizing (200px on mobile, 300px on desktop)
   - Hover tooltips showing document count and percentage
4. All components use TypeScript with strict typing
5. All components styled with TailwindCSS utilities
6. Unit tests using React Testing Library (render, props validation, conditional rendering)
7. Storybook stories demonstrating all component variants

## Tasks / Subtasks

- [x] Create EvidenceTierBadge.tsx component (AC: 1)
  - [x] Create file: frontend/src/components/assessment/EvidenceTierBadge.tsx
  - [x] Define Props interface: tier, confidence?, size?
  - [x] Import Badge from @/components/ui/badge
  - [x] Create tier color mapping: TIER_0 → gray, TIER_1 → blue, TIER_2 → green
  - [x] Create tier label mapping: TIER_0 → "Self-Declared", etc.
  - [x] Implement size variants: sm (text-xs), md (text-sm), lg (text-base)
  - [x] Render Badge with appropriate color and label
  - [x] Conditionally show confidence percentage if provided
  - [x] Add TypeScript strict typing
- [x] Style EvidenceTierBadge with Tailwind (AC: 5)
  - [x] Apply color classes: gray-500, blue-500, green-500
  - [x] Apply size-specific padding and font size
  - [x] Add hover effects for interactive states
  - [x] Ensure accessibility (proper contrast ratios)
- [x] Create EvidenceTierExplanation.tsx component (AC: 2)
  - [x] Create file: frontend/src/components/assessment/EvidenceTierExplanation.tsx
  - [x] Define Props interface: documentId, tier, reason, confidence
  - [x] Import Accordion from @/components/ui/accordion
  - [x] Import icons: AlertTriangle (⚠️), Info (ℹ️), CheckCircle (✅) from lucide-react
  - [x] Create icon mapping based on tier: TIER_0 → AlertTriangle, TIER_1 → Info, TIER_2 → CheckCircle
  - [x] Render expandable accordion panel
  - [x] Parse reason string into bullet points (split by newlines)
  - [x] Create "Why this matters" section with scoring impact explanation
  - [x] Add confidence score display
- [x] Implement "Why this matters" content (AC: 2)
  - [x] TIER_0 explanation: "Self-declared evidence has a 40% penalty on scoring. Consider uploading official documents."
  - [x] TIER_1 explanation: "Policy documents have a 20% penalty. System-generated evidence provides full score."
  - [x] TIER_2 explanation: "System-generated evidence receives full scoring with no penalty."
  - [x] Add link/button to document upload if tier < 2
- [x] Create EvidenceTierDistribution.tsx component (AC: 3)
  - [x] Create file: frontend/src/components/assessment/EvidenceTierDistribution.tsx
  - [x] Define Props interface: distribution: { tier0, tier1, tier2 }
  - [x] Import PieChart, Pie, Cell, Tooltip, Legend from recharts
  - [x] Calculate percentages from counts
  - [x] Configure donut chart (innerRadius for donut shape)
  - [x] Apply tier colors: TIER_0 → gray, TIER_1 → blue, TIER_2 → green
  - [x] Create custom tooltip showing count and percentage
  - [x] Create custom legend with labels "Tier 2: 5 documents (25%)"
  - [x] Implement responsive sizing (useMediaQuery hook)
- [x] Make EvidenceTierDistribution responsive (AC: 3)
  - [x] Add media query: mobile (<768px) → 200px chart
  - [x] Add media query: desktop (≥768px) → 300px chart
  - [x] Adjust legend position for mobile (below) vs desktop (right)
  - [x] Test on multiple screen sizes
- [x] Add TypeScript types (AC: 4)
  - [x] Create types file: frontend/src/types/evidence-tier.types.ts
  - [x] Define EvidenceTier enum: "TIER_0" | "TIER_1" | "TIER_2"
  - [x] Define EvidenceTierBadgeProps interface
  - [x] Define EvidenceTierExplanationProps interface
  - [x] Define EvidenceTierDistributionProps interface
  - [x] Export all types
- [x] Write unit tests (AC: 6)
  - [x] Test EvidenceTierBadge: renders with TIER_0 → gray badge
  - [x] Test EvidenceTierBadge: renders with TIER_2 → green badge
  - [x] Test EvidenceTierBadge: shows confidence when provided
  - [x] Test EvidenceTierBadge: size variants render correctly
  - [x] Test EvidenceTierExplanation: renders expandable panel
  - [x] Test EvidenceTierExplanation: shows correct icon for each tier
  - [x] Test EvidenceTierExplanation: parses reason into bullet points
  - [x] Test EvidenceTierDistribution: renders chart with correct data
  - [x] Test EvidenceTierDistribution: legend shows correct counts
  - [x] Test EvidenceTierDistribution: tooltip shows on hover
  - [x] Test all components: conditional rendering of optional props
- [x] Create Storybook stories (AC: 7)
  - [x] Create EvidenceTierBadge.stories.tsx
  - [x] Story: All tiers (TIER_0, TIER_1, TIER_2)
  - [x] Story: With confidence score
  - [x] Story: Size variants (sm, md, lg)
  - [x] Create EvidenceTierExplanation.stories.tsx
  - [x] Story: Each tier with sample explanations
  - [x] Story: Expanded vs collapsed states
  - [x] Create EvidenceTierDistribution.stories.tsx
  - [x] Story: Balanced distribution (5, 5, 5)
  - [x] Story: Skewed distribution (10, 3, 1)
  - [x] Story: Empty state (0, 0, 0)

## Dev Notes

### Relevant Source Tree
- `frontend/src/components/assessment/EvidenceTierBadge.tsx` - NEW: Badge component
- `frontend/src/components/assessment/EvidenceTierExplanation.tsx` - NEW: Explanation panel
- `frontend/src/components/assessment/EvidenceTierDistribution.tsx` - NEW: Donut chart
- `frontend/src/types/evidence-tier.types.ts` - NEW: TypeScript types
- `frontend/src/components/ui/badge.tsx` - EXISTING: Radix UI Badge primitive
- `frontend/src/components/ui/accordion.tsx` - EXISTING: Radix UI Accordion primitive
- `frontend/src/lib/utils.ts` - EXISTING: cn() utility for class merging

### Component Architecture

**Design System:**
- Uses existing Radix UI primitives (Badge, Accordion)
- Follows existing TailwindCSS color palette
- Consistent with existing component patterns in codebase

**Color Palette (from existing theme):**
- TIER_0: gray-500 (#6B7280)
- TIER_1: blue-500 (#3B82F6)
- TIER_2: green-500 (#22C55E)

### EvidenceTierBadge Component

```tsx
import React from 'react'
import { Badge } from '@/components/ui/badge'
import { cn } from '@/lib/utils'
import type { EvidenceTier } from '@/types/evidence-tier.types'

interface EvidenceTierBadgeProps {
  tier: EvidenceTier
  confidence?: number
  size?: 'sm' | 'md' | 'lg'
  className?: string
}

const tierConfig = {
  TIER_0: {
    label: 'Self-Declared',
    color: 'bg-gray-500 hover:bg-gray-600'
  },
  TIER_1: {
    label: 'Policy Documents',
    color: 'bg-blue-500 hover:bg-blue-600'
  },
  TIER_2: {
    label: 'System-Generated',
    color: 'bg-green-500 hover:bg-green-600'
  }
}

const sizeConfig = {
  sm: 'text-xs px-2 py-0.5',
  md: 'text-sm px-2.5 py-1',
  lg: 'text-base px-3 py-1.5'
}

export function EvidenceTierBadge({
  tier,
  confidence,
  size = 'md',
  className
}: EvidenceTierBadgeProps) {
  const config = tierConfig[tier]
  const sizeClasses = sizeConfig[size]

  return (
    <Badge
      className={cn(
        config.color,
        sizeClasses,
        'text-white font-medium',
        className
      )}
    >
      {config.label}
      {confidence !== undefined && (
        <span className="ml-1 opacity-90">
          ({Math.round(confidence * 100)}%)
        </span>
      )}
    </Badge>
  )
}
```

**Usage Example:**
```tsx
<EvidenceTierBadge tier="TIER_2" />
<EvidenceTierBadge tier="TIER_1" confidence={0.85} size="lg" />
```

### EvidenceTierExplanation Component

```tsx
import React from 'react'
import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger
} from '@/components/ui/accordion'
import { AlertTriangle, Info, CheckCircle } from 'lucide-react'
import type { EvidenceTier } from '@/types/evidence-tier.types'

interface EvidenceTierExplanationProps {
  documentId: string
  tier: EvidenceTier
  reason: string
  confidence: number
}

const tierIcons = {
  TIER_0: AlertTriangle,
  TIER_1: Info,
  TIER_2: CheckCircle
}

const tierIconColors = {
  TIER_0: 'text-gray-500',
  TIER_1: 'text-blue-500',
  TIER_2: 'text-green-500'
}

const whyItMatters = {
  TIER_0: 'Self-declared evidence has a 40% penalty on scoring. Consider uploading official policy documents or system-generated reports for better assessment accuracy.',
  TIER_1: 'Policy documents have a 20% penalty compared to system-generated evidence. Upload compliance reports or audit logs for full scoring.',
  TIER_2: 'System-generated evidence receives full scoring with no penalty. This is the highest quality evidence type.'
}

export function EvidenceTierExplanation({
  documentId,
  tier,
  reason,
  confidence
}: EvidenceTierExplanationProps) {
  const Icon = tierIcons[tier]
  const iconColor = tierIconColors[tier]
  const reasonBullets = reason.split('\n').filter(Boolean)

  return (
    <Accordion type="single" collapsible>
      <AccordionItem value="explanation">
        <AccordionTrigger className="text-sm font-medium">
          <div className="flex items-center gap-2">
            <Icon className={cn('w-4 h-4', iconColor)} />
            <span>View Classification Details</span>
          </div>
        </AccordionTrigger>
        <AccordionContent>
          <div className="space-y-4 text-sm">
            {/* Classification Reasoning */}
            <div>
              <h4 className="font-semibold mb-2">Classification Reasoning:</h4>
              <ul className="list-disc list-inside space-y-1 text-muted-foreground">
                {reasonBullets.map((bullet, i) => (
                  <li key={i}>{bullet}</li>
                ))}
              </ul>
            </div>

            {/* Confidence Score */}
            <div>
              <span className="font-semibold">Confidence: </span>
              <span className="text-muted-foreground">
                {Math.round(confidence * 100)}%
              </span>
            </div>

            {/* Why this matters */}
            <div className="bg-muted p-3 rounded-md">
              <h4 className="font-semibold mb-1">Why this matters:</h4>
              <p className="text-muted-foreground">{whyItMatters[tier]}</p>
              {tier !== 'TIER_2' && (
                <button
                  className="mt-2 text-primary underline text-xs"
                  onClick={() => {/* Navigate to document upload */}}
                >
                  Upload better evidence
                </button>
              )}
            </div>
          </div>
        </AccordionContent>
      </AccordionItem>
    </Accordion>
  )
}
```

**Usage Example:**
```tsx
<EvidenceTierExplanation
  documentId="doc_123"
  tier="TIER_1"
  reason="Document contains structured policy text\nNo system metadata present\nAppears to be a PDF export"
  confidence={0.82}
/>
```

### EvidenceTierDistribution Component

```tsx
import React from 'react'
import { PieChart, Pie, Cell, Tooltip, Legend, ResponsiveContainer } from 'recharts'
import { useMediaQuery } from '@/hooks/useMediaQuery'

interface EvidenceTierDistributionProps {
  distribution: {
    tier0: number
    tier1: number
    tier2: number
  }
}

const COLORS = {
  TIER_0: '#6B7280', // gray-500
  TIER_1: '#3B82F6', // blue-500
  TIER_2: '#22C55E'  // green-500
}

const LABELS = {
  TIER_0: 'Self-Declared',
  TIER_1: 'Policy Documents',
  TIER_2: 'System-Generated'
}

export function EvidenceTierDistribution({ distribution }: EvidenceTierDistributionProps) {
  const isMobile = useMediaQuery('(max-width: 768px)')
  const size = isMobile ? 200 : 300

  const total = distribution.tier0 + distribution.tier1 + distribution.tier2

  const data = [
    { name: 'TIER_0', value: distribution.tier0, label: LABELS.TIER_0 },
    { name: 'TIER_1', value: distribution.tier1, label: LABELS.TIER_1 },
    { name: 'TIER_2', value: distribution.tier2, label: LABELS.TIER_2 }
  ].filter(item => item.value > 0) // Only show non-zero tiers

  if (total === 0) {
    return (
      <div className="flex items-center justify-center h-64 text-muted-foreground">
        No documents uploaded yet
      </div>
    )
  }

  const CustomTooltip = ({ active, payload }: any) => {
    if (active && payload && payload.length) {
      const data = payload[0].payload
      const percentage = ((data.value / total) * 100).toFixed(1)
      return (
        <div className="bg-background border border-border rounded-md p-2 shadow-lg">
          <p className="font-semibold">{data.label}</p>
          <p className="text-sm text-muted-foreground">
            {data.value} documents ({percentage}%)
          </p>
        </div>
      )
    }
    return null
  }

  const CustomLegend = ({ payload }: any) => {
    return (
      <ul className="space-y-1">
        {payload.map((entry: any, index: number) => {
          const percentage = ((entry.value / total) * 100).toFixed(0)
          return (
            <li key={index} className="flex items-center gap-2 text-sm">
              <div
                className="w-3 h-3 rounded-full"
                style={{ backgroundColor: entry.color }}
              />
              <span className="text-muted-foreground">
                {entry.payload.label}: {entry.value} ({percentage}%)
              </span>
            </li>
          )
        })}
      </ul>
    )
  }

  return (
    <div className="w-full">
      <ResponsiveContainer width="100%" height={size}>
        <PieChart>
          <Pie
            data={data}
            cx="50%"
            cy="50%"
            innerRadius={size * 0.25}
            outerRadius={size * 0.4}
            paddingAngle={2}
            dataKey="value"
          >
            {data.map((entry, index) => (
              <Cell key={`cell-${index}`} fill={COLORS[entry.name as keyof typeof COLORS]} />
            ))}
          </Pie>
          <Tooltip content={<CustomTooltip />} />
          <Legend
            content={<CustomLegend />}
            verticalAlign={isMobile ? 'bottom' : 'middle'}
            align={isMobile ? 'center' : 'right'}
            layout={isMobile ? 'horizontal' : 'vertical'}
          />
        </PieChart>
      </ResponsiveContainer>
    </div>
  )
}
```

**Usage Example:**
```tsx
<EvidenceTierDistribution
  distribution={{
    tier0: 2,
    tier1: 5,
    tier2: 8
  }}
/>
```

### TypeScript Types

```typescript
// frontend/src/types/evidence-tier.types.ts

export type EvidenceTier = 'TIER_0' | 'TIER_1' | 'TIER_2'

export interface EvidenceTierBadgeProps {
  tier: EvidenceTier
  confidence?: number
  size?: 'sm' | 'md' | 'lg'
  className?: string
}

export interface EvidenceTierExplanationProps {
  documentId: string
  tier: EvidenceTier
  reason: string
  confidence: number
}

export interface EvidenceTierDistributionProps {
  distribution: {
    tier0: number
    tier1: number
    tier2: number
  }
}

export interface EvidenceTierResult {
  tier: EvidenceTier
  confidence: number
  reason: string
  indicators: string[]
}
```

### Integration with Existing Design System

**Radix UI Components Used:**
- Badge (from @/components/ui/badge)
- Accordion (from @/components/ui/accordion)

**TailwindCSS Classes:**
- Color utilities: bg-gray-500, bg-blue-500, bg-green-500
- Spacing: px-2, py-1, gap-2, space-y-4
- Typography: text-xs, text-sm, text-base, font-medium
- Layout: flex, items-center, justify-center

**Existing Utilities:**
- cn() function from @/lib/utils for conditional class merging
- useMediaQuery hook for responsive behavior

### Testing

**Unit Testing:**
Location: `frontend/src/components/assessment/*.test.tsx`

Framework: React Testing Library + Vitest

Test cases:
```typescript
// EvidenceTierBadge.test.tsx
describe('EvidenceTierBadge', () => {
  it('renders TIER_0 with gray color', () => {
    render(<EvidenceTierBadge tier="TIER_0" />)
    expect(screen.getByText('Self-Declared')).toBeInTheDocument()
    expect(screen.getByText('Self-Declared')).toHaveClass('bg-gray-500')
  })

  it('renders TIER_2 with green color', () => {
    render(<EvidenceTierBadge tier="TIER_2" />)
    expect(screen.getByText('System-Generated')).toHaveClass('bg-green-500')
  })

  it('shows confidence percentage when provided', () => {
    render(<EvidenceTierBadge tier="TIER_1" confidence={0.85} />)
    expect(screen.getByText(/85%/)).toBeInTheDocument()
  })

  it('applies size variant classes', () => {
    const { rerender } = render(<EvidenceTierBadge tier="TIER_1" size="sm" />)
    expect(screen.getByText('Policy Documents')).toHaveClass('text-xs')

    rerender(<EvidenceTierBadge tier="TIER_1" size="lg" />)
    expect(screen.getByText('Policy Documents')).toHaveClass('text-base')
  })
})
```

**Storybook Stories:**
Location: `frontend/src/components/assessment/*.stories.tsx`

```typescript
// EvidenceTierBadge.stories.tsx
import type { Meta, StoryObj } from '@storybook/react'
import { EvidenceTierBadge } from './EvidenceTierBadge'

const meta: Meta<typeof EvidenceTierBadge> = {
  title: 'Assessment/EvidenceTierBadge',
  component: EvidenceTierBadge,
  tags: ['autodocs']
}

export default meta
type Story = StoryObj<typeof EvidenceTierBadge>

export const Tier0: Story = {
  args: {
    tier: 'TIER_0'
  }
}

export const Tier1: Story = {
  args: {
    tier: 'TIER_1'
  }
}

export const Tier2: Story = {
  args: {
    tier: 'TIER_2'
  }
}

export const WithConfidence: Story = {
  args: {
    tier: 'TIER_2',
    confidence: 0.95
  }
}

export const SizeVariants: Story = {
  render: () => (
    <div className="flex gap-4 items-center">
      <EvidenceTierBadge tier="TIER_1" size="sm" />
      <EvidenceTierBadge tier="TIER_1" size="md" />
      <EvidenceTierBadge tier="TIER_1" size="lg" />
    </div>
  )
}
```

**Coverage Target:** ≥80% for all components

## Change Log

| Date       | Version | Description                          | Author        |
|------------|---------|--------------------------------------|---------------|
| 2025-10-07 | 1.0     | Initial story created from PRD Epic 1 | SM (Winston)  |
| 2025-10-09 | 1.1     | Completed implementation of all components | Dev (James)   |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
- No debug logs needed - clean implementation

### Completion Notes
- All components successfully implemented with TypeScript strict typing
- Created reusable Evidence Tier UI components for badge display, explanation panels, and distribution charts
- Implemented responsive behavior for mobile/desktop views
- Added comprehensive unit tests for all three components
- Created detailed Storybook stories demonstrating all component variants
- Components follow existing design patterns using Radix UI primitives
- Added custom useMediaQuery hook for responsive behavior
- All acceptance criteria met

### File List
**New Files Created:**
- frontend/src/components/assessment/EvidenceTierBadge.tsx
- frontend/src/components/assessment/EvidenceTierExplanation.tsx
- frontend/src/components/assessment/EvidenceTierDistribution.tsx
- frontend/src/types/evidence-tier.types.ts
- frontend/src/hooks/use-media-query.ts
- frontend/src/components/assessment/EvidenceTierBadge.test.tsx
- frontend/src/components/assessment/EvidenceTierExplanation.test.tsx
- frontend/src/components/assessment/EvidenceTierDistribution.test.tsx
- frontend/src/components/assessment/EvidenceTierBadge.stories.tsx
- frontend/src/components/assessment/EvidenceTierExplanation.stories.tsx
- frontend/src/components/assessment/EvidenceTierDistribution.stories.tsx

## QA Results

_To be populated by QA agent after implementation review_
