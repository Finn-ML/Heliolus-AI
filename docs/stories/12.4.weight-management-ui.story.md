# Story 12.4: Section & Question Weight Management UI

## Status
Draft

## Story

**As a** platform administrator,
**I want** to set and manage weights for sections and questions in the admin template UI,
**so that** templates use accurate weighted scoring aligned with regulatory frameworks.

## Acceptance Criteria

1. **Section Weight Input** - Add to Section Create/Edit Dialog
   - Number input field labeled "Weight (0-100)"
   - Default value: 1.0
   - Validation: Must be between 0 and 100
   - Shows inline error if value out of range
   - Saves to section.weight field via updateSection mutation

2. **Question Weight Input** - Add to Question Create/Edit Dialog
   - Number input field labeled "Weight (0-100)"
   - Default value: 1.0
   - Validation: Must be between 0 and 100
   - Shows inline error if value out of range
   - Saves to question.weight field via updateQuestion mutation

3. **Total Weight Display** - Template Detail View
   - Display total section weight per template
   - Display total question weight per section
   - Visual indicator if weights don't sum to 100 (warning badge)
   - Color coding: Green if sum = 100, Yellow if sum != 100
   - Calculate automatically on client side from section/question arrays

4. **Weight Distribution Visualization** - Template Statistics Card
   - Show percentage breakdown of section weights
   - Progress bar showing weight contribution per section
   - Tooltip showing exact weight value on hover
   - Update in real-time as weights change

5. **Validation Warnings**
   - Warn if template has sections with zero weight
   - Warn if section has questions with zero weight
   - Display warning icon next to affected section/question
   - Show explanation tooltip: "Zero weight items won't contribute to scoring"

6. **Bulk Weight Update** - Optional convenience feature
   - "Distribute Evenly" button for sections (divides 100 by section count)
   - "Distribute Evenly" button for questions within a section
   - Confirmation dialog before applying bulk update
   - Updates all weights via individual updateSection/updateQuestion mutations

## Tasks / Subtasks

- [ ] Task 1: Add Weight Input to Section Dialog (AC: 1)
  - [ ] Add number input field to section create/edit dialog
  - [ ] Set default value: 1.0
  - [ ] Add Zod validation: z.number().min(0).max(100)
  - [ ] Display validation error below input field
  - [ ] Include weight in createSection/updateSection mutation data
  - [ ] Test: Create section with weight 50, verify in database
  - [ ] Test: Try to create section with weight 150, show error

- [ ] Task 2: Add Weight Input to Question Dialog (AC: 2)
  - [ ] Add number input field to question create/edit dialog
  - [ ] Set default value: 1.0
  - [ ] Add Zod validation: z.number().min(0).max(100)
  - [ ] Display validation error below input field
  - [ ] Include weight in createQuestion/updateQuestion mutation data
  - [ ] Test: Create question with weight 25, verify in database
  - [ ] Test: Update question weight from 25 to 75, verify update

- [ ] Task 3: Calculate Total Weights (AC: 3)
  - [ ] Add `calculateTotalSectionWeight(template)` helper function
  - [ ] Add `calculateTotalQuestionWeight(section)` helper function
  - [ ] Sum all section.weight values for template
  - [ ] Sum all question.weight values for section
  - [ ] Return { total, isBalanced: total === 100 }

- [ ] Task 4: Display Total Weight with Indicators (AC: 3, 5)
  - [ ] Add weight summary card to template detail view
  - [ ] Display "Total Section Weight: X" with color badge
  - [ ] Green badge if total = 100, yellow if != 100
  - [ ] Show warning icon if any section/question has weight = 0
  - [ ] Tooltip on warning: "Zero weight items won't contribute to scoring"
  - [ ] Update dynamically when weights change (use template query data)

- [ ] Task 5: Weight Distribution Visualization (AC: 4)
  - [ ] Create WeightDistributionCard component
  - [ ] Use Recharts BarChart or custom progress bars
  - [ ] Display each section with label + percentage
  - [ ] Color code bars by weight value (high=green, low=yellow)
  - [ ] Add tooltip showing exact weight value
  - [ ] Place in template statistics sidebar

- [ ] Task 6: Implement Bulk Weight Update (AC: 6)
  - [ ] Add "Distribute Evenly" button to section list header
  - [ ] Calculate even distribution: 100 / sectionCount
  - [ ] Show confirmation dialog with preview of changes
  - [ ] On confirm, call updateSection for each section sequentially
  - [ ] Show progress indicator during bulk update
  - [ ] Toast notification on completion
  - [ ] Replicate for questions within section

- [ ] Task 7: Integration Testing (All AC)
  - [ ] Test section weight input (0, 1, 50, 100, 150)
  - [ ] Test question weight input (0, 1, 25, 100, 101)
  - [ ] Test total weight calculation (3 sections: 30+40+30=100)
  - [ ] Test warning display for zero weight items
  - [ ] Test weight distribution visualization
  - [ ] Test bulk distribute evenly (5 sections → 20 each)
  - [ ] Test real-time updates (change weight → visualization updates)

## Dev Notes

### Weight Field Context

**Database Schema:**
- Section.weight: Float, default 1.0 (already exists in schema)
- Question.weight: Float, default 1.0 (already exists in schema)
- No migration needed - fields already present

**Regulatory Alignment:**
Section weights should align with regulatory priorities (e.g., FFIEC BSA/AML framework):
- High-risk sections (Sanctions Screening, Transaction Monitoring): 25-30%
- Medium-risk sections (KYC, Customer Due Diligence): 15-20%
- Lower-risk sections (Reporting, Training): 10-15%

Admins can reference Section.regulatoryPriority field for guidance.

### Weight Calculation Functions

**Helper Functions:**
```typescript
// Calculate total section weight for template
function calculateTotalSectionWeight(template: Template): { total: number; isBalanced: boolean } {
  const total = template.sections.reduce((sum, section) => sum + (section.weight || 0), 0);
  return {
    total,
    isBalanced: Math.abs(total - 100) < 0.01, // Allow small floating point errors
  };
}

// Calculate total question weight for section
function calculateTotalQuestionWeight(section: Section): { total: number; isBalanced: boolean } {
  const total = section.questions.reduce((sum, question) => sum + (question.weight || 0), 0);
  return {
    total,
    isBalanced: Math.abs(total - 100) < 0.01,
  };
}

// Distribute weight evenly
function distributeWeightEvenly(itemCount: number): number {
  return Math.round((100 / itemCount) * 100) / 100; // Round to 2 decimals
}
```

### UI Components

**Weight Input Component:**
```typescript
<div className="space-y-2">
  <Label htmlFor="weight">Weight (0-100)</Label>
  <Input
    id="weight"
    type="number"
    min="0"
    max="100"
    step="0.1"
    value={weight}
    onChange={(e) => setWeight(parseFloat(e.target.value))}
    className={errors.weight ? 'border-red-500' : ''}
  />
  {errors.weight && (
    <p className="text-sm text-red-500">{errors.weight.message}</p>
  )}
  <p className="text-xs text-muted-foreground">
    Importance weight for scoring (higher = more important)
  </p>
</div>
```

**Total Weight Badge:**
```typescript
function WeightBadge({ total }: { total: number }) {
  const isBalanced = Math.abs(total - 100) < 0.01;
  const variant = isBalanced ? 'success' : 'warning';
  const color = isBalanced ? 'text-green-600' : 'text-yellow-600';

  return (
    <div className="flex items-center gap-2">
      <span className="text-sm font-medium">Total Weight:</span>
      <Badge variant={variant} className={color}>
        {total.toFixed(1)}
      </Badge>
      {!isBalanced && (
        <TooltipProvider>
          <Tooltip>
            <TooltipTrigger>
              <AlertCircle className="h-4 w-4 text-yellow-500" />
            </TooltipTrigger>
            <TooltipContent>
              <p>Weights should sum to 100 for balanced scoring</p>
            </TooltipContent>
          </Tooltip>
        </TooltipProvider>
      )}
    </div>
  );
}
```

**Weight Distribution Visualization:**
```typescript
function WeightDistributionChart({ sections }: { sections: Section[] }) {
  const data = sections.map((section) => ({
    name: section.title,
    weight: section.weight || 0,
    percentage: ((section.weight || 0) / 100) * 100,
  }));

  return (
    <Card>
      <CardHeader>
        <CardTitle>Section Weight Distribution</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="space-y-2">
          {data.map((item) => (
            <div key={item.name} className="flex items-center gap-2">
              <span className="text-sm w-32 truncate">{item.name}</span>
              <div className="flex-1">
                <Progress value={item.percentage} className="h-2" />
              </div>
              <span className="text-sm font-medium w-12 text-right">
                {item.weight.toFixed(1)}
              </span>
            </div>
          ))}
        </div>
      </CardContent>
    </Card>
  );
}
```

### Bulk Weight Update Flow

**Distribute Evenly Implementation:**
```typescript
function useBulkUpdateSectionWeights() {
  const updateSection = useUpdateSection();
  const [isPending, setIsPending] = useState(false);

  const distributeEvenly = async (template: Template) => {
    const evenWeight = distributeWeightEvenly(template.sections.length);

    // Confirm with user
    const confirmed = await confirm(
      `This will set all ${template.sections.length} sections to ${evenWeight.toFixed(1)} weight each. Continue?`
    );

    if (!confirmed) return;

    setIsPending(true);
    const toastId = toast.loading('Updating section weights...');

    try {
      // Update each section sequentially
      for (const section of template.sections) {
        await updateSection.mutateAsync({
          id: section.id,
          data: { weight: evenWeight },
        });
      }

      toast.success('Section weights distributed evenly', { id: toastId });
    } catch (error) {
      toast.error('Failed to update weights', { id: toastId });
    } finally {
      setIsPending(false);
    }
  };

  return { distributeEvenly, isPending };
}
```

### File Locations

**Modified Files:**
- `frontend/src/pages/admin/TemplateManagement.tsx` - Add weight inputs to dialogs
- `frontend/src/components/admin/WeightDistributionChart.tsx` - New component (optional)

**New Components (Optional):**
- `frontend/src/components/admin/WeightBadge.tsx` - Reusable weight indicator

### Testing Checklist

```
□ Create section with weight 50
□ Update section weight from 50 to 75
□ Create question with weight 25
□ Update question weight from 25 to 100
□ Test validation: weight 150 (should fail)
□ Test validation: weight -10 (should fail)
□ View template with 3 sections (30+40+30=100) → green badge
□ View template with 2 sections (60+60=120) → yellow badge
□ Create section with weight 0 → warning icon appears
□ Distribute evenly: 5 sections → 20 each
□ Distribute evenly: 3 questions → 33.33 each
□ Weight visualization displays correctly
□ Real-time update: change weight → chart updates
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Story created - Section & question weight management UI | Bob (Scrum Master) |

---

## Dev Agent Record
_To be populated by dev agent during implementation_

---

## QA Results
_To be populated by QA agent after testing_
