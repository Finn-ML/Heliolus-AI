# Story 13.6: Contact Form System (Basic Lead)

## Status
Draft

## Story

**As a** Free tier user
**I want** to submit a simple contact form to vendors
**So that** I can express interest without Premium subscription

## Acceptance Criteria

1. Contact form includes:
   - User name, email (auto-populated from User)
   - Company name (auto-populated from Organization)
   - Message (required, 500 char max)
   - Budget range (optional dropdown: <50K, 50K-100K, 100K-500K, 500K+)
   - Timeline (optional dropdown: <3mo, 3-6mo, 6-12mo, 12mo+)
   - Single vendor selection (not multi-select)
2. Form validation: Message required
3. API: `POST /v1/vendor/:vendorId/contact` creates VendorContact record
   - Sets `type: GENERAL_INQUIRY` (not RFP)
4. Vendor email notification:
   - Subject: "New inquiry from [Company Name]"
   - Body: Message, budget, timeline, user contact info
   - CTA: "Reply to [user email]"
5. Success message: "Your inquiry has been sent to [Vendor Name]"
6. Rate limiting: Max 3 contacts per user per day (prevent spam)

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Contact Vendor API Endpoint** (AC: 3)
  - [ ] Create route: `POST /v1/vendor/:vendorId/contact` in vendor.routes.ts
  - [ ] Require authentication (JWT)
  - [ ] NO Premium tier check (available to Free users)
  - [ ] Request body validation with Zod:
    ```typescript
    {
      message: string,       // Required, max 500 chars
      budget?: string,       // Optional
      timeline?: string      // Optional
    }
    ```
  - [ ] Fetch vendor by vendorId (validate exists)
  - [ ] Create VendorContact record:
    - vendorId: From URL parameter
    - userId: From authenticated user
    - organizationId: From user's organization
    - type: GENERAL_INQUIRY (not RFP)
    - message: From request body
    - budget: From request body
    - timeline: From request body
    - status: PENDING
  - [ ] Return VendorContact object

- [ ] **Task 2: Rate Limiting** (AC: 6)
  - [ ] Implement rate limiting: Max 3 contacts per user per day
  - [ ] Use in-memory Map: `{ userId: [timestamp1, timestamp2, timestamp3] }`
  - [ ] Filter timestamps: Only count contacts in last 24 hours
  - [ ] If limit exceeded: Return 429 Too Many Requests
    - Error message: "You've reached the daily limit of 3 vendor contacts. Please try again tomorrow."
  - [ ] Alternative: Use Redis if available for distributed rate limiting

- [ ] **Task 3: Vendor Inquiry Email Template** (AC: 4)
  - [ ] Create `backend/src/templates/vendor-inquiry.html`
  - [ ] Create `backend/src/templates/vendor-inquiry.text`
  - [ ] Template variables:
    - `{{companyName}}` - User's company
    - `{{userName}}` - User's name
    - `{{userEmail}}` - User's email
    - `{{message}}` - User's message
    - `{{budget}}` - Budget range (if provided)
    - `{{timeline}}` - Timeline (if provided)
  - [ ] Email structure:
    - Subject: "New inquiry from {{companyName}}"
    - Greeting: "Dear {{vendorName}} Team,"
    - Body: "You've received a new inquiry from {{companyName}}."
    - Message section with user's message
    - Budget and timeline (if provided)
    - CTA: "Reply directly to {{userEmail}}"
    - Footer with unsubscribe link

- [ ] **Task 4: Send Vendor Inquiry Email** (AC: 4)
  - [ ] Extend email.service.ts with `sendVendorInquiry` method
  - [ ] Parameters: vendorEmail, vendorName, userCompany, userName, userEmail, message, budget, timeline
  - [ ] Load vendor-inquiry template (HTML + text)
  - [ ] Render template with data
  - [ ] Send via Postmark using existing sendEmailWithRetry
  - [ ] Subject: "New inquiry from {companyName}"

- [ ] **Task 5: Integrate Email Sending into Contact API** (AC: 4)
  - [ ] After creating VendorContact record, send email
  - [ ] Handle email failure gracefully (log error, don't fail API call)
  - [ ] If vendor has no contactEmail: Skip email, log warning

### Frontend Tasks

- [ ] **Task 6: Contact Vendor Form Component** (AC: 1, 2)
  - [ ] Create `frontend/src/components/vendor/ContactVendorForm.tsx`
  - [ ] Can be modal or dedicated page
  - [ ] Form fields:
    - **User Name**: Auto-populated, read-only (from useAuth)
    - **User Email**: Auto-populated, read-only
    - **Company Name**: Auto-populated, read-only
    - **Message**: Textarea, required, 500 char max, character counter
    - **Budget Range**: Select dropdown (optional)
      - Options: "< €50K", "€50K - €100K", "€100K - €500K", "€500K - €1M", "> €1M", "Not specified"
    - **Timeline**: Select dropdown (optional)
      - Options: "< 3 months", "3-6 months", "6-12 months", "> 12 months", "Flexible"
  - [ ] Form validation with React Hook Form + Zod
  - [ ] Submit button disabled until message is entered

- [ ] **Task 7: Form Submission** (AC: 3, 5)
  - [ ] On submit: Call `POST /v1/vendor/:vendorId/contact`
  - [ ] Loading state: Disable form, show spinner on button
  - [ ] Success:
    - Close form/modal
    - Show success toast: "Your inquiry has been sent to {vendorName}"
    - Optional: Redirect to vendor profile or dashboard
  - [ ] Error:
    - 429 (rate limit): Show error toast with daily limit message
    - 404 (vendor not found): Show error toast "Vendor not found"
    - Other errors: Show generic error toast

- [ ] **Task 8: Contact Button Integration** (AC: 1)
  - [ ] Add "Contact Vendor" button on vendor profile pages
  - [ ] Add "Contact" button in vendor results list
  - [ ] On click: Open ContactVendorForm modal with vendorId
  - [ ] For Premium users: Also show "Create RFP" button (from Story 13.1)
  - [ ] For Free users: Only show "Contact Vendor" button

- [ ] **Task 9: Contact Form Modal** (AC: 1)
  - [ ] Use Radix UI Dialog for modal
  - [ ] Modal header: "Contact {vendorName}"
  - [ ] Modal body: ContactVendorForm
  - [ ] Modal footer: Cancel button, Submit button
  - [ ] Close button (X) in top right

- [ ] **Task 10: API Hook** (AC: 3)
  - [ ] Create `frontend/src/hooks/useContactVendor.ts`
  - [ ] Mutation hook: `useContactVendor(vendorId)`
  - [ ] Call `POST /v1/vendor/:vendorId/contact`
  - [ ] Handle success/error states

- [ ] **Task 11: Rate Limit UI Handling** (AC: 6)
  - [ ] On 429 response:
    - Show toast: "Daily contact limit reached. You can contact 3 vendors per day. Please try again tomorrow."
    - Disable "Contact Vendor" button with tooltip showing limit
  - [ ] Optional: Display remaining contacts count (if backend provides it)

### Testing

- [ ] **Task 12: Backend Unit Tests** (AC: 3, 6)
  - [ ] Test vendor.routes.ts POST /v1/vendor/:vendorId/contact:
    - Valid request creates VendorContact (type: GENERAL_INQUIRY)
    - Missing message: 400 validation error
    - Invalid vendorId: 404 vendor not found
    - Rate limit: 4th contact in 24h returns 429
  - [ ] Test rate limiting logic:
    - 1st, 2nd, 3rd contacts: Success
    - 4th contact within 24h: 429
    - 4th contact after 24h: Success (old timestamps cleaned up)

- [ ] **Task 13: Email Template Tests**
  - [ ] Test vendor-inquiry template renders correctly
  - [ ] Test with all optional fields filled
  - [ ] Test with only message (no budget/timeline)
  - [ ] Visual inspection: Professional, clear, actionable

- [ ] **Task 14: API Contract Tests** (AC: 3, 4, 6)
  - [ ] Test POST /v1/vendor/:vendorId/contact as authenticated user (200)
  - [ ] Test as unauthenticated user (401)
  - [ ] Test with invalid vendorId (404)
  - [ ] Test rate limiting: 3 contacts succeed, 4th fails with 429
  - [ ] Verify VendorContact record created with correct type
  - [ ] Verify email sent (mock email service)

- [ ] **Task 15: Frontend Component Tests**
  - [ ] Test ContactVendorForm: Renders fields, validates message
  - [ ] Test form submission: Success toast, error handling
  - [ ] Test rate limit handling: 429 error shows appropriate message
  - [ ] Test Contact button: Opens modal with correct vendor

## Dev Notes

### Project Context
Story 13.6 provides Free tier users with a simple contact form to express interest in vendors without requiring a Premium subscription. This complements the RFP system (Premium feature) by offering basic vendor engagement for all users, generating Basic leads for admin tracking (Story 13.3).

**Dependencies:**
- Existing VendorContact model (already in database)
- Email service (email.service.ts with Postmark)

[Source: docs/prd/epic-13-rfp-vendor-engagement.md#Story 13.6]

### Tech Stack
- **Backend**: Fastify 4 + TypeScript | Prisma 6 | Postmark (email)
- **Frontend**: React 18 + TypeScript | React Hook Form + Zod | Radix UI Dialog

[Source: CLAUDE.md#Tech Stack]

### VendorContact Model (Existing)

**No Schema Changes Needed:**
VendorContact model already supports all required fields for contact form.

```prisma
model VendorContact {
  id             String @id @default(cuid())
  vendorId       String
  userId         String
  organizationId String

  // Contact details
  type         ContactType      // Use GENERAL_INQUIRY (not RFP)
  message      String?
  requirements Json?
  budget       String?
  timeline     String?

  // Status
  status         ContactStatus @default(PENDING)
  vendorResponse String?
  respondedAt    DateTime?

  createdAt DateTime @default(now())

  // Relations
  vendor       Vendor       @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([vendorId])
  @@index([userId])
  @@index([organizationId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}
```

**ContactType Values:**
- GENERAL_INQUIRY (use for basic contact form)
- DEMO_REQUEST
- PRICING_INQUIRY
- RFP (from Story 13.2)

**ContactStatus Values:**
- PENDING (default - vendor hasn't responded)
- RESPONDED (vendor has replied)
- CLOSED (engagement closed)

[Source: backend/prisma/schema.prisma:907-938]

### Contact API Endpoint

**Route:** `POST /v1/vendor/:vendorId/contact`

**Location:** Add to `backend/src/routes/vendor.routes.ts`

**Middleware:**
- Authentication required (JWT)
- NO Premium tier check (available to all authenticated users)
- Rate limiting (custom middleware)

**Request:**
```typescript
{
  message: string,     // Required, max 500 chars
  budget?: string,     // Optional
  timeline?: string    // Optional
}
```

**Response:**
```typescript
{
  success: true,
  data: {
    id: string,
    vendorId: string,
    userId: string,
    organizationId: string,
    type: 'GENERAL_INQUIRY',
    message: string,
    budget?: string,
    timeline?: string,
    status: 'PENDING',
    createdAt: DateTime
  },
  message: 'Your inquiry has been sent to {vendorName}'
}
```

**Implementation:**
```typescript
fastify.post(
  '/v1/vendor/:vendorId/contact',
  {
    preHandler: [authenticationMiddleware, rateLimitContactsMiddleware]
  },
  asyncHandler(async (request, reply) => {
    const { vendorId } = request.params;
    const { message, budget, timeline } = request.body;
    const userId = request.user.id;

    // Validate vendor exists
    const vendor = await prisma.vendor.findUnique({ where: { id: vendorId } });
    if (!vendor) {
      return reply.code(404).send({ success: false, message: 'Vendor not found' });
    }

    // Get user's organization
    const user = await prisma.user.findUnique({
      where: { id: userId },
      include: { organization: true }
    });

    // Create VendorContact
    const contact = await prisma.vendorContact.create({
      data: {
        vendorId,
        userId,
        organizationId: user.organization.id,
        type: 'GENERAL_INQUIRY',
        message,
        budget,
        timeline,
        status: 'PENDING'
      }
    });

    // Send email to vendor (non-blocking)
    if (vendor.contactEmail) {
      await emailService.sendVendorInquiry(
        vendor.contactEmail,
        vendor.companyName,
        user.organization.name,
        user.name,
        user.email,
        message,
        budget,
        timeline
      ).catch(err => logger.error('Failed to send vendor inquiry email', err));
    }

    return reply.send({
      success: true,
      data: contact,
      message: `Your inquiry has been sent to ${vendor.companyName}`
    });
  })
);
```

[Source: Fastify route patterns from backend/src/routes/vendor.routes.ts]

### Rate Limiting Implementation

**In-Memory Rate Limiter:**
```typescript
// backend/src/middleware/rate-limit-contacts.middleware.ts
const contactAttempts = new Map<string, number[]>();

export function rateLimitContactsMiddleware(
  request: FastifyRequest,
  reply: FastifyReply
) {
  const userId = request.user?.id;
  if (!userId) {
    return reply.code(401).send({ success: false, message: 'Authentication required' });
  }

  const now = Date.now();
  const oneDayAgo = now - (24 * 60 * 60 * 1000);

  // Get user's recent contacts
  let attempts = contactAttempts.get(userId) || [];

  // Filter to last 24 hours
  attempts = attempts.filter(timestamp => timestamp > oneDayAgo);

  if (attempts.length >= 3) {
    return reply.code(429).send({
      success: false,
      message: "You've reached the daily limit of 3 vendor contacts. Please try again tomorrow.",
      code: 'RATE_LIMIT_EXCEEDED'
    });
  }

  // Record this attempt
  attempts.push(now);
  contactAttempts.set(userId, attempts);
}
```

**Alternative: Redis-Based Rate Limiting (More Scalable):**
```typescript
import { Redis } from 'ioredis';

const redis = new Redis(process.env.REDIS_URL);

export async function rateLimitContactsMiddleware(
  request: FastifyRequest,
  reply: FastifyReply
) {
  const userId = request.user?.id;
  const key = `rate_limit:contacts:${userId}`;

  const count = await redis.incr(key);

  if (count === 1) {
    // Set expiry on first contact
    await redis.expire(key, 24 * 60 * 60); // 24 hours
  }

  if (count > 3) {
    return reply.code(429).send({
      success: false,
      message: "You've reached the daily limit of 3 vendor contacts. Please try again tomorrow."
    });
  }
}
```

[Source: Rate limiting patterns, Redis documentation]

### Vendor Inquiry Email Template

**Template Files:**
- `backend/src/templates/vendor-inquiry.html`
- `backend/src/templates/vendor-inquiry.text`

**HTML Template Structure:**
```html
<!DOCTYPE html>
<html>
<head>
  <style>
    /* Professional email styles */
  </style>
</head>
<body>
  <h1>New Inquiry from {{companyName}}</h1>

  <p>Dear {{vendorName}} Team,</p>

  <p>You've received a new inquiry through the Heliolus Platform from <strong>{{companyName}}</strong>.</p>

  <h2>Contact Information</h2>
  <ul>
    <li><strong>Name:</strong> {{userName}}</li>
    <li><strong>Email:</strong> {{userEmail}}</li>
    <li><strong>Company:</strong> {{companyName}}</li>
  </ul>

  <h2>Message</h2>
  <p>{{message}}</p>

  <h2>Project Details</h2>
  <ul>
    {{#if budget}}
    <li><strong>Budget Range:</strong> {{budget}}</li>
    {{/if}}
    {{#if timeline}}
    <li><strong>Timeline:</strong> {{timeline}}</li>
    {{/if}}
  </ul>

  <p>
    <a href="mailto:{{userEmail}}" style="...">Reply to {{userName}}</a>
  </p>

  <hr>
  <p style="font-size: 12px; color: #666;">
    This inquiry was sent via Heliolus Platform. If you wish to unsubscribe from vendor inquiries, please contact support.
  </p>
</body>
</html>
```

**Text Template:**
```
New Inquiry from {{companyName}}

Dear {{vendorName}} Team,

You've received a new inquiry through the Heliolus Platform from {{companyName}}.

Contact Information:
- Name: {{userName}}
- Email: {{userEmail}}
- Company: {{companyName}}

Message:
{{message}}

Project Details:
{{#if budget}}- Budget Range: {{budget}}{{/if}}
{{#if timeline}}- Timeline: {{timeline}}{{/if}}

To respond, please reply directly to: {{userEmail}}

---
This inquiry was sent via Heliolus Platform.
```

[Source: Email template patterns from backend/src/templates/]

### Email Service Method

**Add to email.service.ts:**
```typescript
async sendVendorInquiry(
  vendorEmail: string,
  vendorName: string,
  userCompany: string,
  userName: string,
  userEmail: string,
  message: string,
  budget?: string,
  timeline?: string
): Promise<void> {
  const htmlTemplate = this.loadTemplate('vendor-inquiry', 'html');
  const textTemplate = this.loadTemplate('vendor-inquiry', 'text');

  const data = {
    vendorName,
    companyName: userCompany,
    userName,
    userEmail,
    message,
    budget: budget || 'Not specified',
    timeline: timeline || 'Flexible'
  };

  const htmlBody = this.renderTemplate(htmlTemplate, data);
  const textBody = this.renderTemplate(textTemplate, data);

  await this.sendEmailWithRetry(
    vendorEmail,
    `New inquiry from ${userCompany}`,
    htmlBody,
    textBody
  );
}
```

[Source: Email service patterns from backend/src/services/email.service.ts]

### Frontend Contact Form Component

**Component Structure:**
```tsx
function ContactVendorForm({ vendorId, vendorName, onSuccess }: Props) {
  const { user, organization } = useAuth();
  const { mutate: contactVendor, isLoading } = useContactVendor(vendorId);

  const form = useForm({
    resolver: zodResolver(contactVendorSchema),
    defaultValues: {
      userName: user.name,
      userEmail: user.email,
      companyName: organization.name,
      message: '',
      budget: '',
      timeline: ''
    }
  });

  const handleSubmit = (data) => {
    contactVendor({
      message: data.message,
      budget: data.budget || undefined,
      timeline: data.timeline || undefined
    }, {
      onSuccess: () => {
        toast.success(`Your inquiry has been sent to ${vendorName}`);
        onSuccess();
      },
      onError: (error) => {
        if (error.response?.status === 429) {
          toast.error("Daily contact limit reached. You can contact 3 vendors per day.");
        } else {
          toast.error("Failed to send inquiry. Please try again.");
        }
      }
    });
  };

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(handleSubmit)}>
        <FormField name="userName" label="Your Name" readOnly />
        <FormField name="userEmail" label="Your Email" readOnly />
        <FormField name="companyName" label="Company" readOnly />

        <FormField
          name="message"
          label="Message"
          as="textarea"
          required
          maxLength={500}
          placeholder="Tell the vendor about your needs..."
          helperText={`${form.watch('message').length}/500 characters`}
        />

        <FormField
          name="budget"
          label="Budget Range (optional)"
          as="select"
          options={[
            { value: '', label: 'Not specified' },
            { value: '< €50K', label: '< €50K' },
            { value: '€50K - €100K', label: '€50K - €100K' },
            { value: '€100K - €500K', label: '€100K - €500K' },
            { value: '€500K - €1M', label: '€500K - €1M' },
            { value: '> €1M', label: '> €1M' }
          ]}
        />

        <FormField
          name="timeline"
          label="Timeline (optional)"
          as="select"
          options={[
            { value: '', label: 'Flexible' },
            { value: '< 3 months', label: '< 3 months' },
            { value: '3-6 months', label: '3-6 months' },
            { value: '6-12 months', label: '6-12 months' },
            { value: '> 12 months', label: '> 12 months' }
          ]}
        />

        <Button type="submit" disabled={isLoading || !form.formState.isValid}>
          {isLoading ? 'Sending...' : 'Send Inquiry'}
        </Button>
      </form>
    </Form>
  );
}
```

[Source: React Hook Form + Radix UI patterns]

### Contact Button Placement

**Locations:**
1. **Vendor Profile Page:** "Contact Vendor" button next to vendor description
2. **Vendor Results List:** "Contact" button on each vendor card
3. **Vendor Match Details:** "Contact Vendor" button below solution details

**Conditional Display:**
- **Free users:** Show only "Contact Vendor" button
- **Premium users:** Show both "Contact Vendor" (basic) and "Create RFP" (premium) buttons

```tsx
function VendorActions({ vendor }: Props) {
  const { tier } = useAuth();

  return (
    <div className="flex gap-2">
      <Button onClick={openContactForm}>
        Contact Vendor
      </Button>

      {tier === 'PREMIUM' && (
        <Button variant="primary" onClick={openRFPForm}>
          Create RFP
        </Button>
      )}
    </div>
  );
}
```

[Source: Frontend component patterns]

### Rate Limit UI Handling

**Display Remaining Contacts (Optional Enhancement):**
```tsx
function ContactVendorButton({ vendorId }: Props) {
  const { data: rateLimit } = useRateLimitStatus(); // Optional API call

  if (rateLimit?.remaining === 0) {
    return (
      <Tooltip content="Daily contact limit reached. Try again tomorrow.">
        <Button disabled>Contact Vendor</Button>
      </Tooltip>
    );
  }

  return (
    <Button onClick={openContactForm}>
      Contact Vendor
      {rateLimit && <Badge>{rateLimit.remaining} left today</Badge>}
    </Button>
  );
}
```

**429 Error Handling:**
```typescript
const { mutate: contactVendor } = useMutation({
  mutationFn: (data) => api.post(`/v1/vendor/${vendorId}/contact`, data),
  onError: (error) => {
    if (error.response?.status === 429) {
      toast.error("Daily limit reached. You can contact 3 vendors per day.", {
        duration: 5000
      });
      // Disable contact button globally for this user until tomorrow
      setContactsDisabled(true);
    }
  }
});
```

[Source: TanStack Query error handling patterns]

### File Locations

**Backend:**
- New route: `backend/src/routes/vendor.routes.ts` (add POST /:vendorId/contact)
- New middleware: `backend/src/middleware/rate-limit-contacts.middleware.ts`
- New templates: `backend/src/templates/vendor-inquiry.html`, `vendor-inquiry.text`
- Extend service: `backend/src/services/email.service.ts` (add sendVendorInquiry method)

**Frontend:**
- New component: `frontend/src/components/vendor/ContactVendorForm.tsx`
- New component: `frontend/src/components/vendor/ContactVendorModal.tsx`
- New hook: `frontend/src/hooks/useContactVendor.ts`
- Update components: Add "Contact Vendor" buttons to vendor pages

[Source: CLAUDE.md#Project Structure]

### Testing

#### Backend Testing

**Service Tests:**
- File: `backend/tests/routes/vendor.routes.test.ts`
- Test POST /v1/vendor/:vendorId/contact:
  - Valid request creates VendorContact
  - Missing message: 400 validation error
  - Invalid vendorId: 404 not found
  - Rate limit: 4th contact returns 429

**Rate Limit Tests:**
- File: `backend/tests/middleware/rate-limit-contacts.test.ts`
- Test 1st, 2nd, 3rd contacts: Success
- Test 4th contact within 24h: 429
- Test 4th contact after 24h: Success

**Email Template Tests:**
- Test vendor-inquiry template renders correctly
- Test with all fields filled
- Test with only required fields

**Run Commands:**
- `npm run test` (from backend/)
- `npm run test:contract` (from backend/)

[Source: CLAUDE.md#Testing]

#### Frontend Testing

**Component Tests:**
- Test ContactVendorForm: Renders fields, validates message
- Test form submission: Success, error handling
- Test rate limit handling: 429 shows appropriate message
- Test Contact button: Opens modal, passes vendorId

[Source: CLAUDE.md#Testing patterns]

## Codebase Review Findings

**Review Date**: 2025-10-27
**Review Document**: `.ai/epic-13-codebase-review.md`

### 🚨 CRITICAL CONFLICT IDENTIFIED 🚨

**Existing Route: POST /v1/vendor/:id/contact ALREADY EXISTS**

**Location**: `backend/src/routes/vendor.routes.ts:518-684`

**Current Behavior**:
```typescript
// Line 518: POST '/:id/contact'
// Line 594-684: Implementation
// Line 614-621: Returns 402 for non-premium users
if (result.message?.includes('subscription') || result.message?.includes('premium')) {
  reply.status(402).send({
    message: result.message || 'Premium subscription required to contact vendors',
    code: 'SUBSCRIPTION_REQUIRED',
    statusCode: 402,
  });
}
```

**Story Requirement**: Contact endpoint should be available to **ALL authenticated users** (Free + Premium)

### Conflict Resolution Required

**The Problem**:
1. Current implementation returns 402 (Payment Required) for non-premium users
2. Story 13.6 requires this feature for FREE tier users
3. Cannot implement Story 13.6 without modifying existing endpoint

**Resolution Options**:

**Option A (RECOMMENDED)**: Remove Premium check, add rate limiting
```typescript
// Modify vendor.routes.ts line 518 implementation:
// 1. Remove Premium subscription check (lines 614-621)
// 2. Add rate-limit-contacts middleware to preHandler
// 3. Keep existing VendorContact creation logic
// 4. Ensure email notification is triggered
```

**Option B**: Create separate endpoint for Free users
- POST /v1/vendor/:id/contact-free (Free tier)
- POST /v1/vendor/:id/contact (Premium tier only)
- **Cons**: Confusing dual endpoints, code duplication

**Decision**: Use Option A - Modify existing endpoint

### Required Modifications to Existing Endpoint

**File**: `backend/src/routes/vendor.routes.ts`

**Modification 1: Remove Premium Check** (Lines 614-621)
```typescript
// DELETE or comment out:
if (result.message?.includes('subscription') || result.message?.includes('premium')) {
  reply.status(402).send({ ... });
  return;
}
```

**Modification 2: Add Rate Limiting Middleware**
```typescript
// Line 593: Modify preHandler
preHandler: [authenticationMiddleware, rateLimitContactsMiddleware]  // ADD rate limiting
```

**Modification 3: Ensure Email Notification**
- Verify email.service.ts sends vendor inquiry email
- May need to add sendVendorInquiry() method (Task 4)

### New Components Still Required

✅ **Middleware**:
- rate-limit-contacts.middleware.ts does NOT exist - must create (Task 2)

✅ **Email Service**:
- email.service.ts EXISTS ✅
- **MUST ADD**: sendVendorInquiry() method (Task 4)
- **MUST CREATE**: Email templates (Task 3):
  - `backend/src/templates/vendor-inquiry.html` (does NOT exist)
  - `backend/src/templates/vendor-inquiry.text` (does NOT exist)

✅ **Database**:
- VendorContact model EXISTS ✅
- All required fields exist (message, budget, timeline, type, status) ✅
- ContactType enum has GENERAL value ✅ (use instead of RFP)

### Rate Limiting Implementation

**In-Memory Option** (simpler, good for single server):
```typescript
const contactAttempts = new Map<string, number[]>();
// Max 3 contacts per user per 24 hours
```

**Redis Option** (recommended, scales):
```typescript
const redis = new Redis(process.env.REDIS_URL);
// Use INCR with 24-hour expiry
```

**Redis is ALREADY AVAILABLE** in the project ✅

### Existing Route Analysis

**vendor.routes.ts POST '/:id/contact'** (Line 518):
- ✅ Requires authentication
- ✅ Creates VendorContact record
- ✅ Has request validation (ContactVendorRequestSchema)
- ❌ Has Premium subscription check (MUST REMOVE)
- ❌ No rate limiting (MUST ADD)
- ⚠️ Email notification unclear (MUST VERIFY/ADD)

**ContactType Values** (Line 30):
```typescript
ContactTypeSchema = z.enum(['DEMO_REQUEST', 'INFO_REQUEST', 'RFP', 'PRICING', 'GENERAL']);
```
**Use**: 'GENERAL' for basic contact form (not 'RFP')

### Implementation Priority

**Story 13.6 Order**:
1. Create rate-limit-contacts.middleware.ts (Task 2)
2. Create vendor inquiry email templates (Task 3)
3. Add sendVendorInquiry() to email.service.ts (Task 4)
4. **MODIFY** existing POST /v1/vendor/:id/contact route:
   - Remove Premium check
   - Add rate limiting middleware
   - Ensure email notification

**Estimated Effort**: 4-5 hours

### Backward Compatibility Concerns

**Breaking Change**: Removing Premium check from vendor contact endpoint

**Impact Analysis**:
- **Users**: Free users can now contact vendors (GOOD - intended behavior)
- **Vendors**: May receive more inquiries (neutral - legitimate use case)
- **Revenue**: May reduce conversion to Premium (RISK - mitigated by rate limiting + upgrade prompts)

**Mitigation**:
- Rate limiting (3 contacts/day) encourages Premium upgrade for unlimited contacts
- Frontend shows upgrade prompts for Free users
- Premium users still get RFP system (major differentiator)

### Task Updates Required

**Task 1 (Contact Vendor API Endpoint)**: ⚠️ **MODIFIED**
- Change from "Create route" to "Modify existing route"
- Remove Premium tier check
- Add rate limiting middleware
- Ensure email notification

**All other tasks remain the same**

### Notes for Dev Agent

- **CRITICAL**: Test existing vendor contact functionality after modifications
- **DO NOT** break existing vendor contact behavior
- **VERIFY**: VendorContact records are still created correctly
- **VERIFY**: Email notifications work for both Premium and Free users
- **TEST**: Rate limiting works correctly (3 contacts per day)
- **REVIEW**: Check if any other code depends on 402 error from contact endpoint

## Architectural Decisions & Issue Resolutions

**Decision Document**: `.ai/epic-13-architectural-decisions.md`
**Review Date**: 2025-10-27

### Critical Issues with Existing Vendor Contact Endpoint

#### 1. Missing Email Notification (CRITICAL)

**Problem**: Existing `vendor.service.ts:738-789` contactVendor() method creates VendorContact record but **NEVER sends email to vendor**.

**Location**: `backend/src/services/vendor.service.ts:738-789`

**Current Code Analysis**:
```typescript
// Lines 738-789: contactVendor method
const contact = await this.prisma.vendorContact.create({ ... });  // Line 738
await this.prisma.vendorMatch.updateMany({ ... });                // Line 752
await this.logAudit({ ... });                                     // Line 772
return this.createResponse(...);                                   // Line 789
// NO EMAIL SENT!
```

**Solution**: Add email notification before returning:

```typescript
// backend/src/services/vendor.service.ts
// UPDATE contactVendor() method (lines 738-789)
async contactVendor(userId: string, validatedData: ContactVendorRequest) {
  // ... existing validation and contact creation ...

  const contact = await this.prisma.vendorContact.create({
    data: { /* ... existing data ... */ }
  });

  await this.prisma.vendorMatch.updateMany({ /* ... existing logic ... */ });

  // **ADD EMAIL NOTIFICATION HERE** (NEW)
  const vendor = await this.prisma.vendor.findUnique({
    where: { id: validatedData.vendorId }
  });

  const user = await this.prisma.user.findUnique({
    where: { id: userId },
    include: { organization: true }
  });

  if (vendor?.contactEmail && user) {
    try {
      await this.emailService.sendVendorInquiry(
        vendor.contactEmail,
        vendor.companyName,
        {
          userName: `${user.firstName} ${user.lastName}`,
          userEmail: user.email,
          companyName: user.organization?.name || 'Unknown',
          message: validatedData.message,
          budget: validatedData.budget,
          timeline: validatedData.timeline,
          type: validatedData.type
        }
      );
    } catch (emailError) {
      // Log but don't fail the contact creation
      console.error('Failed to send vendor inquiry email:', emailError);
    }
  }

  await this.logAudit({ /* ... existing audit log ... */ });

  return this.createResponse(
    this.formatContactResponse(contact),
    'Vendor contacted successfully'
  );
}
```

**Task Update**: Add "Fix existing contactVendor() to send email" as **FIRST subtask** of Task 4 (Email Service Extension).

#### 2. Redis-Based Rate Limiting (HIGH)

**Problem**: In-memory Map for rate limiting won't work across multiple servers and loses data on restart.

**Solution**: Use Redis-based rate limiting (Redis already available in project):

```typescript
// backend/src/middleware/rate-limit-contacts.middleware.ts
import { FastifyRequest, FastifyReply } from 'fastify';
import { Redis } from 'ioredis';

const CONTACT_LIMIT = 3;
const WINDOW_MS = 24 * 60 * 60 * 1000; // 24 hours

export async function rateLimitContactsMiddleware(
  request: FastifyRequest,
  reply: FastifyReply
) {
  const userId = request.user.id;
  const redis = (request.server as any).redis; // Get from server decorator

  const key = `rate-limit:contact:${userId}`;

  // Get current count
  const current = await redis.get(key);
  const count = current ? parseInt(current, 10) : 0;

  if (count >= CONTACT_LIMIT) {
    // Check time remaining
    const ttl = await redis.ttl(key);
    const resetIn = ttl > 0 ? Math.ceil(ttl / 3600) : 0;

    return reply.code(429).send({
      success: false,
      message: `You've reached the daily limit of ${CONTACT_LIMIT} vendor contacts. Resets in ${resetIn} hours.`,
      code: 'RATE_LIMIT_EXCEEDED',
      retryAfter: resetIn * 3600,
      data: {
        limit: CONTACT_LIMIT,
        remaining: 0,
        resetIn: resetIn * 3600
      }
    });
  }

  // Increment counter
  const newCount = await redis.incr(key);

  // Set expiry on first request
  if (newCount === 1) {
    await redis.expire(key, Math.floor(WINDOW_MS / 1000));
  }

  // Add rate limit headers
  reply.header('X-RateLimit-Limit', CONTACT_LIMIT);
  reply.header('X-RateLimit-Remaining', Math.max(0, CONTACT_LIMIT - newCount));
  reply.header('X-RateLimit-Reset', Math.floor(Date.now() / 1000) + await redis.ttl(key));
}
```

**Server Setup** (if not already configured):
```typescript
// backend/src/server.ts (add after line 100)
import Redis from 'ioredis';

const redis = new Redis(process.env.REDIS_URL || 'redis://localhost:6379');

// Decorate server with redis client
server.decorate('redis', redis);
```

**Update Task 2**: Use Redis-based implementation (not in-memory Map).

#### 3. Premium User Exemption from Rate Limiting (MEDIUM)

**Problem**: Rate limiting should only apply to Free users, not Premium users.

**Solution**: Check subscription tier before applying rate limit:

```typescript
// backend/src/routes/vendor.routes.ts
// MODIFY existing POST /:id/contact endpoint (line 518)
server.post<{ Params: { id: string }; Body: ContactVendorRequest }>(
  '/:id/contact',
  {
    preHandler: [
      server.authenticate,
      requireUser,
      // REMOVE: requirePremium (this is the fix!)
      // ADD: Conditional rate limiting
      async (request: FastifyRequest, reply: FastifyReply) => {
        // Check if user is Premium
        const subscription = await server.prisma.subscription.findUnique({
          where: { userId: request.user.id }
        });

        const isPremium = subscription?.plan === 'PREMIUM' && subscription?.status === 'ACTIVE';

        // Only rate limit Free users
        if (!isPremium) {
          await rateLimitContactsMiddleware(request, reply);
        }
        // Premium users bypass rate limiting entirely
      }
    ],
    schema: { /* ... existing schema ... */ }
  },
  async (request, reply) => {
    // ... existing contactVendor logic ...
  }
);
```

**Benefits**:
- Free users: 3 contacts/day → encourages upgrade
- Premium users: Unlimited contacts → value proposition
- Rate limit removed, not Premium check → Free users can still use feature

**Update Required Modifications Section**: Add Premium user exemption logic.

#### 4. Email Template Variables (MEDIUM)

**Problem**: Vendor inquiry email needs context about inquiry.

**Solution**: Create comprehensive email template:

**Template**: `backend/src/templates/vendor-inquiry.html`
```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Vendor Inquiry from {{companyName}}</title>
</head>
<body>
  <h2>New Inquiry from {{companyName}}</h2>

  <p>You have received a new inquiry through the platform.</p>

  <h3>Contact Information:</h3>
  <ul>
    <li><strong>Name:</strong> {{userName}}</li>
    <li><strong>Email:</strong> {{userEmail}}</li>
    <li><strong>Company:</strong> {{companyName}}</li>
  </ul>

  <h3>Inquiry Details:</h3>
  <p><strong>Type:</strong> {{type}}</p>
  {{#if budget}}
  <p><strong>Budget Range:</strong> {{budget}}</p>
  {{/if}}
  {{#if timeline}}
  <p><strong>Timeline:</strong> {{timeline}}</p>
  {{/if}}

  <h3>Message:</h3>
  <p>{{message}}</p>

  <hr>
  <p><small>This inquiry was sent through the compliance assessment platform.</small></p>
</body>
</html>
```

**Email Service Method**:
```typescript
// backend/src/services/email.service.ts
async sendVendorInquiry(
  vendorEmail: string,
  vendorName: string,
  inquiryData: {
    userName: string;
    userEmail: string;
    companyName: string;
    message: string;
    budget?: string;
    timeline?: string;
    type: string;
  }
) {
  const templateData = {
    vendorName,
    ...inquiryData
  };

  return this.sendEmailWithRetry(() =>
    this.postmark.sendEmail({
      From: process.env.EMAIL_FROM || 'noreply@heliolus.com',
      To: vendorEmail,
      Subject: `New Inquiry from ${inquiryData.companyName}`,
      HtmlBody: this.renderTemplate('vendor-inquiry.html', templateData),
      TextBody: this.renderTemplate('vendor-inquiry.text', templateData),
      ReplyTo: inquiryData.userEmail,  // Allow vendor to reply directly
      Tag: 'vendor-inquiry'
    })
  );
}
```

**Update Task 3**: Use template variables above.
**Update Task 4**: Add sendVendorInquiry() method with ReplyTo support.

### Implementation Priority Order

**Task 4 (Email Service) - CRITICAL UPDATE**:
1. **FIRST**: Fix existing contactVendor() in vendor.service.ts to send email
2. Add sendVendorInquiry() method to email.service.ts
3. Create email templates with proper variables
4. Test email delivery for both Premium and Free users

**Task 2 (Rate Limiting Middleware) - UPDATED**:
1. Use Redis (not in-memory Map)
2. Add Premium user exemption logic
3. Return detailed rate limit info in 429 response
4. Add rate limit headers to all responses

**Existing Route Modification (vendor.routes.ts) - UPDATED**:
1. Remove Premium subscription check (lines 614-621)
2. Add conditional rate limiting (Free users only)
3. Keep existing validation and VendorContact creation
4. Verify email notification is triggered (after Task 4)

### Testing Requirements

**Critical Tests to Add**:
1. **Email Notification Test**: Verify contactVendor() sends email
2. **Premium Exemption Test**: Premium users bypass rate limit
3. **Free User Rate Limit Test**: Free users hit 429 on 4th contact
4. **Redis Persistence Test**: Rate limit counter survives server restart

**Backward Compatibility Tests**:
1. Existing Premium users can still contact vendors
2. VendorContact records created correctly
3. Audit logging still works
4. No regression in vendor matching logic

### References

- Architectural Decisions: `.ai/epic-13-architectural-decisions.md` (Section 8)
- Deep Analysis: `.ai/epic-13-deep-analysis-issues.md` (Issue #10)
- Existing Vendor Service: `backend/src/services/vendor.service.ts:738-789`
- Existing Vendor Route: `backend/src/routes/vendor.routes.ts:518-684`
- Redis Setup: `backend/docker-compose.yml` (Redis already configured)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-27 | 1.0 | Initial story creation for Epic 13: RFP System | Bob (Scrum Master) |
| 2025-10-27 | 1.1 | **CRITICAL**: Identified conflict with existing vendor contact endpoint - requires modification | Claude (Dev Agent) |
| 2025-10-27 | 1.2 | Added architectural decisions - email notification fix, Redis rate limiting, Premium exemption | Claude (Dev Agent) |

## Dev Agent Record

### Agent Model Used
(To be populated by dev agent)

### Debug Log References
(To be populated by dev agent)

### Completion Notes List
(To be populated by dev agent)

### File List
(To be populated by dev agent)

## QA Results
(To be populated by QA agent)
