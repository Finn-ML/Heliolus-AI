# Story 13.6: Contact Form System (Basic Lead)

## Status
Draft

## Story

**As a** Free tier user
**I want** to submit a simple contact form to vendors
**So that** I can express interest without Premium subscription

## Acceptance Criteria

1. Contact form includes:
   - User name, email (auto-populated from User)
   - Company name (auto-populated from Organization)
   - Message (required, 500 char max)
   - Budget range (optional dropdown: <50K, 50K-100K, 100K-500K, 500K+)
   - Timeline (optional dropdown: <3mo, 3-6mo, 6-12mo, 12mo+)
   - Single vendor selection (not multi-select)
2. Form validation: Message required
3. API: `POST /v1/vendor/:vendorId/contact` creates VendorContact record
   - Sets `type: GENERAL_INQUIRY` (not RFP)
4. Vendor email notification:
   - Subject: "New inquiry from [Company Name]"
   - Body: Message, budget, timeline, user contact info
   - CTA: "Reply to [user email]"
5. Success message: "Your inquiry has been sent to [Vendor Name]"
6. Rate limiting: Max 3 contacts per user per day (prevent spam)

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Contact Vendor API Endpoint** (AC: 3)
  - [ ] Create route: `POST /v1/vendor/:vendorId/contact` in vendor.routes.ts
  - [ ] Require authentication (JWT)
  - [ ] NO Premium tier check (available to Free users)
  - [ ] Request body validation with Zod:
    ```typescript
    {
      message: string,       // Required, max 500 chars
      budget?: string,       // Optional
      timeline?: string      // Optional
    }
    ```
  - [ ] Fetch vendor by vendorId (validate exists)
  - [ ] Create VendorContact record:
    - vendorId: From URL parameter
    - userId: From authenticated user
    - organizationId: From user's organization
    - type: GENERAL_INQUIRY (not RFP)
    - message: From request body
    - budget: From request body
    - timeline: From request body
    - status: PENDING
  - [ ] Return VendorContact object

- [ ] **Task 2: Rate Limiting** (AC: 6)
  - [ ] Implement rate limiting: Max 3 contacts per user per day
  - [ ] Use in-memory Map: `{ userId: [timestamp1, timestamp2, timestamp3] }`
  - [ ] Filter timestamps: Only count contacts in last 24 hours
  - [ ] If limit exceeded: Return 429 Too Many Requests
    - Error message: "You've reached the daily limit of 3 vendor contacts. Please try again tomorrow."
  - [ ] Alternative: Use Redis if available for distributed rate limiting

- [ ] **Task 3: Vendor Inquiry Email Template** (AC: 4)
  - [ ] Create `backend/src/templates/vendor-inquiry.html`
  - [ ] Create `backend/src/templates/vendor-inquiry.text`
  - [ ] Template variables:
    - `{{companyName}}` - User's company
    - `{{userName}}` - User's name
    - `{{userEmail}}` - User's email
    - `{{message}}` - User's message
    - `{{budget}}` - Budget range (if provided)
    - `{{timeline}}` - Timeline (if provided)
  - [ ] Email structure:
    - Subject: "New inquiry from {{companyName}}"
    - Greeting: "Dear {{vendorName}} Team,"
    - Body: "You've received a new inquiry from {{companyName}}."
    - Message section with user's message
    - Budget and timeline (if provided)
    - CTA: "Reply directly to {{userEmail}}"
    - Footer with unsubscribe link

- [ ] **Task 4: Send Vendor Inquiry Email** (AC: 4)
  - [ ] Extend email.service.ts with `sendVendorInquiry` method
  - [ ] Parameters: vendorEmail, vendorName, userCompany, userName, userEmail, message, budget, timeline
  - [ ] Load vendor-inquiry template (HTML + text)
  - [ ] Render template with data
  - [ ] Send via Postmark using existing sendEmailWithRetry
  - [ ] Subject: "New inquiry from {companyName}"

- [ ] **Task 5: Integrate Email Sending into Contact API** (AC: 4)
  - [ ] After creating VendorContact record, send email
  - [ ] Handle email failure gracefully (log error, don't fail API call)
  - [ ] If vendor has no contactEmail: Skip email, log warning

### Frontend Tasks

- [ ] **Task 6: Contact Vendor Form Component** (AC: 1, 2)
  - [ ] Create `frontend/src/components/vendor/ContactVendorForm.tsx`
  - [ ] Can be modal or dedicated page
  - [ ] Form fields:
    - **User Name**: Auto-populated, read-only (from useAuth)
    - **User Email**: Auto-populated, read-only
    - **Company Name**: Auto-populated, read-only
    - **Message**: Textarea, required, 500 char max, character counter
    - **Budget Range**: Select dropdown (optional)
      - Options: "< €50K", "€50K - €100K", "€100K - €500K", "€500K - €1M", "> €1M", "Not specified"
    - **Timeline**: Select dropdown (optional)
      - Options: "< 3 months", "3-6 months", "6-12 months", "> 12 months", "Flexible"
  - [ ] Form validation with React Hook Form + Zod
  - [ ] Submit button disabled until message is entered

- [ ] **Task 7: Form Submission** (AC: 3, 5)
  - [ ] On submit: Call `POST /v1/vendor/:vendorId/contact`
  - [ ] Loading state: Disable form, show spinner on button
  - [ ] Success:
    - Close form/modal
    - Show success toast: "Your inquiry has been sent to {vendorName}"
    - Optional: Redirect to vendor profile or dashboard
  - [ ] Error:
    - 429 (rate limit): Show error toast with daily limit message
    - 404 (vendor not found): Show error toast "Vendor not found"
    - Other errors: Show generic error toast

- [ ] **Task 8: Contact Button Integration** (AC: 1)
  - [ ] Add "Contact Vendor" button on vendor profile pages
  - [ ] Add "Contact" button in vendor results list
  - [ ] On click: Open ContactVendorForm modal with vendorId
  - [ ] For Premium users: Also show "Create RFP" button (from Story 13.1)
  - [ ] For Free users: Only show "Contact Vendor" button

- [ ] **Task 9: Contact Form Modal** (AC: 1)
  - [ ] Use Radix UI Dialog for modal
  - [ ] Modal header: "Contact {vendorName}"
  - [ ] Modal body: ContactVendorForm
  - [ ] Modal footer: Cancel button, Submit button
  - [ ] Close button (X) in top right

- [ ] **Task 10: API Hook** (AC: 3)
  - [ ] Create `frontend/src/hooks/useContactVendor.ts`
  - [ ] Mutation hook: `useContactVendor(vendorId)`
  - [ ] Call `POST /v1/vendor/:vendorId/contact`
  - [ ] Handle success/error states

- [ ] **Task 11: Rate Limit UI Handling** (AC: 6)
  - [ ] On 429 response:
    - Show toast: "Daily contact limit reached. You can contact 3 vendors per day. Please try again tomorrow."
    - Disable "Contact Vendor" button with tooltip showing limit
  - [ ] Optional: Display remaining contacts count (if backend provides it)

### Testing

- [ ] **Task 12: Backend Unit Tests** (AC: 3, 6)
  - [ ] Test vendor.routes.ts POST /v1/vendor/:vendorId/contact:
    - Valid request creates VendorContact (type: GENERAL_INQUIRY)
    - Missing message: 400 validation error
    - Invalid vendorId: 404 vendor not found
    - Rate limit: 4th contact in 24h returns 429
  - [ ] Test rate limiting logic:
    - 1st, 2nd, 3rd contacts: Success
    - 4th contact within 24h: 429
    - 4th contact after 24h: Success (old timestamps cleaned up)

- [ ] **Task 13: Email Template Tests**
  - [ ] Test vendor-inquiry template renders correctly
  - [ ] Test with all optional fields filled
  - [ ] Test with only message (no budget/timeline)
  - [ ] Visual inspection: Professional, clear, actionable

- [ ] **Task 14: API Contract Tests** (AC: 3, 4, 6)
  - [ ] Test POST /v1/vendor/:vendorId/contact as authenticated user (200)
  - [ ] Test as unauthenticated user (401)
  - [ ] Test with invalid vendorId (404)
  - [ ] Test rate limiting: 3 contacts succeed, 4th fails with 429
  - [ ] Verify VendorContact record created with correct type
  - [ ] Verify email sent (mock email service)

- [ ] **Task 15: Frontend Component Tests**
  - [ ] Test ContactVendorForm: Renders fields, validates message
  - [ ] Test form submission: Success toast, error handling
  - [ ] Test rate limit handling: 429 error shows appropriate message
  - [ ] Test Contact button: Opens modal with correct vendor

## Dev Notes

### Project Context
Story 13.6 provides Free tier users with a simple contact form to express interest in vendors without requiring a Premium subscription. This complements the RFP system (Premium feature) by offering basic vendor engagement for all users, generating Basic leads for admin tracking (Story 13.3).

**Dependencies:**
- Existing VendorContact model (already in database)
- Email service (email.service.ts with Postmark)

[Source: docs/prd/epic-13-rfp-vendor-engagement.md#Story 13.6]

### Tech Stack
- **Backend**: Fastify 4 + TypeScript | Prisma 6 | Postmark (email)
- **Frontend**: React 18 + TypeScript | React Hook Form + Zod | Radix UI Dialog

[Source: CLAUDE.md#Tech Stack]

### VendorContact Model (Existing)

**No Schema Changes Needed:**
VendorContact model already supports all required fields for contact form.

```prisma
model VendorContact {
  id             String @id @default(cuid())
  vendorId       String
  userId         String
  organizationId String

  // Contact details
  type         ContactType      // Use GENERAL_INQUIRY (not RFP)
  message      String?
  requirements Json?
  budget       String?
  timeline     String?

  // Status
  status         ContactStatus @default(PENDING)
  vendorResponse String?
  respondedAt    DateTime?

  createdAt DateTime @default(now())

  // Relations
  vendor       Vendor       @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([vendorId])
  @@index([userId])
  @@index([organizationId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}
```

**ContactType Values:**
- GENERAL_INQUIRY (use for basic contact form)
- DEMO_REQUEST
- PRICING_INQUIRY
- RFP (from Story 13.2)

**ContactStatus Values:**
- PENDING (default - vendor hasn't responded)
- RESPONDED (vendor has replied)
- CLOSED (engagement closed)

[Source: backend/prisma/schema.prisma:907-938]

### Contact API Endpoint

**Route:** `POST /v1/vendor/:vendorId/contact`

**Location:** Add to `backend/src/routes/vendor.routes.ts`

**Middleware:**
- Authentication required (JWT)
- NO Premium tier check (available to all authenticated users)
- Rate limiting (custom middleware)

**Request:**
```typescript
{
  message: string,     // Required, max 500 chars
  budget?: string,     // Optional
  timeline?: string    // Optional
}
```

**Response:**
```typescript
{
  success: true,
  data: {
    id: string,
    vendorId: string,
    userId: string,
    organizationId: string,
    type: 'GENERAL_INQUIRY',
    message: string,
    budget?: string,
    timeline?: string,
    status: 'PENDING',
    createdAt: DateTime
  },
  message: 'Your inquiry has been sent to {vendorName}'
}
```

**Implementation:**
```typescript
fastify.post(
  '/v1/vendor/:vendorId/contact',
  {
    preHandler: [authenticationMiddleware, rateLimitContactsMiddleware]
  },
  asyncHandler(async (request, reply) => {
    const { vendorId } = request.params;
    const { message, budget, timeline } = request.body;
    const userId = request.user.id;

    // Validate vendor exists
    const vendor = await prisma.vendor.findUnique({ where: { id: vendorId } });
    if (!vendor) {
      return reply.code(404).send({ success: false, message: 'Vendor not found' });
    }

    // Get user's organization
    const user = await prisma.user.findUnique({
      where: { id: userId },
      include: { organization: true }
    });

    // Create VendorContact
    const contact = await prisma.vendorContact.create({
      data: {
        vendorId,
        userId,
        organizationId: user.organization.id,
        type: 'GENERAL_INQUIRY',
        message,
        budget,
        timeline,
        status: 'PENDING'
      }
    });

    // Send email to vendor (non-blocking)
    if (vendor.contactEmail) {
      await emailService.sendVendorInquiry(
        vendor.contactEmail,
        vendor.companyName,
        user.organization.name,
        user.name,
        user.email,
        message,
        budget,
        timeline
      ).catch(err => logger.error('Failed to send vendor inquiry email', err));
    }

    return reply.send({
      success: true,
      data: contact,
      message: `Your inquiry has been sent to ${vendor.companyName}`
    });
  })
);
```

[Source: Fastify route patterns from backend/src/routes/vendor.routes.ts]

### Rate Limiting Implementation

**In-Memory Rate Limiter:**
```typescript
// backend/src/middleware/rate-limit-contacts.middleware.ts
const contactAttempts = new Map<string, number[]>();

export function rateLimitContactsMiddleware(
  request: FastifyRequest,
  reply: FastifyReply
) {
  const userId = request.user?.id;
  if (!userId) {
    return reply.code(401).send({ success: false, message: 'Authentication required' });
  }

  const now = Date.now();
  const oneDayAgo = now - (24 * 60 * 60 * 1000);

  // Get user's recent contacts
  let attempts = contactAttempts.get(userId) || [];

  // Filter to last 24 hours
  attempts = attempts.filter(timestamp => timestamp > oneDayAgo);

  if (attempts.length >= 3) {
    return reply.code(429).send({
      success: false,
      message: "You've reached the daily limit of 3 vendor contacts. Please try again tomorrow.",
      code: 'RATE_LIMIT_EXCEEDED'
    });
  }

  // Record this attempt
  attempts.push(now);
  contactAttempts.set(userId, attempts);
}
```

**Alternative: Redis-Based Rate Limiting (More Scalable):**
```typescript
import { Redis } from 'ioredis';

const redis = new Redis(process.env.REDIS_URL);

export async function rateLimitContactsMiddleware(
  request: FastifyRequest,
  reply: FastifyReply
) {
  const userId = request.user?.id;
  const key = `rate_limit:contacts:${userId}`;

  const count = await redis.incr(key);

  if (count === 1) {
    // Set expiry on first contact
    await redis.expire(key, 24 * 60 * 60); // 24 hours
  }

  if (count > 3) {
    return reply.code(429).send({
      success: false,
      message: "You've reached the daily limit of 3 vendor contacts. Please try again tomorrow."
    });
  }
}
```

[Source: Rate limiting patterns, Redis documentation]

### Vendor Inquiry Email Template

**Template Files:**
- `backend/src/templates/vendor-inquiry.html`
- `backend/src/templates/vendor-inquiry.text`

**HTML Template Structure:**
```html
<!DOCTYPE html>
<html>
<head>
  <style>
    /* Professional email styles */
  </style>
</head>
<body>
  <h1>New Inquiry from {{companyName}}</h1>

  <p>Dear {{vendorName}} Team,</p>

  <p>You've received a new inquiry through the Heliolus Platform from <strong>{{companyName}}</strong>.</p>

  <h2>Contact Information</h2>
  <ul>
    <li><strong>Name:</strong> {{userName}}</li>
    <li><strong>Email:</strong> {{userEmail}}</li>
    <li><strong>Company:</strong> {{companyName}}</li>
  </ul>

  <h2>Message</h2>
  <p>{{message}}</p>

  <h2>Project Details</h2>
  <ul>
    {{#if budget}}
    <li><strong>Budget Range:</strong> {{budget}}</li>
    {{/if}}
    {{#if timeline}}
    <li><strong>Timeline:</strong> {{timeline}}</li>
    {{/if}}
  </ul>

  <p>
    <a href="mailto:{{userEmail}}" style="...">Reply to {{userName}}</a>
  </p>

  <hr>
  <p style="font-size: 12px; color: #666;">
    This inquiry was sent via Heliolus Platform. If you wish to unsubscribe from vendor inquiries, please contact support.
  </p>
</body>
</html>
```

**Text Template:**
```
New Inquiry from {{companyName}}

Dear {{vendorName}} Team,

You've received a new inquiry through the Heliolus Platform from {{companyName}}.

Contact Information:
- Name: {{userName}}
- Email: {{userEmail}}
- Company: {{companyName}}

Message:
{{message}}

Project Details:
{{#if budget}}- Budget Range: {{budget}}{{/if}}
{{#if timeline}}- Timeline: {{timeline}}{{/if}}

To respond, please reply directly to: {{userEmail}}

---
This inquiry was sent via Heliolus Platform.
```

[Source: Email template patterns from backend/src/templates/]

### Email Service Method

**Add to email.service.ts:**
```typescript
async sendVendorInquiry(
  vendorEmail: string,
  vendorName: string,
  userCompany: string,
  userName: string,
  userEmail: string,
  message: string,
  budget?: string,
  timeline?: string
): Promise<void> {
  const htmlTemplate = this.loadTemplate('vendor-inquiry', 'html');
  const textTemplate = this.loadTemplate('vendor-inquiry', 'text');

  const data = {
    vendorName,
    companyName: userCompany,
    userName,
    userEmail,
    message,
    budget: budget || 'Not specified',
    timeline: timeline || 'Flexible'
  };

  const htmlBody = this.renderTemplate(htmlTemplate, data);
  const textBody = this.renderTemplate(textTemplate, data);

  await this.sendEmailWithRetry(
    vendorEmail,
    `New inquiry from ${userCompany}`,
    htmlBody,
    textBody
  );
}
```

[Source: Email service patterns from backend/src/services/email.service.ts]

### Frontend Contact Form Component

**Component Structure:**
```tsx
function ContactVendorForm({ vendorId, vendorName, onSuccess }: Props) {
  const { user, organization } = useAuth();
  const { mutate: contactVendor, isLoading } = useContactVendor(vendorId);

  const form = useForm({
    resolver: zodResolver(contactVendorSchema),
    defaultValues: {
      userName: user.name,
      userEmail: user.email,
      companyName: organization.name,
      message: '',
      budget: '',
      timeline: ''
    }
  });

  const handleSubmit = (data) => {
    contactVendor({
      message: data.message,
      budget: data.budget || undefined,
      timeline: data.timeline || undefined
    }, {
      onSuccess: () => {
        toast.success(`Your inquiry has been sent to ${vendorName}`);
        onSuccess();
      },
      onError: (error) => {
        if (error.response?.status === 429) {
          toast.error("Daily contact limit reached. You can contact 3 vendors per day.");
        } else {
          toast.error("Failed to send inquiry. Please try again.");
        }
      }
    });
  };

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(handleSubmit)}>
        <FormField name="userName" label="Your Name" readOnly />
        <FormField name="userEmail" label="Your Email" readOnly />
        <FormField name="companyName" label="Company" readOnly />

        <FormField
          name="message"
          label="Message"
          as="textarea"
          required
          maxLength={500}
          placeholder="Tell the vendor about your needs..."
          helperText={`${form.watch('message').length}/500 characters`}
        />

        <FormField
          name="budget"
          label="Budget Range (optional)"
          as="select"
          options={[
            { value: '', label: 'Not specified' },
            { value: '< €50K', label: '< €50K' },
            { value: '€50K - €100K', label: '€50K - €100K' },
            { value: '€100K - €500K', label: '€100K - €500K' },
            { value: '€500K - €1M', label: '€500K - €1M' },
            { value: '> €1M', label: '> €1M' }
          ]}
        />

        <FormField
          name="timeline"
          label="Timeline (optional)"
          as="select"
          options={[
            { value: '', label: 'Flexible' },
            { value: '< 3 months', label: '< 3 months' },
            { value: '3-6 months', label: '3-6 months' },
            { value: '6-12 months', label: '6-12 months' },
            { value: '> 12 months', label: '> 12 months' }
          ]}
        />

        <Button type="submit" disabled={isLoading || !form.formState.isValid}>
          {isLoading ? 'Sending...' : 'Send Inquiry'}
        </Button>
      </form>
    </Form>
  );
}
```

[Source: React Hook Form + Radix UI patterns]

### Contact Button Placement

**Locations:**
1. **Vendor Profile Page:** "Contact Vendor" button next to vendor description
2. **Vendor Results List:** "Contact" button on each vendor card
3. **Vendor Match Details:** "Contact Vendor" button below solution details

**Conditional Display:**
- **Free users:** Show only "Contact Vendor" button
- **Premium users:** Show both "Contact Vendor" (basic) and "Create RFP" (premium) buttons

```tsx
function VendorActions({ vendor }: Props) {
  const { tier } = useAuth();

  return (
    <div className="flex gap-2">
      <Button onClick={openContactForm}>
        Contact Vendor
      </Button>

      {tier === 'PREMIUM' && (
        <Button variant="primary" onClick={openRFPForm}>
          Create RFP
        </Button>
      )}
    </div>
  );
}
```

[Source: Frontend component patterns]

### Rate Limit UI Handling

**Display Remaining Contacts (Optional Enhancement):**
```tsx
function ContactVendorButton({ vendorId }: Props) {
  const { data: rateLimit } = useRateLimitStatus(); // Optional API call

  if (rateLimit?.remaining === 0) {
    return (
      <Tooltip content="Daily contact limit reached. Try again tomorrow.">
        <Button disabled>Contact Vendor</Button>
      </Tooltip>
    );
  }

  return (
    <Button onClick={openContactForm}>
      Contact Vendor
      {rateLimit && <Badge>{rateLimit.remaining} left today</Badge>}
    </Button>
  );
}
```

**429 Error Handling:**
```typescript
const { mutate: contactVendor } = useMutation({
  mutationFn: (data) => api.post(`/v1/vendor/${vendorId}/contact`, data),
  onError: (error) => {
    if (error.response?.status === 429) {
      toast.error("Daily limit reached. You can contact 3 vendors per day.", {
        duration: 5000
      });
      // Disable contact button globally for this user until tomorrow
      setContactsDisabled(true);
    }
  }
});
```

[Source: TanStack Query error handling patterns]

### File Locations

**Backend:**
- New route: `backend/src/routes/vendor.routes.ts` (add POST /:vendorId/contact)
- New middleware: `backend/src/middleware/rate-limit-contacts.middleware.ts`
- New templates: `backend/src/templates/vendor-inquiry.html`, `vendor-inquiry.text`
- Extend service: `backend/src/services/email.service.ts` (add sendVendorInquiry method)

**Frontend:**
- New component: `frontend/src/components/vendor/ContactVendorForm.tsx`
- New component: `frontend/src/components/vendor/ContactVendorModal.tsx`
- New hook: `frontend/src/hooks/useContactVendor.ts`
- Update components: Add "Contact Vendor" buttons to vendor pages

[Source: CLAUDE.md#Project Structure]

### Testing

#### Backend Testing

**Service Tests:**
- File: `backend/tests/routes/vendor.routes.test.ts`
- Test POST /v1/vendor/:vendorId/contact:
  - Valid request creates VendorContact
  - Missing message: 400 validation error
  - Invalid vendorId: 404 not found
  - Rate limit: 4th contact returns 429

**Rate Limit Tests:**
- File: `backend/tests/middleware/rate-limit-contacts.test.ts`
- Test 1st, 2nd, 3rd contacts: Success
- Test 4th contact within 24h: 429
- Test 4th contact after 24h: Success

**Email Template Tests:**
- Test vendor-inquiry template renders correctly
- Test with all fields filled
- Test with only required fields

**Run Commands:**
- `npm run test` (from backend/)
- `npm run test:contract` (from backend/)

[Source: CLAUDE.md#Testing]

#### Frontend Testing

**Component Tests:**
- Test ContactVendorForm: Renders fields, validates message
- Test form submission: Success, error handling
- Test rate limit handling: 429 shows appropriate message
- Test Contact button: Opens modal, passes vendorId

[Source: CLAUDE.md#Testing patterns]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-27 | 1.0 | Initial story creation for Epic 13: RFP System | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
(To be populated by dev agent)

### Debug Log References
(To be populated by dev agent)

### Completion Notes List
(To be populated by dev agent)

### File List
(To be populated by dev agent)

## QA Results
(To be populated by QA agent)
