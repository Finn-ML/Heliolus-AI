# Story 13.3: Assessment-Driven Comparison Matrix

## Status
Draft

## Story

**As a** Premium/Enterprise user,
**I want** the comparison matrix to show how each vendor addresses my specific assessment gaps and priorities,
**so that** I can make data-driven decisions based on my actual compliance needs rather than generic feature comparisons.

## Acceptance Criteria

1. Comparison rows generated from user's actual assessment gaps (not hardcoded)
2. Gap coverage percentage displayed per vendor
3. matchReasons array displayed in comparison for each vendor
4. Priority alignment indicators show #1, #2, #3 priority coverage
5. Gaps covered by one vendor but not the other are highlighted
6. Must-have features matched/missing shown per vendor
7. Maintains responsive design across screen sizes

## Tasks / Subtasks

- [ ] Task 1: Replace Hardcoded Comparison Categories with Assessment Gaps (AC: 1)
  - [ ] Remove existing hardcoded `comparisonCategories` array from VendorComparison
  - [ ] Access assessment gaps from vendors[0].matchDetails.vendor context
  - [ ] Query assessment gaps using API: `GET /assessments/:assessmentId/gaps`
  - [ ] Group gaps by category (e.g., KYC_AML, TRANSACTION_MONITORING, SANCTIONS_SCREENING)
  - [ ] Generate comparison sections dynamically from gap categories
  - [ ] Each section title = gap category (formatted: "KYC_AML" → "KYC & AML")
  - [ ] Each row within section = individual gap title and description

- [ ] Task 2: Calculate and Display Gap Coverage Per Vendor (AC: 2)
  - [ ] For each vendor, calculate gaps covered using baseScore.riskAreaCoverage
  - [ ] Formula: coverage_percentage = (riskAreaCoverage / 40) * 100
  - [ ] Display coverage as percentage with visual progress bar (Radix Progress component)
  - [ ] Color code based on coverage: ≥75% green, 50-74% yellow, <50% red
  - [ ] Show breakdown: "Covers 12 of 15 identified gaps (80%)"

- [ ] Task 3: Display matchReasons in Comparison Matrix (AC: 3)
  - [ ] Extract matchReasons array from each vendor's matchDetails
  - [ ] Create dedicated section in comparison view: "Why This Vendor Matches"
  - [ ] Render each match reason as bullet point with CheckCircle icon
  - [ ] Example reasons from backend:
    - [ ] "Covers your #1 priority: Transaction Monitoring"
    - [ ] "Addresses 85% of your identified compliance gaps"
    - [ ] "Has all must-have features you specified"
    - [ ] "Designed for companies your size"
    - [ ] "Within your budget range"
  - [ ] Style reasons with different colors based on category (priority = cyan, gaps = green, etc.)

- [ ] Task 4: Add Priority Alignment Indicators (AC: 4)
  - [ ] Parse priorityBoost.matchedPriority to extract priority rank (#1, #2, #3)
  - [ ] Display priority badges prominently:
    - [ ] #1 Priority: Large gold/yellow badge with star icon
    - [ ] #2 Priority: Medium silver badge
    - [ ] #3 Priority: Small bronze badge
  - [ ] Show priority text: e.g., "Matches your #1 priority: Transaction Monitoring"
  - [ ] Position badges near vendor header for visibility
  - [ ] If vendor doesn't match any top 3 priorities, show gray "No Priority Match" badge

- [ ] Task 5: Highlight Differential Gap Coverage (AC: 5)
  - [ ] Compare gaps covered by vendor1 vs vendor2 using category overlap
  - [ ] Identify gaps covered by one but not the other
  - [ ] Add visual indicator (highlighted row, different background color)
  - [ ] Show icon: CheckCircle (covered) vs XCircle (not covered) vs AlertCircle (partial)
  - [ ] Add tooltip explaining: "Only Vendor A covers this gap" or "Both vendors address this"
  - [ ] Use color coding: green (unique advantage), gray (both cover), red (neither covers)

- [ ] Task 6: Display Must-Have Features Matched/Missing (AC: 6)
  - [ ] Extract priorityBoost.missingFeatures array for each vendor
  - [ ] Create "Feature Coverage" comparison section
  - [ ] List all must-have features from priorities questionnaire
  - [ ] For each feature, show status per vendor:
    - [ ] ✓ Matched (green CheckCircle)
    - [ ] ✗ Missing (red XCircle with feature name)
  - [ ] Calculate feature coverage percentage: (matched / total) * 100
  - [ ] Highlight vendor with better feature coverage

- [ ] Task 7: Maintain Responsive Design (AC: 7)
  - [ ] Ensure matrix adapts to screen sizes:
    - [ ] Desktop (≥1024px): Side-by-side columns
    - [ ] Tablet (768-1023px): Side-by-side with smaller spacing
    - [ ] Mobile (<768px): Accordion or stacked cards per vendor
  - [ ] Use Tailwind responsive classes: `grid-cols-1 md:grid-cols-2 lg:grid-cols-2`
  - [ ] Test on multiple viewport sizes
  - [ ] Ensure charts and progress bars scale proportionally

- [ ] Task 8: Integrate with Assessment API (AC: 1)
  - [ ] Fetch assessment data including gaps using TanStack Query
  - [ ] Query key: `['assessment', assessmentId, 'gaps']`
  - [ ] Endpoint: `GET /v1/assessments/:assessmentId/gaps`
  - [ ] Cache gaps data (already fetched for results page)
  - [ ] Handle loading state: show skeleton loaders for comparison matrix
  - [ ] Handle error state: show fallback message if gaps fetch fails

- [ ] Task 9: Testing (All AC)
  - [ ] Test dynamic matrix generation from assessment gaps
  - [ ] Test gap coverage calculation and display
  - [ ] Test matchReasons rendering with various reason types
  - [ ] Test priority badges for ranks #1, #2, #3, and no match
  - [ ] Test differential highlighting when vendors have different gap coverage
  - [ ] Test feature coverage display with missing features
  - [ ] Test responsive behavior across screen sizes
  - [ ] Test loading and error states

## Dev Notes

### Previous Story Insights
[Source: Story 13.1, 13.2]

**Story 13.1** established premium/free feature detection.
**Story 13.2** implemented score visualization with charts.

This story (13.3) builds on the PremiumComparisonView from 13.2 by adding the actual assessment-driven comparison matrix below the score charts.

**Data Flow:**
```
User completes assessment → Assessment generates gaps → Priorities questionnaire completed →
Vendor matching calculates scores → matchReasons generated → Premium comparison displays all data
```

### Data Models
[Source: frontend/src/types/vendor-matching.types.ts, backend/prisma/schema.prisma]

**Gap Model** (from assessment):
```typescript
interface Gap {
  id: string;
  assessmentId: string;
  category: VendorCategory;   // e.g., "KYC_AML", "TRANSACTION_MONITORING"
  title: string;              // Gap title
  description: string;        // Gap description
  severity: Severity;         // CRITICAL, HIGH, MEDIUM, LOW
  priority: Priority;         // P0, P1, P2, P3
  effort: EffortRange;        // ONE_WEEK, ONE_MONTH, THREE_MONTHS, SIX_MONTHS, ONE_YEAR
  estimatedCost: CostRange;   // UNDER_10K, FROM_10K_50K, FROM_50K_100K, OVER_100K
}
```

**VendorMatchScore** (already used in Stories 13.1, 13.2):
```typescript
interface VendorMatchScore {
  vendorId: string;
  vendor: Vendor;
  baseScore: BaseScore;        // Contains riskAreaCoverage for gap coverage %
  priorityBoost: PriorityBoost; // Contains matchedPriority and missingFeatures
  totalScore: number;
  matchReasons: string[];      // Pre-generated human-readable reasons
}

interface PriorityBoost {
  vendorId: string;
  topPriorityBoost: number;    // 20 (rank #1), 15 (rank #2), 10 (rank #3), 0 (no match)
  matchedPriority?: string;    // e.g., "Transaction Monitoring"
  featureBoost: number;
  missingFeatures: string[];   // Array of missing must-have features
  deploymentBoost: number;
  speedBoost: number;
  totalBoost: number;
}
```

**Match Reasons Examples** (from backend/src/matching/match-reasons.ts):
- "Covers your #1 priority: Transaction Monitoring"
- "Addresses 85% of your identified compliance gaps"
- "Has all must-have features you specified"
- "Has most features, missing: Real-time monitoring"
- "Designed for companies your size"
- "Full coverage for all your jurisdictions"
- "Within your budget range"
- "Supports your preferred deployment model"
- "Fast implementation timeline (≤90 days)"

### API Specifications
[Source: backend/src/routes/assessment.routes.ts]

**Assessment Gaps API:**
- Endpoint: `GET /v1/assessments/:assessmentId/gaps`
- Authentication: Bearer token required
- Response: `{ success: true, data: Gap[] }`
- Error Handling: 404 if assessment not found, 403 if unauthorized
- Caching: TanStack Query with key `['assessment', assessmentId, 'gaps']`

**TanStack Query Pattern:**
```typescript
const { data: gapsData, isLoading: isLoadingGaps } = useQuery({
  queryKey: ['assessment', assessmentId, 'gaps'],
  queryFn: async () => {
    const response = await fetch(`/v1/assessments/${assessmentId}/gaps`, {
      headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
    });
    if (!response.ok) throw new Error('Failed to fetch gaps');
    const result = await response.json();
    return result.data;
  },
  enabled: !!assessmentId,
});
```

### Component Architecture
[Source: docs/architecture.md#ui-integration]

**Enhanced Component Hierarchy:**
```
PremiumComparisonView (from Story 13.2)
├─ Score Section (from Story 13.2)
│   ├─ Vendor 1 Score + Charts
│   └─ Vendor 2 Score + Charts
├─ NEW: Priority Alignment Section (Task 4)
│   ├─ Vendor 1 Priority Badges
│   └─ Vendor 2 Priority Badges
├─ NEW: Match Reasons Section (Task 3)
│   ├─ Vendor 1 Match Reasons List
│   └─ Vendor 2 Match Reasons List
├─ NEW: Gap Coverage Matrix (Tasks 1, 2, 5)
│   ├─ Gap Category Sections (dynamic from assessment)
│   │   ├─ Gap 1: Coverage indicators per vendor
│   │   ├─ Gap 2: Coverage indicators per vendor
│   │   └─ ...
│   └─ Coverage Summary: Progress bars per vendor
└─ NEW: Feature Coverage Section (Task 6)
    ├─ Vendor 1 Feature Checklist
    └─ Vendor 2 Feature Checklist
```

### Calculation Logic
[Source: backend/src/matching/base-scorer.ts]

**Gap Coverage Percentage:**
```typescript
// Backend calculates riskAreaCoverage (0-40 points)
// Frontend converts to percentage for display:
const gapCoveragePercent = (baseScore.riskAreaCoverage / 40) * 100;

// Example:
// riskAreaCoverage = 32 → 80% gap coverage
// riskAreaCoverage = 20 → 50% gap coverage
```

**Gap Coverage Breakdown:**
```typescript
// Total gaps from assessment
const totalGaps = gaps.length;

// Vendor categories determine which gaps they can address
const vendorCategories = vendor.categories; // e.g., ["KYC_AML", "TRANSACTION_MONITORING"]

// Count gaps covered
const gapsCovered = gaps.filter(gap =>
  vendorCategories.includes(gap.category)
).length;

// Display: "Covers 12 of 15 identified gaps (80%)"
```

### Styling and UI Patterns

**Gap Coverage Progress Bar:**
```tsx
<Progress value={gapCoveragePercent} className={
  gapCoveragePercent >= 75 ? "bg-green-500" :
  gapCoveragePercent >= 50 ? "bg-yellow-500" : "bg-red-500"
} />
<span>{gapsCovered} of {totalGaps} gaps ({gapCoveragePercent}%)</span>
```

**Match Reasons List:**
```tsx
<ul className="space-y-2">
  {matchReasons.map(reason => (
    <li className="flex items-start gap-2">
      <CheckCircle className="h-5 w-5 text-green-400 mt-0.5" />
      <span className="text-gray-300">{reason}</span>
    </li>
  ))}
</ul>
```

**Priority Badge:**
```tsx
<Badge className={
  rank === 1 ? "bg-gradient-to-r from-yellow-400 to-orange-400" :
  rank === 2 ? "bg-gradient-to-r from-gray-300 to-gray-400" :
  rank === 3 ? "bg-gradient-to-r from-amber-600 to-amber-700" :
  "bg-gray-600"
}>
  <Star className="h-4 w-4 mr-1" />
  {rank === 1 ? "#1 Priority" : rank === 2 ? "#2 Priority" : rank === 3 ? "#3 Priority" : "No Priority Match"}
</Badge>
```

**Differential Highlighting:**
```tsx
<div className={
  coveredByVendor1 && !coveredByVendor2 ? "bg-cyan-500/10 border-l-4 border-cyan-400" :
  !coveredByVendor1 && coveredByVendor2 ? "bg-pink-500/10 border-l-4 border-pink-400" :
  "bg-gray-800/50"
}>
  <span>Gap title</span>
  {coveredByVendor1 ? <CheckCircle className="text-green-400" /> : <XCircle className="text-red-400" />}
</div>
```

### Technical Constraints
[Source: docs/architecture.md#compatibility-requirements]

**Data Fetching Performance:**
- Gaps data should be cached from assessment results page (user likely viewed it before comparison)
- If not cached, fetch gaps on comparison page load
- Show loading skeleton while gaps fetch in progress
- Use React.Suspense boundary for progressive loading

**Matrix Rendering Performance:**
- If assessment has >50 gaps, virtualize the list (react-window or native CSS)
- Group gaps by category to reduce visual clutter
- Use collapsible sections (Radix Accordion) for large gap lists

**Responsive Strategy:**
- Desktop: Full side-by-side matrix
- Tablet: Side-by-side with smaller fonts and compact spacing
- Mobile: Convert to Accordion with one vendor per expanded section
  - User taps vendor name to expand/collapse their gap coverage

### File Locations

**Files to Modify:**
- `frontend/src/components/vendor/PremiumComparisonView.tsx` (add matrix sections)

**New Component Files (optional):**
- `frontend/src/components/vendor/GapCoverageMatrix.tsx` (gap comparison grid)
- `frontend/src/components/vendor/MatchReasonsList.tsx` (match reasons display)
- `frontend/src/components/vendor/PriorityBadge.tsx` (reusable priority indicator)
- `frontend/src/components/vendor/FeatureCoverageList.tsx` (feature checklist)

**Files to Reference:**
- `frontend/src/types/vendor-matching.types.ts` (VendorMatchScore, BaseScore, PriorityBoost)
- `backend/prisma/schema.prisma` (Gap model definition)
- `backend/src/matching/match-reasons.ts` (reason generation logic - read-only)

### Project Structure Notes

Gap categories from Prisma schema:
```typescript
enum VendorCategory {
  KYC_AML
  TRANSACTION_MONITORING
  SANCTIONS_SCREENING
  TRADE_SURVEILLANCE
  RISK_ASSESSMENT
  COMPLIANCE_TRAINING
  REGULATORY_REPORTING
  DATA_GOVERNANCE
}
```

Map to user-friendly names:
```typescript
const categoryNames = {
  KYC_AML: "KYC & AML",
  TRANSACTION_MONITORING: "Transaction Monitoring",
  SANCTIONS_SCREENING: "Sanctions Screening",
  TRADE_SURVEILLANCE: "Trade Surveillance",
  RISK_ASSESSMENT: "Risk Assessment",
  COMPLIANCE_TRAINING: "Compliance Training",
  REGULATORY_REPORTING: "Regulatory Reporting",
  DATA_GOVERNANCE: "Data Governance",
};
```

## Testing

[Source: docs/architecture.md#tech-stack - Testing Framework]

### Testing Standards

**Testing Framework:** React Testing Library + Vitest
**Test File Location:** `frontend/src/components/__tests__/VendorComparison.premium.test.tsx` (extend existing)
**Test Pattern:** Component integration tests with mocked assessment gaps

### Test Cases

1. **Dynamic Matrix Generation**
   - Mock assessment with 15 gaps across 3 categories (KYC_AML, TRANSACTION_MONITORING, SANCTIONS_SCREENING)
   - Render PremiumComparisonView
   - Assert 3 category sections rendered
   - Assert 15 gap rows rendered (5 per category)
   - Assert category names formatted correctly ("KYC_AML" → "KYC & AML")

2. **Gap Coverage Display**
   - Mock vendor1 with riskAreaCoverage: 32 (80%), vendor2 with riskAreaCoverage: 20 (50%)
   - Assert progress bars show 80% and 50%
   - Assert text shows "12 of 15 gaps" and "8 of 15 gaps"
   - Assert color coding: vendor1 green (≥75%), vendor2 yellow (50-74%)

3. **Match Reasons Rendering**
   - Mock matchReasons: ["Covers your #1 priority: Transaction Monitoring", "Addresses 85% of your identified compliance gaps", "Has all must-have features"]
   - Render Match Reasons section
   - Assert 3 reasons displayed with CheckCircle icons
   - Assert reason text matches mock data

4. **Priority Alignment Badges**
   - Mock vendor1 with matchedPriority: "Transaction Monitoring", topPriorityBoost: 20 (#1)
   - Mock vendor2 with matchedPriority: "KYC/AML", topPriorityBoost: 15 (#2)
   - Assert vendor1 shows gold "#1 Priority" badge
   - Assert vendor2 shows silver "#2 Priority" badge
   - Assert priority text displayed correctly

5. **Differential Highlighting**
   - Mock vendor1 covers gaps 1-10, vendor2 covers gaps 5-15
   - Render matrix
   - Assert gaps 1-4 highlighted as "Only Vendor 1" (cyan background)
   - Assert gaps 11-15 highlighted as "Only Vendor 2" (pink background)
   - Assert gaps 5-10 no highlight (both cover)

6. **Feature Coverage Display**
   - Mock vendor1 with missingFeatures: []
   - Mock vendor2 with missingFeatures: ["Real-time monitoring", "API integration"]
   - Render Feature Coverage section
   - Assert vendor1 shows all features with CheckCircle (100% coverage)
   - Assert vendor2 shows 2 missing features with XCircle
   - Assert vendor1 highlighted as better feature coverage

7. **Responsive Layout**
   - Test desktop: assert grid-cols-2, side-by-side layout
   - Test mobile: assert grid-cols-1, stacked layout or Accordion

8. **Loading and Error States**
   - Mock gaps query with isLoading: true
   - Assert skeleton loaders displayed
   - Mock gaps query with error
   - Assert error message: "Unable to load assessment gaps"
   - Assert fallback to static comparison

### Testing Requirements

- Use @testing-library/react render, screen, within, waitFor
- Mock TanStack Query for gaps data
- Mock window.matchMedia for responsive tests
- Verify no console errors
- Test accessibility: ARIA labels for progress bars and badges

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-28 | 1.0 | Initial story creation for Epic 13: Premium Vendor Comparison - Assessment-Driven Matrix | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
_To be populated during implementation_

### Debug Log References
_To be populated during implementation_

### Completion Notes List
_To be populated during implementation_

### File List
_To be populated during implementation_

## QA Results
_To be populated by QA Agent after implementation_
