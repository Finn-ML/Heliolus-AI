# Story 11.7: Real-time Activity Feed and Detailed Drill-Downs

## Status
Draft

## Story

**As an** admin
**I want** to see live activity and drill into specific metrics
**So that** I can monitor platform in real-time and investigate issues

## Acceptance Criteria

1. New "Activity Feed" card added to dashboard:
   - Shows last 20 platform events in real-time
   - Event types: User Registered, Assessment Started, Assessment Completed, Vendor Contacted, Subscription Created
   - Each event shows: Icon, Event type, User (name/email), Timestamp (relative)
   - Auto-updates every 30 seconds
2. Backend endpoint: `GET /v1/admin/analytics/activity-feed?limit=20`
3. Clickable metrics for drill-down:
   - Click "Total Assessments" → Opens assessment list filtered by date range
   - Click "Completion Rate" → Opens assessment list filtered by status = COMPLETED
   - Click vendor in "Top Vendors" → Opens vendor details page
   - Click "Active Users" → Opens user list filtered by recent activity
4. Drill-down modal for chart data points:
   - Click bar in trend chart → Shows detailed breakdown for that day
   - Click pie slice in distribution → Shows assessments of that template type
   - Modal shows data table with export option
5. Performance indicators:
   - Green/yellow/red status dots for system health
   - Response time monitoring (API latency)
   - Database connection status
6. Activity feed filters:
   - Filter by event type (dropdown multi-select)
   - Search by user email
   - Toggle auto-refresh on/off

## Tasks / Subtasks

- [ ] Task 1: Activity Feed Backend (AC: 2)
  - [ ] Add `getActivityFeed` method to AnalyticsService
  - [ ] Query recent events from multiple tables:
    - User registrations (User.createdAt)
    - Assessment starts (Assessment.createdAt)
    - Assessment completions (Assessment.completedAt)
    - Vendor contacts (VendorContact.createdAt)
    - Subscriptions (Subscription.createdAt)
  - [ ] Merge and sort by timestamp descending
  - [ ] Limit to 20 most recent
  - [ ] Include user details (name, email)
  - [ ] Add route: GET /admin/analytics/activity-feed

- [ ] Task 2: Activity Feed UI (AC: 1, 6)
  - [ ] Create ActivityFeed component
  - [ ] Display events in timeline format
  - [ ] Add icons for each event type
  - [ ] Format timestamps with formatDistanceToNow
  - [ ] Use TanStack Query with refetchInterval: 30000 (30 sec)
  - [ ] Add filter dropdown for event types
  - [ ] Add search input for user email
  - [ ] Add toggle for auto-refresh

- [ ] Task 3: Clickable Metrics Navigation (AC: 3)
  - [ ] Make metric cards clickable
  - [ ] Navigate to appropriate pages with filters:
    - Total Assessments → /admin/assessments?from=...&to=...
    - Completion Rate → /admin/assessments?status=COMPLETED
    - Active Users → /admin/users?active=true
  - [ ] Pass date range via URL params
  - [ ] Make top vendors clickable → /admin/vendors?id={vendorId}

- [ ] Task 4: Chart Drill-Down Modals (AC: 4)
  - [ ] Add onClick handlers to chart elements
  - [ ] Create DrillDownModal component
  - [ ] Fetch detailed data for selected point
  - [ ] Display in data table format
  - [ ] Add "Export to CSV" button in modal

- [ ] Task 5: System Health Indicators (AC: 5)
  - [ ] Add health check endpoint: GET /health
  - [ ] Return: API latency, DB connection status, Redis status
  - [ ] Display status dots in dashboard header:
    - Green: All systems operational
    - Yellow: Degraded performance
    - Red: System issues
  - [ ] Poll health endpoint every 60 seconds

- [ ] Task 6: Testing
  - [ ] Test activity feed updates every 30 seconds
  - [ ] Test event filtering and search
  - [ ] Test metric navigation with URL params
  - [ ] Test drill-down modals
  - [ ] Test health indicators

## Dev Notes

### Activity Feed Query Pattern
```typescript
async getActivityFeed(limit: number = 20): Promise<ActivityEvent[]> {
  const events: ActivityEvent[] = [];

  // User registrations
  const users = await this.prisma.user.findMany({
    take: limit,
    orderBy: { createdAt: 'desc' },
    select: { id: true, email: true, firstName: true, lastName: true, createdAt: true }
  });
  events.push(...users.map(u => ({
    type: 'USER_REGISTERED',
    userId: u.id,
    userEmail: u.email,
    userName: `${u.firstName} ${u.lastName}`,
    timestamp: u.createdAt
  })));

  // Assessment starts
  const assessments = await this.prisma.assessment.findMany({
    take: limit,
    orderBy: { createdAt: 'desc' },
    include: { user: true }
  });
  events.push(...assessments.map(a => ({
    type: 'ASSESSMENT_STARTED',
    userId: a.userId,
    userEmail: a.user.email,
    userName: `${a.user.firstName} ${a.user.lastName}`,
    timestamp: a.createdAt
  })));

  // ... other event types

  // Merge and sort
  return events
    .sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime())
    .slice(0, limit);
}
```

### Activity Feed Component
```tsx
const ActivityFeed = () => {
  const [autoRefresh, setAutoRefresh] = useState(true);

  const { data: events } = useQuery({
    queryKey: ['admin-activity-feed'],
    queryFn: () => adminApi.getActivityFeed(),
    refetchInterval: autoRefresh ? 30000 : false
  });

  return (
    <Card>
      <CardHeader className="flex flex-row items-center justify-between">
        <CardTitle>Activity Feed</CardTitle>
        <Switch checked={autoRefresh} onCheckedChange={setAutoRefresh} />
      </CardHeader>
      <CardContent>
        <div className="space-y-4 max-h-[400px] overflow-y-auto">
          {events?.map(event => (
            <div key={event.id} className="flex items-start gap-3">
              <EventIcon type={event.type} />
              <div className="flex-1">
                <p className="font-medium">{event.type.replace('_', ' ')}</p>
                <p className="text-sm text-muted-foreground">
                  {event.userName} ({event.userEmail})
                </p>
                <p className="text-xs text-muted-foreground">
                  {formatDistanceToNow(new Date(event.timestamp), { addSuffix: true })}
                </p>
              </div>
            </div>
          ))}
        </div>
      </CardContent>
    </Card>
  );
};
```

### Clickable Metrics Pattern
```tsx
<Card
  className="cursor-pointer hover:shadow-lg transition-shadow"
  onClick={() => navigate(`/admin/assessments?from=${dateRange.from}&to=${dateRange.to}`)}
>
  <CardHeader>
    <CardTitle>Total Assessments</CardTitle>
  </CardHeader>
  <CardContent>
    <div className="text-2xl font-bold">{data?.total}</div>
  </CardContent>
</Card>
```

### Drill-Down Modal
```tsx
const DrillDownModal = ({ dataPoint, onClose }) => {
  const { data } = useQuery({
    queryKey: ['drill-down', dataPoint],
    queryFn: () => fetchDetailedData(dataPoint)
  });

  return (
    <Dialog open onOpenChange={onClose}>
      <DialogContent className="max-w-4xl">
        <DialogHeader>
          <DialogTitle>Details for {dataPoint.label}</DialogTitle>
        </DialogHeader>
        <DataTable columns={columns} data={data} />
        <DialogFooter>
          <Button onClick={() => exportToCSV(data)}>
            <Download className="mr-2 h-4 w-4" />
            Export CSV
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
};
```

### Health Check Endpoint
```typescript
// backend/src/routes/health.routes.ts
server.get('/health', async (request, reply) => {
  const startTime = Date.now();

  try {
    // Check database
    await prisma.$queryRaw`SELECT 1`;
    const dbLatency = Date.now() - startTime;

    // Check Redis
    await redis.ping();

    return {
      status: 'healthy',
      timestamp: new Date().toISOString(),
      services: {
        database: { status: 'up', latency: dbLatency },
        redis: { status: 'up' },
        api: { status: 'up' }
      }
    };
  } catch (error) {
    return {
      status: 'unhealthy',
      error: error.message
    };
  }
});
```

### File Locations
- `backend/src/services/analytics.service.ts` - Add getActivityFeed
- `backend/src/routes/admin.routes.ts` - Add activity feed endpoint
- `backend/src/routes/health.routes.ts` - New health check endpoint
- `frontend/src/components/ActivityFeed.tsx` - New component
- `frontend/src/components/DrillDownModal.tsx` - New component
- `frontend/src/pages/admin/Dashboard.tsx` - Add activity feed, make metrics clickable

---

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Story created | Bob (Scrum Master) |

---

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
