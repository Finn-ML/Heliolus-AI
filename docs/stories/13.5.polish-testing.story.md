# Story 13.5: Polish & Testing

## Status
Draft

## Story

**As a** development team,
**I want** comprehensive testing, polish, and edge case handling for the premium vendor comparison feature,
**so that** we can confidently release a production-ready feature that works flawlessly across all user scenarios and devices.

## Acceptance Criteria

1. Responsive design works on mobile, tablet, and desktop
2. Loading states shown while fetching match data
3. Edge cases handled: no assessment selected, no priorities completed, no match data
4. Integration tests verify premium rendering for PREMIUM/ENTERPRISE plans
5. Integration tests verify static rendering for FREE plan
6. Tests verify graceful degradation when match data unavailable
7. Accessibility requirements met (ARIA labels, keyboard navigation)

## Tasks / Subtasks

- [ ] Task 1: Responsive Design Polish (AC: 1)
  - [ ] Test comparison view on mobile devices (iPhone SE 375px, iPhone 12 390px, iPhone 14 Pro Max 430px)
  - [ ] Test comparison view on tablets (iPad 768px, iPad Pro 1024px)
  - [ ] Test comparison view on desktop (1280px, 1440px, 1920px)
  - [ ] Ensure all charts scale appropriately (Recharts ResponsiveContainer)
  - [ ] Verify text remains readable at all sizes (minimum font-size: 14px on mobile)
  - [ ] Test touch interactions on mobile (tap targets ≥44px, no hover-dependent features)
  - [ ] Ensure horizontal scrolling not needed on any viewport
  - [ ] Test landscape orientation on mobile devices
  - [ ] Use CSS media query breakpoints matching Tailwind: sm (640px), md (768px), lg (1024px), xl (1280px)

- [ ] Task 2: Implement Loading States (AC: 2)
  - [ ] Add skeleton loaders for match scores while data fetching
  - [ ] Add skeleton loaders for charts (placeholder bars/circles)
  - [ ] Add skeleton loaders for comparison matrix rows
  - [ ] Add spinner with text: "Calculating vendor matches..." during initial load
  - [ ] Add progress indicator if loading takes >2 seconds
  - [ ] Use Radix Skeleton component for consistent styling
  - [ ] Ensure loading states don't cause layout shift (reserve space)
  - [ ] Test loading states by mocking slow API responses (setTimeout 3000ms)

- [ ] Task 3: Handle Edge Case - No Assessment Selected (AC: 3)
  - [ ] Detect when assessmentId is undefined or null in VendorComparison
  - [ ] Show user-friendly message: "Select an assessment to see personalized vendor comparison"
  - [ ] Provide CTA button: "Go to Assessments" linking to /assessments page
  - [ ] Use Alert component with info variant (blue)
  - [ ] Fallback to static comparison view (show generic features)
  - [ ] Log warning to console for debugging: "Assessment ID missing in vendor comparison"

- [ ] Task 4: Handle Edge Case - No Priorities Completed (AC: 3)
  - [ ] Detect when priorities questionnaire not completed (matchDetails.priorityBoost all zeros)
  - [ ] Show Alert banner: "Complete priorities questionnaire to unlock AI-powered insights"
  - [ ] Provide CTA button: "Complete Questionnaire" linking to priorities flow
  - [ ] Show partial premium view: display baseScore only (no priorityBoost components)
  - [ ] Explain: "Your personalized match scores will improve after completing the questionnaire"
  - [ ] Use Alert component with warning variant (yellow)

- [ ] Task 5: Handle Edge Case - No Match Data (AC: 3, 6)
  - [ ] Detect when vendors lack matchDetails (undefined or null)
  - [ ] Fallback to static comparison view gracefully (no error thrown)
  - [ ] Show info message: "Vendor match data unavailable. Showing generic comparison"
  - [ ] Log debug info: which vendors are missing matchDetails
  - [ ] Verify Premium badge still shows (user has paid tier)
  - [ ] Test with mock: vendor1 has matchDetails, vendor2 doesn't (should fallback)

- [ ] Task 6: Comprehensive Integration Tests (AC: 4, 5, 6)
  - [ ] Test FREE plan user flow:
    - [ ] Mock billingInfo: { data: { plan: 'FREE' } }
    - [ ] Render VendorComparison with 2 vendors
    - [ ] Assert StaticComparisonView rendered
    - [ ] Assert upgrade banner visible
    - [ ] Assert no premium features shown
  - [ ] Test PREMIUM plan user flow:
    - [ ] Mock billingInfo: { data: { plan: 'PREMIUM' } }
    - [ ] Mock vendors with full matchDetails
    - [ ] Assert PremiumComparisonView rendered
    - [ ] Assert match scores displayed
    - [ ] Assert charts rendered
    - [ ] Assert insights section visible
  - [ ] Test ENTERPRISE plan user flow (same as PREMIUM):
    - [ ] Mock billingInfo: { data: { plan: 'ENTERPRISE' } }
    - [ ] Assert same premium features as PREMIUM
  - [ ] Test graceful degradation:
    - [ ] Mock PREMIUM plan but vendors without matchDetails
    - [ ] Assert fallback to StaticComparisonView
    - [ ] Assert info message shown
  - [ ] Test loading states:
    - [ ] Mock query isLoading: true
    - [ ] Assert skeleton loaders displayed
  - [ ] Test error states:
    - [ ] Mock query error
    - [ ] Assert error message displayed
    - [ ] Assert fallback to static view

- [ ] Task 7: Accessibility (WCAG 2.1 AA Compliance) (AC: 7)
  - [ ] Add ARIA labels to all interactive elements:
    - [ ] Buttons: `aria-label="Compare vendors"`
    - [ ] Charts: `aria-label="Match score breakdown"`
    - [ ] Progress bars: `role="progressbar" aria-valuenow={value} aria-valuemin="0" aria-valuemax="100"`
    - [ ] Badges: `aria-label="Premium tier indicator"`
  - [ ] Ensure keyboard navigation works:
    - [ ] Tab through all interactive elements (buttons, links, tooltips)
    - [ ] Enter/Space to activate buttons
    - [ ] Escape to close modals/tooltips
    - [ ] Arrow keys for chart navigation (if applicable)
  - [ ] Test with screen reader (VoiceOver on Mac, NVDA on Windows):
    - [ ] Verify all content announced correctly
    - [ ] Verify semantic HTML: `<section>`, `<article>`, `<header>`
  - [ ] Color contrast ratios:
    - [ ] Text on backgrounds: minimum 4.5:1 contrast ratio
    - [ ] Interactive elements: minimum 3:1 contrast ratio
    - [ ] Use WebAIM Contrast Checker tool
  - [ ] Focus indicators visible:
    - [ ] Add `focus:ring-2 focus:ring-cyan-400` to interactive elements
    - [ ] Verify focus not trapped or lost
  - [ ] Alt text for icons:
    - [ ] Decorative icons: `aria-hidden="true"`
    - [ ] Meaningful icons: `aria-label="descriptive text"`

- [ ] Task 8: Performance Optimization (AC: 1, 2)
  - [ ] Memoize expensive calculations with useMemo:
    - [ ] generateComparativeInsights()
    - [ ] Gap coverage calculations
    - [ ] Chart data transformations
  - [ ] Memoize components with React.memo:
    - [ ] BaseScoreChart
    - [ ] PriorityBoostChart
    - [ ] MatchQualityBadge
  - [ ] Use useCallback for event handlers passed to child components
  - [ ] Lazy load chart library (Recharts) with React.lazy:
    - [ ] `const BaseScoreChart = lazy(() => import('./BaseScoreChart'))`
    - [ ] Wrap in Suspense with fallback
  - [ ] Measure render performance with React DevTools Profiler
  - [ ] Verify no unnecessary re-renders (use why-did-you-render in dev)
  - [ ] Test comparison load time: should be <1 second on fast connection

- [ ] Task 9: Cross-Browser Testing (AC: 1)
  - [ ] Test on Chrome (latest)
  - [ ] Test on Firefox (latest)
  - [ ] Test on Safari (latest)
  - [ ] Test on Edge (latest)
  - [ ] Test on mobile Safari (iOS 15+)
  - [ ] Test on mobile Chrome (Android)
  - [ ] Verify CSS Grid support (all modern browsers)
  - [ ] Verify TailwindCSS classes render correctly
  - [ ] Check for browser-specific bugs (especially Safari)

- [ ] Task 10: Final Polish (AC: 1, 7)
  - [ ] Add smooth transitions for view switching (premium <-> static)
  - [ ] Add animation to score displays (count-up effect)
  - [ ] Add subtle hover effects to interactive elements
  - [ ] Polish spacing and alignment (consistent gaps: 16px, 24px, 32px)
  - [ ] Verify color palette consistency across all sections
  - [ ] Add micro-interactions (button ripples, tooltip fades)
  - [ ] Ensure dark theme works throughout (no white backgrounds)
  - [ ] Add loading transitions for charts (fade-in effect)
  - [ ] Polish error messages (friendly tone, helpful actions)
  - [ ] Final copywriting review (grammar, clarity, tone)

- [ ] Task 11: End-to-End Testing (AC: 1-7)
  - [ ] Test complete user journey: FREE user
    - [ ] Navigate to vendor marketplace
    - [ ] Select 2 vendors
    - [ ] Click "Compare"
    - [ ] Verify static comparison shown
    - [ ] Verify upgrade banner shown
    - [ ] Click "Upgrade Now" → redirects to /pricing
  - [ ] Test complete user journey: PREMIUM user
    - [ ] Complete assessment with priorities questionnaire
    - [ ] Navigate to vendor marketplace
    - [ ] Select 2 vendors
    - [ ] Click "Compare"
    - [ ] Verify premium comparison shown with all features
    - [ ] Verify match scores, charts, insights, matrix all render
    - [ ] Test interactions: hover tooltips, click expand sections
  - [ ] Test complete user journey: Edge cases
    - [ ] PREMIUM user without completed priorities
    - [ ] PREMIUM user with assessment but no vendors have match data
    - [ ] Network error during data fetch

## Dev Notes

### Previous Story Insights
[Source: Stories 13.1, 13.2, 13.3, 13.4]

All core functionality implemented in Stories 13.1-13.4:
- **13.1:** Premium/free feature detection
- **13.2:** Match score visualization with charts
- **13.3:** Assessment-driven comparison matrix
- **13.4:** Advanced comparative insights

This story (13.5) is the final polish layer to ensure production readiness across all scenarios, devices, and edge cases.

### Testing Framework Configuration
[Source: docs/architecture.md#tech-stack]

**Testing Stack:**
- **Unit Tests:** Vitest 3.x
- **Component Tests:** React Testing Library
- **E2E Tests:** (Optional) Playwright or Cypress
- **Accessibility Tests:** axe-core + jest-axe
- **Performance Tests:** React DevTools Profiler + Lighthouse

**Test File Structure:**
```
frontend/src/components/__tests__/
├── VendorComparison.test.tsx              # Basic component tests
├── VendorComparison.premium.test.tsx      # Premium features (from Stories 13.1-13.4)
├── VendorComparison.responsive.test.tsx   # NEW: Responsive tests
├── VendorComparison.a11y.test.tsx         # NEW: Accessibility tests
└── VendorComparison.e2e.test.tsx          # NEW: End-to-end flows
```

**Testing Utilities:**
```
frontend/src/test-utils/
├── mockVendorData.ts      # Mock vendor + matchDetails
├── mockBillingData.ts     # Mock subscription plans
├── mockAssessmentData.ts  # Mock assessment + gaps
└── renderWithProviders.ts # Wrapper with TanStack Query, Router
```

### Responsive Design Breakpoints
[Source: TailwindCSS configuration]

**Breakpoint Strategy:**
```typescript
// Mobile-first approach
const breakpoints = {
  sm: '640px',   // Small devices
  md: '768px',   // Tablets
  lg: '1024px',  // Small laptops
  xl: '1280px',  // Desktops
  '2xl': '1536px' // Large desktops
};
```

**Responsive Layout Examples:**
```tsx
// Side-by-side on desktop, stacked on mobile
<div className="grid grid-cols-1 lg:grid-cols-2 gap-6">

// Hide on mobile, show on tablet+
<div className="hidden md:block">

// Smaller text on mobile
<h1 className="text-2xl md:text-3xl lg:text-4xl">

// Adjust padding
<div className="p-4 md:p-6 lg:p-8">
```

### Accessibility Standards
[Source: WCAG 2.1 AA Guidelines]

**WCAG 2.1 AA Requirements:**
1. **Perceivable**
   - Text alternatives for non-text content (alt text, ARIA labels)
   - Color not sole means of conveying information
   - Minimum contrast ratio 4.5:1 for normal text, 3:1 for large text

2. **Operable**
   - Keyboard accessible (all functionality available via keyboard)
   - Focus visible (clear focus indicators)
   - Navigation: skip links, landmarks, headings

3. **Understandable**
   - Readable text (clear language, no jargon)
   - Predictable interactions (consistent UI patterns)
   - Error prevention and recovery (clear error messages, undo options)

4. **Robust**
   - Valid HTML (semantic elements, ARIA when needed)
   - Compatible with assistive technologies (screen readers, voice control)

**ARIA Best Practices:**
```tsx
// Progress bar
<div role="progressbar" aria-valuenow={75} aria-valuemin="0" aria-valuemax="100" aria-label="Gap coverage">

// Button
<button aria-label="Compare selected vendors">

// Section
<section aria-labelledby="insights-heading">
  <h2 id="insights-heading">AI-Powered Insights</h2>

// Hidden decorative icon
<StarIcon aria-hidden="true" />

// Meaningful icon
<InfoIcon aria-label="More information about match scores" />
```

### Loading State Patterns
[Source: Existing component patterns]

**Skeleton Loader Components:**
```tsx
// Score skeleton
<div className="animate-pulse">
  <div className="h-16 w-32 bg-gray-700 rounded"></div>
</div>

// Chart skeleton
<div className="animate-pulse">
  <div className="h-64 bg-gray-700 rounded"></div>
</div>

// Matrix row skeleton
<div className="animate-pulse space-y-2">
  {[1, 2, 3, 4, 5].map(i => (
    <div key={i} className="h-12 bg-gray-700 rounded"></div>
  ))}
</div>
```

**Progress Indicator:**
```tsx
<div className="flex items-center gap-3">
  <Loader2 className="h-6 w-6 animate-spin text-cyan-400" />
  <span className="text-gray-300">Calculating vendor matches...</span>
</div>
```

### Performance Optimization Patterns

**Memoization Examples:**
```typescript
// Memoize expensive calculations
const comparativeInsights = useMemo(() => {
  return generateComparativeInsights(vendor1.matchDetails, vendor2.matchDetails);
}, [vendor1.matchDetails, vendor2.matchDetails]);

// Memoize chart data transformation
const chartData = useMemo(() => {
  return transformBaseScoreToChartData(baseScore);
}, [baseScore]);

// Memoize component
const BaseScoreChart = React.memo(({ baseScore }: { baseScore: BaseScore }) => {
  // Chart rendering
});
```

**Lazy Loading:**
```typescript
// Lazy load chart library (large bundle)
const BaseScoreChart = lazy(() => import('./vendor/BaseScoreChart'));
const PriorityBoostChart = lazy(() => import('./vendor/PriorityBoostChart'));

// Usage
<Suspense fallback={<ChartSkeleton />}>
  <BaseScoreChart baseScore={vendor1.matchDetails.baseScore} />
</Suspense>
```

### Edge Case Scenarios

**Scenario Matrix:**
| Plan | Assessment | Priorities | Match Data | Expected Behavior |
|------|------------|-----------|-----------|-------------------|
| FREE | ✓ | ✓ | ✓ | Static view + upgrade banner |
| FREE | ✓ | ✗ | ✓ | Static view + upgrade banner |
| FREE | ✗ | ✗ | ✗ | Static view + upgrade banner |
| PREMIUM | ✓ | ✓ | ✓ | Full premium view |
| PREMIUM | ✓ | ✗ | ✓ | Partial premium (baseScore only) + complete priorities prompt |
| PREMIUM | ✗ | ✗ | ✗ | Info message + link to assessments |
| PREMIUM | ✓ | ✓ | ✗ | Fallback to static + info message |
| ENTERPRISE | (same as PREMIUM) | | | |

### Browser Compatibility Matrix

**Supported Browsers:**
- Chrome 90+ (2021+)
- Firefox 88+ (2021+)
- Safari 14+ (2020+)
- Edge 90+ (2021+)
- Mobile Safari iOS 14+ (2020+)
- Mobile Chrome Android 90+ (2021+)

**Known Issues:**
- Safari: CSS Grid gap property uses older syntax (use gap, not grid-gap)
- Firefox: Smooth scrolling requires scroll-behavior CSS
- Edge: Some Radix UI components need polyfills for older versions

### File Locations

**Test Files to Create:**
- `frontend/src/components/__tests__/VendorComparison.responsive.test.tsx`
- `frontend/src/components/__tests__/VendorComparison.a11y.test.tsx`
- `frontend/src/components/__tests__/VendorComparison.e2e.test.tsx`

**Test Utilities:**
- `frontend/src/test-utils/mockVendorData.ts` (if not exists)
- `frontend/src/test-utils/renderWithProviders.ts` (if not exists)

**Files to Polish:**
- All component files from Stories 13.1-13.4
- VendorComparison.tsx (main component)
- PremiumComparisonView.tsx
- All chart and insight components

## Testing

[Source: docs/architecture.md#tech-stack - Testing Framework]

### Testing Standards

**Testing Framework:** React Testing Library + Vitest + jest-axe
**Test Coverage Target:** ≥80% for premium comparison components
**Performance Budget:** Comparison render <1 second, no layout shifts

### Comprehensive Test Suite

1. **Responsive Design Tests**
   ```typescript
   describe('VendorComparison - Responsive', () => {
     test('renders side-by-side on desktop', () => {
       window.matchMedia = createMatchMedia('(min-width: 1024px)');
       render(<VendorComparison vendors={mockVendors} />);
       expect(screen.getByTestId('comparison-grid')).toHaveClass('lg:grid-cols-2');
     });

     test('renders stacked on mobile', () => {
       window.matchMedia = createMatchMedia('(max-width: 767px)');
       render(<VendorComparison vendors={mockVendors} />);
       expect(screen.getByTestId('comparison-grid')).toHaveClass('grid-cols-1');
     });
   });
   ```

2. **Loading State Tests**
   ```typescript
   test('shows skeleton loaders while loading', () => {
     const { container } = render(<VendorComparison vendors={mockVendors} />);
     mockQuery({ isLoading: true });
     expect(container.querySelector('.animate-pulse')).toBeInTheDocument();
   });
   ```

3. **Edge Case Tests**
   ```typescript
   test('handles no assessment ID', () => {
     render(<VendorComparison vendors={mockVendors} assessmentId={undefined} />);
     expect(screen.getByText(/Select an assessment/i)).toBeInTheDocument();
   });

   test('handles no priorities completed', () => {
     mockVendors[0].matchDetails.priorityBoost.totalBoost = 0;
     render(<VendorComparison vendors={mockVendors} />);
     expect(screen.getByText(/Complete priorities questionnaire/i)).toBeInTheDocument();
   });
   ```

4. **Accessibility Tests**
   ```typescript
   import { axe, toHaveNoViolations } from 'jest-axe';
   expect.extend(toHaveNoViolations);

   test('has no accessibility violations', async () => {
     const { container } = render(<VendorComparison vendors={mockVendors} />);
     const results = await axe(container);
     expect(results).toHaveNoViolations();
   });

   test('is keyboard navigable', () => {
     render(<VendorComparison vendors={mockVendors} />);
     const firstButton = screen.getAllByRole('button')[0];
     firstButton.focus();
     expect(firstButton).toHaveFocus();
     fireEvent.keyDown(firstButton, { key: 'Tab' });
     expect(screen.getAllByRole('button')[1]).toHaveFocus();
   });
   ```

5. **End-to-End Tests**
   ```typescript
   test('FREE user complete journey', async () => {
     mockBilling({ plan: 'FREE' });
     render(<VendorComparison vendors={mockVendors} />);

     expect(screen.getByText(/Unlock Premium Comparison/i)).toBeInTheDocument();
     expect(screen.queryByText(/AI-Powered Insights/i)).not.toBeInTheDocument();

     const upgradeButton = screen.getByRole('button', { name: /Upgrade Now/i });
     fireEvent.click(upgradeButton);
     expect(mockNavigate).toHaveBeenCalledWith('/pricing');
   });

   test('PREMIUM user complete journey', async () => {
     mockBilling({ plan: 'PREMIUM' });
     render(<VendorComparison vendors={mockVendorsWithMatchData} />);

     await waitFor(() => {
       expect(screen.getByText(/AI-Powered Insights/i)).toBeInTheDocument();
     });
     expect(screen.getByText(/Match Score: 120/i)).toBeInTheDocument();
     expect(screen.getByText(/Addresses 85% of your identified compliance gaps/i)).toBeInTheDocument();
   });
   ```

### Testing Requirements

- All tests pass before merge
- Coverage ≥80% for new components
- No accessibility violations (axe-core)
- No console errors or warnings
- Performance tests pass (render <1s)
- Cross-browser smoke tests pass

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-28 | 1.0 | Initial story creation for Epic 13: Premium Vendor Comparison - Polish & Testing | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
_To be populated during implementation_

### Debug Log References
_To be populated during implementation_

### Completion Notes List
_To be populated during implementation_

### File List
_To be populated during implementation_

## QA Results
_To be populated by QA Agent after implementation_
