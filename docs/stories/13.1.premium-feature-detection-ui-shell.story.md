# Story 13.1: Premium Feature Detection & UI Shell

## Status
Draft

## Story

**As a** compliance platform user,
**I want** the vendor comparison tool to detect my subscription plan and render appropriate views,
**so that** Premium/Enterprise users see intelligent comparison features while Free users see an upgrade prompt with the existing static comparison.

## Acceptance Criteria

1. VendorComparison receives and checks subscription plan from props or context
2. Premium view renders when `currentPlan === 'PREMIUM' || 'ENTERPRISE'`
3. Static view renders when `currentPlan === 'FREE'`
4. Free users see "Unlock Premium Comparison" banner with upgrade CTA
5. Premium badge appears for premium users
6. No breaking changes to existing comparison interface

## Tasks / Subtasks

- [ ] Task 1: Add Subscription Plan Detection to VendorComparison (AC: 1)
  - [ ] Import subscription query from VendorMarketplace pattern
  - [ ] Add useQuery hook to fetch billing info: `/v1/subscriptions/:userId/billing-info`
  - [ ] Extract currentPlan from billingInfo?.data?.plan with 'FREE' fallback
  - [ ] Create isPremium boolean: `currentPlan === 'PREMIUM' || currentPlan === 'ENTERPRISE'`
  - [ ] Add hasMatchData check: `vendors[0]?.matchDetails && vendors[1]?.matchDetails`

- [ ] Task 2: Create Premium/Free View Switching Logic (AC: 2, 3, 6)
  - [ ] Extract existing static comparison code into <StaticComparisonView> component
  - [ ] Create component stub <PremiumComparisonView> (to be filled in Story 13.2)
  - [ ] Implement conditional rendering: if (isPremium && hasMatchData) → PremiumComparisonView, else → StaticComparisonView
  - [ ] Pass all existing props to StaticComparisonView to maintain backward compatibility
  - [ ] Verify existing comparison functionality unchanged for free users

- [ ] Task 3: Create Free User Upgrade Banner (AC: 4)
  - [ ] Design banner component using existing Alert or Card components from Radix UI
  - [ ] Add banner at top of StaticComparisonView: "Unlock Premium Comparison"
  - [ ] Include upgrade CTA button linking to pricing page (/pricing)
  - [ ] Use existing button styles from VendorMarketplace
  - [ ] Add Sparkles icon from Lucide React for visual appeal
  - [ ] Make banner dismissible (localStorage key: 'dismissedPremiumComparisonBanner')

- [ ] Task 4: Add Premium Badge for Premium Users (AC: 5)
  - [ ] Create premium badge component using Radix Badge
  - [ ] Style with gradient: bg-gradient-to-r from-cyan-400 to-purple-400
  - [ ] Position badge near comparison title when isPremium === true
  - [ ] Add tooltip: "You have access to AI-powered comparison insights"
  - [ ] Use CheckCircle icon from Lucide React

- [ ] Task 5: Update TypeScript Types (AC: 1, 6)
  - [ ] Verify VendorComparisonProps includes vendors array with matchDetails
  - [ ] Add BillingInfo interface if not already defined
  - [ ] Ensure backwards compatibility - all existing props remain unchanged
  - [ ] Document new optional behavior in JSDoc comments

- [ ] Task 6: Testing (All AC)
  - [ ] Test free user experience: static comparison renders, upgrade banner shows
  - [ ] Test premium user experience: premium view switch activates (even if stub)
  - [ ] Test edge case: missing billing info defaults to free view
  - [ ] Test edge case: premium user but no match data (show static view)
  - [ ] Verify no regression: existing comparison functionality intact
  - [ ] Test banner dismissal persists across sessions

## Dev Notes

### Previous Story Insights
No previous stories in this epic. This is the foundation story that establishes the premium/free feature flag pattern for all subsequent stories.

### Component Architecture
[Source: docs/architecture.md#ui-integration]

**Existing Component:**
- Location: `frontend/src/components/VendorComparison.tsx`
- Current Props: `{ vendors: any[], onBack: () => void }`
- Current Behavior: Shows static, hardcoded feature comparison matrix
- Integration: Called from VendorMarketplace when user selects 2 vendors

**Component Modification Strategy:**
- Extract existing comparison JSX into `<StaticComparisonView>` child component
- Add subscription plan detection using existing pattern from VendorMarketplace
- Wrap rendering in conditional: `isPremium && hasMatchData ? <PremiumComparisonView /> : <StaticComparisonView />`
- Maintain all existing props and callbacks unchanged (backward compatibility requirement)

### Data Models
[Source: docs/architecture.md#data-models-and-schema-changes]

**VendorMatchScore Interface** (already defined in frontend/src/types/vendor-matching.types.ts):
```typescript
interface VendorMatchScore {
  vendorId: string;
  vendor: Vendor;
  baseScore: BaseScore;       // 0-100 breakdown
  priorityBoost: PriorityBoost; // 0-40 breakdown
  totalScore: number;          // 0-140 combined
  matchReasons: string[];      // Human-readable explanations
}
```

Each vendor in the vendors array should have `matchDetails: VendorMatchScore` populated by VendorMarketplace. This story just checks for existence; subsequent stories will render it.

**Billing Info Structure** (from VendorMarketplace pattern):
```typescript
interface BillingInfo {
  data: {
    plan: 'FREE' | 'PREMIUM' | 'ENTERPRISE';
    status: 'ACTIVE' | 'TRIALING' | 'PAST_DUE' | 'CANCELED';
    creditsBalance: number;
    // ... other fields
  }
}
```

### API Specifications
[Source: frontend/src/components/VendorMarketplace.tsx:64-80]

**Subscription Plan API:**
- Endpoint: `GET /v1/subscriptions/:userId/billing-info`
- Authentication: Bearer token required (localStorage.getItem('token'))
- Response: BillingInfo object with plan, status, credits
- Error Handling: Returns null if request fails (defaults to FREE plan)
- Caching: TanStack Query with key `['subscription', 'billing-info']`

**Implementation Pattern from VendorMarketplace:**
```typescript
const { data: billingInfo } = useQuery({
  queryKey: ['subscription', 'billing-info'],
  queryFn: async () => {
    const userId = getCurrentUserId();
    if (!userId) return null;
    const response = await fetch(`/v1/subscriptions/${userId}/billing-info`, {
      headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
    });
    if (!response.ok) return null;
    return response.json();
  },
  enabled: !!localStorage.getItem('token'),
  retry: false,
});
const currentPlan = billingInfo?.data?.plan || 'FREE';
const isPremium = currentPlan === 'PREMIUM' || currentPlan === 'ENTERPRISE';
```

### File Locations
[Source: docs/architecture.md#ui-integration + CLAUDE.md]

**Files to Modify:**
- `frontend/src/components/VendorComparison.tsx` (primary modification)

**Files to Reference:**
- `frontend/src/components/VendorMarketplace.tsx` (subscription pattern)
- `frontend/src/types/vendor-matching.types.ts` (VendorMatchScore interface)
- `frontend/src/lib/api.ts` (getCurrentUserId helper)

**New Component Files to Create (optional refactoring):**
- `frontend/src/components/vendor/StaticComparisonView.tsx` (extracted existing code)
- `frontend/src/components/vendor/PremiumComparisonView.tsx` (stub for Story 13.2)

### Technical Constraints
[Source: docs/architecture.md#compatibility-requirements]

**Backward Compatibility Requirements:**
1. VendorComparison props interface must remain unchanged
2. Free users must see identical comparison experience as before this story
3. If billing API fails or returns null, default to FREE plan (safe fallback)
4. If vendors lack matchDetails, render static view even for premium users
5. No new dependencies - use existing Radix UI, Lucide React, TanStack Query

**Performance Considerations:**
- Subscription query cached by TanStack Query (no re-fetch on every render)
- Conditional rendering introduces negligible performance impact
- Banner dismissal uses localStorage (synchronous, instant)

### Styling and Design System
[Source: docs/architecture.md#ui-ux-consistency]

**Use Existing Patterns:**
- Radix UI components: Alert (for banner), Badge (for premium indicator), Tooltip
- TailwindCSS utility classes from existing theme
- Color palette: Use existing cyan-400, purple-400, pink-400 gradients (seen in VendorMarketplace)
- Icons: Lucide React (Sparkles for premium, CheckCircle for badge)

**Banner Styling Example:**
```tsx
<Alert className="bg-gradient-to-r from-cyan-500/10 to-purple-500/10 border-cyan-500/30">
  <Sparkles className="h-4 w-4 text-cyan-400" />
  <AlertTitle>Unlock Premium Comparison</AlertTitle>
  <AlertDescription>
    Get AI-powered insights...
    <Button variant="outline" className="ml-4">Upgrade Now</Button>
  </AlertDescription>
</Alert>
```

**Premium Badge Example:**
```tsx
<Badge className="bg-gradient-to-r from-cyan-400 to-purple-400 text-white">
  <CheckCircle className="h-3 w-3 mr-1" />
  Premium
</Badge>
```

### Project Structure Notes
[Source: CLAUDE.md#project-structure]

**Frontend Component Organization:**
```
frontend/src/components/
├── VendorComparison.tsx           # Main component (modify)
├── VendorMarketplace.tsx          # Parent component (read-only reference)
├── vendor/                        # Optional: create subdirectory for clarity
│   ├── StaticComparisonView.tsx  # Extracted static comparison
│   └── PremiumComparisonView.tsx # Stub for Story 13.2
```

**Alternative:** Keep all logic in single VendorComparison.tsx file if refactoring adds unnecessary complexity. Decide based on file size after implementation.

## Testing

[Source: docs/architecture.md#tech-stack - Testing Framework]

### Testing Standards

**Testing Framework:** React Testing Library + Vitest
**Test File Location:** `frontend/src/components/__tests__/VendorComparison.premium.test.tsx`
**Test Pattern:** Component integration tests with mocked TanStack Query

### Test Cases

1. **Free User Experience**
   - Mock billingInfo to return plan: 'FREE'
   - Render VendorComparison with mock vendors
   - Assert StaticComparisonView rendered (existing comparison matrix visible)
   - Assert upgrade banner present with "Unlock Premium Comparison" text
   - Assert premium badge NOT present

2. **Premium User Experience**
   - Mock billingInfo to return plan: 'PREMIUM'
   - Mock vendors with matchDetails populated
   - Render VendorComparison
   - Assert PremiumComparisonView rendered (stub component visible)
   - Assert upgrade banner NOT present
   - Assert premium badge present

3. **Enterprise User Experience**
   - Mock billingInfo to return plan: 'ENTERPRISE'
   - Same assertions as Premium user (both tiers get same features)

4. **Edge Case: Missing Billing Info**
   - Mock billing query to return null
   - Assert defaults to FREE plan behavior
   - Assert static view rendered with upgrade banner

5. **Edge Case: Premium User Without Match Data**
   - Mock billingInfo to return plan: 'PREMIUM'
   - Mock vendors without matchDetails (undefined or null)
   - Assert StaticComparisonView rendered (graceful degradation)
   - Assert no error thrown

6. **Backward Compatibility**
   - Render VendorComparison with minimal props (vendors, onBack)
   - Assert no TypeScript errors
   - Assert component renders successfully
   - Verify onBack callback works

7. **Banner Dismissal**
   - Mock FREE plan
   - Render component, assert banner visible
   - Simulate banner dismiss action
   - Assert localStorage.setItem called with key 'dismissedPremiumComparisonBanner'
   - Re-render component
   - Assert banner not visible

### Testing Requirements

- Use @testing-library/react render and screen utilities
- Mock TanStack Query with QueryClientProvider wrapper
- Mock localStorage for banner dismissal tests
- Verify no console errors or warnings
- Test responsive behavior (desktop, tablet, mobile - optional if time permits)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-28 | 1.0 | Initial story creation for Epic 13: Premium Vendor Comparison | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
_To be populated during implementation_

### Debug Log References
_To be populated during implementation_

### Completion Notes List
_To be populated during implementation_

### File List
_To be populated during implementation_

## QA Results
_To be populated by QA Agent after implementation_
