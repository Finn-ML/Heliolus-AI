# Story 12.2: Admin Section & Question CRUD API Routes

## Status
Draft

## Story

**As a** platform administrator,
**I want** backend API routes for creating, updating, and deleting template sections and questions,
**so that** I can build complete assessment templates with structured sections and questions through the admin UI.

## Acceptance Criteria

1. **Section Creation Route** - POST /admin/templates/:templateId/sections
   - Accepts section data (title, description, order, weight)
   - Validates input using Zod schema
   - Requires ADMIN role
   - Creates section via TemplateService.createSection()
   - Returns created section with 201 status
   - Logs audit event: TEMPLATE_SECTION_CREATED

2. **Section Update Route** - PUT /admin/sections/:id
   - Accepts partial section updates (title, description, order, weight)
   - Validates weight field (0-100 range)
   - Requires ADMIN role
   - Updates section via new TemplateService method
   - Returns updated section with 200 status
   - Logs audit event: TEMPLATE_SECTION_UPDATED

3. **Section Delete Route** - DELETE /admin/sections/:id
   - Cascades deletion to child questions (Prisma handles via onDelete: Cascade)
   - Requires ADMIN role
   - Prevents deletion if template is active and has assessments
   - Returns success message with 200 status
   - Logs audit event: TEMPLATE_SECTION_DELETED

4. **Question Creation Route** - POST /admin/sections/:sectionId/questions
   - Accepts question data (text, type, order, required, options[], helpText, aiPromptHint, weight)
   - Validates QuestionType enum (TEXT, NUMBER, BOOLEAN, SELECT, MULTISELECT, FILE, DATE, RATING)
   - Validates weight field (0-100 range)
   - Requires ADMIN role
   - Creates question via TemplateService.createQuestion()
   - Returns created question with 201 status
   - Logs audit event: TEMPLATE_QUESTION_CREATED

5. **Question Update Route** - PUT /admin/questions/:id
   - Accepts partial question updates (text, type, required, options, helpText, aiPromptHint, weight, order)
   - Validates input using Zod schema
   - Requires ADMIN role
   - Updates question via new TemplateService method
   - Returns updated question with 200 status
   - Logs audit event: TEMPLATE_QUESTION_UPDATED

6. **Question Delete Route** - DELETE /admin/questions/:id
   - Requires ADMIN role
   - Prevents deletion if template is active and has assessments
   - Returns success message with 200 status
   - Logs audit event: TEMPLATE_QUESTION_DELETED

7. **Bulk Question Creation Route** - POST /admin/sections/:sectionId/questions/bulk
   - Accepts array of question objects
   - Validates all questions in single request
   - Requires ADMIN role
   - Creates questions via TemplateService.bulkCreateQuestions()
   - Returns array of created questions with 201 status
   - Logs audit event: TEMPLATE_QUESTIONS_BULK_CREATED with count

8. **Error Handling**
   - 400: Invalid input (Zod validation, weight out of range, invalid enum)
   - 401: Unauthorized (missing/invalid JWT)
   - 403: Forbidden (non-ADMIN role)
   - 404: Section/Question not found, Parent template not found
   - 400: TEMPLATE_INACTIVE (cannot modify inactive template)
   - 500: Server error

9. **OpenAPI Documentation**
   - All 7 routes documented with schema definitions
   - Tagged as 'Admin' in Swagger UI
   - Request/response examples included
   - Nested resource relationships documented (template → section → question)

## Tasks / Subtasks

- [ ] Task 1: Add Section Update/Delete Methods to TemplateService (AC: 2, 3)
  - [ ] Add `updateSection(id, data, context)` method to template.service.ts
  - [ ] Add `deleteSection(id, context)` method to template.service.ts
  - [ ] Implement validation: Check template isActive before allowing changes
  - [ ] Implement audit logging in both methods
  - [ ] Add error handling for section not found, inactive template

- [ ] Task 2: Add Question Update/Delete Methods to TemplateService (AC: 5, 6)
  - [ ] Add `updateQuestion(id, data, context)` method to template.service.ts
  - [ ] Add `deleteQuestion(id, context)` method to template.service.ts
  - [ ] Implement validation: Check template isActive before allowing changes
  - [ ] Implement audit logging in both methods
  - [ ] Add error handling for question not found, inactive template

- [ ] Task 3: Create Validation Schemas (AC: 1, 2, 4, 5, 7)
  - [ ] Create UpdateSectionSchema (title, description, order, weight 0-100)
  - [ ] Create UpdateQuestionSchema (text, type, required, options, helpText, aiPromptHint, weight 0-100, order)
  - [ ] Reuse existing CreateSectionSchema, CreateQuestionSchema, BulkCreateQuestionsSchema from template.service.ts
  - [ ] Validate QuestionType enum matches Prisma schema

- [ ] Task 4: Implement Section Routes (AC: 1, 2, 3, 9)
  - [ ] POST /admin/templates/:templateId/sections
  - [ ] PUT /admin/sections/:id
  - [ ] DELETE /admin/sections/:id
  - [ ] Apply authenticationMiddleware and requireRole([UserRole.ADMIN])
  - [ ] Define OpenAPI schemas for all routes
  - [ ] Extract service context from request.currentUser
  - [ ] Handle nested resource paths (template → section)
  - [ ] Add request/response examples to OpenAPI docs

- [ ] Task 5: Implement Question Routes (AC: 4, 5, 6, 9)
  - [ ] POST /admin/sections/:sectionId/questions
  - [ ] PUT /admin/questions/:id
  - [ ] DELETE /admin/questions/:id
  - [ ] Apply authenticationMiddleware and requireRole([UserRole.ADMIN])
  - [ ] Define OpenAPI schemas for all routes
  - [ ] Extract service context from request.currentUser
  - [ ] Handle nested resource paths (section → question)
  - [ ] Add request/response examples to OpenAPI docs

- [ ] Task 6: Implement Bulk Question Creation Route (AC: 7, 9)
  - [ ] POST /admin/sections/:sectionId/questions/bulk
  - [ ] Apply authenticationMiddleware and requireRole([UserRole.ADMIN])
  - [ ] Validate array of questions using BulkCreateQuestionsSchema
  - [ ] Call TemplateService.bulkCreateQuestions()
  - [ ] Handle transaction failures (all or nothing)
  - [ ] Return 201 with array of created questions
  - [ ] Add OpenAPI documentation

- [ ] Task 7: Integration Testing (All AC)
  - [ ] Test POST sections with valid data (201)
  - [ ] Test PUT sections with valid data (200)
  - [ ] Test DELETE sections (200)
  - [ ] Test POST questions with valid data (201)
  - [ ] Test PUT questions with weight validation (200, 400 for invalid weight)
  - [ ] Test DELETE questions (200)
  - [ ] Test POST bulk questions with 10 questions (201)
  - [ ] Test bulk with invalid question in array (400, no partial creation)
  - [ ] Test section/question modification on inactive template (400 TEMPLATE_INACTIVE)
  - [ ] Test as non-ADMIN user (403)
  - [ ] Verify audit logging for all operations
  - [ ] Verify cascade delete: delete section → questions deleted automatically
  - [ ] Verify templates with existing sections/questions still work in assessment flow

## Dev Notes

### Existing System Context

**TemplateService (backend/src/services/template.service.ts):**
Existing methods (already implemented):
- `createSection(data, context)` - Creates section with template validation, audit logging
- `createQuestion(data, context)` - Creates question with section/template validation, audit logging
- `bulkCreateQuestions(data, context)` - Creates multiple questions in single transaction

**Missing methods (need to be added in this story):**
- `updateSection(id, data, context)` - Update section fields
- `deleteSection(id, context)` - Delete section (cascade to questions handled by Prisma)
- `updateQuestion(id, data, context)` - Update question fields
- `deleteQuestion(id, context)` - Delete question

**Database Schema (backend/prisma/schema.prisma):**

Section model (lines 579-598):
```prisma
model Section {
  id          String  @id @default(cuid())
  templateId  String
  title       String
  description String?
  weight      Float   @default(1.0) // For scoring
  regulatoryPriority String? // FFIEC, FATF reference
  order       Int
  isRequired  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  template  Template    @relation(fields: [templateId], references: [id], onDelete: Cascade)
  questions Question[]  // Cascade delete handled by Prisma

  @@index([templateId])
  @@index([order])
}
```

Question model (lines 600-630):
```prisma
model Question {
  id         String       @id @default(cuid())
  sectionId  String
  text       String
  type       QuestionType // TEXT, NUMBER, BOOLEAN, SELECT, MULTISELECT, FILE, DATE, RATING
  required   Boolean      @default(false)
  options    String[]     // For select/multi
  validation Json?
  helpText   String?
  order      Int

  // AI Assessment fields
  categoryTag   String? // Risk category tag
  tags          String[] @default([])
  weight        Float   @default(1.0) // Importance weight for scoring (0-100)
  isFoundational Boolean @default(false)
  aiPromptHint  String? // Specific AI prompt guidance for this question
  scoringRules  Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  section Section @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  answers Answer[]

  @@index([sectionId])
  @@index([order])
  @@index([type])
  @@index([categoryTag])
}

enum QuestionType {
  TEXT
  NUMBER
  BOOLEAN
  SELECT
  MULTISELECT
  FILE
  DATE
  RATING
}
```

### New Service Methods Pattern

**Template: updateSection method**
```typescript
async updateSection(
  id: string,
  data: z.infer<typeof UpdateSectionSchema>,
  context?: ServiceContext
): Promise<ApiResponse<DatabaseSection>> {
  try {
    const validatedData = await this.validateInput(UpdateSectionSchema, data);

    // Only admins can modify templates
    this.requirePermission(context, [UserRole.ADMIN]);

    // Verify section exists and get template
    const section = await this.prisma.section.findUnique({
      where: { id },
      include: { template: { select: { id: true, isActive: true } } },
    });

    if (!section) {
      throw this.createError('Section not found', 404, 'SECTION_NOT_FOUND');
    }

    if (!section.template.isActive) {
      throw this.createError('Cannot modify inactive template', 400, 'TEMPLATE_INACTIVE');
    }

    // Update section
    const updatedSection = await this.prisma.section.update({
      where: { id },
      data: {
        title: validatedData.title,
        description: validatedData.description,
        order: validatedData.order,
        weight: validatedData.weight,
      },
    });

    await this.logAudit(
      {
        action: 'TEMPLATE_SECTION_UPDATED',
        entity: 'Section',
        entityId: id,
        oldValues: { title: section.title, weight: section.weight },
        newValues: validatedData,
      },
      context
    );

    this.logger.info('Section updated successfully', { sectionId: id });

    return this.createResponse(true, updatedSection, 'Section updated successfully');
  } catch (error) {
    if (error.statusCode) throw error;
    this.handleDatabaseError(error, 'updateSection');
  }
}
```

**Template: deleteSection method**
```typescript
async deleteSection(
  id: string,
  context?: ServiceContext
): Promise<ApiResponse<void>> {
  try {
    // Only admins can modify templates
    this.requirePermission(context, [UserRole.ADMIN]);

    // Verify section exists and get template + question count
    const section = await this.prisma.section.findUnique({
      where: { id },
      include: {
        template: { select: { id: true, isActive: true } },
        _count: { select: { questions: true } },
      },
    });

    if (!section) {
      throw this.createError('Section not found', 404, 'SECTION_NOT_FOUND');
    }

    if (!section.template.isActive) {
      throw this.createError('Cannot modify inactive template', 400, 'TEMPLATE_INACTIVE');
    }

    // Delete section (cascade to questions handled by Prisma schema)
    await this.prisma.section.delete({ where: { id } });

    await this.logAudit(
      {
        action: 'TEMPLATE_SECTION_DELETED',
        entity: 'Section',
        entityId: id,
        oldValues: { title: section.title, questionCount: section._count.questions },
      },
      context
    );

    this.logger.info('Section deleted successfully', { sectionId: id, cascadedQuestions: section._count.questions });

    return this.createResponse(true, undefined, `Section and ${section._count.questions} questions deleted successfully`);
  } catch (error) {
    if (error.statusCode) throw error;
    this.handleDatabaseError(error, 'deleteSection');
  }
}
```

### Weight Validation

Weights should be validated as floating point numbers between 0-100:
```typescript
const UpdateSectionSchema = z.object({
  title: z.string().min(1).max(200).optional(),
  description: z.string().optional(),
  order: z.number().min(0).optional(),
  weight: z.number().min(0).max(100).optional(), // 0-100 range
});

const UpdateQuestionSchema = z.object({
  text: z.string().min(1).max(1000).optional(),
  type: z.nativeEnum(QuestionType).optional(),
  required: z.boolean().optional(),
  options: z.array(z.string()).optional(),
  helpText: z.string().optional(),
  aiPromptHint: z.string().max(1000).optional(),
  weight: z.number().min(0).max(100).optional(), // 0-100 range
  order: z.number().min(0).optional(),
});
```

### Nested Resource Routes

Admin routes follow RESTful nested resource pattern:
```
POST   /admin/templates/:templateId/sections      - Create section under template
PUT    /admin/sections/:id                        - Update section (flat route)
DELETE /admin/sections/:id                        - Delete section (flat route)

POST   /admin/sections/:sectionId/questions       - Create question under section
PUT    /admin/questions/:id                       - Update question (flat route)
DELETE /admin/questions/:id                       - Delete question (flat route)

POST   /admin/sections/:sectionId/questions/bulk  - Bulk create questions under section
```

**Rationale:**
- Creation routes are nested (show parent relationship)
- Update/delete routes are flat (operate on resource by ID, no parent context needed)
- Matches REST best practices and existing API patterns

### File Locations

**Modified Files:**
- `backend/src/services/template.service.ts` - Add 4 new methods (updateSection, deleteSection, updateQuestion, deleteQuestion)
- `backend/src/routes/admin.routes.ts` - Add 7 new route handlers

**No New Files Required**

### Integration Points

1. **Cascade Deletion:**
   - Section deletion automatically deletes child questions (Prisma onDelete: Cascade)
   - No manual cleanup needed in service layer
   - Integration test must verify cascade behavior

2. **Template Activation State:**
   - Section/question modifications blocked if template.isActive = false
   - Prevents changes to templates currently being used in assessments
   - Error code: TEMPLATE_INACTIVE

3. **Audit Logging:**
   - All mutations logged via BaseService.logAudit()
   - Actions: TEMPLATE_SECTION_CREATED, TEMPLATE_SECTION_UPDATED, TEMPLATE_SECTION_DELETED, TEMPLATE_QUESTION_CREATED, TEMPLATE_QUESTION_UPDATED, TEMPLATE_QUESTION_DELETED, TEMPLATE_QUESTIONS_BULK_CREATED

### Testing Standards

**Test Location:** `backend/tests/integration/admin-template-sections-questions.test.ts` (new file)

**Key Test Scenarios:**
```typescript
describe('Admin Section Routes', () => {
  it('should create section with valid data', /* ... */);
  it('should update section weight', /* ... */);
  it('should reject weight > 100', /* ... */);
  it('should cascade delete questions when section deleted', async () => {
    // Create section with 3 questions
    // Delete section
    // Verify questions also deleted
  });
  it('should prevent section modification on inactive template', /* ... */);
});

describe('Admin Question Routes', () => {
  it('should create question with aiPromptHint', /* ... */);
  it('should update question weight', /* ... */);
  it('should validate QuestionType enum', /* ... */);
  it('should bulk create 10 questions in transaction', /* ... */);
  it('should rollback bulk create if one question invalid', /* ... */);
});
```

### OpenAPI Schema Example (Section Creation)

```typescript
const CreateSectionSchema = {
  description: 'Create a new section in an assessment template',
  tags: ['Admin'],
  params: {
    type: 'object',
    required: ['templateId'],
    properties: {
      templateId: { type: 'string', pattern: '^[c-z][a-z0-9]{24}$' }, // CUID format
    },
  },
  body: {
    type: 'object',
    required: ['title', 'order'],
    properties: {
      title: { type: 'string', minLength: 1, maxLength: 200 },
      description: { type: 'string' },
      order: { type: 'integer', minimum: 0 },
      weight: { type: 'number', minimum: 0, maximum: 100, default: 1.0 },
    },
  },
  response: {
    201: {
      type: 'object',
      properties: {
        success: { type: 'boolean' },
        data: {
          type: 'object',
          properties: {
            id: { type: 'string' },
            templateId: { type: 'string' },
            title: { type: 'string' },
            description: { type: 'string', nullable: true },
            order: { type: 'integer' },
            weight: { type: 'number' },
            createdAt: { type: 'string' },
            updatedAt: { type: 'string' },
          },
        },
        message: { type: 'string' },
      },
    },
    400: { /* Validation or TEMPLATE_INACTIVE */ },
    403: { /* Forbidden */ },
    404: { /* Template not found */ },
  },
};
```

### Performance Considerations

- **Bulk Create Optimization:** TemplateService.bulkCreateQuestions() uses Prisma transaction for atomic operation
- **Cascade Delete:** Database-level cascade (Prisma schema) is faster than application-level deletion
- **Weight Validation:** Client-side and server-side validation prevents invalid data early

### Security Considerations

- **RBAC:** All routes require ADMIN role
- **Template Locking:** isActive check prevents modification during assessment execution
- **Audit Trail:** All CRUD operations logged with userId, entity, entityId
- **Input Validation:** Zod schemas prevent injection attacks, XSS

### Backward Compatibility

✅ **Existing Templates Unchanged:**
- No database migrations required (all fields already exist)
- weight fields have default values (1.0)
- Existing sections/questions continue functioning

✅ **Assessment Flow Unchanged:**
- Assessment creation reads sections/questions via existing relations
- No changes to assessment execution logic

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Story created - Admin section & question CRUD API routes | Bob (Scrum Master) |

---

## Dev Agent Record
_To be populated by dev agent during implementation_

---

## QA Results
_To be populated by QA agent after testing_
