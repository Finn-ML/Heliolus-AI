# Story 11.5: User Activity and Conversion Metrics

## Status
Draft

## Story

**As an** admin
**I want** user registration and conversion analytics
**So that** I can optimize the user journey

## Acceptance Criteria

1. New endpoint: `GET /v1/admin/analytics/users`
2. Returns user activity metrics:
   ```typescript
   {
     totalUsers: number,
     activeUsers: number,        // Logged in last 30 days
     newUsers: number,           // Created last 30 days
     verifiedUsers: number,      // emailVerified = true
     retentionRate: number,      // Users active in last 7 days / total users
     conversionFunnel: {
       signups: number,
       emailVerified: number,
       profileCompleted: number,  // Has organization
       assessmentStarted: number,
       assessmentCompleted: number,
       upgradedToPremium: number
     },
     usersByRole: {
       USER: number,
       ADMIN: number,
       VENDOR: number
     },
     signupTrend: Array<{
       date: string,
       signups: number,
       verifications: number
     }>,  // Last 30 days
     engagementSegments: {
       highlyActive: number,     // 5+ assessments
       active: number,            // 2-4 assessments
       inactive: number,          // 0-1 assessments
       churned: number           // No login in 90 days
     }
   }
   ```
3. Profile completion: User has organizationId
4. Retention: % of users who logged in within last 7 days
5. Response time < 1 second
6. Cache for 5 minutes

## Tasks / Subtasks

- [ ] Task 1: Add User Analytics Method (AC: 1, 2, 3, 4)
  - [ ] Add `getUserAnalytics` to AnalyticsService
  - [ ] Query total users, active users (last 30 days login)
  - [ ] Query new users (created last 30 days)
  - [ ] Query verified users (emailVerified = true)
  - [ ] Calculate retention rate
  - [ ] Build conversion funnel data
  - [ ] Group users by role
  - [ ] Generate signup trend (last 30 days)
  - [ ] Calculate engagement segments by assessment count

- [ ] Task 2: Add Analytics Route (AC: 1)
  - [ ] Add route: GET /admin/analytics/users
  - [ ] Require ADMIN role
  - [ ] Call AnalyticsService.getUserAnalytics
  - [ ] Return formatted response

- [ ] Task 3: Optimize and Cache (AC: 5, 6)
  - [ ] Add indexes: User(lastLogin), User(emailVerified)
  - [ ] Cache with Redis (5 min TTL)
  - [ ] Test performance with 10,000+ users

- [ ] Task 4: Testing
  - [ ] Unit test: getUserAnalytics
  - [ ] Test conversion funnel calculations
  - [ ] Test engagement segments
  - [ ] Integration test: GET /admin/analytics/users

## Dev Notes

### Efficient Query Patterns

**Active and New Users**:
```typescript
const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);

const [totalUsers, activeUsers, newUsers, verifiedUsers, activeInWeek] = await Promise.all([
  this.prisma.user.count({ where: { status: { not: 'DELETED' } } }),
  this.prisma.user.count({ where: { lastLogin: { gte: thirtyDaysAgo } } }),
  this.prisma.user.count({ where: { createdAt: { gte: thirtyDaysAgo } } }),
  this.prisma.user.count({ where: { emailVerified: true } }),
  this.prisma.user.count({ where: { lastLogin: { gte: sevenDaysAgo } } })
]);

const retentionRate = (activeInWeek / totalUsers) * 100;
```

**Conversion Funnel**:
```typescript
const signups = await this.prisma.user.count();
const emailVerified = await this.prisma.user.count({ where: { emailVerified: true } });
const profileCompleted = await this.prisma.user.count({
  where: { organization: { isNot: null } }
});
const assessmentStarted = await this.prisma.user.count({
  where: { assessments: { some: {} } }
});
const assessmentCompleted = await this.prisma.user.count({
  where: { assessments: { some: { status: 'COMPLETED' } } }
});
const upgradedToPremium = await this.prisma.user.count({
  where: {
    subscription: {
      plan: { in: ['PREMIUM', 'ENTERPRISE'] },
      status: 'ACTIVE'
    }
  }
});
```

**Engagement Segments**:
```typescript
const segments = await this.prisma.$queryRaw`
  SELECT
    CASE
      WHEN assessment_count >= 5 THEN 'highlyActive'
      WHEN assessment_count BETWEEN 2 AND 4 THEN 'active'
      WHEN assessment_count BETWEEN 0 AND 1 THEN 'inactive'
      ELSE 'churned'
    END as segment,
    COUNT(*) as count
  FROM (
    SELECT
      u.id,
      COUNT(a.id) as assessment_count,
      u.last_login
    FROM "User" u
    LEFT JOIN "Assessment" a ON u.id = a.user_id
    WHERE u.status != 'DELETED'
    GROUP BY u.id
  ) user_stats
  WHERE last_login > NOW() - INTERVAL '90 days'
     OR assessment_count > 0
  GROUP BY segment
`;
```

### File Locations
- `backend/src/services/analytics.service.ts` - Add getUserAnalytics
- `backend/src/routes/admin.routes.ts` - Add GET /admin/analytics/users

---

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Story created | Bob (Scrum Master) |

---

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
