# Story 1.21: Enhanced PDF Report Template

## Status
Draft

## Story

**As a** backend developer,
**I want** to update the PDF report template to include evidence tier breakdown, weighted scoring visualization, and strategy matrix,
**so that** users receive comprehensive reports suitable for auditor presentation.

## Acceptance Criteria

1. Extend `report-generator.service.ts` to generate enhanced reports
2. New report sections (added to existing template):
   **Section: Methodology Overview (New, page 2)**
   - Brief explanation of evidence-weighted, regulatory-aligned scoring
   - Reference to FFIEC/FATF frameworks
   - Statement: "This assessment uses a defensible methodology suitable for regulatory presentation"

   **Section: Evidence Quality Summary (New, page 3)**
   - Evidence tier distribution table:
     - Tier 2 (System-Generated): X documents (Y%)
     - Tier 1 (Policy Documents): X documents (Y%)
     - Tier 0 (Self-Declared): X documents (Y%)
   - Donut chart visualization (embedded PNG)
   - Document list by tier (truncated, top 5 per tier with classifications)

   **Section: Overall Risk Score (Enhanced, page 4)**
   - Large risk score display with band (Critical/High/Medium/Low)
   - Risk band definition and implications
   - Comparison to industry benchmarks (if available in future)

   **Section: Section-by-Section Breakdown (Enhanced, page 5-10)**
   - Each section on separate page or half-page block
   - Section score, weight, contribution to overall
   - Bar chart showing question scores within section
   - Top 3 lowest-scoring questions highlighted

   **Section: Gap Analysis (Enhanced, page 11-15)**
   - Gap summary table: Gap Title, Severity, Priority, Effort, Cost Estimate
   - Sorted by priority descending
   - Color-coded severity indicators
   - Remediation recommendations per gap

   **Section: Strategy Matrix Timeline (New, page 16-17)**
   - Three-column visual showing timeline buckets
   - Gaps organized by timeframe with effort/cost aggregations
   - Recommended vendors per bucket (top 2-3)
   - Visual roadmap gantt-chart style

   **Section: Vendor Recommendations (Enhanced, page 18-20)**
   - Top 10 vendor matches with scores
   - Match reasoning per vendor
   - Gap coverage matrix
   - Vendor comparison table (top 3 vendors side-by-side)

3. Verify PDF generation works for both legacy and enhanced assessments
4. Include feature flag check: only enhanced sections for assessments with methodology="complete"
5. PDF generation completes within 10 seconds for typical assessment (50 questions, 10 vendors)
6. Generated PDF is ADA-accessible (tagged PDF with proper structure)
7. All charts embedded as high-resolution PNGs (300 DPI)

## Tasks / Subtasks

- [ ] Extend report-generator.service.ts with enhanced sections (AC: 1, 2)
  - [ ] Add generateMethodologyOverviewSection() method
  - [ ] Add generateEvidenceQualitySummarySection() method with tier distribution logic
  - [ ] Add generateEnhancedOverallRiskScoreSection() with band visualization
  - [ ] Add generateSectionBreakdownPages() with per-section charts
  - [ ] Add generateEnhancedGapAnalysisSection() with color-coded table
  - [ ] Add generateStrategyMatrixTimelineSection() with bucket visualization
  - [ ] Add generateEnhancedVendorRecommendationsSection() with comparison table
- [ ] Create chart generation utility functions (AC: 7)
  - [ ] Implement generateDonutChart() for evidence tier distribution
  - [ ] Implement generateBarChart() for section question scores
  - [ ] Implement generateGanttChart() for timeline roadmap
  - [ ] Ensure all charts render at 300 DPI
- [ ] Add feature flag logic for conditional sections (AC: 4)
  - [ ] Check assessment.scoringMethodology field
  - [ ] Conditionally include enhanced sections only if methodology="complete"
  - [ ] Include fallback message for legacy assessments
- [ ] Test PDF generation for both assessment types (AC: 3, 5)
  - [ ] Generate PDF for legacy assessment, verify existing sections work
  - [ ] Generate PDF for enhanced assessment, verify all new sections included
  - [ ] Measure PDF generation time, optimize if >10 seconds
- [ ] Ensure ADA accessibility compliance (AC: 6)
  - [ ] Tag PDF with proper semantic structure
  - [ ] Add alt text for all embedded charts
  - [ ] Verify reading order with PDF accessibility checker
- [ ] Update report.service.ts to handle enhanced reports
  - [ ] Ensure report download endpoint serves enhanced PDFs
  - [ ] Update report metadata to indicate enhanced vs legacy

## Dev Notes

### Relevant Source Tree
- `backend/src/services/report-generator.service.ts` - Report generation service (existing)
- `backend/src/services/report.service.ts` - Report storage and access control (existing)
- `backend/src/services/assessment.service.ts` - Assessment orchestration (60KB, largest service)
- `backend/src/services/strategy-matrix.service.ts` - Strategy matrix logic (to be created in Story 1.15)
- `backend/src/lib/chart-generator.ts` - Chart generation utilities (create if doesn't exist)
- `backend/src/templates/` - Email/report templates directory

### Report Generation Design Decisions

**PDF Library:**
The existing report-generator.service.ts likely uses a PDF generation library (e.g., PDFKit, Puppeteer, or similar). Follow the existing pattern when adding new sections.

**Chart Generation Strategy:**
Generate charts server-side using a headless browser (Puppeteer) or chart rendering library (ChartJS node-canvas). Convert to PNG at 300 DPI before embedding in PDF.

**Data Gathering:**
Enhanced report requires data from multiple sources:
- Assessment model (scoringMethodology, overall score, risk band)
- Document model with evidenceTier classifications
- Section and Question models with weights
- Answer model with finalScore values
- Gap model with priority, effort, costRange
- VendorMatch model with totalScore and reasoning
- Strategy matrix data from strategy-matrix.service.ts

**Existing Report Template Structure:**
Review the existing report-generator.service.ts to understand current sections and page layout. Enhanced sections should follow the same visual design language.

**Performance Optimization:**
- Generate charts in parallel where possible
- Cache generated charts in memory during single report generation
- Consider moving to background job queue if generation exceeds 10 seconds

**Feature Flag Integration:**
Check assessment.scoringMethodology field. If "complete", include all enhanced sections. If "unavailable" or null, generate legacy report format only.

### Integration Points

**Dependencies:**
- strategy-matrix.service.ts (Story 1.15) must be completed first
- vendor-matching.service.ts (Story 1.13) provides vendor match data
- weighted-scoring.service.ts (Story 1.4) provides finalScore calculations
- evidence-classification.service.ts (Story 1.3) provides tier classifications

**API Endpoints:**
- GET /api/assessments/:id/report - Existing endpoint, should return enhanced PDF
- POST /api/assessments/:id/generate-report - Existing endpoint, triggers generation

### Testing

**Location:** `backend/tests/integration/report-generator.spec.ts`

**Testing Frameworks:**
- Vitest 3 for test execution
- Fastify inject for API testing
- PDF parsing library (e.g., pdf-parse) for validating generated PDF content

**Test Cases:**
1. Generate report for legacy assessment (methodology="unavailable")
   - Verify: Only legacy sections present
   - Verify: No evidence tier or strategy matrix sections
2. Generate report for enhanced assessment (methodology="complete")
   - Verify: All 7 enhanced sections present
   - Verify: Evidence tier distribution matches document data
   - Verify: Strategy matrix includes all timeline buckets
   - Verify: Vendor recommendations include top 10 matches
3. Chart generation produces valid PNGs at 300 DPI
4. PDF generation completes within 10 seconds
5. Generated PDF is ADA-accessible (tagged structure, alt text present)
6. PDF includes correct data from assessment, gaps, vendors
7. Section-by-section breakdown matches weighted score calculations

**Coverage Target:** ≥80% code coverage for new report generation methods

**Integration Verification:**
- Full E2E test: Create enhanced assessment → Upload documents → Complete assessment → Submit priorities → Generate report → Verify all sections present and accurate

## Change Log

| Date       | Version | Description                          | Author        |
|------------|---------|--------------------------------------|---------------|
| 2025-10-07 | 1.0     | Initial story created from PRD Epic 1 | SM (Winston)  |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent during implementation_

### Debug Log References
_To be populated by dev agent during implementation_

### Completion Notes
_To be populated by dev agent during implementation_

### File List
_To be populated by dev agent during implementation_

## QA Results

_To be populated by QA agent after implementation review_
