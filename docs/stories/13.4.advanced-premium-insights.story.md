# Story 13.4: Advanced Premium Insights

## Status
Draft

## Story

**As a** Premium/Enterprise user,
**I want** AI-generated comparative insights and detailed deployment/budget analysis,
**so that** I can quickly understand which vendor is objectively better for my specific situation and make confident procurement decisions.

## Acceptance Criteria

1. Comparative insights generated (e.g., "Vendor A: +15% better for high-priority gaps")
2. Feature coverage breakdown shows must-have features matched/missing with visual indicators
3. Deployment model comparison displayed (cloud/on-prem preferences)
4. Implementation timeline comparison shown
5. Budget fit indicators displayed (within budget, slightly over, over budget)
6. All insights based on actual matchDetails data, not assumptions

## Tasks / Subtasks

- [ ] Task 1: Generate Comparative Insights (AC: 1, 6)
  - [ ] Create `generateComparativeInsights()` utility function
  - [ ] Accept both vendors' matchDetails as input
  - [ ] Calculate score differential: `(vendor1.totalScore - vendor2.totalScore) / vendor1.totalScore * 100`
  - [ ] Generate insights based on differentials:
    - [ ] Overall: "Vendor A scores 15% higher overall"
    - [ ] Gap Coverage: "Vendor A addresses 8 more critical gaps"
    - [ ] Priority Alignment: "Vendor B better matches your #1 priority"
    - [ ] Feature Completeness: "Vendor A has all must-have features, Vendor B missing 2"
    - [ ] Budget Fit: "Vendor A within budget, Vendor B 20% over"
  - [ ] Return array of insight objects: `{ type: string, message: string, advantage: 'vendor1' | 'vendor2' | 'neutral' }`
  - [ ] Render insights with color-coded badges (green for advantage, gray for neutral)

- [ ] Task 2: Enhanced Feature Coverage Breakdown (AC: 2)
  - [ ] Extend feature coverage from Story 13.3 with visual percentage indicators
  - [ ] Create progress circle or radial chart showing feature completeness per vendor
  - [ ] List all must-have features from priorities questionnaire (if available)
  - [ ] For each feature, show match status:
    - [ ] ✓ Fully Matched (vendor has feature)
    - [ ] ⚠ Partial Match (vendor has similar but not exact)
    - [ ] ✗ Missing (vendor doesn't have feature)
  - [ ] Calculate feature completeness score: `(matched / total) * 100`
  - [ ] Display: "Vendor A: 10/10 features (100%)", "Vendor B: 8/10 features (80%)"
  - [ ] Highlight vendor with better feature coverage with "Best Feature Fit" badge

- [ ] Task 3: Deployment Model Comparison (AC: 3, 6)
  - [ ] Extract deployment preferences from priorities (cloud, on-prem, hybrid)
  - [ ] Extract vendor deployment options from vendor.deploymentOptions field
  - [ ] Parse deploymentOptions string to detect supported models:
    - [ ] Check for keywords: "cloud", "saas", "on-premise", "on-prem", "hybrid"
  - [ ] Display comparison table:
    - [ ] Row 1: User Preference (from priorities)
    - [ ] Row 2: Vendor 1 Supports (Yes/No with CheckCircle/XCircle)
    - [ ] Row 3: Vendor 2 Supports (Yes/No)
  - [ ] Highlight vendor that matches user preference with green background
  - [ ] Show deploymentBoost score from priorityBoost (5 points if matches, 0 if not)

- [ ] Task 4: Implementation Timeline Comparison (AC: 4, 6)
  - [ ] Extract implementation timeline from vendor.implementationTimeline field (days)
  - [ ] Convert days to user-friendly format:
    - [ ] ≤30 days: "1 Month"
    - [ ] 31-90 days: "1-3 Months"
    - [ ] 91-180 days: "3-6 Months"
    - [ ] >180 days: "6+ Months"
  - [ ] Display timeline comparison with calendar icons
  - [ ] Highlight faster vendor with "Faster Implementation" badge
  - [ ] Show speedBoost score from priorityBoost (5 points if ≤90 days, 0 otherwise)
  - [ ] Add context: "Based on typical implementation for companies your size"

- [ ] Task 5: Budget Fit Indicators (AC: 5, 6)
  - [ ] Extract budget preference from priorities.budgetRange
  - [ ] Extract vendor pricing from vendor.pricingRange field
  - [ ] Compare using baseScore.priceScore to determine fit:
    - [ ] priceScore = 20: Within Budget ✓ (green badge, CheckCircle)
    - [ ] priceScore = 10: Slightly Over Budget ⚠ (yellow badge, AlertCircle, "+25% tolerance")
    - [ ] priceScore = 0: Over Budget ✗ (red badge, XCircle)
  - [ ] Display pricing comparison table:
    - [ ] Row 1: Your Budget Range (e.g., "€50K-€100K")
    - [ ] Row 2: Vendor 1 Pricing (e.g., "€60K-€90K" with "Within Budget" badge)
    - [ ] Row 3: Vendor 2 Pricing (e.g., "€110K-€150K" with "Over Budget" badge)
  - [ ] Add disclaimer: "Pricing is estimated and subject to negotiation"

- [ ] Task 6: Create Insights Summary Section (AC: 1)
  - [ ] Design "AI-Powered Insights" section at top of premium comparison
  - [ ] Use Card component with gradient header (cyan-to-purple gradient)
  - [ ] Add Sparkles icon to emphasize AI-generated insights
  - [ ] Display comparative insights in priority order:
    1. Overall score advantage
    2. Gap coverage advantage
    3. Priority alignment advantage
    4. Feature completeness advantage
    5. Budget fit comparison
    6. Implementation speed comparison
  - [ ] Each insight as bullet point with icon and color-coded advantage indicator
  - [ ] Add "Summary Recommendation" at bottom: "Based on your assessment, Vendor [A/B] is the stronger match"

- [ ] Task 7: Testing (All AC)
  - [ ] Test comparative insights generation with various score differentials
  - [ ] Test feature coverage breakdown with 100%, 80%, 50% coverage scenarios
  - [ ] Test deployment model matching when user prefers cloud, on-prem, hybrid
  - [ ] Test timeline comparison with different implementation periods
  - [ ] Test budget fit indicators for within budget, slightly over, over budget
  - [ ] Test insights summary recommendation logic
  - [ ] Verify all data comes from matchDetails, not hardcoded

## Dev Notes

### Previous Story Insights
[Source: Stories 13.1, 13.2, 13.3]

**Story 13.1:** Established premium/free feature detection
**Story 13.2:** Implemented score visualization with charts
**Story 13.3:** Built assessment-driven comparison matrix with gaps, match reasons, priorities

This story (13.4) adds the final intelligence layer by generating comparative insights and detailed deployment/budget analysis. It synthesizes all matchDetails data into actionable recommendations.

### Data Models
[Source: frontend/src/types/vendor-matching.types.ts, backend/prisma/schema.prisma]

**PriorityBoost Interface** (key data source for this story):
```typescript
interface PriorityBoost {
  vendorId: string;
  topPriorityBoost: number;    // 0-20 points
  matchedPriority?: string;    // e.g., "Transaction Monitoring"
  featureBoost: number;        // 0-10 points (10 = all features, 5 = most, 0 = missing critical)
  missingFeatures: string[];   // Array of missing must-have features
  deploymentBoost: number;     // 0-5 points (5 = matches preference, 0 = doesn't)
  speedBoost: number;          // 0-5 points (5 = ≤90 days, 0 = >90 days)
  totalBoost: number;          // Sum of above
}
```

**Vendor Model Fields** (relevant for this story):
```typescript
interface Vendor {
  id: string;
  companyName: string;
  deploymentOptions: string;       // e.g., "Cloud, On-Premise, Hybrid"
  pricingRange: string;            // e.g., "RANGE_50K_100K"
  implementationTimeline: number;  // Days (e.g., 60, 90, 120)
  // ... other fields
}
```

**Priorities Data** (from AssessmentPriorities model):
```typescript
interface AssessmentPriorities {
  budgetRange: BudgetRange;        // e.g., "RANGE_50K_100K"
  deploymentPreference: string[];  // e.g., ["Cloud", "Hybrid"]
  mustHaveFeatures: string[];      // e.g., ["Real-time monitoring", "API integration"]
  implementationUrgency: string;   // e.g., "ASAP", "3-6 months"
  // ... other fields
}
```

### Calculation Logic
[Source: backend/src/matching/base-scorer.ts, priority-boost.ts]

**Budget Fit Scoring:**
```typescript
// Backend logic (read-only reference)
if (priceRangesOverlap(userBudget, vendorPrice)) {
  priceScore = 20; // Within budget
} else if (priceWithinTolerance(userBudget, vendorPrice, 0.25)) {
  priceScore = 10; // Within 25% tolerance
} else {
  priceScore = 0; // Over budget
}

// Frontend display:
priceScore === 20 → "Within Budget" (green)
priceScore === 10 → "Slightly Over Budget (+25%)" (yellow)
priceScore === 0 → "Over Budget" (red)
```

**Deployment Boost Scoring:**
```typescript
// Backend logic (read-only reference)
if (vendorDeploymentOptions.includes(userPreference)) {
  deploymentBoost = 5; // Matches preference
} else {
  deploymentBoost = 0; // Doesn't match
}

// Frontend display:
deploymentBoost === 5 → "Matches Your Preference" (green CheckCircle)
deploymentBoost === 0 → "Doesn't Match Preference" (gray XCircle)
```

**Implementation Speed Boost:**
```typescript
// Backend logic (read-only reference)
if (vendor.implementationTimeline <= 90) {
  speedBoost = 5; // Fast implementation
} else {
  speedBoost = 0; // Slower implementation
}

// Frontend display:
speedBoost === 5 → "Fast Implementation (≤90 days)" (green badge)
speedBoost === 0 → "Standard Timeline (>90 days)" (gray badge)
```

### Comparative Insights Algorithm

**Insight Generation Logic:**
```typescript
function generateComparativeInsights(
  vendor1: VendorMatchScore,
  vendor2: VendorMatchScore
): Insight[] {
  const insights: Insight[] = [];

  // 1. Overall Score Advantage
  const scoreDiff = Math.abs(vendor1.totalScore - vendor2.totalScore);
  const scorePercent = (scoreDiff / Math.max(vendor1.totalScore, vendor2.totalScore)) * 100;
  if (scorePercent >= 10) {
    const winner = vendor1.totalScore > vendor2.totalScore ? 'vendor1' : 'vendor2';
    insights.push({
      type: 'overall',
      message: `Vendor ${winner === 'vendor1' ? 'A' : 'B'} scores ${scorePercent.toFixed(0)}% higher overall`,
      advantage: winner
    });
  }

  // 2. Gap Coverage Advantage
  const gapDiff = Math.abs(
    vendor1.baseScore.riskAreaCoverage - vendor2.baseScore.riskAreaCoverage
  );
  if (gapDiff >= 5) { // 5 points = ~12.5% difference in coverage
    const winner = vendor1.baseScore.riskAreaCoverage > vendor2.baseScore.riskAreaCoverage ? 'vendor1' : 'vendor2';
    insights.push({
      type: 'gaps',
      message: `Vendor ${winner === 'vendor1' ? 'A' : 'B'} addresses more of your critical compliance gaps`,
      advantage: winner
    });
  }

  // 3. Priority Alignment Advantage
  if (vendor1.priorityBoost.topPriorityBoost > vendor2.priorityBoost.topPriorityBoost) {
    insights.push({
      type: 'priority',
      message: `Vendor A better aligns with your top priorities`,
      advantage: 'vendor1'
    });
  } else if (vendor2.priorityBoost.topPriorityBoost > vendor1.priorityBoost.topPriorityBoost) {
    insights.push({
      type: 'priority',
      message: `Vendor B better aligns with your top priorities`,
      advantage: 'vendor2'
    });
  }

  // 4. Feature Completeness
  const vendor1MissingCount = vendor1.priorityBoost.missingFeatures.length;
  const vendor2MissingCount = vendor2.priorityBoost.missingFeatures.length;
  if (vendor1MissingCount < vendor2MissingCount) {
    insights.push({
      type: 'features',
      message: `Vendor A has ${vendor2MissingCount - vendor1MissingCount} more of your must-have features`,
      advantage: 'vendor1'
    });
  } else if (vendor2MissingCount < vendor1MissingCount) {
    insights.push({
      type: 'features',
      message: `Vendor B has ${vendor1MissingCount - vendor2MissingCount} more of your must-have features`,
      advantage: 'vendor2'
    });
  }

  // 5. Budget Fit
  if (vendor1.baseScore.priceScore > vendor2.baseScore.priceScore) {
    insights.push({
      type: 'budget',
      message: vendor1.baseScore.priceScore === 20 ? `Vendor A is within your budget` : `Vendor A is closer to your budget`,
      advantage: 'vendor1'
    });
  } else if (vendor2.baseScore.priceScore > vendor1.baseScore.priceScore) {
    insights.push({
      type: 'budget',
      message: vendor2.baseScore.priceScore === 20 ? `Vendor B is within your budget` : `Vendor B is closer to your budget`,
      advantage: 'vendor2'
    });
  }

  // 6. Implementation Speed
  if (vendor1.priorityBoost.speedBoost > vendor2.priorityBoost.speedBoost) {
    insights.push({
      type: 'speed',
      message: `Vendor A offers faster implementation`,
      advantage: 'vendor1'
    });
  } else if (vendor2.priorityBoost.speedBoost > vendor1.priorityBoost.speedBoost) {
    insights.push({
      type: 'speed',
      message: `Vendor B offers faster implementation`,
      advantage: 'vendor2'
    });
  }

  return insights;
}
```

### Component Architecture

**New Components:**
```
PremiumComparisonView (extended from Story 13.3)
├─ NEW: Insights Summary Section (Task 6)
│   └─ <ComparativeInsights insights={generatedInsights} />
├─ Score & Charts Section (from Story 13.2)
├─ Match Reasons Section (from Story 13.3)
├─ Gap Coverage Matrix (from Story 13.3)
├─ NEW: Deployment & Timeline Section (Tasks 3, 4)
│   ├─ <DeploymentComparison vendor1={...} vendor2={...} userPreference={...} />
│   └─ <TimelineComparison vendor1={...} vendor2={...} />
├─ NEW: Budget Fit Section (Task 5)
│   └─ <BudgetFitComparison vendor1={...} vendor2={...} userBudget={...} />
└─ Feature Coverage Section (Task 2 - enhanced from 13.3)
    └─ <FeatureCoverageBreakdown vendor1={...} vendor2={...} mustHaveFeatures={...} />
```

### Styling and UI Patterns

**Insights Summary Card:**
```tsx
<Card className="bg-gradient-to-br from-cyan-900/20 to-purple-900/20 border-cyan-500/30">
  <CardHeader className="flex items-center gap-2">
    <Sparkles className="h-6 w-6 text-cyan-400 animate-pulse" />
    <h3 className="text-xl font-bold">AI-Powered Insights</h3>
  </CardHeader>
  <CardContent>
    <ul className="space-y-3">
      {insights.map(insight => (
        <li className={`flex items-start gap-2 ${
          insight.advantage === 'vendor1' ? 'text-cyan-400' :
          insight.advantage === 'vendor2' ? 'text-pink-400' : 'text-gray-400'
        }`}>
          <TrendingUp className="h-5 w-5 mt-0.5" />
          <span>{insight.message}</span>
        </li>
      ))}
    </ul>
    <div className="mt-6 p-4 bg-gray-800/50 rounded-lg">
      <p className="font-semibold text-green-400">
        Summary Recommendation: Based on your assessment, Vendor A is the stronger match
      </p>
    </div>
  </CardContent>
</Card>
```

**Budget Fit Comparison:**
```tsx
<div className="grid grid-cols-3 gap-4">
  <div className="text-gray-400">Your Budget</div>
  <div className="text-center">{formatBudgetRange(userBudget)}</div>
  <div></div>

  <div className="font-semibold">Vendor A</div>
  <div className="text-center">{formatBudgetRange(vendor1.pricing)}</div>
  <div>
    {priceScore1 === 20 && <Badge className="bg-green-500">Within Budget ✓</Badge>}
    {priceScore1 === 10 && <Badge className="bg-yellow-500">+25% Over ⚠</Badge>}
    {priceScore1 === 0 && <Badge className="bg-red-500">Over Budget ✗</Badge>}
  </div>

  <div className="font-semibold">Vendor B</div>
  <div className="text-center">{formatBudgetRange(vendor2.pricing)}</div>
  <div>
    {priceScore2 === 20 && <Badge className="bg-green-500">Within Budget ✓</Badge>}
    {priceScore2 === 10 && <Badge className="bg-yellow-500">+25% Over ⚠</Badge>}
    {priceScore2 === 0 && <Badge className="bg-red-500">Over Budget ✗</Badge>}
  </div>
</div>
```

### File Locations

**Files to Modify:**
- `frontend/src/components/vendor/PremiumComparisonView.tsx` (add insights section)

**New Component Files (optional):**
- `frontend/src/components/vendor/ComparativeInsights.tsx` (insights summary)
- `frontend/src/components/vendor/DeploymentComparison.tsx` (deployment model comparison)
- `frontend/src/components/vendor/TimelineComparison.tsx` (implementation timeline)
- `frontend/src/components/vendor/BudgetFitComparison.tsx` (budget indicators)

**New Utility Files:**
- `frontend/src/utils/vendorInsights.ts` (generateComparativeInsights function)
- `frontend/src/utils/formatters.ts` (budget range, timeline formatting)

### Technical Constraints
[Source: docs/architecture.md#compatibility-requirements]

**Data Validation:**
- All insights must be derived from matchDetails data
- Never generate insights based on assumptions or hardcoded logic
- If data is missing (e.g., implementationTimeline), show "Not Available" instead of guessing

**Performance:**
- Insight generation should be memoized with useMemo
- Only recalculate when vendor matchDetails change
- Keep insight generation function pure (no side effects)

## Testing

[Source: docs/architecture.md#tech-stack - Testing Framework]

### Testing Standards

**Testing Framework:** React Testing Library + Vitest
**Test File Location:** `frontend/src/components/__tests__/VendorComparison.premium.test.tsx` (extend)
**Utility Tests:** `frontend/src/utils/__tests__/vendorInsights.test.ts`

### Test Cases

1. **Comparative Insights Generation**
   - Mock vendor1 with totalScore: 120, vendor2 with totalScore: 90
   - Call generateComparativeInsights()
   - Assert insight: "Vendor A scores 25% higher overall"
   - Assert advantage: 'vendor1'

2. **Feature Coverage Breakdown**
   - Mock vendor1 with 10/10 features (100%), vendor2 with 8/10 features (80%)
   - Render Feature Coverage section
   - Assert progress circle shows 100% and 80%
   - Assert "Best Feature Fit" badge on vendor1

3. **Deployment Model Comparison**
   - Mock user preference: ["Cloud"], vendor1: "Cloud, On-Premise", vendor2: "On-Premise"
   - Render Deployment Comparison
   - Assert vendor1 shows CheckCircle for Cloud (matches)
   - Assert vendor2 shows XCircle for Cloud (doesn't match)
   - Assert vendor1 highlighted with green background

4. **Implementation Timeline Comparison**
   - Mock vendor1: 60 days (≤90), vendor2: 120 days (>90)
   - Render Timeline Comparison
   - Assert vendor1 shows "1-3 Months" with "Faster Implementation" badge
   - Assert vendor2 shows "3-6 Months"

5. **Budget Fit Indicators**
   - Mock userBudget: "RANGE_50K_100K", vendor1 priceScore: 20, vendor2 priceScore: 0
   - Render Budget Fit section
   - Assert vendor1 shows "Within Budget ✓" green badge
   - Assert vendor2 shows "Over Budget ✗" red badge

6. **Insights Summary Recommendation**
   - Mock vendor1 with higher totalScore
   - Render Insights Summary
   - Assert recommendation: "Based on your assessment, Vendor A is the stronger match"
   - Assert recommendation styled with green color

7. **Edge Case: Equal Scores**
   - Mock both vendors with identical totalScore (100)
   - Generate insights
   - Assert no overall score advantage insight generated
   - Assert other differentiating insights still present (gaps, features, etc.)

8. **Edge Case: Missing Data**
   - Mock vendor without implementationTimeline field
   - Render Timeline Comparison
   - Assert displays "Not Available" instead of throwing error

### Testing Requirements

- Test insight generation function separately from component rendering
- Mock all matchDetails data structures
- Verify no insights generated from hardcoded logic
- Test responsive layout for insights cards
- Verify accessibility: ARIA labels for badges and indicators

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-28 | 1.0 | Initial story creation for Epic 13: Premium Vendor Comparison - Advanced Insights | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
_To be populated during implementation_

### Debug Log References
_To be populated during implementation_

### Completion Notes List
_To be populated during implementation_

### File List
_To be populated during implementation_

## QA Results
_To be populated by QA Agent after implementation_
