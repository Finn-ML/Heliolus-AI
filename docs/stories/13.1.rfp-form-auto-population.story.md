# Story 13.1: RFP Form & Auto-Population System

## Status
Draft

## Story

**As a** Premium user
**I want** to create a detailed RFP with auto-populated strategic context
**So that** I can efficiently engage vendors with comprehensive requirements

## Acceptance Criteria

1. RFP form includes fields:
   - Company overview (auto-populated from Organization)
   - Project objectives (auto-populated from Strategic Roadmap)
   - Technical requirements (manual + auto-suggested from gaps)
   - Timeline & budget constraints
   - Document uploads (drag-and-drop, multi-file support)
   - Vendor selection (multi-select from matched vendors)
2. Auto-population button pre-fills strategic roadmap data
3. Document upload supports: PDF, DOCX, XLSX (max 10MB per file, 5 files max)
4. Form validation prevents submission without required fields
5. API: `POST /v1/rfp` creates RFP record
6. API: `GET /v1/organization/:id/strategic-roadmap` retrieves context
7. API: `POST /v1/rfp/:id/documents` handles file uploads to S3
8. Database: New `RFP` model with relationships to User, Organization, Vendor[]

## Tasks / Subtasks

### Backend Tasks

- [ ] **Task 1: Database Schema Migration** (AC: 8)
  - [ ] Add `RFP` model to Prisma schema with fields: id, userId, organizationId, title, objectives, requirements, timeline, budget, documents (String[]), vendorIds (String[]), status (RFPStatus), sentAt, createdAt, updatedAt
  - [ ] Add `RFPStatus` enum: DRAFT, SENT, ACTIVE, CLOSED, ARCHIVED
  - [ ] Add `rfpId` field (String?) to VendorContact model
  - [ ] Add RFP relation to User and Organization models
  - [ ] Add ContactType enum value: RFP
  - [ ] Create and apply Prisma migration: `npm run db:migrate`
  - [ ] Generate Prisma client: `npm run db:generate`

- [ ] **Task 2: RFP Service** (AC: 5, 8)
  - [ ] Create `backend/src/services/rfp.service.ts` extending BaseService
  - [ ] Implement `createRFP(userId, organizationId, data)` method with Zod validation
  - [ ] Implement `getRFPById(id, userId)` with authorization check (owner only)
  - [ ] Implement `updateRFP(id, userId, updates)` for editing draft RFPs
  - [ ] Implement `deleteDraft(id, userId)` for draft cleanup
  - [ ] Add input validation schemas with Zod (title required, objectives optional, etc.)

- [ ] **Task 3: Strategic Roadmap API** (AC: 2, 6)
  - [ ] Create `backend/src/services/strategic-roadmap.service.ts`
  - [ ] Implement `getStrategicRoadmap(organizationId)` aggregating:
    - Organization profile (name, industry, size, description, annualRevenue, complianceTeamSize, geography)
    - Latest completed Assessment with Priorities (from AssessmentPriorities)
    - Top 5 prioritized Gaps (severity HIGH or CRITICAL, sorted by priority)
    - Strategy Matrix data if available (phased roadmap)
  - [ ] Return structured JSON: `{ organizationProfile, assessmentContext, topGaps, phasedRoadmap }`
  - [ ] Handle case where no assessment exists (return organization profile only)

- [ ] **Task 4: Document Upload for RFP** (AC: 3, 7)
  - [ ] Extend document.service.ts with `uploadRFPDocument(rfpId, file)` method
  - [ ] Validate file types: PDF, DOCX, XLSX only
  - [ ] Validate file size: Max 10MB per file
  - [ ] Upload to Replit Object Storage (path: `rfp/{rfpId}/{filename}`)
  - [ ] Store S3 URL in RFP.documents array (append, max 5 files)
  - [ ] Return upload confirmation with document URL

- [ ] **Task 5: RFP API Routes** (AC: 5, 6, 7)
  - [ ] Create `backend/src/routes/rfp.routes.ts`
  - [ ] Add route: `POST /v1/rfp` (create RFP, requires authentication + Premium tier)
    - Request body: { title, objectives?, requirements?, timeline?, budget?, vendorIds[] }
    - Returns: RFP object with status: DRAFT
  - [ ] Add route: `GET /v1/organization/:id/strategic-roadmap` (requires authentication, owner check)
    - Returns: Strategic roadmap data (organization + assessment + gaps + roadmap)
  - [ ] Add route: `POST /v1/rfp/:id/documents` (file upload, multipart/form-data)
    - Validates: Premium tier, RFP owner, file count ≤ 5, file size ≤ 10MB
    - Returns: Updated RFP with new document URL in documents array
  - [ ] Add route: `GET /v1/rfp/:id` (retrieve RFP details, owner only)
  - [ ] Add route: `PATCH /v1/rfp/:id` (update draft RFP, owner only, status must be DRAFT)
  - [ ] Register routes in server.ts

- [ ] **Task 6: Premium Tier Middleware** (AC: 5, 7)
  - [ ] Create `backend/src/middleware/premium-tier.middleware.ts`
  - [ ] Implement `requirePremiumTier` middleware checking user's Subscription.plan
  - [ ] Return 403 Forbidden with message: "This feature requires a Premium subscription. Upgrade to unlock."
  - [ ] Apply middleware to: POST /v1/rfp, POST /v1/rfp/:id/documents

### Frontend Tasks

- [ ] **Task 7: RFP Form Component** (AC: 1, 2, 3, 4)
  - [ ] Create `frontend/src/components/rfp/RFPFormModal.tsx`
  - [ ] Use React Hook Form + Zod for form validation
  - [ ] Add form fields:
    - Title (text input, required)
    - Company Overview (textarea, auto-populated, editable)
    - Project Objectives (textarea, auto-populated, editable)
    - Technical Requirements (textarea, required)
    - Timeline (select: <3mo, 3-6mo, 6-12mo, 12mo+)
    - Budget (select: <50K, 50K-100K, 100K-500K, 500K+, 1M+)
    - Vendor Selection (multi-select dropdown from matched vendors)
  - [ ] Add "Auto-Fill Strategic Context" button triggering roadmap API call
  - [ ] Implement drag-and-drop document upload area using react-dropzone
  - [ ] Display uploaded files with remove button (max 5 files)
  - [ ] Show file validation errors (unsupported type, size > 10MB)
  - [ ] Add form validation: Required fields, file count/size limits
  - [ ] Submit button disabled until validation passes

- [ ] **Task 8: Auto-Population Logic** (AC: 2, 6)
  - [ ] Create API hook: `useStrategicRoadmap(organizationId)` using TanStack Query
  - [ ] On "Auto-Fill" button click:
    - Fetch strategic roadmap data from API
    - Pre-fill "Company Overview" with organization profile summary
    - Pre-fill "Project Objectives" with assessment goals + top gaps summary
    - Auto-suggest "Technical Requirements" from top gaps (user can edit)
  - [ ] Show loading spinner during fetch
  - [ ] Handle errors with toast notification

- [ ] **Task 9: Document Upload UI** (AC: 3, 7)
  - [ ] Integrate react-dropzone for drag-and-drop area
  - [ ] Display upload progress bar per file
  - [ ] Show uploaded files list with:
    - File name, size, type icon
    - Remove button (delete from array, not from storage)
  - [ ] Validate client-side: PDF/DOCX/XLSX only, max 10MB, max 5 files
  - [ ] Upload files on selection using `POST /v1/rfp/:id/documents`
  - [ ] Update RFP.documents array after successful upload

- [ ] **Task 10: Vendor Multi-Select** (AC: 1)
  - [ ] Create vendor multi-select dropdown component
  - [ ] Fetch matched vendors for user's latest assessment
  - [ ] Display vendors with: Company name, category badges, match score
  - [ ] Allow selection of multiple vendors
  - [ ] Show selected count badge
  - [ ] Store selected vendor IDs in form state

- [ ] **Task 11: Form Submission & API Integration** (AC: 4, 5)
  - [ ] Create mutation hook: `useCreateRFP()` using TanStack Query
  - [ ] On form submit:
    - Validate all required fields
    - Call `POST /v1/rfp` with form data
    - Handle success: Show success toast, close modal, redirect to RFP dashboard
    - Handle errors: Display error message (403 = upgrade prompt, 400 = validation)
  - [ ] Save as draft automatically every 2 minutes (background save)

- [ ] **Task 12: RFP Creation Entry Point** (AC: 1)
  - [ ] Add "Create RFP" button on vendor results page
  - [ ] Add "Create RFP" button on assessment complete page
  - [ ] Check user tier: Premium users see enabled button, Free users see disabled with tooltip
  - [ ] On click: Open RFP form modal
  - [ ] Pre-select vendors if coming from vendor results page

### Testing

- [ ] **Task 13: Backend Unit Tests** (AC: 5, 6, 7, 8)
  - [ ] Test rfp.service.ts: createRFP, getRFPById, updateRFP with valid/invalid inputs
  - [ ] Test strategic-roadmap.service.ts: aggregation logic, handle missing assessments
  - [ ] Test document upload: file type validation, size limits, S3 storage
  - [ ] Test premium tier middleware: valid/invalid subscriptions

- [ ] **Task 14: API Contract Tests** (AC: 5, 6, 7)
  - [ ] Test POST /v1/rfp: Create RFP as Premium user (201), as Free user (403)
  - [ ] Test GET /v1/organization/:id/strategic-roadmap: Valid org (200), non-owner (403)
  - [ ] Test POST /v1/rfp/:id/documents: Valid file (200), oversized file (400), wrong type (400), 6th file (400)

- [ ] **Task 15: Frontend Component Tests**
  - [ ] Test RFP form validation: required fields, file limits
  - [ ] Test auto-population: API call, field pre-fill
  - [ ] Test document upload: drag-and-drop, progress, error handling
  - [ ] Test form submission: success, error cases

## Dev Notes

### Project Context
This story implements the first major component of Epic 13: RFP & Vendor Engagement System. It enables Premium users to create detailed RFPs with auto-populated strategic context from their assessment results and organization profile, laying the foundation for vendor engagement features in subsequent stories.

[Source: docs/prd/epic-13-rfp-vendor-engagement.md]

### Tech Stack
- **Frontend**: Vite + React 18 + TypeScript 5.5 | TanStack Query 5 | Zustand | Radix UI | TailwindCSS | React Hook Form + Zod | react-dropzone
- **Backend**: Fastify 4 + TypeScript 5.2 | Prisma 6 (PostgreSQL) | @fastify/jwt | Redis (ioredis)
- **Storage**: Replit Object Storage (NOT AWS S3 - important!)
- **Infrastructure**: PostgreSQL 15 | Redis 7 | Docker Compose

[Source: CLAUDE.md#Tech Stack]

### Database Schema

**New RFP Model (to be added to backend/prisma/schema.prisma):**
```prisma
model RFP {
  id             String   @id @default(cuid())
  userId         String
  organizationId String

  // RFP Content
  title          String
  objectives     String   // Auto-populated from strategic roadmap
  requirements   String   // Technical requirements
  timeline       String?  // Project timeline
  budget         String?  // Budget range

  // Documents
  documents      String[] // Replit Object Storage URLs

  // Vendors
  vendorIds      String[] // Vendors this RFP will be sent to

  // Status
  status         RFPStatus @default(DRAFT)
  sentAt         DateTime?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  user           User         @relation(fields: [userId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contacts       VendorContact[]

  @@index([userId])
  @@index([organizationId])
  @@index([status])
  @@index([sentAt])
}

enum RFPStatus {
  DRAFT
  SENT
  ACTIVE
  CLOSED
  ARCHIVED
}
```

**VendorContact Enhancement:**
Add optional `rfpId` field to link contacts created from RFPs:
```prisma
model VendorContact {
  // ... existing fields
  rfpId  String?
  rfp    RFP?    @relation(fields: [rfpId], references: [id])
}
```

**ContactType Enhancement:**
Add RFP value to existing ContactType enum:
```prisma
enum ContactType {
  GENERAL_INQUIRY   // Existing
  DEMO_REQUEST      // Existing
  PRICING_INQUIRY   // Existing
  RFP               // NEW
}
```

[Source: docs/prd/epic-13-rfp-vendor-engagement.md#Database Schema Changes]

### Existing Models Referenced

**Organization Model:**
Contains business profile fields used for auto-population: name, industry, size, description, annualRevenue, complianceTeamSize, geography, country.
Location: backend/prisma/schema.prisma:327-364

**AssessmentPriorities Model:**
6-step questionnaire data including goals, timeline, use cases, budget, vendor preferences. Used for strategic roadmap objectives.
Location: backend/prisma/schema.prisma:1116-1156

**Vendor, VendorMatch Models:**
Used for vendor multi-select dropdown. VendorMatch provides matched vendors for user's assessment.
Location: backend/prisma/schema.prisma:634-688 (Vendor), 735-760 (VendorMatch)

[Source: backend/prisma/schema.prisma]

### API Patterns

**Authentication:**
- All RFP routes require JWT authentication via `@fastify/jwt`
- Bearer token sent in Authorization header
- User context available in `request.user` after authentication
- RBAC middleware used for role checks (USER/ADMIN/VENDOR)

**Authorization:**
- Users can only access their own RFPs (check userId matches request.user.id)
- Premium tier check required for RFP creation (Subscription.plan = PREMIUM)

**API Response Pattern:**
```typescript
interface ApiResponse<T> {
  success: boolean;
  data: T;
  message?: string;
}
```

[Source: CLAUDE.md#API Architecture]

### File Upload Patterns

**Replit Object Storage (NOT AWS S3):**
- Service: `ObjectStorageService` from `backend/src/objectStorage`
- Allowed MIME types: PDF, DOCX, XLSX (see document.service.ts ALLOWED_MIME_TYPES)
- Max file size: 50MB per file (document.service.ts uses this, but RFP limits to 10MB)
- Storage path pattern: `rfp/{rfpId}/{filename}`
- Validation: File type, size, count limits enforced server-side

**Document Upload Flow:**
1. Frontend uploads file via multipart/form-data to `POST /v1/rfp/:id/documents`
2. Backend validates: file type, size (≤ 10MB), count (≤ 5), Premium tier, ownership
3. Upload to Replit Object Storage using ObjectStorageService
4. Store URL in RFP.documents array (String[])
5. Return updated RFP object

[Source: backend/src/services/document.service.ts:1-80]

### Service Architecture Pattern

**BaseService Extension:**
All services extend `BaseService` class with:
- Constructor dependency injection (Prisma client, logger, config)
- Cleanup lifecycle methods
- Async/await error handling
- Transaction support

**New RFP Service Pattern:**
```typescript
export class RFPService extends BaseService {
  constructor(context: ServiceContext) {
    super(context);
  }

  async createRFP(userId: string, organizationId: string, data: CreateRFPInput): Promise<RFP> {
    // Validate with Zod
    // Create RFP with Prisma
    // Return RFP object
  }

  // ... other methods
}
```

[Source: CLAUDE.md#Core Architecture, backend/src/services/base.service.ts pattern]

### Frontend Component Patterns

**Form Handling:**
- Use React Hook Form for form state management
- Zod schemas for validation
- Error display with inline error messages

**API Integration:**
- TanStack Query for data fetching (useQuery, useMutation)
- Centralized API client in `frontend/src/lib/api.ts`
- Automatic JWT token injection
- 401 auto-logout handling

**UI Components:**
- Radix UI primitives (Dialog, Select, Button, Input, Textarea)
- TailwindCSS for styling
- Responsive design patterns

**File Upload:**
- Use react-dropzone library for drag-and-drop
- Show upload progress with progress bar
- Client-side validation before upload

[Source: CLAUDE.md#API Architecture, frontend/src/lib/api.ts]

### Strategic Roadmap Data Sources

The "strategic roadmap" for auto-population aggregates data from multiple sources:

1. **Organization Profile** (Organization model):
   - Company name, industry, size, description
   - Annual revenue, compliance team size, geography

2. **Assessment Context** (Assessment + AssessmentPriorities):
   - Latest completed assessment
   - User's goals, timeline, implementation urgency (from priorities questionnaire)
   - Selected use cases and ranked priorities

3. **Top Gaps** (Gap model):
   - High/Critical severity gaps from latest assessment
   - Gap descriptions, categories, affected areas

4. **Phased Roadmap** (Strategy Matrix, if available):
   - 0-6 month priorities
   - 6-18 month initiatives
   - 18+ month strategic goals

Strategic Roadmap Service should aggregate this data into a structured JSON response.

[Source: backend/prisma/schema.prisma models, docs/architecture.md]

### Premium Tier Check

**Subscription Model:**
- `Subscription.plan` enum: FREE, PREMIUM
- Premium features require `plan = PREMIUM`
- Check in middleware: `requirePremiumTier`
- Frontend: Conditional rendering based on user's subscription plan

**Error Handling:**
- 403 Forbidden if Free user attempts RFP creation
- Message: "This feature requires a Premium subscription. Upgrade to unlock."
- Frontend shows upgrade modal with CTA to /settings/subscription

[Source: docs/prd/epic-13-rfp-vendor-engagement.md#Story 13.5]

### File Locations

**Backend:**
- New service: `backend/src/services/rfp.service.ts`
- New service: `backend/src/services/strategic-roadmap.service.ts`
- New middleware: `backend/src/middleware/premium-tier.middleware.ts`
- New routes: `backend/src/routes/rfp.routes.ts`
- Schema update: `backend/prisma/schema.prisma` (add RFP model, enums)

**Frontend:**
- New component: `frontend/src/components/rfp/RFPFormModal.tsx`
- New hook: `frontend/src/hooks/useStrategicRoadmap.ts`
- New hook: `frontend/src/hooks/useCreateRFP.ts`
- API client update: `frontend/src/lib/api.ts` (add RFP endpoints)

[Source: CLAUDE.md#Project Structure]

### Testing

**Backend Testing:**
- Test framework: Vitest
- Location: `backend/tests/`
- Unit tests: Service methods with mocked Prisma
- Contract tests: API routes with actual HTTP requests

**Frontend Testing:**
- Test framework: (Planned: React Testing Library, not yet implemented)
- Focus on: Form validation, API integration, component rendering

**Commands:**
- Run backend tests: `npm run test` (from backend/)
- Run contract tests: `npm run test:contract` (from backend/)

[Source: CLAUDE.md#Development Commands, CLAUDE.md#Testing]

### Security Considerations

**Input Validation:**
- All API inputs validated with Zod schemas
- File uploads: Type, size, count validation
- SQL injection prevention: Prisma ORM parameterized queries

**Authorization:**
- JWT token verification on all routes
- Owner checks: Users can only access their own RFPs
- Premium tier enforcement: Middleware blocks Free users

**File Upload Security:**
- Whitelist allowed MIME types (PDF, DOCX, XLSX)
- File size limits: Max 10MB per file, 5 files total
- Store files with unique paths: `rfp/{rfpId}/{filename}`

[Source: docs/prd/epic-13-rfp-vendor-engagement.md#Technical Considerations]

### Performance Considerations

**Database:**
- Add indexes: userId, organizationId, status, sentAt on RFP model
- Strategic roadmap query optimization: Single query with joins where possible
- Limit returned gaps to top 5 (avoid large data transfers)

**File Uploads:**
- Direct upload to Replit Object Storage (not through backend buffer)
- Progress tracking for better UX
- Max 5 files to limit storage growth

**Frontend:**
- TanStack Query caching for strategic roadmap data
- Auto-save drafts every 2 minutes (background operation)
- Lazy load vendor list (paginated if needed)

[Source: docs/prd/epic-13-rfp-vendor-engagement.md#Technical Considerations]

### Integration Points

**Existing Services:**
- `document.service.ts`: Extend with `uploadRFPDocument()` method
- `organization.service.ts`: Referenced for organization data
- `assessment.service.ts`: Referenced for latest assessment
- `vendor.service.ts`: Referenced for vendor listing

**Existing Routes:**
- Register new `rfp.routes.ts` in `backend/src/server.ts`
- Apply authentication middleware to all RFP routes

**Existing Middleware:**
- Use existing auth middleware from `backend/src/middleware/auth.middleware.ts`
- Create new premium tier middleware following same pattern

[Source: CLAUDE.md#Core Architecture]

### Backward Compatibility

**No Breaking Changes:**
- RFP model is new, doesn't affect existing tables
- VendorContact.rfpId is optional (nullable), existing contacts unaffected
- ContactType enum addition is additive (existing values unchanged)
- No changes to existing API endpoints

**Safe Migration:**
- Prisma migration will add new tables/fields without data loss
- Existing assessments, organizations, vendors work as before

[Source: docs/prd/epic-13-rfp-vendor-engagement.md#Compatibility Requirements]

### Testing

#### Backend Testing Standards

**Test Framework:** Vitest
**Test Location:** `backend/tests/`

**Service Tests:**
- File: `backend/tests/services/rfp.service.test.ts`
- Mock Prisma client for unit tests
- Test positive and negative cases for all methods
- Example:
  ```typescript
  describe('RFPService', () => {
    it('should create RFP with valid data', async () => { ... });
    it('should throw error for missing required fields', async () => { ... });
  });
  ```

**Contract Tests:**
- File: `backend/tests/contract/rfp.routes.test.ts`
- Use actual HTTP requests via Fastify test server
- Test authentication, authorization, validation
- Test Premium tier enforcement (403 for Free users)

**Run Commands:**
- Unit tests: `npm run test` (from backend/)
- Contract tests: `npm run test:contract` (from backend/)

[Source: CLAUDE.md#Testing, backend/tests/ structure]

#### Frontend Testing Standards

**Test Framework:** (Planned: React Testing Library, not yet fully implemented)
**Focus Areas:**
- Form validation behavior
- API integration with mocked responses
- Component rendering and user interactions
- File upload flow

**Example Test Structure:**
```typescript
describe('RFPFormModal', () => {
  it('should display validation errors for required fields', () => { ... });
  it('should auto-populate fields when auto-fill button clicked', () => { ... });
  it('should prevent upload of files > 10MB', () => { ... });
});
```

[Source: CLAUDE.md#Testing]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-27 | 1.0 | Initial story creation for Epic 13: RFP System | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
(To be populated by dev agent)

### Debug Log References
(To be populated by dev agent)

### Completion Notes List
(To be populated by dev agent)

### File List
(To be populated by dev agent)

## QA Results
(To be populated by QA agent)
