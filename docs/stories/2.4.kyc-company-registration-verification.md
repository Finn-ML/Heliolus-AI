# Story 2.4: KYC Company Registration Verification with OpenCorporates

## Status
üìù **DRAFT** - Ready for Review

## Story

**As a** platform administrator managing compliance and user verification,
**I want** to capture and verify company registration details during user signup using OpenCorporates API,
**so that** we can ensure legitimate business users, meet KYC requirements, and reduce fraudulent registrations.

## Acceptance Criteria

1. **Registration Form Enhancement**
   - Add "Country" dropdown field to registration form (required)
   - Add "Company Registration Number / Tax ID" text field (optional)
   - Field label dynamically changes based on selected country:
     - US: "EIN or State Registration Number"
     - UK: "Company Number or VAT Number"
     - EU: "VAT Number or Registration Number"
     - Others: "Registration Number or Tax ID"
   - Add help text showing format examples per country
   - Form validation enforces country selection before submission

2. **Database Schema Updates**
   - Add `registrationNumber` field to Organization model (String, optional)
   - Add `taxIdVerified` field to Organization model (Boolean, default: false)
   - Add `verificationStatus` enum field with values: PENDING, VERIFIED, FAILED, MANUAL_REVIEW
   - Add `verificationDate` field (DateTime, optional)
   - Add `opencorporatesUrl` field (String, optional) - link to company on OpenCorporates
   - Add `legalStatus` field (String, optional) - e.g., "active", "dissolved"
   - Create Prisma migration for schema changes

3. **OpenCorporates API Integration**
   - Create `KYCService` class (`backend/src/services/kyc.service.ts`)
   - Implement `verifyCompany(registrationNumber, jurisdiction)` method
   - Implement `searchCompany(name, jurisdiction)` method (for future use)
   - Map user's selected country to OpenCorporates jurisdiction code
   - Handle API errors gracefully (404, rate limits, network errors)
   - Store verification results in Organization model
   - Log all verification attempts to AuditLog

4. **Backend API Updates**
   - Update `POST /v1/auth/register` endpoint to accept new fields
   - Add Zod validation for `country` and `registrationNumber` fields
   - Call KYCService after organization creation (async, non-blocking)
   - Store verification status in database
   - Return registration success even if verification fails (don't block signup)

5. **Environment Configuration**
   - Add `OPENCORPORATES_API_KEY` to `.env.example`
   - Add `OPENCORPORATES_API_URL` (default: https://api.opencorporates.com/v0.4)
   - Add `KYC_VERIFICATION_ENABLED` flag (default: false for dev, true for prod)
   - Document setup instructions in README

6. **Admin Review Interface**
   - Add "KYC Verification" section to Admin User Management page
   - Display verification status badge: PENDING, VERIFIED, FAILED, MANUAL_REVIEW
   - Show company details from OpenCorporates (if verified)
   - Add "Mark as Verified" button for manual approval
   - Add "Mark as Failed" button with reason field
   - Filter users by verification status

7. **Error Handling & Logging**
   - Log all KYC verification attempts to AuditLog with metadata
   - Handle OpenCorporates API errors:
     - 404: Company not found ‚Üí Status: MANUAL_REVIEW
     - 429: Rate limit ‚Üí Status: PENDING, retry later
     - 500: API error ‚Üí Status: PENDING, retry later
   - Display user-friendly error messages in registration form
   - Admin can view error logs in audit trail

8. **Free Tier Management**
   - Implement request counter for OpenCorporates API (500/month limit)
   - Add warning when approaching 80% of limit (400 requests)
   - Disable auto-verification when limit reached (manual review only)
   - Display admin notification when limit exceeded
   - Track monthly usage in database

## Tasks / Subtasks

- [ ] Update database schema (AC: 2)
  - [ ] Add new fields to `backend/prisma/schema.prisma`:
    - `registrationNumber String?`
    - `taxIdVerified Boolean @default(false)`
    - `verificationStatus KYCVerificationStatus @default(PENDING)`
    - `verificationDate DateTime?`
    - `opencorporatesUrl String?`
    - `legalStatus String?`
  - [ ] Create `KYCVerificationStatus` enum: PENDING, VERIFIED, FAILED, MANUAL_REVIEW
  - [ ] Run `npm run db:migrate` to create migration
  - [ ] Run `npm run db:generate` to regenerate Prisma client
  - [ ] Verify migration in development database

- [ ] Create KYC Service (AC: 3)
  - [ ] Create `/backend/src/services/kyc.service.ts`
  - [ ] Implement `verifyCompany(registrationNumber, jurisdiction)` method:
    - Makes API call to OpenCorporates
    - Parses response and extracts company data
    - Returns verification result with status
  - [ ] Implement `searchCompany(name, jurisdiction)` method (for admin search)
  - [ ] Create `mapCountryToJurisdiction(country)` helper function:
    - Maps "United States" ‚Üí "us"
    - Maps "United Kingdom" ‚Üí "gb"
    - Maps "Germany" ‚Üí "de"
    - Maps "France" ‚Üí "fr"
    - etc. (see Dev Notes for full mapping)
  - [ ] Handle API errors with proper error codes
  - [ ] Add retry logic for transient errors (429, 500)
  - [ ] Add request logging for debugging

- [ ] Update Registration Backend (AC: 4)
  - [ ] Update `/backend/src/routes/auth.routes.ts`:
    - Add `country` field to RegisterRequestSchema (required)
    - Add `registrationNumber` field to RegisterRequestSchema (optional)
    - Add Zod validation for both fields
  - [ ] Update registration handler:
    - Save country and registrationNumber to Organization model
    - Call KYCService.verifyCompany() asynchronously (don't await)
    - Store verification result in database
    - Continue registration flow (don't block on verification)
  - [ ] Add audit log entry for registration with KYC attempt
  - [ ] Update API response schema to include verificationStatus

- [ ] Update Registration Frontend (AC: 1)
  - [ ] Update `/frontend/src/pages/Register.tsx`:
    - Add country dropdown field (required)
    - Add registrationNumber text field (optional)
    - Create country options list (see Dev Notes for full list)
  - [ ] Add dynamic label helper function:
    - If country === "United States": "EIN or State Registration Number"
    - If country === "United Kingdom": "Company Number or VAT Number"
    - If country starts with "EU-": "VAT Number or Registration Number"
    - Else: "Registration Number or Tax ID"
  - [ ] Add help text with format examples:
    - US: "e.g., 12-3456789 (EIN) or C3268102 (CA)"
    - UK: "e.g., 07444723 or GB123456789"
    - DE: "e.g., HRB12345 or DE123456789"
  - [ ] Update form validation schema (Zod):
    - Country is required
    - RegistrationNumber is optional
    - Min length 5, max length 50
  - [ ] Update registration API call to include new fields
  - [ ] Update form state management to track new fields

- [ ] Create Country Mapping Configuration (AC: 3)
  - [ ] Create `/backend/src/config/country-jurisdictions.ts`
  - [ ] Define mapping object with country ‚Üí jurisdiction code:
    ```typescript
    const COUNTRY_JURISDICTION_MAP = {
      'United States': 'us',
      'United Kingdom': 'gb',
      'Germany': 'de',
      'France': 'fr',
      // ... (see Dev Notes for full list)
    };
    ```
  - [ ] Export helper functions:
    - `getJurisdictionCode(country: string): string`
    - `getCountryLabel(country: string): string`
    - `getRegistrationNumberPlaceholder(country: string): string`
  - [ ] Add unit tests for mapping functions

- [ ] Add Environment Configuration (AC: 5)
  - [ ] Update `/backend/.env.example`:
    - Add `OPENCORPORATES_API_KEY=your_api_key_here`
    - Add `OPENCORPORATES_API_URL=https://api.opencorporates.com/v0.4`
    - Add `KYC_VERIFICATION_ENABLED=false # Set to true in production`
  - [ ] Update `/backend/src/config/env.validation.ts`:
    - Add validation for OPENCORPORATES_API_KEY (optional)
    - Add validation for KYC_VERIFICATION_ENABLED (boolean)
  - [ ] Update README with setup instructions
  - [ ] Add documentation for obtaining OpenCorporates API key

- [ ] Create Admin KYC Review Interface (AC: 6)
  - [ ] Update `/frontend/src/pages/admin/UserManagement.tsx` (or create VendorManagement page):
    - Add "Verification Status" column to users table
    - Display status badge with color coding:
      - PENDING: yellow
      - VERIFIED: green
      - FAILED: red
      - MANUAL_REVIEW: orange
    - Add filter dropdown to filter by verification status
  - [ ] Create KYC details modal component:
    - Display company name, registration number, country
    - Display OpenCorporates data (if verified)
    - Display legal status (active/dissolved)
    - Display verification date
    - Show link to OpenCorporates page
  - [ ] Add action buttons:
    - "Mark as Verified" button (changes status to VERIFIED)
    - "Mark for Review" button (changes status to MANUAL_REVIEW)
    - "Mark as Failed" button (opens modal to enter reason)
  - [ ] Create backend API endpoints:
    - `PUT /v1/admin/kyc/:organizationId/verify` - Manual verification
    - `PUT /v1/admin/kyc/:organizationId/reject` - Reject verification
  - [ ] Add RBAC checks (ADMIN role only)

- [ ] Implement Error Handling & Logging (AC: 7)
  - [ ] Add error handling in KYCService:
    - Catch 404: Set status to MANUAL_REVIEW, log reason
    - Catch 429: Set status to PENDING, schedule retry
    - Catch 500: Set status to PENDING, log error
    - Catch network errors: Set status to PENDING
  - [ ] Add audit log entries:
    - Log all verification attempts with timestamp
    - Log API responses (success and failure)
    - Log manual admin actions (verify/reject)
  - [ ] Create error response handler:
    - Return user-friendly error messages
    - Don't expose API keys or internal errors
  - [ ] Add Sentry/logging integration for API failures

- [ ] Implement Free Tier Management (AC: 8)
  - [ ] Create `KYCUsageTracker` class in KYCService:
    - Track API requests per month
    - Store count in Redis or database
    - Reset counter on first day of month
  - [ ] Add usage check before API call:
    - If usage >= 500: Skip verification, set status to PENDING
    - If usage >= 400: Log warning to admin dashboard
  - [ ] Create admin notification system:
    - Display banner when approaching limit
    - Send email to admin when limit reached
  - [ ] Add usage display in admin dashboard:
    - Show current month usage: "375 / 500 requests"
    - Show reset date: "Resets on Nov 1, 2025"
  - [ ] Add override flag for admins to manually verify

- [ ] Testing (AC: All)
  - [ ] Unit tests for KYCService:
    - Test verifyCompany() with mock OpenCorporates responses
    - Test error handling (404, 429, 500)
    - Test jurisdiction code mapping
  - [ ] Unit tests for country mapping functions
  - [ ] Integration tests for registration endpoint:
    - Test registration with valid country and registration number
    - Test registration without registration number (optional field)
    - Test verification status is stored correctly
  - [ ] Frontend tests for registration form:
    - Test country dropdown renders correctly
    - Test registration number field is optional
    - Test dynamic label changes based on country
    - Test form submission includes new fields
  - [ ] Admin interface tests:
    - Test verification status filter
    - Test manual verification actions
    - Test modal displays correct data

- [ ] Documentation (AC: 5)
  - [ ] Update `/backend/README.md`:
    - Add section "KYC Verification Setup"
    - Document environment variables
    - Add instructions for obtaining OpenCorporates API key
  - [ ] Create `/docs/kyc-verification.md`:
    - Explain KYC verification flow
    - Document country jurisdiction mapping
    - Add troubleshooting guide
  - [ ] Update API documentation:
    - Document new registration fields
    - Document admin KYC endpoints

## Dev Notes

### Relevant Source Tree

**Backend:**
- `/backend/src/services/kyc.service.ts` - NEW (KYC verification service)
- `/backend/src/config/country-jurisdictions.ts` - NEW (country mapping config)
- `/backend/src/routes/auth.routes.ts` - Existing (registration endpoint)
- `/backend/src/routes/admin.routes.ts` - Existing (admin endpoints, add KYC routes)
- `/backend/prisma/schema.prisma` - Existing (database schema)

**Frontend:**
- `/frontend/src/pages/Register.tsx` - Existing (registration form)
- `/frontend/src/pages/admin/UserManagement.tsx` - Existing (admin panel)
- `/frontend/src/components/admin/KYCVerificationModal.tsx` - NEW (KYC modal)

### Design Decisions

**Why Optional Registration Number:**
- Don't block legitimate users who don't know their registration number
- Manual admin review available for all registrations
- Verification improves trust but isn't mandatory for MVP

**Why Async Non-Blocking Verification:**
- Registration should complete quickly
- API calls can be slow (500ms - 2s)
- Failed verification shouldn't prevent signup
- Admin can manually verify later

**Why Free Tier First:**
- 500 requests/month = ~16/day sufficient for MVP testing
- Can upgrade to paid tier ($650/month) when needed
- Usage tracking prevents surprise costs

### OpenCorporates API Integration

**Base URL:** `https://api.opencorporates.com/v0.4`

**Authentication:** API key in query parameter: `?api_token=YOUR_KEY`

**Endpoints:**

1. **Company Lookup (Direct):**
   ```
   GET /companies/{jurisdiction_code}/{company_number}
   ```
   Example:
   ```
   GET /companies/gb/07444723?api_token=YOUR_KEY
   ```

2. **Company Search (by name):**
   ```
   GET /companies/search?q={company_name}&jurisdiction_code={jurisdiction}
   ```

**Response Format:**
```json
{
  "results": {
    "company": {
      "name": "APPLE INC.",
      "company_number": "C3268102",
      "jurisdiction_code": "us_ca",
      "incorporation_date": "1977-01-03",
      "current_status": "Active",
      "registered_address_in_full": "One Apple Park Way, Cupertino, CA 95014",
      "opencorporates_url": "https://opencorporates.com/companies/us_ca/C3268102"
    }
  }
}
```

**Error Responses:**
- `404`: Company not found
- `429`: Rate limit exceeded (500/month for free tier)
- `401`: Invalid API key
- `500`: Server error

### Country ‚Üí Jurisdiction Code Mapping

**Full Mapping Table:**

| Country | Jurisdiction Code | Example Format |
|---------|-------------------|----------------|
| United States | `us` (or `us_ca`, `us_de`, etc.) | 12-3456789 (EIN) or C3268102 (CA) |
| United Kingdom | `gb` | 07444723 or GB123456789 |
| Germany | `de` | HRB12345 or DE123456789 |
| France | `fr` | 123456789 or FR12345678901 |
| Ireland | `ie` | 123456 or IE1234567A |
| Netherlands | `nl` | 12345678 or NL123456789B01 |
| Belgium | `be` | 0123.456.789 or BE0123456789 |
| Spain | `es` | A12345678 or ESA12345678 |
| Italy | `it` | 12345678901 or IT12345678901 |
| Sweden | `se` | 556016-6223 or SE556016622301 |
| Denmark | `dk` | 12345678 or DK12345678 |
| Norway | `no` | 123456789 |
| Finland | `fi` | 1234567-8 or FI12345678 |
| Poland | `pl` | 1234563218 or PL1234563218 |
| Singapore | `sg` | 199700735E (UEN) |
| Hong Kong | `hk` | 12345678 |
| Australia | `au` (or `au_nsw`, etc.) | 12345678901 (ABN) |
| New Zealand | `nz` | 1234567 |
| Canada | `ca` (or `ca_on`, `ca_bc`, etc.) | 123456789 |
| Japan | `jp` | 0123-01-012345 |
| South Korea | `kr` | 123-45-67890 |
| India | `in` | U12345MH2020PTC123456 (CIN) |
| Brazil | `br` | 12.345.678/0001-90 (CNPJ) |
| Mexico | `mx` | ABC123456ABC |
| South Africa | `za` | 2020/123456/07 |

**Note:** For US, users may need to select state (e.g., "United States - California" ‚Üí `us_ca`). For MVP, we can accept country-level only and attempt `us` jurisdiction.

### Database Schema Changes

**Organization Model Updates:**

```prisma
model Organization {
  // ... existing fields ...

  // NEW: KYC fields
  registrationNumber  String?  // Company registration number or tax ID
  taxIdVerified       Boolean  @default(false) // Has registration been verified?
  verificationStatus  KYCVerificationStatus @default(PENDING) // Verification status
  verificationDate    DateTime? // When verification completed
  opencorporatesUrl   String?  // Link to OpenCorporates page
  legalStatus         String?  // Company status (active, dissolved, etc.)

  // ... existing relations ...

  @@index([verificationStatus])
  @@index([taxIdVerified])
}

enum KYCVerificationStatus {
  PENDING        // Not yet verified or verification in progress
  VERIFIED       // Successfully verified via API
  FAILED         // Verification failed (company not found)
  MANUAL_REVIEW  // Requires manual admin review
}
```

### KYC Service Implementation

**Service Structure:**

```typescript
// backend/src/services/kyc.service.ts

import axios from 'axios';
import { PrismaClient } from '../generated/prisma/index.js';

export interface CompanyVerificationResult {
  verified: boolean;
  status: 'VERIFIED' | 'FAILED' | 'MANUAL_REVIEW';
  companyName?: string;
  registrationNumber: string;
  jurisdiction: string;
  legalStatus?: string;
  opencorporatesUrl?: string;
  incorporationDate?: string;
  registeredAddress?: string;
  error?: string;
}

export class KYCService {
  private apiKey: string;
  private baseUrl: string;
  private enabled: boolean;
  private prisma: PrismaClient;

  constructor() {
    this.apiKey = process.env.OPENCORPORATES_API_KEY || '';
    this.baseUrl = process.env.OPENCORPORATES_API_URL || 'https://api.opencorporates.com/v0.4';
    this.enabled = process.env.KYC_VERIFICATION_ENABLED === 'true';
    this.prisma = new PrismaClient();
  }

  /**
   * Verify company by registration number and jurisdiction
   */
  async verifyCompany(
    registrationNumber: string,
    jurisdiction: string
  ): Promise<CompanyVerificationResult> {
    // If KYC verification is disabled, return PENDING
    if (!this.enabled || !this.apiKey) {
      return {
        verified: false,
        status: 'MANUAL_REVIEW',
        registrationNumber,
        jurisdiction,
        error: 'KYC verification is disabled',
      };
    }

    try {
      // Check usage limit before making API call
      const usage = await this.getMonthlyUsage();
      if (usage >= 500) {
        console.warn('[KYC] Monthly API limit reached (500/500)');
        return {
          verified: false,
          status: 'MANUAL_REVIEW',
          registrationNumber,
          jurisdiction,
          error: 'Monthly API limit reached',
        };
      }

      // Make API call to OpenCorporates
      const response = await axios.get(
        `${this.baseUrl}/companies/${jurisdiction}/${registrationNumber}`,
        {
          params: {
            api_token: this.apiKey,
          },
          timeout: 10000, // 10 second timeout
        }
      );

      // Increment usage counter
      await this.incrementUsage();

      const company = response.data.results.company;

      return {
        verified: true,
        status: 'VERIFIED',
        companyName: company.name,
        registrationNumber: company.company_number,
        jurisdiction: company.jurisdiction_code,
        legalStatus: company.current_status || 'unknown',
        opencorporatesUrl: company.opencorporates_url,
        incorporationDate: company.incorporation_date,
        registeredAddress: company.registered_address_in_full,
      };
    } catch (error: any) {
      console.error('[KYC] Verification error:', error.message);

      // Handle specific error codes
      if (error.response?.status === 404) {
        return {
          verified: false,
          status: 'MANUAL_REVIEW',
          registrationNumber,
          jurisdiction,
          error: 'Company not found in registry',
        };
      }

      if (error.response?.status === 429) {
        return {
          verified: false,
          status: 'PENDING',
          registrationNumber,
          jurisdiction,
          error: 'Rate limit exceeded, will retry',
        };
      }

      // All other errors: MANUAL_REVIEW
      return {
        verified: false,
        status: 'MANUAL_REVIEW',
        registrationNumber,
        jurisdiction,
        error: error.message || 'Verification failed',
      };
    }
  }

  /**
   * Get monthly usage count
   */
  private async getMonthlyUsage(): Promise<number> {
    // Implementation depends on storage (Redis or database)
    // For now, return 0 (to be implemented)
    return 0;
  }

  /**
   * Increment usage counter
   */
  private async incrementUsage(): Promise<void> {
    // Implementation depends on storage (Redis or database)
    // For now, no-op (to be implemented)
  }

  /**
   * Search for company by name (for admin use)
   */
  async searchCompany(name: string, jurisdiction?: string) {
    if (!this.enabled || !this.apiKey) {
      return [];
    }

    try {
      const response = await axios.get(
        `${this.baseUrl}/companies/search`,
        {
          params: {
            q: name,
            jurisdiction_code: jurisdiction,
            api_token: this.apiKey,
            per_page: 10,
          },
        }
      );

      return response.data.results.companies.map((result: any) => ({
        name: result.company.name,
        registrationNumber: result.company.company_number,
        jurisdiction: result.company.jurisdiction_code,
        status: result.company.current_status,
        opencorporatesUrl: result.company.opencorporates_url,
      }));
    } catch (error) {
      console.error('[KYC] Search error:', error);
      return [];
    }
  }
}

// Export singleton instance
export const kycService = new KYCService();
```

### Frontend Registration Form Updates

**Dynamic Label Logic:**

```typescript
function getRegistrationNumberLabel(country: string): string {
  switch (country) {
    case 'United States':
      return 'EIN or State Registration Number';
    case 'United Kingdom':
      return 'Company Number or VAT Number';
    case 'Germany':
    case 'France':
    case 'Ireland':
    case 'Netherlands':
    case 'Belgium':
    case 'Spain':
    case 'Italy':
      return 'VAT Number or Registration Number';
    case 'Singapore':
      return 'UEN (Unique Entity Number)';
    case 'Hong Kong':
      return 'Company Registration Number';
    case 'Australia':
      return 'ABN (Australian Business Number)';
    case 'Canada':
      return 'Business Number';
    case 'India':
      return 'CIN (Corporate Identification Number)';
    default:
      return 'Registration Number or Tax ID';
  }
}

function getRegistrationNumberPlaceholder(country: string): string {
  switch (country) {
    case 'United States':
      return 'e.g., 12-3456789 or C3268102';
    case 'United Kingdom':
      return 'e.g., 07444723 or GB123456789';
    case 'Germany':
      return 'e.g., HRB12345 or DE123456789';
    case 'France':
      return 'e.g., 123456789 or FR12345678901';
    case 'Singapore':
      return 'e.g., 199700735E';
    case 'Hong Kong':
      return 'e.g., 12345678';
    case 'Australia':
      return 'e.g., 12345678901';
    default:
      return 'Enter your company registration number';
  }
}
```

### Testing

**Test File Locations:**
- Unit tests: `/backend/tests/unit/kyc.service.test.ts`
- Integration tests: `/backend/tests/integration/kyc-registration.spec.ts`
- Frontend tests: `/frontend/src/pages/__tests__/Register.test.tsx`

**Test Framework:** Vitest 3 (backend) + React Testing Library (frontend)

**Key Test Cases:**

1. **KYC Service Unit Tests:**
   - Test verifyCompany() with valid company (mocked 200 response)
   - Test verifyCompany() with invalid company (mocked 404 response)
   - Test verifyCompany() with rate limit (mocked 429 response)
   - Test verifyCompany() with API error (mocked 500 response)
   - Test jurisdiction code mapping
   - Test usage limit enforcement (skip API call when >= 500)

2. **Registration Integration Tests:**
   - Test registration with country and registration number
   - Test registration with country only (no registration number)
   - Test verification status is stored in database
   - Test audit log entry is created

3. **Frontend Component Tests:**
   - Test country dropdown renders all countries
   - Test registration number field is optional
   - Test dynamic label changes when country changes
   - Test placeholder text changes when country changes
   - Test form validation requires country
   - Test form submission includes new fields

### Usage Tracking Implementation

**Option A: Database (Simple, MVP-ready):**

```prisma
model KYCUsageLog {
  id        String   @id @default(cuid())
  month     String   // Format: "2025-10"
  count     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([month])
}
```

**Option B: Redis (Better performance, requires Redis):**

```typescript
// Store counter in Redis
const month = new Date().toISOString().slice(0, 7); // "2025-10"
const key = `kyc:usage:${month}`;
await redis.incr(key);
await redis.expire(key, 60 * 60 * 24 * 35); // Expire after 35 days
```

### Admin Dashboard Integration

**Verification Status Badge Component:**

```typescript
function VerificationStatusBadge({ status }: { status: string }) {
  const config = {
    PENDING: { color: 'yellow', label: 'Pending' },
    VERIFIED: { color: 'green', label: 'Verified' },
    FAILED: { color: 'red', label: 'Failed' },
    MANUAL_REVIEW: { color: 'orange', label: 'Review Required' },
  };

  const { color, label } = config[status] || config.PENDING;

  return (
    <Badge className={`bg-${color}-500/20 text-${color}-400`}>
      {label}
    </Badge>
  );
}
```

### Performance Considerations

- **API Call Timeout:** 10 seconds max to prevent slow registrations
- **Async Non-Blocking:** Verification happens after user sees success message
- **Caching:** Cache verification results for 7 days (reduce duplicate calls)
- **Rate Limiting:** Track usage to prevent exceeding free tier (500/month)
- **Retry Logic:** Retry failed verifications (429, 500) after 1 hour

### Security Considerations

- **API Key Protection:** Store in environment variable, never commit to git
- **Input Validation:** Sanitize registration number to prevent injection
- **Rate Limiting:** Protect registration endpoint from abuse
- **Audit Logging:** Log all verification attempts for compliance
- **RBAC:** Only admins can manually verify/reject

### Cost Analysis

**OpenCorporates Pricing:**
- Free tier: 500 API calls/month (sufficient for MVP)
- Starter plan: ‚Ç¨600/month for 10,000 calls (~$650/month)
- Professional: ‚Ç¨2,400/month for 100,000 calls

**Usage Estimates:**
- 10 registrations/day √ó 30 days = 300 calls/month (within free tier)
- 50 registrations/day √ó 30 days = 1,500 calls/month (requires Starter plan)

**Recommendation:** Start with free tier, upgrade when reaching 100 registrations/month.

## Change Log

| Date       | Version | Description                          | Author        |
|------------|---------|--------------------------------------|---------------|
| 2025-10-15 | 1.0     | Initial story created based on authentication gap analysis | SM (Bob)  |

## Dev Agent Record

### Agent Model Used
_To be populated during implementation_

### Debug Log References
_To be populated during implementation_

### Completion Notes
_To be populated after implementation_

### File List
_To be populated after implementation_

## QA Results

_To be populated by QA agent after implementation review_
