# Story 13.0: Seed Revenue Test Data

## Status
Draft

## Epic
Epic 13: Admin Revenue Reports - Backend Integration

## Story

**As a** developer
**I want** sample invoice data in the development database
**So that** I can test revenue analytics without relying on production data

## Description

This prerequisite story creates a seed data script that generates realistic invoice records spanning 12 months. This test data is essential for developing and validating the revenue analytics features in Stories 13.1-13.3.

Without this data, developers would see empty charts and zero revenue calculations, making it impossible to verify the UI renders correctly or that calculations are accurate.

## Acceptance Criteria

1. ✅ Seed script file created: `backend/prisma/seed-revenue.ts`
2. ✅ Script generates 50+ sample invoices spanning 12 months (past year)
3. ✅ Invoice distribution:
   - 80% PAID status (primary revenue data)
   - 10% OPEN status (pending payments)
   - 5% VOID status (refunds/cancellations)
   - 5% DRAFT status (not yet sent)
4. ✅ Realistic amounts based on actual pricing:
   - PREMIUM Monthly: €599
   - PREMIUM Annual: €5,388 (€599 × 12 × 0.75 discount)
   - ENTERPRISE Monthly: €1,999
   - ENTERPRISE Annual: €17,991 (€1,999 × 12 × 0.75 discount)
5. ✅ Invoices linked to existing seed users/subscriptions
6. ✅ At least 5-10 distinct organizations for customer ranking tests
7. ✅ Script is idempotent (can run multiple times safely without duplicates)
8. ✅ NPM script added: `npm run db:seed:revenue` runs the script
9. ✅ Console output shows summary: "Created X invoices across Y organizations"
10. ✅ README.md updated with seed data instructions

## Tasks / Subtasks

- [ ] Task 1: Create Seed Script File (AC: 1)
  - [ ] Create file: `backend/prisma/seed-revenue.ts`
  - [ ] Import Prisma client, date utilities
  - [ ] Add TypeScript types for seed data
  - [ ] Export main seed function

- [ ] Task 2: Generate Date Ranges (AC: 2)
  - [ ] Calculate date range: 12 months ago to today
  - [ ] Generate 50+ random dates within range
  - [ ] Distribute dates evenly across months
  - [ ] Calculate periodStart/periodEnd (30-day periods)
  - [ ] Calculate dueDate (periodEnd + 7 days)
  - [ ] Calculate paidAt (random 0-14 days after dueDate for PAID invoices)

- [ ] Task 3: Fetch Existing Subscriptions (AC: 5, 6)
  - [ ] Query existing subscriptions with user and organization
  - [ ] Filter to subscriptions with billingCycle (not FREE tier)
  - [ ] Ensure at least 5-10 distinct organizations exist
  - [ ] If insufficient, log warning with instructions
  - [ ] Store subscription data for invoice creation

- [ ] Task 4: Generate Invoice Data (AC: 3, 4)
  - [ ] Loop through date range, create 50+ invoices
  - [ ] Randomly assign status: 80% PAID, 10% OPEN, 5% VOID, 5% DRAFT
  - [ ] Randomly assign subscription from existing subscriptions
  - [ ] Calculate amount based on subscription plan and billingCycle:
    - PREMIUM + MONTHLY → €599
    - PREMIUM + ANNUAL → €5,388
    - ENTERPRISE + MONTHLY → €1,999
    - ENTERPRISE + ANNUAL → €17,991
  - [ ] Generate unique invoice number: `INV-2024-{count}`
  - [ ] Generate Stripe invoice ID: `in_test_{randomId}`
  - [ ] Set paidAt = null for OPEN/DRAFT status
  - [ ] Set paidAt = calculated date for PAID status
  - [ ] Set paidAt = null for VOID status

- [ ] Task 5: Create Invoices in Database (AC: 7)
  - [ ] Check for existing seed invoices (stripeInvoiceId starts with `in_test_`)
  - [ ] Skip creation if seed data already exists (idempotent)
  - [ ] Use Prisma createMany for bulk insert
  - [ ] Wrap in try-catch for error handling
  - [ ] Log success message with count

- [ ] Task 6: Add NPM Script (AC: 8)
  - [ ] Add to package.json scripts: `"db:seed:revenue": "tsx prisma/seed-revenue.ts"`
  - [ ] Test script runs successfully: `npm run db:seed:revenue`

- [ ] Task 7: Add Console Output (AC: 9)
  - [ ] Log "Seeding revenue data..." at start
  - [ ] Log "Created {count} invoices across {orgCount} organizations"
  - [ ] Log breakdown by status (X PAID, Y OPEN, Z VOID, W DRAFT)
  - [ ] Log total revenue amount: "€{total} in test revenue"

- [ ] Task 8: Update Documentation (AC: 10)
  - [ ] Add section to README.md: "Seeding Test Data"
  - [ ] Document command: `npm run db:seed:revenue`
  - [ ] Document idempotent behavior (safe to run multiple times)
  - [ ] Document prerequisites (need existing users/subscriptions)

## Testing Validation

After implementation, validate:

```bash
# Run seed script
cd backend
npm run db:seed:revenue

# Expected output:
# Seeding revenue data...
# Created 50 invoices across 8 organizations
# - 40 PAID invoices (€23,960)
# - 5 OPEN invoices (€2,995)
# - 3 VOID invoices (€1,797)
# - 2 DRAFT invoices (€1,198)
# Total test revenue: €23,960

# Verify in database
npx prisma studio
# Check Invoice table, confirm 50+ records with in_test_* IDs
# Check status distribution roughly matches 80/10/5/5
# Check amounts match plan pricing
```

## Dev Notes

**File**: `backend/prisma/seed-revenue.ts`

**Dependencies**:
```typescript
import { PrismaClient } from '../src/generated/prisma';
import { InvoiceStatus, SubscriptionPlan, BillingCycle } from '../src/types/database';
```

**Key Logic**:
```typescript
// Amount calculation
const calculateInvoiceAmount = (plan: SubscriptionPlan, cycle: BillingCycle): number => {
  const pricing = {
    PREMIUM: { MONTHLY: 599, ANNUAL: 5388 },
    ENTERPRISE: { MONTHLY: 1999, ANNUAL: 17991 },
  };
  return pricing[plan]?.[cycle] || 0;
};

// Date generation
const generateRandomDate = (start: Date, end: Date): Date => {
  return new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime()));
};

// Status distribution
const getRandomStatus = (): InvoiceStatus => {
  const rand = Math.random();
  if (rand < 0.80) return 'PAID';
  if (rand < 0.90) return 'OPEN';
  if (rand < 0.95) return 'VOID';
  return 'DRAFT';
};
```

**Idempotent Check**:
```typescript
// Check if seed data already exists
const existingSeedInvoices = await prisma.invoice.count({
  where: { stripeInvoiceId: { startsWith: 'in_test_' } }
});

if (existingSeedInvoices > 0) {
  console.log(`Seed data already exists (${existingSeedInvoices} invoices). Skipping.`);
  return;
}
```

**Prerequisites**:
- Users must exist (created by main seed script)
- Subscriptions must exist with billingCycle set
- At least 5 organizations recommended for meaningful customer analytics

**Testing Tip**: After seeding, navigate to `/admin/reports` in UI to see charts populated with test data.

## Related Files
- `backend/prisma/seed.ts` - Main seed script (must run first)
- `backend/src/types/database.ts` - Type definitions
- `backend/prisma/schema.prisma` - Invoice model definition

## Estimated Effort
**Story Points**: 2
**Time Estimate**: 2-3 hours

## Definition of Done
- [x] All tasks completed and checked off
- [x] Seed script runs without errors
- [x] Database contains 50+ test invoices
- [x] Invoice amounts match pricing table
- [x] Status distribution roughly 80/10/5/5
- [x] NPM script works: `npm run db:seed:revenue`
- [x] README.md updated with instructions
- [x] Verified in Prisma Studio (visual inspection)
- [x] Ready for Story 13.1 to use test data
