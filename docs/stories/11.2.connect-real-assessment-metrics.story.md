# Story 11.2: Connect Real Assessment Metrics to Dashboard

## Status
Draft

## Story

**As an** admin
**I want** to see real assessment metrics on the dashboard
**So that** I can monitor actual platform usage

## Acceptance Criteria

1. Replace all mock assessment data with real API data
2. Key metrics cards updated with real numbers:
   - Total Assessments (with growth % from previous period)
   - Completion Rate (with progress bar)
   - Currently Active (real-time count of IN_PROGRESS)
   - Average Duration (formatted as "X min" or "X hr Y min")
3. Conversion Funnel updated with real data:
   - Started Assessment
   - Completed Questions (completed assessments)
   - Viewed Results (same as completed)
   - Contacted Vendor (from VendorContact)
   - Converted (subscriptions created after assessment)
4. Weekly Activity Trend updated:
   - Real counts per day for last 7 days
   - Smooth line chart with actual data points
5. Assessment Type Distribution pie chart:
   - Real counts by template
   - Top 5 templates shown, rest grouped as "Other"
   - Percentage labels
6. Loading states while fetching data
7. Error handling with retry button
8. Auto-refresh every 5 minutes

## Tasks / Subtasks

- [ ] Task 1: Create API Client Function (AC: 1)
  - [ ] Add `fetchAssessmentAnalytics` to `frontend/src/lib/api.ts`
  - [ ] Accept query params: startDate, endDate, groupBy
  - [ ] Return typed response matching backend schema
  - [ ] Handle auth token injection (automatic via api client)

- [ ] Task 2: Create TanStack Query Hook (AC: 1, 8)
  - [ ] Add custom hook: `useAssessmentAnalytics` in Dashboard component
  - [ ] Use `useQuery` with key: `['admin-analytics-assessments', dateParams]`
  - [ ] Enable auto-refresh: `refetchInterval: 300000` (5 minutes)
  - [ ] Add `staleTime: 60000` (1 minute) for cache optimization

- [ ] Task 3: Update Key Metrics Cards (AC: 2)
  - [ ] Remove mock data from Dashboard.tsx lines 37-44
  - [ ] Replace with `data?.total`, `data?.completionRate`, etc.
  - [ ] Calculate growth percentage:
    - Fetch previous period metrics
    - Compare: `((current - previous) / previous) * 100`
  - [ ] Format average duration using date-fns:
    ```typescript
    const formatDuration = (minutes: number) => {
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return hours > 0 ? `${hours}hr ${mins}min` : `${mins}min`;
    };
    ```
  - [ ] Update "Currently Active" with `data?.inProgress`
  - [ ] Add loading skeleton for metrics cards

- [ ] Task 4: Update Conversion Funnel (AC: 3)
  - [ ] Remove mock funnelData (lines 55-61)
  - [ ] Transform API data to Recharts funnel format:
    ```typescript
    const funnelData = [
      { name: 'Started Assessment', value: data.started, fill: '#3BE2E9' },
      { name: 'Completed', value: data.completed, fill: '#3BE2E9' },
      { name: 'Viewed Results', value: data.completed, fill: '#3BE2E9' },
      // Vendor contacts from separate query
      { name: 'Contacted Vendor', value: vendorData.contacts, fill: '#F345B8' },
      { name: 'Converted', value: conversions, fill: '#F345B8' }
    ];
    ```
  - [ ] Note: Vendor contacts will come from Story 11.4
  - [ ] For now, use `data.completed` as placeholder for vendor steps

- [ ] Task 5: Update Weekly Activity Trend (AC: 4)
  - [ ] Remove mock trendData (lines 64-72)
  - [ ] Transform `data.trend` to Recharts format:
    ```typescript
    const trendData = data.trend.slice(-7).map(t => ({
      day: new Date(t.date).toLocaleDateString('en-US', { weekday: 'short' }),
      assessments: t.started,
      completed: t.completed
    }));
    ```
  - [ ] Ensure chart updates with real data points
  - [ ] Handle empty data: Show "No data available" message

- [ ] Task 6: Update Assessment Type Distribution (AC: 5)
  - [ ] Remove mock distributionData (lines 75-81)
  - [ ] Transform `data.byTemplate`:
    ```typescript
    const topTemplates = data.byTemplate.slice(0, 5);
    const others = data.byTemplate.slice(5);
    const othersSum = others.reduce((sum, t) => sum + t.count, 0);
    const othersPercentage = others.reduce((sum, t) => sum + t.percentage, 0);

    const distributionData = [
      ...topTemplates.map(t => ({
        name: t.templateName,
        value: t.percentage,
        color: getColorForIndex(index)
      })),
      ...(othersSum > 0 ? [{
        name: 'Other',
        value: othersPercentage,
        color: '#94a3b8'
      }] : [])
    ];
    ```
  - [ ] Update pie chart with real data

- [ ] Task 7: Add Loading and Error States (AC: 6, 7)
  - [ ] Add loading skeletons for all dashboard sections
  - [ ] Show shimmer effect while `isLoading === true`
  - [ ] Add error boundary with retry button:
    ```tsx
    {error && (
      <Alert variant="destructive">
        <AlertCircle className="h-4 w-4" />
        <AlertDescription>
          Failed to load analytics: {error.message}
          <Button variant="outline" size="sm" onClick={() => refetch()}>
            Retry
          </Button>
        </AlertDescription>
      </Alert>
    )}
    ```
  - [ ] Handle partial data: Show what's available, mark missing sections

- [ ] Task 8: Calculate Growth Percentages (AC: 2)
  - [ ] Fetch previous period data for comparison
  - [ ] Calculate growth for Total Assessments:
    - Previous period = same duration ending at startDate
    - Example: If showing last 30 days, compare to previous 30 days
  - [ ] Display growth with up/down arrow and color:
    ```tsx
    {growth > 0 ? (
      <ArrowUpRight className="h-3 w-3 text-green-500" />
    ) : (
      <ArrowDownRight className="h-3 w-3 text-red-500" />
    )}
    <span className={growth > 0 ? 'text-green-500' : 'text-red-500'}>
      {Math.abs(growth).toFixed(1)}%
    </span>
    ```

- [ ] Task 9: Testing (All AC)
  - [ ] Test API client function returns correct data
  - [ ] Test TanStack Query hook with mock API
  - [ ] Test metrics cards render with real data
  - [ ] Test charts update with real data
  - [ ] Test loading states
  - [ ] Test error states and retry
  - [ ] Test auto-refresh after 5 minutes
  - [ ] Visual regression test: Dashboard matches design

## Dev Notes

### Existing Dashboard Structure
[Source: frontend/src/pages/admin/Dashboard.tsx]

**Mock Data Locations** (to replace):
- Lines 37-44: `assessmentMetrics` object
- Lines 55-61: `funnelData` array
- Lines 64-72: `trendData` array
- Lines 75-81: `distributionData` array

**Chart Components**:
- Lines 159-174: Conversion Funnel (FunnelChart)
- Lines 176-210: Weekly Trend (LineChart)
- Lines 215-257: Assessment Types (PieChart)

### Frontend API Pattern
[Source: CLAUDE.md:204-219, frontend/src/lib/api.ts]

**API Client Structure**:
```typescript
// In frontend/src/lib/api.ts
export const adminApi = {
  // ... existing methods

  getAssessmentAnalytics: async (params?: {
    startDate?: string;
    endDate?: string;
    groupBy?: 'day' | 'week' | 'month';
  }) => {
    const searchParams = new URLSearchParams();
    if (params?.startDate) searchParams.set('startDate', params.startDate);
    if (params?.endDate) searchParams.set('endDate', params.endDate);
    if (params?.groupBy) searchParams.set('groupBy', params.groupBy);

    const response = await fetch(`/v1/admin/analytics/assessments?${searchParams}`, {
      headers: {
        Authorization: `Bearer ${localStorage.getItem('token')}`,
        'Content-Type': 'application/json',
      },
    });

    if (!response.ok) throw new Error('Failed to fetch assessment analytics');
    return response.json();
  }
};
```

### TanStack Query Pattern
[Source: CLAUDE.md - Frontend optimization]

```typescript
const { data, isLoading, error, refetch } = useQuery({
  queryKey: ['admin-analytics-assessments'],
  queryFn: () => adminApi.getAssessmentAnalytics(),
  refetchInterval: 300000, // 5 minutes
  staleTime: 60000,        // 1 minute
  retry: 3,
  retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
});
```

### Loading Skeleton Component

```tsx
const MetricCardSkeleton = () => (
  <Card>
    <CardHeader>
      <div className="h-4 w-32 bg-muted animate-pulse rounded" />
    </CardHeader>
    <CardContent>
      <div className="h-8 w-20 bg-muted animate-pulse rounded mb-2" />
      <div className="h-3 w-40 bg-muted animate-pulse rounded" />
    </CardContent>
  </Card>
);
```

### Duration Formatting

```typescript
import { formatDistanceStrict } from 'date-fns';

const formatDuration = (minutes: number): string => {
  if (minutes < 1) return '< 1 min';
  if (minutes < 60) return `${Math.round(minutes)} min`;

  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;

  if (mins === 0) return `${hours} hr`;
  return `${hours} hr ${mins} min`;
};
```

### Growth Calculation

```typescript
const calculateGrowth = (current: number, previous: number): number => {
  if (previous === 0) return current > 0 ? 100 : 0;
  return ((current - previous) / previous) * 100;
};

// Usage
const currentPeriod = data.total;
const previousPeriod = previousData?.total || 0;
const growth = calculateGrowth(currentPeriod, previousPeriod);
```

### Chart Color Palette
[Source: frontend/src/pages/admin/Dashboard.tsx:75-81]

Existing colors used:
- Primary: #3BE2E9 (cyan)
- Secondary: #F345B8 (pink)
- Gray: #939393
- Success: #4ade80 (green)
- Warning: #f59e0b (orange)

Use same colors for consistency.

### Empty State Handling

```tsx
{data?.trend.length === 0 ? (
  <div className="h-[300px] flex items-center justify-center text-muted-foreground">
    <div className="text-center">
      <Activity className="h-12 w-12 mx-auto mb-2 opacity-50" />
      <p>No assessment data available</p>
      <p className="text-sm">Data will appear once assessments are created</p>
    </div>
  </div>
) : (
  <ResponsiveContainer width="100%" height={300}>
    {/* Chart */}
  </ResponsiveContainer>
)}
```

### File Locations

**Modified Files**:
- `frontend/src/lib/api.ts` - Add getAssessmentAnalytics function
- `frontend/src/pages/admin/Dashboard.tsx` - Replace mock data, add query hook

**No New Files Required**

### Testing Standards
[Source: CLAUDE.md]
- Frontend tests: React Testing Library + Vitest
- Mock TanStack Query responses
- Test loading, success, and error states
- Visual regression with Chromatic or Percy (optional)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Story created - Connect real assessment metrics to dashboard | Bob (Scrum Master) |

---

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
