# Story 7.6: Create Get Subscription Billing Info Endpoint

## Status
Draft

## Story
**As a** user,
**I want** to retrieve my subscription and billing information,
**so that** the frontend can display my current plan, credits, and renewal date.

## Acceptance Criteria
1. New endpoint: `GET /v1/subscriptions/:userId/billing-info`
2. Route protected by: `authMiddleware`
3. Request schema validation:
   ```typescript
   params: z.object({ userId: z.string() })
   ```
4. Endpoint queries Subscription with select:
   ```typescript
   {
     plan: true,
     billingCycle: true,
     currentPeriodStart: true,
     currentPeriodEnd: true,
     creditsBalance: true,
     stripeSubscriptionId: true
   }
   ```
5. Success response (200):
   ```json
   {
     "success": true,
     "data": {
       "plan": "PREMIUM",
       "billingCycle": "MONTHLY",
       "currentPeriodStart": "2025-10-01T...",
       "currentPeriodEnd": "2025-11-01T...",
       "creditsBalance": 75,
       "stripeSubscriptionId": "sub_..."
     }
   }
   ```
6. Error responses:
   - 401 if unauthenticated
   - 403 if userId doesn't match authenticated user
   - 404 if subscription not found

## Tasks / Subtasks

- [ ] **Task 1: Define Request/Response Schemas** (AC: 3, 5)
  - [ ] Open `backend/src/routes/subscription.routes.ts`
  - [ ] Add Zod schema for params:
    ```typescript
    const GetBillingInfoParamsSchema = z.object({
      userId: z.string().cuid('Invalid user ID format'),
    });
    ```
  - [ ] Add Fastify response schema:
    ```typescript
    const GetBillingInfoResponseSchema = {
      200: {
        type: 'object',
        properties: {
          success: { type: 'boolean' },
          data: {
            type: 'object',
            properties: {
              plan: { type: 'string', enum: ['FREE', 'PREMIUM', 'ENTERPRISE'] },
              billingCycle: { type: 'string', enum: ['MONTHLY', 'ANNUAL'], nullable: true },
              currentPeriodStart: { type: 'string', format: 'date-time' },
              currentPeriodEnd: { type: 'string', format: 'date-time', nullable: true },
              creditsBalance: { type: 'number' },
              stripeSubscriptionId: { type: 'string', nullable: true },
            },
            required: ['plan', 'currentPeriodStart', 'creditsBalance'],
          },
        },
      },
      401: {
        type: 'object',
        properties: {
          success: { type: 'boolean' },
          message: { type: 'string' },
          code: { type: 'string' },
        },
      },
      403: {
        type: 'object',
        properties: {
          success: { type: 'boolean' },
          message: { type: 'string' },
          code: { type: 'string' },
        },
      },
      404: {
        type: 'object',
        properties: {
          success: { type: 'boolean' },
          message: { type: 'string' },
          code: { type: 'string' },
        },
      },
    };
    ```

- [ ] **Task 2: Create GET /subscriptions/:userId/billing-info Endpoint** (AC: 1, 2)
  - [ ] Add endpoint definition:
    ```typescript
    server.get('/:userId/billing-info', {
      schema: {
        description: 'Get subscription and billing information for user',
        tags: ['Subscriptions'],
        params: GetBillingInfoParamsSchema,
        response: GetBillingInfoResponseSchema,
      },
      preHandler: authenticationMiddleware,
    }, asyncHandler(async (request, reply) => {
      // Implementation in next tasks
    }));
    ```

- [ ] **Task 3: Implement Authorization Check** (AC: 6)
  - [ ] Parse request and check ownership:
    ```typescript
    const { userId } = request.params as z.infer<typeof GetBillingInfoParamsSchema>;
    const user = (request as any).user ?? (request as any).currentUser;

    // User can only view their own billing info (unless admin)
    if (user.id !== userId && user.role !== 'ADMIN') {
      return reply.status(403).send({
        success: false,
        message: 'You can only view your own billing information',
        code: 'FORBIDDEN',
      });
    }
    ```

- [ ] **Task 4: Query Subscription with Selective Fields** (AC: 4, 5)
  - [ ] Use Prisma select to retrieve only required fields:
    ```typescript
    const subscription = await this.prisma.subscription.findUnique({
      where: { userId },
      select: {
        plan: true,
        billingCycle: true,
        currentPeriodStart: true,
        currentPeriodEnd: true,
        creditsBalance: true,
        stripeSubscriptionId: true,
      },
    });

    if (!subscription) {
      return reply.status(404).send({
        success: false,
        message: 'User subscription not found',
        code: 'SUBSCRIPTION_NOT_FOUND',
      });
    }
    ```
  - [ ] Note: Do NOT return sensitive fields (stripeCustomerId, stripePaymentMethodId)

- [ ] **Task 5: Return Billing Info Response** (AC: 5)
  - [ ] Return subscription data:
    ```typescript
    reply.status(200).send({
      success: true,
      data: {
        plan: subscription.plan,
        billingCycle: subscription.billingCycle,
        currentPeriodStart: subscription.currentPeriodStart.toISOString(),
        currentPeriodEnd: subscription.currentPeriodEnd?.toISOString() || null,
        creditsBalance: subscription.creditsBalance,
        stripeSubscriptionId: subscription.stripeSubscriptionId,
      },
    });
    ```

- [ ] **Task 6: Add Error Handling** (AC: 6)
  - [ ] Wrap handler in try-catch:
    ```typescript
    try {
      // Main logic
    } catch (error: any) {
      request.log.error({ error, userId }, 'Failed to get billing info');

      if (error.code === 'SUBSCRIPTION_NOT_FOUND') {
        return reply.status(404).send({
          success: false,
          message: error.message || 'User subscription not found',
          code: 'SUBSCRIPTION_NOT_FOUND',
        });
      }

      throw error;
    }
    ```

- [ ] **Task 7: Add JSDoc Documentation** (AC: 1, 4)
  - [ ] Add comment above endpoint:
    ```typescript
    /**
     * Get Subscription Billing Information
     *
     * GET /v1/subscriptions/:userId/billing-info
     *
     * Retrieves subscription and billing information for display in frontend UI.
     * Includes current plan, billing cycle, renewal date, and credit balance.
     *
     * IMPORTANT: This endpoint does NOT return sensitive Stripe data:
     * - stripeCustomerId: EXCLUDED
     * - stripePaymentMethodId: EXCLUDED
     * - billingEmail: EXCLUDED (privacy)
     *
     * Only returns fields needed for frontend display.
     *
     * @param userId - User ID (must match authenticated user unless admin)
     * @returns Subscription billing information
     *
     * @see Story 8.x - Frontend subscription display component
     */
    ```

- [ ] **Task 8: Write Integration Test** (AC: 1-6)
  - [ ] Create test file: `backend/tests/integration/billing-info-endpoint.test.ts`
  - [ ] Test user can retrieve own billing info (200)
  - [ ] Test response includes all required fields
  - [ ] Test FREE user shows null billingCycle and currentPeriodEnd
  - [ ] Test PREMIUM user shows MONTHLY/ANNUAL billingCycle
  - [ ] Test user cannot view other user's billing info (403)
  - [ ] Test admin can view any user's billing info (200)
  - [ ] Test nonexistent user gets 404
  - [ ] Test sensitive Stripe fields NOT included in response
  - [ ] Test unauthenticated request gets 401
  - [ ] Run tests: `npm test`

- [ ] **Task 9: Update OpenAPI/Swagger Documentation** (AC: 1)
  - [ ] Verify Swagger UI includes new endpoint
  - [ ] Verify "Subscriptions" tag grouping
  - [ ] Verify example response shown

## Dev Notes

### Endpoint Purpose
This endpoint provides subscription and billing information for frontend display:
- Account settings page shows current plan and renewal date
- Subscription widget displays credits remaining
- Billing page shows billing cycle and next charge date

**Security:** Only returns fields needed for display. Sensitive Stripe data excluded.

[Source: docs/prd/epic-7-api-endpoints.md#Story 3.6]

---

### Response Fields

**Included Fields (Safe for Frontend Display):**
- `plan`: Subscription tier (FREE, PREMIUM, ENTERPRISE)
- `billingCycle`: MONTHLY, ANNUAL, or null (for FREE)
- `currentPeriodStart`: When current billing period started
- `currentPeriodEnd`: When current billing period ends (null for FREE)
- `creditsBalance`: Available assessment credits
- `stripeSubscriptionId`: Stripe subscription ID (useful for support)

**Excluded Fields (Sensitive/Not Needed):**
- `stripeCustomerId`: Internal Stripe customer ID (security risk)
- `stripePaymentMethodId`: Payment method ID (PCI compliance)
- `billingEmail`: Email for invoices (privacy)
- `creditsPurchased`: Internal tracking
- `creditsUsed`: Internal tracking
- `cancelAt`: Cancellation date (not needed for this endpoint)

**Why Selective Fields:**
- Security: Prevent exposure of sensitive Stripe data
- Privacy: Don't return email addresses
- Performance: Reduce payload size
- Clarity: Only return what frontend needs

[Source: docs/prd/epic-7-api-endpoints.md#Story 3.6]

---

### Prisma Selective Query

**Using Prisma Select:**
```typescript
const subscription = await prisma.subscription.findUnique({
  where: { userId },
  select: {
    plan: true,
    billingCycle: true,
    currentPeriodStart: true,
    currentPeriodEnd: true,
    creditsBalance: true,
    stripeSubscriptionId: true,
    // All other fields EXCLUDED (default false)
  },
});
```

**Benefits:**
- Only queries needed columns from database
- Prevents accidental exposure of sensitive fields
- Improves query performance
- Type-safe (TypeScript enforces field access)

**Alternative Approach (NOT Recommended):**
```typescript
// BAD: Queries all fields, then manually excludes
const subscription = await prisma.subscription.findUnique({ where: { userId } });
delete subscription.stripeCustomerId;  // Error-prone
delete subscription.stripePaymentMethodId;
```

[Source: Prisma documentation, security best practices]

---

### Response Examples by Plan

**FREE User:**
```json
{
  "success": true,
  "data": {
    "plan": "FREE",
    "billingCycle": null,
    "currentPeriodStart": "2025-10-01T00:00:00.000Z",
    "currentPeriodEnd": null,
    "creditsBalance": 0,
    "stripeSubscriptionId": null
  }
}
```

**PREMIUM User (Monthly):**
```json
{
  "success": true,
  "data": {
    "plan": "PREMIUM",
    "billingCycle": "MONTHLY",
    "currentPeriodStart": "2025-10-01T00:00:00.000Z",
    "currentPeriodEnd": "2025-11-01T00:00:00.000Z",
    "creditsBalance": 75,
    "stripeSubscriptionId": "sub_1A2B3C4D5E6F"
  }
}
```

**PREMIUM User (Annual):**
```json
{
  "success": true,
  "data": {
    "plan": "PREMIUM",
    "billingCycle": "ANNUAL",
    "currentPeriodStart": "2025-01-01T00:00:00.000Z",
    "currentPeriodEnd": "2026-01-01T00:00:00.000Z",
    "creditsBalance": 250,
    "stripeSubscriptionId": "sub_9Z8Y7X6W5V4U"
  }
}
```

**ENTERPRISE User:**
```json
{
  "success": true,
  "data": {
    "plan": "ENTERPRISE",
    "billingCycle": null,
    "currentPeriodStart": "2025-10-01T00:00:00.000Z",
    "currentPeriodEnd": null,
    "creditsBalance": 500,
    "stripeSubscriptionId": null
  }
}
```

[Source: docs/prd/epic-7-api-endpoints.md#Story 3.6]

---

### Frontend Usage

**Use Cases:**

**1. Account Settings Page:**
```typescript
const { data } = await api.getBillingInfo(userId);

if (data.plan === 'FREE') {
  showUpgradeButton();
} else if (data.plan === 'PREMIUM') {
  showRenewalInfo(data.currentPeriodEnd);
}
```

**2. Credits Display Widget:**
```typescript
const { data } = await api.getBillingInfo(userId);

displayCredits({
  balance: data.creditsBalance,
  plan: data.plan,
  renewalDate: data.currentPeriodEnd,
});
```

**3. Billing Page:**
```typescript
const { data } = await api.getBillingInfo(userId);

if (data.billingCycle === 'MONTHLY') {
  showMonthlyPricing();
  showNextBillingDate(data.currentPeriodEnd);
} else if (data.billingCycle === 'ANNUAL') {
  showAnnualPricing();
  showNextBillingDate(data.currentPeriodEnd);
}
```

[Source: Frontend integration patterns]

---

### Authorization Logic

**User Ownership Check:**
```typescript
if (user.id !== userId && user.role !== 'ADMIN') {
  return reply.status(403).send({
    success: false,
    message: 'You can only view your own billing information',
    code: 'FORBIDDEN',
  });
}
```

**Why This Check:**
- Users should only see their own billing info (privacy)
- Prevents user A from viewing user B's credits/plan
- Admins can view any user's billing info (for support)

**Test Cases:**
1. User views own billing info → 200 OK
2. User tries to view different user's billing info → 403 Forbidden
3. Admin views any user's billing info → 200 OK

[Source: Common authorization pattern, privacy best practices]

---

### Error Handling

**Error Types:**

| Error Code | HTTP Status | Cause | Handled By |
|------------|-------------|-------|-----------|
| AUTH_REQUIRED | 401 | Missing/invalid JWT | authenticationMiddleware |
| FORBIDDEN | 403 | userId mismatch (non-admin) | Route handler authorization check |
| SUBSCRIPTION_NOT_FOUND | 404 | User subscription doesn't exist | Route handler |

**Route Error Handler:**
```typescript
try {
  const subscription = await prisma.subscription.findUnique({ where: { userId }, select: { ... } });

  if (!subscription) {
    return reply.status(404).send({
      success: false,
      message: 'User subscription not found',
      code: 'SUBSCRIPTION_NOT_FOUND',
    });
  }

  reply.status(200).send({ success: true, data: subscription });
} catch (error: any) {
  request.log.error({ error, userId }, 'Failed to get billing info');
  throw error;
}
```

[Source: backend/src/services/base.service.ts#createError]

---

### Testing Standards

**Test Framework:** Vitest 3
**Test Location:** `backend/tests/integration/billing-info-endpoint.test.ts`

**Key Test Cases:**
1. **User views own billing info (200):** Verify all fields returned
2. **FREE user response:** billingCycle and currentPeriodEnd are null
3. **PREMIUM/MONTHLY:** billingCycle=MONTHLY, currentPeriodEnd set
4. **PREMIUM/ANNUAL:** billingCycle=ANNUAL, currentPeriodEnd 1 year out
5. **Ownership check (403):** User cannot view other user's info
6. **Admin override (200):** Admin can view any user's info
7. **Missing subscription (404):** Nonexistent user gets 404
8. **Sensitive fields excluded:** Verify stripeCustomerId, stripePaymentMethodId NOT in response
9. **Unauthenticated (401):** Missing token gets 401

[Source: CLAUDE.md#Testing Infrastructure]

---

### Performance Considerations

**Why Use Prisma Select:**
1. **Database Performance:** Only queries needed columns (6 fields vs 20+ fields)
2. **Network Efficiency:** Smaller payload size
3. **Security:** Prevents accidental exposure of excluded fields
4. **Maintainability:** Clear intent (which fields are public)

**Query Plan:**
```sql
SELECT plan, billingCycle, currentPeriodStart, currentPeriodEnd, creditsBalance, stripeSubscriptionId
FROM Subscription
WHERE userId = ?
LIMIT 1
```

vs.

```sql
SELECT *  -- All 20+ fields
FROM Subscription
WHERE userId = ?
LIMIT 1
```

[Source: Prisma performance best practices]

---

### File Locations
- **Route File:** `backend/src/routes/subscription.routes.ts`
- **Test:** `backend/tests/integration/billing-info-endpoint.test.ts`

---

### Dependencies
**Depends On:**
- Existing: Subscription model, authenticationMiddleware
- Story 6.2: Subscription has billingCycle field

**Depended On By:**
- Story 8.x: Frontend subscription/billing display components

---

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from Epic 7 | Bob (Scrum Master) |

---

## Dev Agent Record
_This section will be populated by the development agent during implementation_

### Agent Model Used
_TBD_

### Debug Log References
_TBD_

### Completion Notes
_TBD_

### File List
_TBD_

---

## QA Results
_This section will be populated by the QA agent after story completion_
