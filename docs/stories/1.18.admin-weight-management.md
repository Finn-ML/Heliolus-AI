# Story 1.18: Admin Weight Management Interface

## Status
**DEFERRED** - Admin Tools Epic (Future Release)

## Deferral Reason
This story is **deferred to a future "Admin Tools" epic** as it's not critical for MVP launch and requires substantial backend development (6 new endpoints + weight service).

**Why Deferred:**
- Admin-only feature (not user-facing)
- Requires 6 new backend APIs + weight change service
- Template weights can be managed via database directly for now
- Priority should be on core user features first

**Estimated Backend Work:** 5-7 days (all 6 endpoints + service + history tracking)
**Future Epic:** "Admin Configuration Tools" (post-MVP)
**Date Deferred:** 2025-10-14

## Original Blockers (Historical)
- ❌ **CRITICAL:** ALL admin weight management endpoints are MISSING from backend
  - `GET /admin/templates` - Template list (may exist but not verified)
  - `GET /admin/templates/:id/weights` - Get template weights - **MISSING**
  - `PUT /admin/templates/:id/weights` - Update template weights - **MISSING**
  - `GET /admin/templates/:id/weights/history` - Get change history - **MISSING**
  - `POST /admin/templates/:id/weights/reset` - Reset to defaults - **MISSING**
  - `POST /admin/templates/:id/weights/preview` - Preview impact - **MISSING**
- ⚠️ **DEPENDENCY:** Database schema must include weight fields on Section/Question models
- ⚠️ **DEPENDENCY:** Weight change history tracking table/model required

## Required Backend Work
Before this story can begin, the following must be implemented:
1. Create all 6 admin weight management endpoints in `backend/src/routes/admin.routes.ts`
2. Implement AdminWeightService or extend TemplateService
3. Add audit logging for weight changes
4. Create weight change history database table
5. Implement impact preview calculation logic

## Story

**As a** frontend developer,
**I want** to create an admin interface for reviewing and adjusting assessment template question/section weights,
**so that** admins can maintain and update the regulatory-aligned weighting methodology.

## Acceptance Criteria

1. **Component: AdminWeightManagement.tsx** - Main admin page
   - Route: `/admin/templates/weights`
   - Template selection dropdown (lists all assessment templates)
   - Loads selected template's sections and questions with current weights
2. **Component: SectionWeightEditor.tsx**
   - List of all sections with current weights
   - Each section row:
     - Section name
     - Current weight (0-1 decimal, displayed as percentage)
     - Editable slider (0-100% with 1% increments)
     - Regulatory priority reference (text field, e.g., "FFIEC BSA/AML Pillar 1")
   - Live validation: sum of all section weights must equal 100%
   - Warning indicator if sum ≠ 100%
3. **Component: QuestionWeightEditor.tsx**
   - Expandable per section
   - Each question row:
     - Question text (truncated, hover for full)
     - Current weight within section
     - Editable slider (0-100% with 1% increments)
     - "Foundational" checkbox (marks question as critical)
   - Live validation: sum of question weights per section must equal 100%
   - Color coding: foundational questions highlighted in yellow
4. Save functionality:
   - "Save Changes" button (disabled until valid + changes made)
   - On click: opens "Change Rationale" modal
   - Modal requires:
     - Rationale text area (mandatory, min 50 characters)
     - Change summary auto-generated: "Modified 3 section weights, 5 question weights"
   - Submit calls PUT /admin/templates/:id/weights
   - Success: show toast "Weights updated successfully", refresh template
   - Error: show inline errors
5. Audit trail panel:
   - "Weight Change History" expandable section
   - Table showing: Date, Admin User, Changes Summary, Rationale, View Details
   - "View Details" opens modal with before/after weight values
6. "Reset to Defaults" button:
   - Confirmation dialog: "This will reset all weights to regulatory framework defaults. Proceed?"
   - Resets weights to framework-aligned values (from config file)
7. "Preview Impact" button:
   - Calculates how weight changes would affect existing completed assessments
   - Shows: "12 assessments would see score changes: +5 avg, -2 min, +12 max"
   - Helps admins understand impact before committing changes
8. Responsive: admin interface desktop-only (≥1024px), mobile shows "Use desktop browser" message

## Tasks / Subtasks

- [ ] Create main AdminWeightManagement component (AC: 1)
  - [ ] Create `/frontend/src/pages/admin/AdminWeightManagement.tsx`
  - [ ] Add route `/admin/templates/weights` to router
  - [ ] Create template selection dropdown (Radix Select)
  - [ ] Fetch all templates from API on mount
  - [ ] Load selected template's sections and questions
  - [ ] Create page layout with header and main content area
  - [ ] Add AdminLayout wrapper for consistent admin UI
- [ ] Create SectionWeightEditor component (AC: 2)
  - [ ] Create `/frontend/src/components/admin/weights/SectionWeightEditor.tsx`
  - [ ] Display section list as table with columns:
    - Section name
    - Current weight (percentage display)
    - Weight slider (Radix Slider)
    - Regulatory priority text field (Radix Input)
  - [ ] Implement weight slider (0-100%, 1% increments)
  - [ ] Convert between decimal (0-1) and percentage (0-100%) for display
  - [ ] Add live validation: calculate sum of all section weights
  - [ ] Display validation warning if sum ≠ 100%
  - [ ] Add visual indicator (red border) for invalid total
  - [ ] Update parent state on weight change
- [ ] Create QuestionWeightEditor component (AC: 3)
  - [ ] Create `/frontend/src/components/admin/weights/QuestionWeightEditor.tsx`
  - [ ] Render as expandable section per parent section (Radix Accordion)
  - [ ] Display question list as table with columns:
    - Question text (truncated with tooltip for full text)
    - Current weight (percentage display)
    - Weight slider (Radix Slider)
    - "Foundational" checkbox (Radix Checkbox)
  - [ ] Implement weight slider (0-100%, 1% increments)
  - [ ] Add live validation: calculate sum per section
  - [ ] Display validation warning if section sum ≠ 100%
  - [ ] Highlight foundational questions with yellow background
  - [ ] Update parent state on weight change
  - [ ] Update parent state on foundational checkbox change
- [ ] Implement save functionality (AC: 4)
  - [ ] Add "Save Changes" button to page header
  - [ ] Track if any weights have changed (dirty state)
  - [ ] Disable button if no changes or validation errors
  - [ ] Create ChangeRationaleModal component
  - [ ] Generate change summary automatically:
    - Count modified section weights
    - Count modified question weights
    - List foundational question changes
  - [ ] Add rationale text area with validation (min 50 chars)
  - [ ] Submit handler calls PUT /admin/templates/:id/weights
  - [ ] Show loading state during submission
  - [ ] On success: show toast, refresh template, reset dirty state
  - [ ] On error: display inline error messages
- [ ] Create audit trail panel (AC: 5)
  - [ ] Create `/frontend/src/components/admin/weights/WeightChangeHistory.tsx`
  - [ ] Add expandable "Weight Change History" section (Radix Collapsible)
  - [ ] Fetch weight change history from API
  - [ ] Display as table with columns:
    - Date (formatted timestamp)
    - Admin user (name and email)
    - Changes summary (condensed)
    - Rationale (truncated with expand)
    - "View Details" button
  - [ ] Create ChangeDetailModal component
  - [ ] Display before/after weight values in modal
  - [ ] Show diff highlighting (red for decreased, green for increased)
- [ ] Implement "Reset to Defaults" functionality (AC: 6)
  - [ ] Add "Reset to Defaults" button to page header
  - [ ] Create confirmation dialog (Radix AlertDialog)
  - [ ] Display warning: "This will reset all weights to regulatory framework defaults. Proceed?"
  - [ ] On confirm: call POST /admin/templates/:id/weights/reset
  - [ ] Show loading state during reset
  - [ ] On success: reload template weights, show toast
  - [ ] On error: display error message
- [ ] Implement "Preview Impact" functionality (AC: 7)
  - [ ] Add "Preview Impact" button to page header
  - [ ] Call POST /admin/templates/:id/weights/preview with modified weights
  - [ ] Create ImpactPreviewModal component
  - [ ] Display impact statistics:
    - Number of assessments affected
    - Average score change
    - Minimum score change
    - Maximum score change
  - [ ] Show list of most affected assessments (top 5)
  - [ ] Add "Proceed with Save" and "Cancel" buttons
- [ ] Add API client integration
  - [ ] Extend `/frontend/src/lib/api.ts` with admin weight management methods:
    - `getTemplateWeights(templateId)`
    - `updateTemplateWeights(templateId, weights, rationale)`
    - `getWeightChangeHistory(templateId)`
    - `resetTemplateWeights(templateId)`
    - `previewWeightImpact(templateId, weights)`
  - [ ] Create TanStack Query hooks for each operation
  - [ ] Configure proper query keys and cache invalidation
  - [ ] Add TypeScript interfaces for weight data structures
- [ ] Add responsive design and desktop-only enforcement (AC: 8)
  - [ ] Check viewport width on mount
  - [ ] Display "Use desktop browser" message if width < 1024px
  - [ ] Hide main content on mobile/tablet
  - [ ] Add desktop icon and helpful message
  - [ ] Test that interface is usable on desktop (≥1024px)

## Dev Notes

### Relevant Source Tree
- `/frontend/src/pages/admin/` - Admin page components
- `/frontend/src/components/admin/` - Admin-specific components
- `/frontend/src/components/AdminLayout.tsx` - Existing admin layout wrapper
- `/frontend/src/components/ui/` - Radix UI component library
- `/frontend/src/lib/api.ts` - Centralized API client
- `/backend/src/routes/admin.routes.ts` - Admin API endpoints (48KB)
- `/backend/src/services/template.service.ts` - Template management service

### Design Decisions

**Weight Representation:**
- Backend stores weights as decimals (0-1 range)
- Frontend displays as percentages (0-100% range)
- Conversion: `percentage = decimal * 100`, `decimal = percentage / 100`

**Validation Strategy:**
- Client-side validation: immediate feedback on weight changes
- Section weights must sum to 100% (1.0 in decimal)
- Question weights within each section must sum to 100%
- Allow temporary invalid state during editing
- Block save until all validations pass

**Change Tracking:**
- Deep comparison of original vs modified weights
- Track changes at both section and question level
- Generate human-readable change summary
- Store initial state on mount for comparison

**Desktop-Only Rationale:**
Weight management requires precise slider control and large data tables. Mobile/tablet interaction would be error-prone. Force desktop use for better UX.

### Data Structure (from API)

```typescript
interface TemplateWeights {
  templateId: string;
  templateName: string;
  sections: Array<{
    id: string;
    title: string;
    weight: number; // 0-1 decimal
    regulatoryPriority: string;
    questions: Array<{
      id: string;
      text: string;
      weight: number; // 0-1 decimal
      isFoundational: boolean;
    }>;
  }>;
}

interface WeightChangeHistory {
  id: string;
  timestamp: string;
  adminUserId: string;
  adminUserName: string;
  changesSummary: string;
  rationale: string;
  changes: {
    sections: Array<{ id: string; before: number; after: number }>;
    questions: Array<{ id: string; before: number; after: number }>;
  };
}

interface WeightImpactPreview {
  assessmentsAffected: number;
  scoreChanges: {
    avg: number;
    min: number;
    max: number;
  };
  topAffectedAssessments: Array<{
    id: string;
    organizationName: string;
    currentScore: number;
    newScore: number;
    change: number;
  }>;
}
```

### Integration Points

**API Endpoints (from admin.routes.ts):**
- ❓ `GET /admin/templates` - List all templates (may exist, not verified)
- ❌ `GET /admin/templates/:id/weights` - Get template weights - **MISSING**
- ❌ `PUT /admin/templates/:id/weights` - Update template weights - **MISSING**
- ❌ `GET /admin/templates/:id/weights/history` - Get change history - **MISSING**
- ❌ `POST /admin/templates/:id/weights/reset` - Reset to defaults - **MISSING**
- ❌ `POST /admin/templates/:id/weights/preview` - Preview impact - **MISSING**

**⚠️ BLOCKER:** None of the weight management endpoints exist in the current backend.
This story CANNOT be implemented until backend work is completed.

**Radix UI Components to Use:**
- `Select` - Template selection dropdown
- `Slider` - Weight adjustment sliders
- `Input` - Regulatory priority text field
- `Checkbox` - Foundational question toggle
- `Accordion` - Expandable question sections
- `AlertDialog` - Reset confirmation
- `Dialog` - Change rationale modal, impact preview modal, change detail modal
- `Collapsible` - Weight change history section
- `Toast` - Success/error notifications
- `Table` - Section/question weight tables, history table

**TanStack Query Integration:**
```typescript
// Fetch template weights
const { data: weights } = useQuery({
  queryKey: ['admin', 'templates', templateId, 'weights'],
  queryFn: () => api.getTemplateWeights(templateId),
  enabled: !!templateId
});

// Update weights mutation
const updateWeights = useMutation({
  mutationFn: ({ weights, rationale }: { weights: TemplateWeights; rationale: string }) =>
    api.updateTemplateWeights(templateId, weights, rationale),
  onSuccess: () => {
    queryClient.invalidateQueries(['admin', 'templates', templateId, 'weights']);
    queryClient.invalidateQueries(['admin', 'templates', templateId, 'weights', 'history']);
    toast.success('Weights updated successfully');
  }
});
```

**Validation Logic:**
```typescript
const validateSectionWeights = (sections: Section[]): boolean => {
  const sum = sections.reduce((acc, s) => acc + s.weight, 0);
  return Math.abs(sum - 1.0) < 0.001; // Allow for floating point precision
};

const validateQuestionWeights = (questions: Question[]): boolean => {
  const sum = questions.reduce((acc, q) => acc + q.weight, 0);
  return Math.abs(sum - 1.0) < 0.001;
};

const isValid = validateSectionWeights(sections) &&
  sections.every(s => validateQuestionWeights(s.questions));
```

**Change Summary Generation:**
```typescript
const generateChangeSummary = (original: TemplateWeights, modified: TemplateWeights): string => {
  const sectionChanges = modified.sections.filter((s, i) =>
    s.weight !== original.sections[i].weight
  ).length;

  const questionChanges = modified.sections.flatMap(s =>
    s.questions.filter((q, i) => {
      const origSection = original.sections.find(os => os.id === s.id);
      const origQuestion = origSection?.questions[i];
      return q.weight !== origQuestion?.weight || q.isFoundational !== origQuestion?.isFoundational;
    })
  ).length;

  return `Modified ${sectionChanges} section weights, ${questionChanges} question weights`;
};
```

### Existing Patterns to Follow

**Admin Layout Pattern:**
Use existing `AdminLayout` component for consistent navigation and styling. Admin pages typically have sidebar navigation and breadcrumbs.

**Form State Management:**
Use React Hook Form for complex form state management with validation. Integrate with Radix UI controlled components using `Controller`.

**Toast Notifications:**
Use existing toast notification system for success/error messages after API operations.

### Testing

**Test File Location:**
- Component tests: `/frontend/src/components/__tests__/admin/AdminWeightManagement.test.tsx`
- Component tests: `/frontend/src/components/__tests__/admin/weights/*.test.tsx`
- Integration tests: `/backend/tests/integration/admin-weight-management.spec.ts`

**Testing Frameworks:**
- Vitest 3 + React Testing Library
- Mock TanStack Query with QueryClientProvider
- Mock admin user context

**Test Cases:**
1. Template selection dropdown lists all templates
2. SectionWeightEditor displays all sections with current weights
3. Weight sliders update section weight correctly
4. Section weight validation shows warning when sum ≠ 100%
5. QuestionWeightEditor displays questions in expandable sections
6. Question weight sliders update weights correctly
7. Question weight validation shows warning when section sum ≠ 100%
8. Foundational checkbox toggles question foundational status
9. Foundational questions highlighted with yellow background
10. "Save Changes" button disabled when no changes made
11. "Save Changes" button disabled when validation errors present
12. Change rationale modal opens on save click
13. Change summary auto-generates correctly
14. Rationale text area validates minimum 50 characters
15. Submit handler calls API with correct payload
16. Success toast displays after save
17. Weight change history displays correctly
18. "View Details" modal shows before/after values
19. "Reset to Defaults" confirmation dialog appears
20. Reset handler calls API and reloads weights
21. "Preview Impact" calculates and displays impact correctly
22. Mobile displays "Use desktop browser" message
23. Desktop (≥1024px) shows full interface

**Coverage Target:**
- Component coverage: 85%+ (comprehensive admin workflow testing)
- Integration coverage: 90%+ (all weight management operations)

## Change Log

| Date       | Version | Description                          | Author        |
|------------|---------|--------------------------------------|---------------|
| 2025-10-07 | 1.0     | Initial story created from PRD Epic 1 | SM (Winston)  |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent during implementation_

### Debug Log References
_To be populated by dev agent during implementation_

### Completion Notes
_To be populated by dev agent during implementation_

### File List
_To be populated by dev agent during implementation_

## QA Results

_To be populated by QA agent after implementation review_
