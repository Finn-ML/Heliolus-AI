# Story 5.4: Create FreemiumContentService

## Status
Ready for Review

## Story
**As a** Freemium user,
**I want** to see blurred/mocked gap analysis and strategy matrix,
**so that** I understand the value proposition without incurring OpenAI API costs for the platform.

## Acceptance Criteria
1. Service class `FreemiumContentService` created extending `BaseService`
2. Method `generateMockedGapAnalysis()` returns 3-5 generic gaps with:
   - Generic titles (e.g., "Risk Area 1", "Compliance Gap 2")
   - Description: "[UNLOCK PREMIUM TO SEE DETAILS]"
   - Generic severity levels
   - No evidence or remediation content
   - `isRestricted: true` flag
3. Method `generateMockedStrategyMatrix()` returns blurred matrix with:
   - Generic coordinates
   - Hidden item details
   - Summary: "Upgrade to Premium to see personalized strategy recommendations"
   - `isRestricted: true` flag
4. Method `shouldGenerateRealAnalysis(userId)` checks user's subscription plan and returns boolean
5. Service does NOT call OpenAI API
6. Service uses consistent mock data structure matching real Gap/StrategyMatrix models

## Tasks / Subtasks

- [ ] **Task 1: Create FreemiumContentService File** (AC: 1)
  - [ ] Create file: `backend/src/services/freemium-content.service.ts`
  - [ ] Import BaseService from `./base.service`
  - [ ] Import types from generated Prisma client
  - [ ] Create class extending BaseService:
    ```typescript
    export class FreemiumContentService extends BaseService {
      constructor() {
        super();
      }
    }
    ```

- [ ] **Task 2: Implement generateMockedGapAnalysis Method** (AC: 2, 6)
  - [ ] Create method signature:
    ```typescript
    async generateMockedGapAnalysis(assessmentId: string): Promise<Gap[]>
    ```
  - [ ] Generate 3-5 random generic gaps
  - [ ] Use titles: "Risk Area 1", "Compliance Gap 2", "Control Weakness 3", etc.
  - [ ] Set description: "[UNLOCK PREMIUM TO SEE DETAILS]"
  - [ ] Rotate severity: HIGH, MEDIUM, LOW (not CRITICAL to avoid alarm)
  - [ ] Set priority: MEDIUM for all
  - [ ] Add custom field: `isRestricted: true`
  - [ ] Return array matching Gap model structure

- [ ] **Task 3: Implement generateMockedStrategyMatrix Method** (AC: 3, 6)
  - [ ] Create method signature:
    ```typescript
    async generateMockedStrategyMatrix(assessmentId: string): Promise<StrategyMatrix>
    ```
  - [ ] Return object with:
    - Generic matrix coordinates
    - Items: ["[DETAILS HIDDEN]"]
    - Summary: "Upgrade to Premium to see personalized strategy recommendations"
    - `isRestricted: true` flag
  - [ ] Match StrategyMatrix structure (if defined in types)

- [ ] **Task 4: Implement shouldGenerateRealAnalysis Method** (AC: 4)
  - [ ] Create method signature:
    ```typescript
    async shouldGenerateRealAnalysis(userId: string): Promise<boolean>
    ```
  - [ ] Query user's subscription plan:
    ```typescript
    const subscription = await this.prisma.subscription.findUnique({
      where: { userId },
      select: { plan: true }
    });
    ```
  - [ ] Return `true` if plan is PREMIUM or ENTERPRISE
  - [ ] Return `false` if plan is FREE or subscription not found

- [ ] **Task 5: Add Type Definitions** (AC: 6)
  - [ ] Create interface for mocked gap (extends Gap):
    ```typescript
    interface MockedGap extends Omit<Gap, 'id' | 'createdAt'> {
      isRestricted: boolean;
    }
    ```
  - [ ] Create interface for mocked strategy matrix:
    ```typescript
    interface MockedStrategyMatrix {
      assessmentId: string;
      matrix: Array<{ x: string; y: string; items: string[] }>;
      summary: string;
      isRestricted: boolean;
    }
    ```

- [ ] **Task 6: Write Unit Tests** (AC: 1-6)
  - [ ] Create test file: `backend/tests/unit/freemium-content-service.test.ts`
  - [ ] Test generateMockedGapAnalysis returns 3-5 gaps
  - [ ] Test all gaps have isRestricted: true
  - [ ] Test gaps match Gap model structure
  - [ ] Test shouldGenerateRealAnalysis returns false for FREE plan
  - [ ] Test shouldGenerateRealAnalysis returns true for PREMIUM plan
  - [ ] Test service does NOT call OpenAI (mock check)
  - [ ] Run tests: `npm test`

- [ ] **Task 7: Document Service Usage** (AC: 5)
  - [ ] Add JSDoc comments to all methods
  - [ ] Document that service is cost-free (no OpenAI calls)
  - [ ] Add example usage in comments
  - [ ] Note that mocked data is intentionally generic

## Dev Notes

### Service Purpose
**FreemiumContentService** generates mock/blurred content for FREE tier users to:
1. **Reduce OpenAI API costs** - No AI calls for free users
2. **Show value proposition** - Users see structure but not details
3. **Drive upgrades** - Clear "unlock" messaging throughout

**Cost Savings:**
- Real AI analysis: €0.50-1.00 per assessment
- Mocked analysis: €0.00 (no API calls)
- For 1000 FREE users: Save €500-1000 in API costs

[Source: docs/V4_REVISED_PAY_GATING_PLAN.md#Freemium Strategy]

---

### BaseService Pattern

**Location:** `backend/src/services/base.service.ts`

**Pattern to Follow:**
```typescript
export abstract class BaseService {
  protected prisma: PrismaClient;
  protected logger: any;

  constructor() {
    this.prisma = new PrismaClient({ ... });
    this.logger = { ... };
  }

  // Common methods: createError, logAudit, requireAdmin, etc.
}
```

**FreemiumContentService Structure:**
```typescript
import { BaseService } from './base.service';
import { SubscriptionPlan } from '../generated/prisma';

export class FreemiumContentService extends BaseService {
  constructor() {
    super(); // Inherits prisma, logger from BaseService
  }

  async generateMockedGapAnalysis(assessmentId: string) {
    // Implementation
  }

  async generateMockedStrategyMatrix(assessmentId: string) {
    // Implementation
  }

  async shouldGenerateRealAnalysis(userId: string): Promise<boolean> {
    // Implementation
  }
}
```

[Source: backend/src/services/base.service.ts]

---

### Gap Model Structure

**Location:** `backend/prisma/schema.prisma` line 428

**Gap Model Fields:**
```prisma
model Gap {
  id           String @id @default(cuid())
  assessmentId String

  category    String
  title       String
  description String
  severity    Severity   // CRITICAL, HIGH, MEDIUM, LOW
  priority    Priority   // HIGH, MEDIUM, LOW
  priorityScore Int?

  // Remediation (should be null for mocked gaps)
  estimatedCost    CostRange?
  estimatedEffort  EffortRange?
  suggestedVendors String[]

  createdAt DateTime @default(now())
}
```

**Mocked Gap Structure:**
```typescript
{
  id: `mock-gap-${assessmentId}-${index}`,  // Fake ID
  assessmentId: assessmentId,
  category: 'HIDDEN_ANALYSIS',              // Generic category
  title: 'Risk Area 1',                     // Generic title
  description: '[UNLOCK PREMIUM TO SEE DETAILS]',
  severity: 'HIGH',                         // Rotate: HIGH, MEDIUM, LOW
  priority: 'MEDIUM',                       // Always MEDIUM
  priorityScore: null,
  estimatedCost: null,                      // No remediation data
  estimatedEffort: null,
  suggestedVendors: [],
  createdAt: new Date(),
  isRestricted: true,                       // CUSTOM field (not in DB model)
}
```

[Source: backend/prisma/schema.prisma#Gap]

---

### Implementation Example

```typescript
import { BaseService } from './base.service';
import { SubscriptionPlan, Severity, Priority } from '../generated/prisma';

interface MockedGap {
  id: string;
  assessmentId: string;
  category: string;
  title: string;
  description: string;
  severity: Severity;
  priority: Priority;
  priorityScore: number | null;
  estimatedCost: null;
  estimatedEffort: null;
  suggestedVendors: string[];
  createdAt: Date;
  isRestricted: boolean;
}

export class FreemiumContentService extends BaseService {
  constructor() {
    super();
  }

  /**
   * Generate mocked gap analysis for Freemium users
   * Does NOT call OpenAI API - pure in-memory generation
   */
  async generateMockedGapAnalysis(assessmentId: string): Promise<MockedGap[]> {
    const mockTitles = [
      'Risk Area 1',
      'Compliance Gap 2',
      'Control Weakness 3',
      'Process Deficiency 4',
      'Documentation Gap 5'
    ];

    const severities: Severity[] = ['HIGH', 'MEDIUM', 'LOW'];
    const gapCount = 3 + Math.floor(Math.random() * 3); // 3-5 gaps

    const gaps: MockedGap[] = [];

    for (let i = 0; i < gapCount; i++) {
      gaps.push({
        id: `mock-gap-${assessmentId}-${i + 1}`,
        assessmentId,
        category: 'HIDDEN_ANALYSIS',
        title: mockTitles[i % mockTitles.length],
        description: '[UNLOCK PREMIUM TO SEE DETAILS]',
        severity: severities[i % severities.length],
        priority: 'MEDIUM',
        priorityScore: null,
        estimatedCost: null,
        estimatedEffort: null,
        suggestedVendors: [],
        createdAt: new Date(),
        isRestricted: true,
      });
    }

    this.logger.info(`Generated ${gaps.length} mocked gaps for assessment ${assessmentId}`);
    return gaps;
  }

  /**
   * Generate mocked strategy matrix for Freemium users
   */
  async generateMockedStrategyMatrix(assessmentId: string) {
    return {
      assessmentId,
      matrix: [
        { x: 'Low', y: 'Low', items: ['[DETAILS HIDDEN]'] },
        { x: 'High', y: 'High', items: ['[DETAILS HIDDEN]'] },
      ],
      summary: 'Upgrade to Premium to see personalized strategy recommendations',
      isRestricted: true,
    };
  }

  /**
   * Check if user should receive real AI analysis
   * @returns true if PREMIUM or ENTERPRISE, false if FREE
   */
  async shouldGenerateRealAnalysis(userId: string): Promise<boolean> {
    const subscription = await this.prisma.subscription.findUnique({
      where: { userId },
      select: { plan: true },
    });

    if (!subscription) {
      this.logger.warn(`No subscription found for user ${userId}, defaulting to FREE`);
      return false;
    }

    const isRealAnalysis = subscription.plan !== SubscriptionPlan.FREE;

    this.logger.info(
      `User ${userId} plan: ${subscription.plan}, real analysis: ${isRealAnalysis}`
    );

    return isRealAnalysis;
  }
}
```

[Source: docs/V4_REVISED_PAY_GATING_PLAN.md#FreemiumContentService]

---

### No OpenAI API Calls

**Critical Requirement:** This service MUST NOT call OpenAI API

**Why:**
- Freemium users don't pay → should not incur API costs
- Mocked content is generated in-memory (fast, free)
- Real AI analysis only for PREMIUM/ENTERPRISE users

**Verification:**
```typescript
// In tests, verify no OpenAI import
import { FreemiumContentService } from '../services/freemium-content.service';

// Service file should NOT import:
// import OpenAI from 'openai';  ❌ Should NOT exist

// Service should only import:
import { BaseService } from './base.service';  ✅
import { SubscriptionPlan } from '../generated/prisma';  ✅
```

[Source: docs/V4_REVISED_PAY_GATING_PLAN.md#Cost Optimization]

---

### Testing Standards

**Test Framework:** Vitest 3
**Test Location:** `backend/tests/unit/freemium-content-service.test.ts`

**Test Pattern:**
```typescript
import { describe, it, expect, beforeAll, afterAll } from 'vitest';
import { FreemiumContentService } from '../src/services/freemium-content.service';
import { PrismaClient, SubscriptionPlan } from '../src/generated/prisma';

describe('FreemiumContentService', () => {
  let service: FreemiumContentService;
  let prisma: PrismaClient;
  let testUserId: string;

  beforeAll(async () => {
    service = new FreemiumContentService();
    prisma = new PrismaClient();

    // Create test user with FREE plan
    const user = await prisma.user.create({
      data: {
        email: 'freemium-test@example.com',
        firstName: 'Free',
        lastName: 'User',
        password: 'hashed',
        subscription: {
          create: {
            plan: SubscriptionPlan.FREE,
            currentPeriodStart: new Date(),
            currentPeriodEnd: new Date(),
          },
        },
      },
    });
    testUserId = user.id;
  });

  afterAll(async () => {
    await prisma.user.delete({ where: { id: testUserId } });
    await prisma.$disconnect();
  });

  describe('generateMockedGapAnalysis', () => {
    it('should return 3-5 mocked gaps', async () => {
      const gaps = await service.generateMockedGapAnalysis('test-assessment-1');

      expect(gaps.length).toBeGreaterThanOrEqual(3);
      expect(gaps.length).toBeLessThanOrEqual(5);
    });

    it('should mark all gaps as restricted', async () => {
      const gaps = await service.generateMockedGapAnalysis('test-assessment-2');

      gaps.forEach(gap => {
        expect(gap.isRestricted).toBe(true);
        expect(gap.description).toContain('[UNLOCK PREMIUM TO SEE DETAILS]');
      });
    });

    it('should match Gap model structure', async () => {
      const gaps = await service.generateMockedGapAnalysis('test-assessment-3');

      gaps.forEach(gap => {
        expect(gap).toHaveProperty('id');
        expect(gap).toHaveProperty('assessmentId');
        expect(gap).toHaveProperty('category');
        expect(gap).toHaveProperty('title');
        expect(gap).toHaveProperty('description');
        expect(gap).toHaveProperty('severity');
        expect(gap).toHaveProperty('priority');
      });
    });
  });

  describe('shouldGenerateRealAnalysis', () => {
    it('should return false for FREE plan user', async () => {
      const result = await service.shouldGenerateRealAnalysis(testUserId);

      expect(result).toBe(false);
    });

    it('should return true for PREMIUM plan user', async () => {
      // Update user to PREMIUM
      await prisma.subscription.update({
        where: { userId: testUserId },
        data: { plan: SubscriptionPlan.PREMIUM },
      });

      const result = await service.shouldGenerateRealAnalysis(testUserId);

      expect(result).toBe(true);

      // Reset to FREE
      await prisma.subscription.update({
        where: { userId: testUserId },
        data: { plan: SubscriptionPlan.FREE },
      });
    });

    it('should return false if subscription not found', async () => {
      const result = await service.shouldGenerateRealAnalysis('nonexistent-user');

      expect(result).toBe(false);
    });
  });

  describe('generateMockedStrategyMatrix', () => {
    it('should return blurred strategy matrix', async () => {
      const matrix = await service.generateMockedStrategyMatrix('test-assessment-4');

      expect(matrix.isRestricted).toBe(true);
      expect(matrix.summary).toContain('Upgrade to Premium');
    });
  });
});
```

[Source: architecture.md#Testing Strategy]

---

### File Locations
- **Service:** `backend/src/services/freemium-content.service.ts`
- **BaseService:** `backend/src/services/base.service.ts`
- **Types:** `backend/src/generated/prisma/index.d.ts`
- **Test:** `backend/tests/unit/freemium-content-service.test.ts`

---

### Usage Example (Future Story)

```typescript
// In AssessmentService.getAssessmentResults()
const freemiumService = new FreemiumContentService();

const shouldUseRealAnalysis = await freemiumService.shouldGenerateRealAnalysis(userId);

if (!shouldUseRealAnalysis) {
  // Generate mocked content (FREE user)
  assessment.gaps = await freemiumService.generateMockedGapAnalysis(assessmentId);
  assessment.strategyMatrix = await freemiumService.generateMockedStrategyMatrix(assessmentId);
  assessment.isRestricted = true;
} else {
  // Return real AI-generated content (PREMIUM/ENTERPRISE user)
  // ... existing logic
}
```

[Source: Story 5.7 - Update AssessmentService]

---

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from Epic 5 | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
No issues encountered.

### Completion Notes
All tasks completed successfully:
1. ✅ Created FreemiumContentService extending BaseService
2. ✅ Implemented generateMockedGapAnalysis() - returns 3-5 generic gaps
3. ✅ Implemented generateMockedStrategyMatrix() - blurred matrix with upgrade CTA
4. ✅ Implemented shouldGenerateRealAnalysis() - checks subscription plan
5. ✅ Service does NOT call OpenAI API (cost-free)
6. ✅ Comprehensive unit tests (16 test cases including performance verification)

### File List
- Created: `backend/src/services/freemium-content.service.ts`
- Created: `backend/tests/unit/freemium-content-service.test.ts`

---

## QA Results
_This section will be populated by the QA agent after story completion_
