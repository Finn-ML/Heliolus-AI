# Story 5.6: Update AssessmentService with Quota Checks

## Status
Draft

## Story
**As a** system,
**I want** assessment creation to check user quotas,
**so that** Freemium users are limited to 2 assessments total.

## Acceptance Criteria
1. `createAssessment()` method checks user subscription plan before creating assessment
2. For FREE tier users:
   - Query `UserAssessmentQuota` for `totalAssessmentsCreated`
   - If >= 2, throw error with code 'FREEMIUM_QUOTA_EXCEEDED'
   - Error message: "Free users can create maximum 2 assessments. Upgrade to Premium for unlimited access."
   - If < 2, increment `totalAssessmentsCreated` after successful assessment creation
3. For PREMIUM/ENTERPRISE users: no quota check, assessment created normally
4. Quota increment happens in same transaction as assessment creation
5. If assessment creation fails, quota is not incremented

## Tasks / Subtasks

- [ ] **Task 1: Locate createAssessment Method** (AC: 1)
  - [ ] Open `backend/src/services/assessment.service.ts`
  - [ ] Find `createAssessment()` method (likely around line 100-200)
  - [ ] Review current implementation logic
  - [ ] Identify where to add quota check (before assessment creation)

- [ ] **Task 2: Add Subscription Plan Query** (AC: 1, 2)
  - [ ] At start of createAssessment, query user subscription:
    ```typescript
    const user = await this.prisma.user.findUnique({
      where: { id: context.userId },
      include: { subscription: true },
    });
    ```
  - [ ] Extract plan: `const plan = user.subscription?.plan || 'FREE'`

- [ ] **Task 3: Implement FREE Tier Quota Check** (AC: 2)
  - [ ] Add conditional check:
    ```typescript
    if (plan === SubscriptionPlan.FREE) {
      const quota = await this.prisma.userAssessmentQuota.findUnique({
        where: { userId: context.userId },
      });

      if (quota && quota.totalAssessmentsCreated >= 2) {
        throw this.createError(
          'Free users can create maximum 2 assessments. Upgrade to Premium for unlimited access.',
          402,
          'FREEMIUM_QUOTA_EXCEEDED'
        );
      }
    }
    ```
  - [ ] HTTP status 402: Payment Required

- [ ] **Task 4: Wrap in Prisma Transaction** (AC: 4, 5)
  - [ ] Replace existing assessment creation with transaction:
    ```typescript
    const assessment = await this.prisma.$transaction(async (tx) => {
      // Create assessment
      const newAssessment = await tx.assessment.create({ ... });

      // Increment quota for FREE users
      if (plan === SubscriptionPlan.FREE) {
        await tx.userAssessmentQuota.upsert({
          where: { userId: context.userId },
          create: {
            userId: context.userId,
            totalAssessmentsCreated: 1,
          },
          update: {
            totalAssessmentsCreated: { increment: 1 },
          },
        });
      }

      return newAssessment;
    });
    ```
  - [ ] Use `upsert` to handle case where quota doesn't exist yet

- [ ] **Task 5: Ensure PREMIUM/ENTERPRISE Flow Unchanged** (AC: 3)
  - [ ] For non-FREE users, skip quota check entirely
  - [ ] Assessment creation proceeds as normal
  - [ ] No performance impact for paid users

- [ ] **Task 6: Write Unit Tests** (AC: 1-5)
  - [ ] Test file: `backend/tests/unit/assessment-quota-enforcement.test.ts`
  - [ ] Test FREE user with 0 assessments → succeeds
  - [ ] Test FREE user with 1 assessment → succeeds
  - [ ] Test FREE user with 2 assessments → fails with 402
  - [ ] Test PREMIUM user → no quota check
  - [ ] Test transaction rollback on error
  - [ ] Run tests: `npm test`

- [ ] **Task 7: Update Error Handling in Routes** (AC: 2)
  - [ ] In `backend/src/routes/assessment.routes.ts`
  - [ ] Catch FREEMIUM_QUOTA_EXCEEDED error
  - [ ] Return 402 with upgrade URL:
    ```typescript
    catch (error) {
      if (error.code === 'FREEMIUM_QUOTA_EXCEEDED') {
        return reply.code(402).send({
          success: false,
          error: error.message,
          code: 'FREEMIUM_QUOTA_EXCEEDED',
          upgradeUrl: '/pricing?upgrade=premium',
        });
      }
      throw error;
    }
    ```

## Dev Notes

### AssessmentService Location
**File:** `backend/src/services/assessment.service.ts`
**Size:** ~60KB (large service - be careful with modifications)

**createAssessment Method:**
- Current signature: `async createAssessment(input: CreateAssessmentInput, context: ServiceContext)`
- Returns: `Promise<Assessment>`
- Creates assessment record with initial status: DRAFT

[Source: backend/src/services/assessment.service.ts]

---

### Quota Enforcement Logic

**Decision Flow:**
```
1. User requests assessment creation
2. Query user subscription plan
3. Is plan === FREE?
   ├─ YES → Check quota
   │   ├─ totalAssessmentsCreated >= 2?
   │   │   ├─ YES → Throw 402 FREEMIUM_QUOTA_EXCEEDED
   │   │   └─ NO  → Create assessment + increment quota
   │   └─ Return assessment
   └─ NO  → Create assessment normally (no quota check)
```

**Freemium Quota Rules:**
- Limit: 2 assessments LIFETIME (not per month)
- Counter: `UserAssessmentQuota.totalAssessmentsCreated`
- Never reset (permanent limit)
- Upgrade to Premium removes limit

[Source: docs/V4_REVISED_PAY_GATING_PLAN.md#Freemium Tier]

---

### Transaction Atomicity

**Why Transaction Required:**
1. Create Assessment record
2. Increment quota counter
3. Both must succeed or both rollback

**Race Condition Protection:**
```typescript
// BAD: Race condition possible
const assessment = await prisma.assessment.create({ ... });
await prisma.userAssessmentQuota.update({ ... }); // Could fail, leaving orphan assessment

// GOOD: Atomic transaction
const assessment = await prisma.$transaction(async (tx) => {
  const newAssessment = await tx.assessment.create({ ... });
  await tx.userAssessmentQuota.update({ ... });
  return newAssessment;
});
```

**Concurrent Requests:**
- Two simultaneous requests from FREE user with 1 assessment
- Without transaction: Both might succeed (total=3, violates limit)
- With transaction: One succeeds, one fails (total=2, correct)

[Source: architecture.md#Transaction Management]

---

### Upsert Pattern for Quota

**Why Upsert:**
- User might not have quota record yet (new user, data migration)
- `upsert` handles both create and update cases
- Idempotent operation

**Pattern:**
```typescript
await tx.userAssessmentQuota.upsert({
  where: { userId: context.userId },
  create: {
    userId: context.userId,
    totalAssessmentsCreated: 1,
    assessmentsThisMonth: 0,
    assessmentsUsedThisMonth: 0,
  },
  update: {
    totalAssessmentsCreated: { increment: 1 },
  },
});
```

[Source: Prisma documentation - upsert pattern]

---

### Error Responses

**402 Payment Required:**
```json
{
  "success": false,
  "error": "Free users can create maximum 2 assessments. Upgrade to Premium for unlimited access.",
  "code": "FREEMIUM_QUOTA_EXCEEDED",
  "upgradeUrl": "/pricing?upgrade=premium"
}
```

**HTTP 402** specifically indicates:
- Payment/upgrade required to proceed
- Distinguishes from 403 (forbidden - no upgrade path)
- Frontend can detect 402 and show upgrade modal

[Source: HTTP status code standards]

---

### Performance Considerations

**Query Overhead:**
- FREE users: 2 extra queries (subscription + quota)
- PREMIUM/ENTERPRISE: 1 extra query (subscription only)
- Queries are indexed and fast (<10ms)

**Optimization:**
```typescript
// Include subscription in user query (1 query instead of 2)
const user = await this.prisma.user.findUnique({
  where: { id: context.userId },
  include: {
    subscription: true,
    assessmentQuota: true, // Include quota if FREE
  },
});
```

[Source: Prisma include optimization]

---

### Testing Standards

**Test Framework:** Vitest 3
**Test Location:** `backend/tests/unit/assessment-quota-enforcement.test.ts`

**Test Pattern:**
```typescript
import { describe, it, expect, beforeAll, afterAll } from 'vitest';
import { AssessmentService } from '../src/services/assessment.service';
import { PrismaClient, SubscriptionPlan } from '../src/generated/prisma';

describe('Assessment Quota Enforcement', () => {
  let service: AssessmentService;
  let prisma: PrismaClient;
  let freeUserId: string;
  let premiumUserId: string;

  beforeAll(async () => {
    service = new AssessmentService();
    prisma = new PrismaClient();

    // Create FREE user
    const freeUser = await prisma.user.create({
      data: {
        email: 'free@example.com',
        firstName: 'Free',
        lastName: 'User',
        password: 'hashed',
        subscription: {
          create: {
            plan: SubscriptionPlan.FREE,
            currentPeriodStart: new Date(),
            currentPeriodEnd: new Date(),
          },
        },
        assessmentQuota: {
          create: {
            totalAssessmentsCreated: 0,
          },
        },
      },
    });
    freeUserId = freeUser.id;

    // Create PREMIUM user
    const premiumUser = await prisma.user.create({
      data: {
        email: 'premium@example.com',
        firstName: 'Premium',
        lastName: 'User',
        password: 'hashed',
        subscription: {
          create: {
            plan: SubscriptionPlan.PREMIUM,
            creditsBalance: 100,
            currentPeriodStart: new Date(),
            currentPeriodEnd: new Date(),
          },
        },
      },
    });
    premiumUserId = premiumUser.id;
  });

  afterAll(async () => {
    await prisma.user.delete({ where: { id: freeUserId } });
    await prisma.user.delete({ where: { id: premiumUserId } });
    await prisma.$disconnect();
  });

  it('should allow FREE user to create 1st assessment', async () => {
    const assessment = await service.createAssessment({
      templateId: 'test-template',
      organizationId: 'test-org',
    }, { userId: freeUserId, userRole: 'USER' });

    expect(assessment).toBeDefined();

    const quota = await prisma.userAssessmentQuota.findUnique({
      where: { userId: freeUserId },
    });

    expect(quota.totalAssessmentsCreated).toBe(1);
  });

  it('should allow FREE user to create 2nd assessment', async () => {
    const assessment = await service.createAssessment({
      templateId: 'test-template',
      organizationId: 'test-org',
    }, { userId: freeUserId, userRole: 'USER' });

    expect(assessment).toBeDefined();

    const quota = await prisma.userAssessmentQuota.findUnique({
      where: { userId: freeUserId },
    });

    expect(quota.totalAssessmentsCreated).toBe(2);
  });

  it('should block FREE user from creating 3rd assessment', async () => {
    await expect(
      service.createAssessment({
        templateId: 'test-template',
        organizationId: 'test-org',
      }, { userId: freeUserId, userRole: 'USER' })
    ).rejects.toThrow('Free users can create maximum 2 assessments');
  });

  it('should not check quota for PREMIUM user', async () => {
    // Create 5 assessments (no limit)
    for (let i = 0; i < 5; i++) {
      const assessment = await service.createAssessment({
        templateId: 'test-template',
        organizationId: 'test-org',
      }, { userId: premiumUserId, userRole: 'USER' });

      expect(assessment).toBeDefined();
    }

    // Verify no quota record created
    const quota = await prisma.userAssessmentQuota.findUnique({
      where: { userId: premiumUserId },
    });

    expect(quota).toBeNull();
  });

  it('should rollback on assessment creation failure', async () => {
    const quotaBefore = await prisma.userAssessmentQuota.findUnique({
      where: { userId: freeUserId },
    });

    // Try to create assessment with invalid data
    await expect(
      service.createAssessment({
        templateId: 'nonexistent-template',
        organizationId: 'test-org',
      }, { userId: freeUserId, userRole: 'USER' })
    ).rejects.toThrow();

    const quotaAfter = await prisma.userAssessmentQuota.findUnique({
      where: { userId: freeUserId },
    });

    // Quota should NOT increment if assessment creation failed
    expect(quotaAfter.totalAssessmentsCreated).toBe(quotaBefore.totalAssessmentsCreated);
  });
});
```

[Source: architecture.md#Testing Strategy]

---

### File Locations
- **Service:** `backend/src/services/assessment.service.ts`
- **Routes:** `backend/src/routes/assessment.routes.ts`
- **Test:** `backend/tests/unit/assessment-quota-enforcement.test.ts`

---

### Dependencies
**Depends On:**
- Story 5.2: UserAssessmentQuota model must exist
- Existing: User model with subscription relation

**Depended On By:**
- Story 7.1: Assessment Routes will catch quota exceeded errors

---

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from Epic 5 | Bob (Scrum Master) |

---

## Dev Agent Record
_This section will be populated by the development agent during implementation_

### Agent Model Used
_TBD_

### Debug Log References
_TBD_

### Completion Notes
_TBD_

### File List
_TBD_

---

## QA Results
_This section will be populated by the QA agent after story completion_
