# Story 12.7: Template Statistics & Usage Tracking

## Status
Draft

## Story

**As a** platform administrator,
**I want** detailed statistics and usage metrics for assessment templates,
**so that** I can understand template popularity, performance, and make data-driven decisions about template management.

## Acceptance Criteria

1. **Enhanced Template Stats API** - Extend GET /admin/templates/stats
   - Total templates count
   - Active templates count
   - Templates by category (breakdown)
   - Average questions per template
   - Total assessments created per template
   - Average completion time per template
   - Template completion rate (completed/started)
   - Most popular templates (top 5 by usage)
   - Least used templates (bottom 5)

2. **Template Usage Count** - Display in template list
   - Show assessment count for each template
   - Format: "145 uses" badge on template card
   - Color coding: Green (>100), Yellow (10-100), Gray (<10)
   - Click to view assessment list (future enhancement)

3. **In-Use Warning** - Before deletion
   - Check assessment count before allowing delete
   - If count > 0, show warning dialog
   - Dialog message: "This template is used in X assessments. Are you sure you want to delete?"
   - "View Assessments" button in dialog (links to filtered assessment list)
   - Require confirmation checkbox: "I understand this may affect historical data"

4. **Template Performance Metrics** - Statistics Dashboard Widget
   - Average completion time per template
   - Completion rate (% of started assessments that finished)
   - Average risk score per template
   - Gap count distribution (avg gaps found)
   - Display as table or chart

5. **Most Popular Templates Widget** - Admin Dashboard
   - Card showing top 5 templates by usage
   - Template name, category, usage count
   - Trend indicator (↑ increasing, → stable, ↓ decreasing)
   - Link to template detail page

6. **Template Health Indicators**
   - Flag templates with completion rate < 50% (potential usability issues)
   - Flag templates with avg completion time > 2 hours (too complex)
   - Flag templates with zero usage in last 30 days (consider archiving)
   - Display warning badges on template cards

7. **Export Template Statistics** - CSV download
   - Button: "Export Statistics"
   - CSV includes: Template ID, Name, Category, Total Uses, Completion Rate, Avg Time, Status
   - Filename: `template-statistics-YYYY-MM-DD.csv`
   - Downloads via browser download API

## Tasks / Subtasks

- [ ] Task 1: Enhance Template Stats Service Method (AC: 1)
  - [ ] Extend `getTemplateStats()` in TemplateService
  - [ ] Query assessment counts grouped by templateId
  - [ ] Calculate completion rates (status=COMPLETED / total)
  - [ ] Calculate average completion times (completedAt - createdAt)
  - [ ] Identify top 5 and bottom 5 templates by usage
  - [ ] Return comprehensive stats object

- [ ] Task 2: Add Usage Count to Template List (AC: 2)
  - [ ] Include assessment count in template list query
  - [ ] Add usage badge to TemplateManagement.tsx cards
  - [ ] Color code based on usage (green/yellow/gray)
  - [ ] Position badge in top-right corner of card
  - [ ] Tooltip showing "X assessments created"

- [ ] Task 3: Implement Enhanced Delete Warning (AC: 3)
  - [ ] Before delete, fetch assessment count
  - [ ] If count > 0, show confirmation dialog
  - [ ] Display count in dialog message
  - [ ] Add "View Assessments" link (opens filtered list)
  - [ ] Require checkbox confirmation
  - [ ] Proceed with delete only if confirmed

- [ ] Task 4: Create Template Performance Metrics Component (AC: 4)
  - [ ] Create TemplatePerformanceTable component
  - [ ] Fetch data from enhanced stats API
  - [ ] Display table with columns: Name, Completion Rate, Avg Time, Avg Risk Score, Avg Gaps
  - [ ] Sort by completion rate (lowest first to identify issues)
  - [ ] Highlight rows with completion rate < 50% (red background)
  - [ ] Add to admin template management page

- [ ] Task 5: Create Popular Templates Widget (AC: 5)
  - [ ] Create PopularTemplatesWidget component
  - [ ] Fetch top 5 templates from stats API
  - [ ] Display template name, category, usage count
  - [ ] Calculate trend (compare to previous period)
  - [ ] Show trend icon (↑/→/↓)
  - [ ] Click template navigates to detail page
  - [ ] Add to admin dashboard

- [ ] Task 6: Implement Template Health Indicators (AC: 6)
  - [ ] Add `getTemplateHealthFlags()` function
  - [ ] Check completion rate < 50% → flag as "Low Completion"
  - [ ] Check avg time > 120 min → flag as "Too Complex"
  - [ ] Check zero uses in 30 days → flag as "Inactive"
  - [ ] Display warning badges on template cards
  - [ ] Tooltip explaining the health issue

- [ ] Task 7: Implement Statistics Export (AC: 7)
  - [ ] Add "Export Statistics" button to template management page
  - [ ] Generate CSV from template stats data
  - [ ] Include columns: ID, Name, Category, Uses, Completion Rate, Avg Time, Status
  - [ ] Use CSV library (e.g., papaparse)
  - [ ] Trigger browser download with filename: `template-statistics-${date}.csv`

- [ ] Task 8: Backend Stat Calculation Optimization
  - [ ] Add database indexes for performance (Assessment.templateId, Assessment.status)
  - [ ] Cache stats results in Redis (TTL: 5 minutes)
  - [ ] Use Prisma aggregation queries for efficiency
  - [ ] Test performance with 1000+ assessments

- [ ] Task 9: Integration Testing (All AC)
  - [ ] Verify stats API returns correct counts
  - [ ] Verify completion rate calculation (10 completed / 15 total = 66.7%)
  - [ ] Verify average completion time (test with known data)
  - [ ] Test usage badge displays correctly (0 uses, 50 uses, 200 uses)
  - [ ] Test delete warning (template with 10 assessments)
  - [ ] Test performance metrics table sorting
  - [ ] Test popular templates widget (top 5 correct)
  - [ ] Test health indicators (low completion, too complex, inactive)
  - [ ] Test CSV export (download, verify contents)

## Dev Notes

### Enhanced Template Stats Response

**API Response Structure:**
```typescript
interface TemplateStats {
  totalTemplates: number;
  activeTemplates: number;
  categoryCounts: Record<string, number>; // e.g., { FINANCIAL_CRIME: 10, TRADE_COMPLIANCE: 5 }
  averageQuestions: number;

  // NEW fields
  templateUsage: TemplateUsageStats[];
  topTemplates: TemplateRanking[]; // Top 5 by usage
  bottomTemplates: TemplateRanking[]; // Bottom 5 by usage
  healthIssues: TemplateHealthIssue[];
}

interface TemplateUsageStats {
  templateId: string;
  templateName: string;
  category: string;
  totalAssessments: number;
  completedAssessments: number;
  completionRate: number; // 0-100
  averageCompletionTimeMinutes: number;
  averageRiskScore: number;
  averageGapCount: number;
  lastUsed: string; // ISO date
}

interface TemplateRanking {
  templateId: string;
  templateName: string;
  usageCount: number;
  trend: 'up' | 'stable' | 'down';
}

interface TemplateHealthIssue {
  templateId: string;
  templateName: string;
  issues: ('low_completion' | 'too_complex' | 'inactive')[];
  completionRate?: number;
  averageTimeMinutes?: number;
  daysSinceLastUse?: number;
}
```

### Backend Implementation

**Enhanced Service Method:**
```typescript
async getTemplateStats(context?: ServiceContext): Promise<ApiResponse<TemplateStats>> {
  try {
    // Check Redis cache first
    const cached = await this.redis.get('admin:template:stats');
    if (cached) {
      return this.createResponse(true, JSON.parse(cached));
    }

    // Fetch basic counts
    const [totalCount, activeCount, templates] = await Promise.all([
      this.prisma.template.count(),
      this.prisma.template.count({ where: { isActive: true } }),
      this.prisma.template.findMany({
        select: {
          id: true,
          name: true,
          category: true,
          _count: { select: { sections: true, assessments: true } },
        },
      }),
    ]);

    // Calculate category counts
    const categoryCounts: Record<string, number> = {};
    templates.forEach(t => {
      categoryCounts[t.category] = (categoryCounts[t.category] || 0) + 1;
    });

    // Fetch assessment data for usage stats
    const assessments = await this.prisma.assessment.findMany({
      select: {
        templateId: true,
        status: true,
        createdAt: true,
        completedAt: true,
        riskScore: true,
      },
    });

    // Group by template
    const templateUsageMap = new Map<string, any[]>();
    assessments.forEach(a => {
      if (!templateUsageMap.has(a.templateId)) {
        templateUsageMap.set(a.templateId, []);
      }
      templateUsageMap.get(a.templateId)!.push(a);
    });

    // Calculate usage stats per template
    const templateUsage: TemplateUsageStats[] = templates.map(t => {
      const tAssessments = templateUsageMap.get(t.id) || [];
      const completed = tAssessments.filter(a => a.status === 'COMPLETED');

      const avgTime = completed.length > 0
        ? completed.reduce((sum, a) => {
            const minutes = (new Date(a.completedAt!).getTime() - new Date(a.createdAt).getTime()) / 60000;
            return sum + minutes;
          }, 0) / completed.length
        : 0;

      const avgRiskScore = completed.length > 0
        ? completed.reduce((sum, a) => sum + (a.riskScore || 0), 0) / completed.length
        : 0;

      const lastUsed = tAssessments.length > 0
        ? new Date(Math.max(...tAssessments.map(a => new Date(a.createdAt).getTime()))).toISOString()
        : null;

      return {
        templateId: t.id,
        templateName: t.name,
        category: t.category,
        totalAssessments: tAssessments.length,
        completedAssessments: completed.length,
        completionRate: tAssessments.length > 0 ? (completed.length / tAssessments.length) * 100 : 0,
        averageCompletionTimeMinutes: Math.round(avgTime),
        averageRiskScore: Math.round(avgRiskScore * 10) / 10,
        averageGapCount: 0, // TODO: Calculate from Gap table
        lastUsed,
      };
    });

    // Top 5 and bottom 5
    const sortedByUsage = [...templateUsage].sort((a, b) => b.totalAssessments - a.totalAssessments);
    const topTemplates = sortedByUsage.slice(0, 5).map(t => ({
      templateId: t.templateId,
      templateName: t.templateName,
      usageCount: t.totalAssessments,
      trend: 'stable' as const, // TODO: Calculate trend
    }));
    const bottomTemplates = sortedByUsage.slice(-5).map(t => ({
      templateId: t.templateId,
      templateName: t.templateName,
      usageCount: t.totalAssessments,
      trend: 'stable' as const,
    }));

    // Health issues
    const healthIssues: TemplateHealthIssue[] = templateUsage
      .map(t => {
        const issues: ('low_completion' | 'too_complex' | 'inactive')[] = [];
        if (t.completionRate < 50) issues.push('low_completion');
        if (t.averageCompletionTimeMinutes > 120) issues.push('too_complex');
        if (t.lastUsed) {
          const daysSince = (Date.now() - new Date(t.lastUsed).getTime()) / (1000 * 60 * 60 * 24);
          if (daysSince > 30) issues.push('inactive');
        }
        return issues.length > 0
          ? {
              templateId: t.templateId,
              templateName: t.templateName,
              issues,
              completionRate: t.completionRate,
              averageTimeMinutes: t.averageCompletionTimeMinutes,
              daysSinceLastUse: t.lastUsed ? Math.floor((Date.now() - new Date(t.lastUsed).getTime()) / (1000 * 60 * 60 * 24)) : undefined,
            }
          : null;
      })
      .filter(Boolean) as TemplateHealthIssue[];

    const stats: TemplateStats = {
      totalTemplates: totalCount,
      activeTemplates: activeCount,
      categoryCounts,
      averageQuestions: templates.length > 0 ? templates.reduce((sum, t) => sum + t._count.sections, 0) / templates.length : 0,
      templateUsage,
      topTemplates,
      bottomTemplates,
      healthIssues,
    };

    // Cache for 5 minutes
    await this.redis.setex('admin:template:stats', 300, JSON.stringify(stats));

    return this.createResponse(true, stats);
  } catch (error) {
    if (error.statusCode) throw error;
    this.handleDatabaseError(error, 'getTemplateStats');
  }
}
```

### Frontend Components

**Usage Badge:**
```typescript
function TemplateUsageBadge({ count }: { count: number }) {
  const variant = count > 100 ? 'success' : count > 10 ? 'warning' : 'secondary';
  const color = count > 100 ? 'bg-green-500/20 text-green-600' : count > 10 ? 'bg-yellow-500/20 text-yellow-600' : 'bg-gray-500/20 text-gray-600';

  return (
    <TooltipProvider>
      <Tooltip>
        <TooltipTrigger>
          <Badge className={color}>
            {count} use{count !== 1 ? 's' : ''}
          </Badge>
        </TooltipTrigger>
        <TooltipContent>
          {count} assessment{count !== 1 ? 's' : ''} created with this template
        </TooltipContent>
      </Tooltip>
    </TooltipProvider>
  );
}
```

**Delete Confirmation Dialog:**
```typescript
function DeleteTemplateDialog({ template, onConfirm, onCancel }: {
  template: Template;
  onConfirm: () => void;
  onCancel: () => void;
}) {
  const [confirmed, setConfirmed] = useState(false);

  return (
    <AlertDialog open onOpenChange={onCancel}>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle>Delete Template?</AlertDialogTitle>
          <AlertDialogDescription>
            This template is used in <strong>{template.assessmentCount} assessments</strong>.
            Deleting it will mark it as inactive but preserve historical assessment data.
          </AlertDialogDescription>
        </AlertDialogHeader>

        <div className="flex items-center gap-2">
          <Checkbox
            id="confirm-delete"
            checked={confirmed}
            onCheckedChange={setConfirmed}
          />
          <label htmlFor="confirm-delete" className="text-sm">
            I understand this may affect historical data
          </label>
        </div>

        <AlertDialogFooter>
          <AlertDialogCancel onClick={onCancel}>Cancel</AlertDialogCancel>
          <AlertDialogAction
            onClick={onConfirm}
            disabled={!confirmed}
            className="bg-red-500 hover:bg-red-600"
          >
            Delete Template
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  );
}
```

**CSV Export:**
```typescript
import Papa from 'papaparse';

function exportTemplateStatistics(stats: TemplateStats) {
  const csvData = stats.templateUsage.map(t => ({
    'Template ID': t.templateId,
    'Name': t.templateName,
    'Category': t.category,
    'Total Uses': t.totalAssessments,
    'Completion Rate': `${t.completionRate.toFixed(1)}%`,
    'Avg Completion Time (min)': t.averageCompletionTimeMinutes,
    'Avg Risk Score': t.averageRiskScore,
    'Last Used': t.lastUsed || 'Never',
  }));

  const csv = Papa.unparse(csvData);
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);

  const link = document.createElement('a');
  link.href = url;
  link.download = `template-statistics-${new Date().toISOString().split('T')[0]}.csv`;
  link.click();

  URL.revokeObjectURL(url);
}
```

### File Locations

**Modified Files:**
- `backend/src/services/template.service.ts` - Enhance getTemplateStats()
- `frontend/src/pages/admin/TemplateManagement.tsx` - Add usage badges, health indicators
- `frontend/src/pages/admin/Dashboard.tsx` - Add popular templates widget

**New Files:**
- `frontend/src/components/admin/TemplatePerformanceTable.tsx` - Performance metrics table
- `frontend/src/components/admin/PopularTemplatesWidget.tsx` - Dashboard widget
- `frontend/src/components/admin/TemplateUsageBadge.tsx` - Reusable usage badge

### Testing Checklist

```
□ API returns correct template count
□ API calculates completion rate correctly (test data: 10/15 = 66.7%)
□ API calculates avg completion time (test with known assessment)
□ API identifies top 5 templates
□ API identifies health issues (low completion, too complex, inactive)
□ Usage badge displays correctly (0 uses, 50 uses, 150 uses)
□ Usage badge color coding (gray, yellow, green)
□ Delete warning shows for template with assessments
□ Delete warning requires checkbox confirmation
□ Performance metrics table displays correctly
□ Popular templates widget shows top 5
□ Health indicators appear on affected templates
□ CSV export downloads successfully
□ CSV export contains correct data
□ Stats cache works (second request faster)
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Story created - Template statistics & usage tracking | Bob (Scrum Master) |

---

## Dev Agent Record
_To be populated by dev agent during implementation_

---

## QA Results
_To be populated by QA agent after testing_
