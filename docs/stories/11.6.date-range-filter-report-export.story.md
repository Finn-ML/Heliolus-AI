# Story 11.6: Date Range Filter and Report Export

## Status
Draft

## Story

**As an** admin
**I want** to filter metrics by date range and export reports
**So that** I can analyze specific time periods

## Acceptance Criteria

1. Date range filter component added to dashboard header:
   - Preset options: "Last 7 days", "Last 30 days", "Last 90 days", "This month", "Last month", "Custom"
   - Custom opens date picker (start date + end date)
   - Filter applies to all metrics and charts
2. URL state management:
   - Date range persists in URL: `?from=2024-01-01&to=2024-01-31`
   - Shareable URLs preserve selected range
3. Export functionality:
   - "Export Report" button in dashboard header
   - Dropdown: "Export as PDF" | "Export as Excel"
   - PDF: Summary page with all metrics and charts (screenshot-based)
   - Excel: Multiple sheets (Assessments, Vendors, Users) with raw data
4. Backend endpoint: `GET /v1/admin/analytics/export?format=pdf|excel&from=...&to=...`
5. Excel export includes:
   - Sheet 1: Summary metrics (key numbers)
   - Sheet 2: Assessment details (daily breakdown)
   - Sheet 3: Vendor engagement (vendor list with metrics)
   - Sheet 4: User activity (user segments)
6. PDF export includes:
   - Cover page with date range and logo
   - Metrics snapshot (cards)
   - All charts (rendered as images)
   - Generated timestamp
7. Downloads as `heliolus-admin-report-YYYY-MM-DD.{pdf|xlsx}`

## Tasks / Subtasks

- [ ] Task 1: Date Range Filter UI (AC: 1)
  - [ ] Create DateRangePicker component using Radix Popover + react-day-picker
  - [ ] Add preset buttons (Last 7/30/90 days, This month, Last month)
  - [ ] Add custom date picker for from/to dates
  - [ ] Position in dashboard header
  - [ ] Apply filter to all analytics queries

- [ ] Task 2: URL State Management (AC: 2)
  - [ ] Use useSearchParams for URL state
  - [ ] Sync date range to URL: ?from=...&to=...
  - [ ] Parse URL params on page load
  - [ ] Test shareable URLs

- [ ] Task 3: Export Backend - Excel (AC: 4, 5)
  - [ ] Add exportAnalytics method to AnalyticsService
  - [ ] Use exceljs library for Excel generation
  - [ ] Create 4 sheets: Summary, Assessments, Vendors, Users
  - [ ] Populate with data from analytics methods
  - [ ] Return Excel buffer

- [ ] Task 4: Export Backend - PDF (AC: 4, 6)
  - [ ] Use puppeteer or jspdf for PDF generation
  - [ ] Create HTML template with metrics
  - [ ] Render charts as images (html2canvas)
  - [ ] Add cover page with branding
  - [ ] Return PDF buffer

- [ ] Task 5: Export Route (AC: 4, 7)
  - [ ] Add route: GET /admin/analytics/export
  - [ ] Query params: format, from, to
  - [ ] Call exportAnalytics method
  - [ ] Set appropriate Content-Type and Content-Disposition headers
  - [ ] Stream file to response

- [ ] Task 6: Export Frontend (AC: 3, 7)
  - [ ] Add "Export Report" button with dropdown
  - [ ] Options: Export as PDF, Export as Excel
  - [ ] Build export URL with current date range
  - [ ] Trigger download via fetch + blob
  - [ ] Show loading spinner during export
  - [ ] Handle errors with toast

- [ ] Task 7: Testing
  - [ ] Test date range filter updates all queries
  - [ ] Test URL state persistence
  - [ ] Test Excel export generates valid file
  - [ ] Test PDF export renders correctly
  - [ ] Test export with different date ranges

## Dev Notes

### Date Range Picker Component
```tsx
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';
import { Calendar } from '@/components/ui/calendar';

const DateRangePicker = ({ value, onChange }) => {
  const presets = [
    { label: 'Last 7 days', days: 7 },
    { label: 'Last 30 days', days: 30 },
    { label: 'Last 90 days', days: 90 }
  ];

  return (
    <Popover>
      <PopoverTrigger asChild>
        <Button variant="outline">
          <Calendar className="mr-2 h-4 w-4" />
          {formatDateRange(value)}
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-auto p-0">
        <div className="p-2 space-y-2">
          {presets.map(preset => (
            <Button
              key={preset.label}
              variant="ghost"
              onClick={() => onChange(getPresetRange(preset.days))}
            >
              {preset.label}
            </Button>
          ))}
        </div>
        <Calendar
          mode="range"
          selected={value}
          onSelect={onChange}
        />
      </PopoverContent>
    </Popover>
  );
};
```

### Excel Generation
```typescript
import ExcelJS from 'exceljs';

async exportToExcel(data: AnalyticsData): Promise<Buffer> {
  const workbook = new ExcelJS.Workbook();

  // Summary sheet
  const summarySheet = workbook.addWorksheet('Summary');
  summarySheet.addRow(['Metric', 'Value']);
  summarySheet.addRow(['Total Assessments', data.assessments.total]);
  summarySheet.addRow(['Completion Rate', `${data.assessments.completionRate}%`]);
  // ... more metrics

  // Assessments sheet
  const assessmentsSheet = workbook.addWorksheet('Assessments');
  assessmentsSheet.addRow(['Date', 'Started', 'Completed', 'Abandoned']);
  data.assessments.trend.forEach(day => {
    assessmentsSheet.addRow([day.date, day.started, day.completed, day.abandoned]);
  });

  // ... Vendors and Users sheets

  return await workbook.xlsx.writeBuffer();
}
```

### PDF Generation with Puppeteer
```typescript
import puppeteer from 'puppeteer';

async exportToPDF(data: AnalyticsData): Promise<Buffer> {
  const browser = await puppeteer.launch();
  const page = await browser.newPage();

  const html = generateReportHTML(data);
  await page.setContent(html);

  const pdf = await page.pdf({
    format: 'A4',
    printBackground: true,
    margin: { top: '20mm', right: '15mm', bottom: '20mm', left: '15mm' }
  });

  await browser.close();
  return pdf;
}
```

### File Locations
- `frontend/src/components/DateRangePicker.tsx` - New component
- `frontend/src/pages/admin/Dashboard.tsx` - Add filter and export
- `backend/src/services/analytics.service.ts` - Add exportAnalytics
- `backend/src/routes/admin.routes.ts` - Add export route

---

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Story created | Bob (Scrum Master) |

---

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
