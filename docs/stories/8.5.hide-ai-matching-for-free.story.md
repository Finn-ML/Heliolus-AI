# Story 8.5: Update Vendor Marketplace to Hide AI Matching for FREE Users

## Status
Draft

## Story
**As a** Freemium user,
**I want** to browse vendors but not see AI recommendations,
**so that** I understand AI matching is a Premium feature.

## Acceptance Criteria
1. `VendorMarketplace.tsx` modified to check user subscription plan
2. For FREE users:
   - Display full vendor directory (browse all vendors)
   - Hide "AI Matched Vendors" section entirely
   - Show message: "Upgrade to Premium to see AI-matched vendors for your assessment"
   - Vendor cards shown without match scores
   - Contact button still functional (no lead tracking)
3. For PREMIUM/ENTERPRISE users:
   - Show "AI Matched Vendors" section with match scores
   - Display personalized recommendations based on assessment gaps
   - Full lead tracking functionality
4. Subscription plan fetched via existing API call
5. Conditional rendering based on plan tier

## Tasks / Subtasks

- [ ] **Task 1: Add Subscription Check to VendorMarketplace** (AC: 1, 4)
  - [ ] Open `frontend/src/components/VendorMarketplace.tsx`
  - [ ] Import and add billing query:
    ```typescript
    import { useQuery } from '@tanstack/react-query';
    import { quotaApi } from '@/lib/api';

    const { data: billingInfo } = useQuery({
      queryKey: ['subscription', 'billing-info'],
      queryFn: getBillingInfo,
    });

    const isFreeUser = billingInfo?.data?.plan === 'FREE';
    const isPremiumUser = ['PREMIUM', 'ENTERPRISE'].includes(billingInfo?.data?.plan);
    ```

- [ ] **Task 2: Conditionally Render AI Matched Section** (AC: 2, 3)
  - [ ] Replace AI matched vendors section:
    ```typescript
    {isPremiumUser ? (
      <section className="mb-12">
        <h2 className="text-2xl font-bold mb-4">
          AI-Matched Vendors for Your Assessment
        </h2>
        <p className="text-muted-foreground mb-6">
          Based on your compliance gaps, we've identified the best vendor matches.
        </p>
        <VendorMatchGrid matches={vendorMatches} showScores={true} />
      </section>
    ) : (
      <section className="mb-12">
        <UpgradePrompt
          title="AI Vendor Matching"
          description="Upgrade to Premium to see AI-matched vendors for your assessment"
          features={[
            'AI-powered vendor matching',
            'Match scores based on your gaps',
            'Personalized recommendations',
            'Lead tracking and RFP management',
          ]}
          onUpgrade={() => navigate('/pricing?upgrade=premium')}
        />
      </section>
    )}
    ```

- [ ] **Task 3: Show All Vendors for FREE Users** (AC: 2)
  - [ ] Display full vendor directory:
    ```typescript
    <section>
      <h2 className="text-2xl font-bold mb-4">Browse All Vendors</h2>
      <p className="text-muted-foreground mb-6">
        Explore our vendor directory{isFreeUser ? ' (Upgrade for AI matching)' : ''}.
      </p>
      <VendorGrid
        vendors={allVendors}
        showScores={isPremiumUser}  // Hide scores for FREE users
      />
    </section>
    ```

- [ ] **Task 4: Remove Match Scores from Vendor Cards** (AC: 2)
  - [ ] Modify VendorCard component:
    ```typescript
    interface VendorCardProps {
      vendor: Vendor;
      matchScore?: number;
      showScore?: boolean;
    }

    const VendorCard = ({ vendor, matchScore, showScore = true }: VendorCardProps) => (
      <Card>
        <CardHeader>
          <div className="flex justify-between items-start">
            <CardTitle>{vendor.name}</CardTitle>
            {showScore && matchScore && (
              <Badge variant="secondary">
                {matchScore}% match
              </Badge>
            )}
          </div>
        </CardHeader>
        {/* Rest of card */}
      </Card>
    );
    ```

- [ ] **Task 5: Keep Contact Button Functional** (AC: 2)
  - [ ] Ensure contact button works for all users:
    ```typescript
    <Button onClick={() => handleContactVendor(vendor.id)}>
      Contact Vendor
    </Button>

    const handleContactVendor = (vendorId: string) => {
      if (isFreeUser) {
        // No lead tracking for FREE users, just open contact form
        setContactVendor(vendorId);
        setShowContactModal(true);
      } else {
        // Full lead tracking for PREMIUM/ENTERPRISE
        createLead(vendorId);
        setContactVendor(vendorId);
        setShowContactModal(true);
      }
    };
    ```

- [ ] **Task 6: Add Upgrade Banner for FREE Users** (AC: 2)
  - [ ] Add banner above vendor list:
    ```typescript
    {isFreeUser && (
      <FreemiumBanner
        title="Unlock AI Vendor Matching"
        description="Get personalized vendor recommendations based on your assessment"
        ctaText="Upgrade to Premium"
        onCTA={() => navigate('/pricing?upgrade=premium')}
        className="mb-8"
      />
    )}
    ```

- [ ] **Task 7: Hide Lead Tracking UI for FREE Users** (AC: 2)
  - [ ] Conditionally show lead tracking badge:
    ```typescript
    {isPremiumUser && (
      <Badge variant="outline" className="text-xs">
        <Activity className="h-3 w-3 mr-1" />
        Lead tracked
      </Badge>
    )}
    ```

- [ ] **Task 8: Update Filters/Search** (AC: 5)
  - [ ] Ensure filters work for both FREE and PREMIUM:
    ```typescript
    const filteredVendors = allVendors
      .filter(v => v.category === selectedCategory || selectedCategory === 'ALL')
      .filter(v => v.name.toLowerCase().includes(searchQuery.toLowerCase()));

    // For PREMIUM: Also filter by match score threshold
    const displayVendors = isPremiumUser
      ? filteredVendors.filter(v => getMatchScore(v.id) > 50)
      : filteredVendors;
    ```

- [ ] **Task 9: Add Analytics Tracking** (Optional)
  - [ ] Track vendor browse vs matched views:
    ```typescript
    useEffect(() => {
      analytics.track('Vendor Marketplace Viewed', {
        userPlan: billingInfo?.data?.plan,
        viewType: isPremiumUser ? 'ai_matched' : 'browse_only',
      });
    }, [isPremiumUser]);
    ```

- [ ] **Task 10: Test User Experience** (AC: 2, 3, 5)
  - [ ] Test as FREE user: No AI section, full browse, no scores
  - [ ] Test as PREMIUM user: AI section visible, scores shown
  - [ ] Test contact button works for both tiers
  - [ ] Verify upgrade prompts clear and actionable

## Dev Notes

### Vendor Marketplace Views

**FREE User View:**
```
Vendor Marketplace
==================

┌─────────────────────────────────┐
│ 👑 Unlock AI Vendor Matching    │
│ Get personalized recommendations│
│ [Upgrade to Premium]            │
└─────────────────────────────────┘

Browse All Vendors
──────────────────
🔍 Search: [________]
Category: [All ▼]

[Vendor A Card]         [Vendor B Card]
- No match score        - No match score
- Basic info           - Basic info
[Contact]              [Contact]
```

**PREMIUM User View:**
```
Vendor Marketplace
==================

AI-Matched Vendors for Your Assessment
───────────────────────────────────────
Based on your compliance gaps...

[Vendor A Card - 92% match]
[Vendor B Card - 87% match]
[Vendor C Card - 81% match]

Browse All Vendors
──────────────────
🔍 Search: [________]

[All vendors with match scores]
```

[Source: docs/prd/epic-8-frontend-integration.md#Story 4.5]

---

### Existing VendorMarketplace Component

**Location:** `frontend/src/components/VendorMarketplace.tsx`

**Current Features:**
- Vendor filtering by category
- Search functionality
- Vendor cards with contact buttons
- Comparison view

**What Needs to Change:**
- Add subscription check
- Conditional AI matched section
- Hide/show match scores
- Upgrade prompts for FREE users

[Source: frontend/src/components/VendorMarketplace.tsx]

---

### Match Score Display

**PREMIUM User - Vendor Card with Score:**
```typescript
<Card>
  <CardHeader>
    <div className="flex justify-between">
      <CardTitle>Vendor Name</CardTitle>
      <Badge variant="secondary">
        <Sparkles className="h-3 w-3 mr-1" />
        92% match
      </Badge>
    </div>
  </CardHeader>
  <CardContent>
    <p>Vendor description...</p>
    <div className="mt-4">
      <Badge variant="outline" className="mr-2">AML Monitoring</Badge>
      <Badge variant="outline">KYC Automation</Badge>
    </div>
  </CardContent>
  <CardFooter>
    <Button>Contact Vendor</Button>
  </CardFooter>
</Card>
```

**FREE User - Vendor Card without Score:**
```typescript
<Card>
  <CardHeader>
    <CardTitle>Vendor Name</CardTitle>
    {/* No match score badge */}
  </CardHeader>
  <CardContent>
    <p>Vendor description...</p>
    <div className="mt-4">
      <Badge variant="outline" className="mr-2">AML Monitoring</Badge>
      <Badge variant="outline">KYC Automation</Badge>
    </div>
  </CardContent>
  <CardFooter>
    <Button>Contact Vendor</Button>
  </CardFooter>
</Card>
```

[Source: Vendor card design patterns]

---

### Lead Tracking Differences

**FREE Users:**
- Contact button opens contact form
- No VendorContact record created
- No lead tracking in CRM
- Simple email notification to vendor

**PREMIUM/ENTERPRISE Users:**
- Contact button creates VendorContact record
- Lead tracked with status (INQUIRY, RFP_REQUESTED, etc.)
- Full CRM integration
- RFP management
- Follow-up tracking

**Implementation:**
```typescript
const handleContactVendor = async (vendorId: string) => {
  if (isPremiumUser) {
    // Create lead record
    await createVendorContact({
      vendorId,
      assessmentId,
      type: 'INQUIRY',
      status: 'NEW',
    });
  }

  // Open contact modal for all users
  setContactVendorId(vendorId);
  setShowContactModal(true);
};
```

[Source: docs/V4_REVISED_PAY_GATING_PLAN.md]

---

### AI Matching Algorithm

**How AI Matching Works (PREMIUM only):**
1. Assessment identifies compliance gaps
2. Each gap tagged with category (AML, KYC, Transaction Monitoring)
3. Vendors tagged with same categories
4. Match score calculated based on:
   - Category alignment
   - Solution features vs gap requirements
   - Company size compatibility
   - Geographic coverage
5. Top matches (>70% score) shown in AI section

**FREE Users:**
- No gap analysis → No matching input
- Even if gaps existed, matching is gated feature
- Must browse full vendor directory manually

[Source: docs/lib/assessment/scorer.ts, VendorMatchingService]

---

### Upgrade Prompt Placement

**Option 1: Banner at Top (Recommended)**
```typescript
<FreemiumBanner
  title="Unlock AI Vendor Matching"
  description="Get personalized recommendations"
  ctaText="Upgrade to Premium"
  className="mb-8"
/>
```

**Option 2: Card in AI Section Placeholder**
```typescript
<UpgradePrompt
  title="AI Vendor Matching"
  features={['AI-powered matching', ...]}
  className="mb-12"
/>
```

**Option 3: Both (Maximum Visibility)**
Use banner + upgrade card for best conversion.

[Source: Freemium conversion best practices]

---

### Testing Checklist

- [ ] FREE user sees "Browse All Vendors" section
- [ ] FREE user does NOT see "AI Matched Vendors" section
- [ ] FREE user sees upgrade prompt
- [ ] Vendor cards for FREE users have no match scores
- [ ] Contact button works for FREE users
- [ ] PREMIUM user sees "AI Matched Vendors" section
- [ ] PREMIUM user sees match scores on vendor cards
- [ ] Match scores sort vendors by relevance
- [ ] Lead tracking creates VendorContact for PREMIUM users
- [ ] Lead tracking does NOT create records for FREE users
- [ ] Search/filters work for both user types
- [ ] Upgrade CTA navigates to /pricing

[Source: Frontend testing best practices]

---

### File Locations
- **Component:** `frontend/src/components/VendorMarketplace.tsx` (modify)
- **Vendor Card:** `frontend/src/components/VendorCard.tsx` (modify to accept showScore prop)

---

### Dependencies
**Depends On:**
- Story 7.6: GET billing info endpoint
- Existing: VendorMarketplace component
- Existing: UpgradePrompt, FreemiumBanner components

**Depended On By:**
- Future: Lead tracking and RFP management features

---

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Initial story creation from Epic 8 | Bob (Scrum Master) |

---

## Dev Agent Record
_This section will be populated by the development agent during implementation_

### Agent Model Used
_TBD_

### Debug Log References
_TBD_

### Completion Notes
_TBD_

### File List
_TBD_

---

## QA Results
_This section will be populated by the QA agent after story completion_
