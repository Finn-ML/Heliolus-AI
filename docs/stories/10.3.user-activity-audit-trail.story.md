# Story 10.3: User Activity Audit Trail

## Status
Draft

## Story

**As an** admin
**I want** to see a history of all administrative actions on users
**So that** I can track changes and troubleshoot issues

## Acceptance Criteria

1. New "Activity" tab added to user detail dialog
2. Tab shows chronological audit trail for the user:
   - Action (e.g., "User Created", "Status Changed", "Role Updated")
   - Changed fields (e.g., "status: ACTIVE â†’ SUSPENDED")
   - Performed by (admin user name + email)
   - Timestamp (relative: "2 hours ago", absolute on hover)
3. Backend endpoint: `GET /v1/admin/users/:id/audit-log`
4. Audit log captures:
   - User creation (auto-logged on registration)
   - Profile updates (name, email, role changes)
   - Status changes (activated, suspended, deleted)
   - Password resets (admin-initiated)
   - Bulk operation participations
5. Audit entries stored in `AuditLog` table (already exists in schema)
6. Pagination: Show last 50 entries, "Load More" button
7. Filter by action type (dropdown: All, Created, Updated, Status Change, etc.)

## Tasks / Subtasks

- [ ] Task 1: Backend Audit Log Endpoint (AC: 3, 4, 5)
  - [ ] Add `getUserAuditLog` method to user.service.ts
  - [ ] Query AuditLog where entityId = userId, order by createdAt DESC
  - [ ] Support pagination (limit 50, offset for "Load More")
  - [ ] Support filtering by action type
  - [ ] Join with User table to get admin names
  - [ ] Add `GET /admin/users/:id/audit-log` route to admin.routes.ts

- [ ] Task 2: Update Existing Actions to Log Audit Entries (AC: 4)
  - [ ] User registration: Log "USER_CREATED" in auth.routes.ts
  - [ ] Profile update: Log "USER_UPDATED" in user.service.updateUser
  - [ ] Status change: Log "STATUS_CHANGED" with before/after values
  - [ ] Password reset: Log "PASSWORD_RESET_SENT" in admin reset endpoint
  - [ ] Bulk operations: Already logged in Story 10.2

- [ ] Task 3: Frontend Activity Tab UI (AC: 1, 2, 7)
  - [ ] Add "Activity" tab to edit user dialog
  - [ ] Create AuditTrail component with timeline view
  - [ ] Fetch audit log: `useQuery(['admin-user-audit', userId])`
  - [ ] Display entries with icons, action, timestamp, admin
  - [ ] Format timestamps: use date-fns formatDistanceToNow
  - [ ] Add action type filter dropdown
  - [ ] Add "Load More" button for pagination (AC: 6)

- [ ] Task 4: Testing
  - [ ] Unit test: getUserAuditLog method
  - [ ] Integration test: GET /admin/users/:id/audit-log
  - [ ] Test audit entries created on each action type
  - [ ] Frontend test: Activity tab renders audit entries

## Dev Notes

### Existing AuditLog Model
[Source: backend/prisma/schema.prisma:909-926]
```prisma
model AuditLog {
  id        String   @id @default(cuid())
  userId    String?  // User who performed the action
  action    String
  entity    String   // 'User'
  entityId  String?  // ID of the user being modified
  changes   Json?    // { field: { from: old, to: new } }
  metadata  Json?    // Additional context
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])
}
```

### Implementation Pattern

**Creating Audit Log Entry**:
```typescript
await this.prisma.auditLog.create({
  data: {
    userId: context.userId,  // Admin who performed action
    action: 'USER_UPDATED',
    entity: 'User',
    entityId: targetUserId,
    changes: {
      role: { from: oldRole, to: newRole },
      status: { from: oldStatus, to: newStatus }
    },
    metadata: {
      source: 'admin_panel',
      timestamp: new Date().toISOString()
    }
  }
});
```

**Fetching Audit Log with Pagination**:
```typescript
const logs = await this.prisma.auditLog.findMany({
  where: {
    entity: 'User',
    entityId: userId,
    ...(actionType && { action: actionType })
  },
  include: {
    user: {
      select: {
        id: true,
        firstName: true,
        lastName: true,
        email: true
      }
    }
  },
  orderBy: { createdAt: 'desc' },
  take: limit,
  skip: offset
});
```

**Frontend Timeline Component**:
```tsx
<div className="space-y-4">
  {auditLogs.map(log => (
    <div key={log.id} className="flex gap-4">
      <div className="flex flex-col items-center">
        <ActionIcon action={log.action} />
        <div className="w-px h-full bg-border" />
      </div>
      <div className="flex-1">
        <p className="font-medium">{log.action}</p>
        {log.changes && (
          <ChangesSummary changes={log.changes} />
        )}
        <p className="text-sm text-muted-foreground">
          by {log.user?.firstName} {log.user?.lastName}
        </p>
        <p className="text-xs text-muted-foreground">
          {formatDistanceToNow(new Date(log.createdAt), { addSuffix: true })}
        </p>
      </div>
    </div>
  ))}
</div>
```

### File Locations

**Backend**:
- `backend/src/services/user.service.ts` - Add getUserAuditLog method, update existing methods to log
- `backend/src/routes/admin.routes.ts` - Add GET /admin/users/:id/audit-log endpoint
- `backend/src/routes/auth.routes.ts` - Add audit log on user registration

**Frontend**:
- `frontend/src/pages/admin/UserManagement.tsx` - Add "Activity" tab to user dialog
- `frontend/src/components/AuditTrail.tsx` - New component for timeline display (optional)

### Testing Standards
[Source: CLAUDE.md:251-263]
- Framework: Vitest 3
- Test Location: backend/tests/integration/
- Pattern: Arrange-Act-Assert

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Story created - User activity audit trail | Bob (Scrum Master) |

---

## Dev Agent Record
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
